<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<title>PlayMatrix VIP Lüks BlackJack | Ücretsiz Online Casino 21 Oyna</title>
<meta name="description" content="PlayMatrix VIP Lüks Blackjack oyna! Şansını dene, 21'i bul, krupiyeyi yen ve anında MC kazan. Kesintisiz ve indirmesiz online casino deneyimi seni bekliyor.">
<meta name="keywords" content="blackjack oyna, online blackjack, ücretsiz casino, 21 oyna, PlayMatrix, VIP casino, tarayıcı oyunları, mc kazan">
<meta name="author" content="PlayMatrix Global">
<meta name="robots" content="index, follow">
<meta name="language" content="Turkish">
<meta name="theme-color" content="#0d5c2e">
<link rel="canonical" href="https://playmatrix.com.tr/BlackJack.html">

<meta property="og:title" content="PlayMatrix VIP Lüks Blackjack Oyna">
<meta property="og:description" content="21'e ulaş, krupiyeyi alt et ve binlerce MC kazan! PlayMatrix'te kesintisiz casino heyecanına hemen katıl.">
<meta property="og:image" content="https://playmatrix.com.tr/assets/blackjack-promo.jpg">
<meta property="og:url" content="https://playmatrix.com.tr/BlackJack.html">
<meta property="og:type" content="website">
<meta property="og:site_name" content="PlayMatrix">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="PlayMatrix VIP Blackjack Oyna">
<meta name="twitter:description" content="Masaya otur, kartlarını çek ve 21'i bularak MC kazanmaya başla!">

<script>
    if (window.history.replaceState) {
        window.history.replaceState(null, null, "/");
    }
</script>

<!-- CSP (tasarımı bozmaz; gerekli domainleri allowlist yaptık) -->
<meta http-equiv="Content-Security-Policy" content="
default-src 'self' https: data: blob:;
script-src 'self' https://www.gstatic.com https://www.googleapis.com 'unsafe-inline';
style-src 'self' https://fonts.googleapis.com https://cdnjs.cloudflare.com 'unsafe-inline';
img-src 'self' https: data: blob:;
media-src 'self' https: data: blob:;
connect-src 'self' https://emirhan-siye.onrender.com https://*.googleapis.com https://*.gstatic.com https://*.firebaseapp.com https://*.firebasedatabase.app https://*.firebaseio.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com;
font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com data:;
">

<style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;}
    
    body {
        height:100vh; width: 100vw; overflow:hidden;
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto, Helvetica, Arial, sans-serif;
        background: radial-gradient(circle at 50% -20%, rgba(212,175,55,0.15) 0%, transparent 50%),
                    radial-gradient(circle at 50% 50%, #0d5c2e 0%, #073b1c 60%, #031c0c 100%);
        color:white; touch-action:manipulation; display: flex; flex-direction: column;
    }

    /* ÜST BAR */
    .top-bar {
        position:fixed; top:0; left:0; right:0; height:65px; 
        display:flex; align-items:center; justify-content:space-between;
        padding:0 10px; 
        background: linear-gradient(to bottom, #1a1a1a 0%, #000000 100%);
        border-bottom: 2px solid #d4af37; z-index:1000;
        box-shadow: 0 4px 20px rgba(0,0,0,0.8);
    }

    /* SEO H1 İÇİN STİL GÜNCELLEMESİ */
    h1.brand {
        margin: 0; padding: 0;
        font-size: clamp(0.9rem, 4vw, 1.1rem); 
        font-weight:900; color: #d4af37;
        letter-spacing: 1px; font-family: 'Times New Roman', Times, serif; 
        white-space: nowrap; flex-shrink: 0;
        text-shadow: 0 2px 4px rgba(0,0,0,1);
    }

    .right-menu { 
        display:flex; gap:5px; align-items: center; 
        flex-wrap: nowrap; overflow: hidden; 
        justify-content: flex-end; flex: 1; margin-left: 10px;
    }
    
    .user-pill-mini { 
        display: flex; align-items: center; gap: 4px; 
        background: linear-gradient(145deg, #222, #111); padding: 4px 8px; 
        border-radius: 15px; border: 1px solid rgba(212,175,55,0.4); 
        white-space: nowrap; flex-shrink: 1; 
        min-width: 0; 
    }
    
    .balance-info { display: flex; align-items: center; overflow: hidden; }
    .balance-info b { font-size: clamp(11px, 3.5vw, 13px); color: #00ffa3; font-family: monospace; font-weight: 700; text-overflow: ellipsis; overflow: hidden; }
    
    .mc-chip {
        width: 16px; height: 16px; flex-shrink: 0;
        background: radial-gradient(circle at 30% 30%, #4fd1ff, #0055ff);
        border-radius: 50%; margin-left: 4px;
        display: flex; align-items: center; justify-content: center;
        font-size: 6px; font-weight: 900; color: #fff;
        box-shadow: 0 0 8px rgba(79, 209, 255, 0.4); border: 1px solid rgba(255,255,255,0.4);
    }

    .back-btn {
        background: linear-gradient(to bottom, #ff4b4b, #cc0000); 
        color: white; text-decoration: none; padding: 5px 8px;
        border-radius: 6px; font-size: clamp(0.6rem, 2.5vw, 0.7rem); 
        font-weight: 900; flex-shrink: 0;
        border: 1px solid #7a0000; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    /* OYUN ALANI */
    .game-container { 
        flex: 1; display: flex; flex-direction: column; justify-content: space-between; 
        padding: 80px 0 20px 0; perspective: 1200px; position: relative; 
        overflow-y: auto;
    }
    
    .area { width: 100%; text-align: center; }
    
    .dealer-title { 
        font-size: 14px; letter-spacing: 4px; font-weight: 900; 
        color: #d4af37; margin-bottom: 5px; 
        text-shadow: 0 2px 4px rgba(0,0,0,0.9); font-family: 'Times New Roman', Times, serif;
    }
    
    .score-badge { 
        background: linear-gradient(to bottom, rgba(30,30,30,0.9), rgba(10,10,10,0.9)); 
        color: #ffd700; padding: 4px 18px; 
        border-radius: 20px; font-size: 12px; font-weight: bold;
        border: 1px solid #d4af37; display: inline-block; margin-bottom: 10px; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.8), inset 0 1px 3px rgba(255,255,255,0.1);
    }

    /* KART GÖRÜNÜM VE ANİMASYONLARI */
    .cards-wrapper { 
        display: flex; justify-content: center; flex-wrap: wrap;
        gap: 5px;
        margin-left: -15px;
        min-height: 105px; padding: 0 10px; 
    }
    
    .card-3d {
        width: 65px; height: 95px;
        position: relative;
        transform-style: preserve-3d;
        transform: translate(350px, -250px) rotateZ(35deg) scale(0.4);
        opacity: 0;
        margin-left: -20px;
        transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s; 
    }
    .card-3d:first-child { margin-left: 0; }

    .card-3d.show { transform: translate(0, 0) rotateZ(0deg) scale(1); opacity: 1; }
    .card-3d.flipped { transform: translate(0, 0) rotateY(180deg); transition: transform 0.5s ease-in-out; }

    .card-face {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden; border-radius: 6px; box-shadow: -4px 4px 12px rgba(0,0,0,0.7); 
    }

    .card-front { background: white; transform: rotateY(180deg); }
    .card-back { background: url('https://deckofcardsapi.com/static/img/back.png') no-repeat center/cover; }

    .action-area { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 85px; z-index: 10; margin-top: 10px;}
    
    #message { 
        font-size: 14px; font-weight: 900; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,1); 
        margin-bottom: 10px; text-transform: uppercase; 
        background: linear-gradient(90deg, transparent, rgba(0,0,0,0.7), transparent); 
        padding: 5px 30px; border-radius: 5px; letter-spacing: 1px;
    }
    
    .controls { display: none; gap: 10px; justify-content: center; flex-wrap: wrap; width: 100%; max-width: 400px; padding: 0 10px;}
    
    .btn { 
        padding: 10px 18px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); 
        font-weight: 900; font-size: 13px; color: white; cursor: pointer; 
        text-transform: uppercase; letter-spacing: 1px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5), inset 0 2px 2px rgba(255,255,255,0.2);
        transition: all 0.1s;
    }
    #hit { background: linear-gradient(to bottom, #2ecc71, #229954); border-color: #1e8449;}
    #stand { background: linear-gradient(to bottom, #e74c3c, #c0392b); border-color: #922b21;}
    #double { background: linear-gradient(to bottom, #f1c40f, #d4ac0d); color: #000; border-color: #b7950b;}
    #split { background: linear-gradient(to bottom, #9b59b6, #8e44ad); border-color: #76448a;}
    .btn:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 1px 2px rgba(0,0,0,0.8), inset 0 2px 2px rgba(0,0,0,0.4); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    /* BÖLÜNMÜŞ ELLER DÜZENİ */
    .hands-container { 
        display: flex; justify-content: center; flex-wrap: wrap;
        gap: 15px; width: 100%; transition: 0.3s; 
    }
    .hand-box { display: flex; flex-direction: column; align-items: center; transition: 0.3s; padding: 10px; border-radius: 10px; border: 2px solid transparent;}
    .hand-box.active { 
        border: 2px solid #d4af37; background: radial-gradient(circle, rgba(212,175,55,0.15), transparent); 
        box-shadow: 0 0 20px rgba(212,175,55,0.2), inset 0 0 15px rgba(212,175,55,0.1); 
    }

    /* ÇİPLER */
    .chips-area { display: flex; justify-content: center; gap: 8px; padding-bottom: 20px; align-items: center; flex-wrap: wrap; transition: opacity 0.3s;}
    .chip { 
        width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
        font-weight: 900; font-size: 13px; cursor: pointer; transition: transform 0.1s; 
        border: 4px dashed #d4af37; box-shadow: 0 6px 12px rgba(0,0,0,0.6), inset 0 0 10px rgba(0,0,0,0.8); 
    }
    .chip:active { transform: scale(0.9); }
    .c1k { background: radial-gradient(circle, #f0f0f0 30%, #a0a0a0 90%); color: #000; border-color: #666;}
    .c3k { background: radial-gradient(circle, #2ecc71 30%, #176634 90%); color: #fff; border-color: #fff;}
    .c5k { background: radial-gradient(circle, #e74c3c 30%, #7a160d 90%); color: #fff; border-color: #fff;}
    .c15k { background: radial-gradient(circle, #3498db 30%, #154360 90%); color: #fff; border-color: #fff;}
    .c20k { background: radial-gradient(circle, #9b59b6 30%, #4a235a 90%); color: #fff; border-color: #d4af37;}
    .c50k { background: radial-gradient(circle, #333 30%, #000 90%); color: #d4af37; border-color: #d4af37;}
    
    .cancel-btn { 
        width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(to bottom, #555, #222); color: white; 
        display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 10px; cursor: pointer; 
        border: 2px solid #888; box-shadow: 0 4px 8px rgba(0,0,0,0.6); 
    }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(8px); }
    .modal-content { background: linear-gradient(to bottom, #1a1a1a, #0a0a0a); border: 2px solid #d4af37; border-radius: 15px; width: 90%; max-width: 380px; padding: 25px; text-align: center; box-shadow: 0 0 40px rgba(212, 175, 55, 0.3); }
    .rules-text { font-size: 13px; color: #ccc; margin-bottom: 20px; text-align: left; line-height: 1.6; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; border: 1px solid #333; }
</style>
</head>
<body>

<div id="sys-start-overlay" class="modal-overlay">
    <div class="modal-content">
        <h2 style="color:#d4af37; margin-bottom: 15px; letter-spacing: 2px; font-family: 'Times New Roman', Times, serif;">VIP LÜKS CASINO</h2>
        <div class="rules-text">
            <b>VIP Blackjack (21) Kuralları:</b><br>
            • Amacınız, kartlarınızın toplam değerini 21'e ulaştırmak veya 21'i geçmeden krupiyeden daha yüksek bir skor elde etmektir.<br>
            • 21'i geçerseniz anında kaybedersiniz (PATLADI).<br>
            • <b>Kart Değerleri:</b> Vale (J), Kız (Q), Papaz (K) 10 değerindedir. As (A) durumuna göre 1 veya 11 sayılır.<br><br>
            <span style="color: #ff4b4b; font-weight: bold;">ÖNEMLİ UYARI:</span> Lütfen stabil bir internet kullanın. Bağlantı kopukluğu, sayfayı yenileme veya oyundan düşme durumunda yatırdığınız MC <b>kesinlikle iade edilmeyecektir.</b>
        </div>
        <button id="systemStartBtn" style="width: 100%; padding: 15px; border-radius: 10px; border: none; background: linear-gradient(to bottom, #f1c40f, #d4ac0d); color: #000; font-weight: 900; font-size: 14px; cursor: pointer; box-shadow: 0 4px 15px rgba(212,175,55,0.4); text-transform: uppercase;" aria-label="Oyuna Başla">Masaya Otur</button>
    </div>
</div>

<header class="top-bar">
    <h1 class="brand">VIP BLACKJACK</h1>
    <nav class="right-menu" aria-label="Kullanıcı Menüsü">
        <div class="user-pill-mini">
            <div class="balance-info"><b id="balance">0</b></div>
            <div class="mc-chip">MC</div>
        </div>
        <div class="user-pill-mini" style="border-color: #ffcc00; background: linear-gradient(145deg, #332800, #1a1400);">
            <div class="balance-info"><b id="betAmount" style="color:#ffcc00">0</b></div>
            <div class="mc-chip" style="background: orange; box-shadow: 0 0 8px rgba(255, 165, 0, 0.4);">MC</div>
        </div>
        <a href="https://playmatrix.com.tr" class="back-btn" aria-label="Ana Sayfaya Dön">ÇIKIŞ</a>
    </nav>
</header>

<main class="game-container">
    <div class="area">
        <div class="dealer-title">KURUPİYER</div>
        <div class="score-badge">Toplam: <span id="dealerScore">0</span></div>
        <div id="dealerCards" class="cards-wrapper"></div>
    </div>

    <div class="action-area">
        <div id="message" aria-live="polite">MC KULLAN (MİN: 1K)</div>

        <div class="controls" id="controls">
            <button id="hit" class="btn" aria-label="Kart Çek">ÇEK</button>
            <button id="stand" class="btn" aria-label="Dur">KAL</button>
            <button id="double" class="btn" aria-label="Bahsi İkiye Katla">2X</button>
            <button id="split" class="btn" aria-label="Kartları Böl">BÖL</button>
        </div>

        <div class="controls" id="insurance-controls">
            <button id="ins-yes" class="btn" style="background: linear-gradient(to bottom, #2ecc71, #229954);" aria-label="Sigorta Al">EVET</button>
            <button id="ins-no" class="btn" style="background: linear-gradient(to bottom, #e74c3c, #c0392b);" aria-label="Sigorta Alma">HAYIR</button>
        </div>
    </div>

    <div class="hands-container" id="playerArea">
        <div class="hand-box active" id="hand0-box">
            <div id="hand0" class="cards-wrapper"></div>
            <div class="score-badge">Toplam: <span id="score0">0</span></div>
        </div>
        <div class="hand-box" id="hand1-box" style="display:none;">
            <div id="hand1" class="cards-wrapper"></div>
            <div class="score-badge">Toplam: <span id="score1">0</span></div>
        </div>
    </div>

    <div class="chips-area" id="chipsArea" aria-label="Bahis Çipleri">
        <div class="cancel-btn" onclick="cancelBet()" aria-label="Bahsi Temizle">SİL</div>
        <div class="chip c1k" onclick="addBet(1000)">1K</div>
        <div class="chip c3k" onclick="addBet(3000)">3K</div>
        <div class="chip c5k" onclick="addBet(5000)">5K</div>
        <div class="chip c15k" onclick="addBet(15000)">15K</div>
        <div class="chip c20k" onclick="addBet(20000)">20K</div>
        <div class="chip c50k" onclick="addBet(50000)">50K</div>
    </div>
</main>

<script type="module">
/**
 * ✅ PlayMatrix Çoklu Oyun Motoru Uyumlu (Render API + Firebase ID Token)
 *
 * Beklenen API sözleşmesi (öneri):
 *  - GET  /api/me
 *      -> { ok:true, balance:number }
 *
 *  - POST /api/blackjack/start  { bet:number }
 *      -> { ok:true, balance:number, gameId:string, state:{...} }
 *
 *  - POST /api/blackjack/insurance { gameId:string, take:boolean }
 *      -> { ok:true, balance:number, state:{...} }
 *
 *  - POST /api/blackjack/action { gameId:string, action:'hit'|'stand'|'double'|'split' }
 *      -> { ok:true, balance:number, state:{...}, resolved?:boolean, payout?:number, message?:string, didWin?:boolean }
 *
 *  - GET /api/blackjack/state (opsiyonel; reload sonrası devam)
 *      -> { ok:true, active:boolean, balance:number, gameId?:string, state?:{...} }
 *
 * state formatı (minimum):
 *  {
 *    dealerCards: [{suit:'S',value:1}, ...],
 *    dealerHidden: true/false,
 *    hands: [
 *      { bet:number, cards:[{suit,value}...], status:'playing'|'stand'|'bust'|'done' }
 *    ],
 *    currentHand: 0,
 *    insuranceOffered: true/false,
 *    insuranceBet: number,
 *    allowedActions: { hit:true, stand:true, double:true, split:true }
 *  }
 */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* ✅ Render API Base */
const API_BASE = "https://emirhan-siye.onrender.com";

/* Firebase */
const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

/* DOM */
const balanceEl = document.getElementById("balance");
const betAmountEl = document.getElementById("betAmount");
const messageEl = document.getElementById("message");

const dealerCardsEl = document.getElementById("dealerCards");
const dealerScoreEl = document.getElementById("dealerScore");

const hand0El = document.getElementById("hand0");
const hand1El = document.getElementById("hand1");
const hand0Box = document.getElementById("hand0-box");
const hand1Box = document.getElementById("hand1-box");
const score0El = document.getElementById("score0");
const score1El = document.getElementById("score1");

const chipsArea = document.getElementById("chipsArea");

const controlsEl = document.getElementById("controls");
const insuranceControlsEl = document.getElementById("insurance-controls");
const btnHit = document.getElementById("hit");
const btnStand = document.getElementById("stand");
const btnDouble = document.getElementById("double");
const btnSplit = document.getElementById("split");
const btnInsYes = document.getElementById("ins-yes");
const btnInsNo = document.getElementById("ins-no");

/* Ses (iOS uyumlu) */
const sounds = {};
let audioCtx = null;

async function initAudio() {
    if (audioCtx) return;
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AudioContext();

    const urls = {
        card: 'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3',
        win: 'https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3',
        lose: 'https://assets.mixkit.co/active_storage/sfx/2043/2043-preview.mp3',
        tick: 'https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3',
        chip: 'https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3'
    };

    for (const [name, url] of Object.entries(urls)) {
        try {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            sounds[name] = audioBuffer;
        } catch(e) { console.warn("Ses yüklenemedi:", name); }
    }

    if (audioCtx.state === 'suspended') await audioCtx.resume();

    // iOS unlock ping
    const buffer = audioCtx.createBuffer(1, 1, 22050);
    const source = audioCtx.createBufferSource();
    source.buffer = buffer;
    source.connect(audioCtx.destination);
    source.start(0);
}

function playSound(name) {
    if(!audioCtx || !sounds[name]) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const source = audioCtx.createBufferSource();
    source.buffer = sounds[name];
    if (name === 'card') source.playbackRate.value = 0.95 + Math.random() * 0.1;
    source.connect(audioCtx.destination);
    source.start(0);
}

document.getElementById('systemStartBtn').addEventListener('click', async () => {
    await initAudio();
    document.getElementById('sys-start-overlay').style.display='none';
});

/* --- Güvenli API Fetch (Bearer ID Token + 401 refresh + timeout) --- */
let lastReqId = 0;

async function apiFetch(path, method = "POST", body = null) {
    if (!auth.currentUser) throw new Error("Oturum yok.");

    const reqId = ++lastReqId;
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 12000);

    const doFetch = async (forceRefresh = false) => {
        const token = await auth.currentUser.getIdToken(forceRefresh);
        return fetch(API_BASE + path, {
            method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
                "X-PlayMatrix-Game": "blackjack",
                "X-Client-ReqId": String(reqId)
            },
            body: body ? JSON.stringify(body) : null,
            mode: "cors",
            signal: controller.signal
        });
    };

    try {
        let res = await doFetch(false);

        if (res.status === 401) {
            res = await doFetch(true);
        }

        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
            throw new Error(data?.error || "Sunucu hatası.");
        }

        // Out-of-order response koruması (eski response UI bozmasın)
        if (reqId !== lastReqId) {
            // Yeni istek atılmış; bu response'u UI'ye uygulama.
            return { __ignored: true };
        }

        return data;
    } finally {
        clearTimeout(t);
    }
}

/* --- Oyun Değişkenleri --- */
let balance = 0;
let initialBet = 0;
let betCountdown = null;
let actionTimer = null;
let isProcessing = false;

let gameId = null;
let state = null;     // sunucudan gelen state
let prevState = null; // animasyon için diff

/* --- UI yardımcıları --- */
function fmt(n){ return Math.floor(Number(n||0)).toLocaleString('tr-TR'); }

function setControlsDisabled(disabled) {
    const btns = document.querySelectorAll('.controls .btn');
    btns.forEach(btn => btn.disabled = disabled);
}

function showControls(show) {
    controlsEl.style.display = show ? "flex" : "none";
    if (!show) setControlsDisabled(true);
}

function showInsurance(show) {
    insuranceControlsEl.style.display = show ? "flex" : "none";
    if (show) setControlsDisabled(false);
}

function clearBoard() {
    dealerCardsEl.innerHTML = "";
    hand0El.innerHTML = "";
    hand1El.innerHTML = "";
    hand1Box.style.display = "none";
    dealerScoreEl.innerText = "0";
    score0El.innerText = "0";
    score1El.innerText = "0";
    hand0Box.classList.remove("active");
    hand1Box.classList.remove("active");
}

function cardVal(v){ return {1:"A", 10:"0", 11:"J", 12:"Q", 13:"K"}[v] || v; }

function getScore(cards) {
    let t = 0, a = 0;
    (cards || []).forEach(c => {
        const vv = Number(c.value);
        let v = vv > 10 ? 10 : (vv === 1 ? 11 : vv);
        if(v === 11) a++;
        t += v;
    });
    while(t > 21 && a > 0) { t -= 10; a--; }
    return { total: t, aces: a };
}

function dealerUpcardScore(dealerCards) {
    const c = (dealerCards || [])[0];
    if(!c) return 0;
    const vv = Number(c.value);
    return vv > 10 ? 10 : (vv === 1 ? 11 : vv);
}

function updateScoreBadges(st) {
    const hands = st?.hands || [];
    const dealerCards = st?.dealerCards || [];
    const dealerHidden = !!st?.dealerHidden;

    // Player scores
    const s0 = hands[0]?.cards ? getScore(hands[0].cards).total : 0;
    score0El.innerText = String(s0);

    if (hands.length > 1) {
        hand1Box.style.display = "flex";
        const s1 = hands[1]?.cards ? getScore(hands[1].cards).total : 0;
        score1El.innerText = String(s1);
    } else {
        hand1Box.style.display = "none";
        score1El.innerText = "0";
    }

    // Dealer score
    const ds = dealerHidden ? dealerUpcardScore(dealerCards) : getScore(dealerCards).total;
    dealerScoreEl.innerText = String(ds);

    // Bet amount top bar: hands + insurance
    let totalBet = Number(st?.insuranceBet || 0);
    hands.forEach(h => totalBet += Number(h.bet || 0));
    betAmountEl.innerText = fmt(totalBet);
}

function setActiveHand(idx) {
    hand0Box.classList.remove("active");
    hand1Box.classList.remove("active");
    if (idx === 1) hand1Box.classList.add("active");
    else hand0Box.classList.add("active");
}

/* Kart animasyonlu ekleme */
function appendCard(divEl, card, isOpen = true) {
    playSound('card');

    const cardCont = document.createElement("div");
    cardCont.className = "card-3d";

    const frontUrl = `https://deckofcardsapi.com/static/img/${cardVal(card.value)}${card.suit}.png`;

    cardCont.innerHTML = `
        <div class="card-face card-front" style="background: url('${frontUrl}') center/cover"></div>
        <div class="card-face card-back"></div>`;

    divEl.appendChild(cardCont);

    return new Promise(resolve => {
        setTimeout(() => {
            cardCont.classList.add("show");
            if (isOpen) {
                setTimeout(() => cardCont.classList.add("flipped"), 400);
            }
            setTimeout(resolve, isOpen ? 900 : 500);
        }, 50);
    });
}

function flipDealerHoleIfNeeded() {
    const cards = dealerCardsEl.querySelectorAll('.card-3d');
    if (cards[1] && !cards[1].classList.contains('flipped')) {
        cards[1].classList.add("flipped");
        playSound('card');
    }
}

/* State render (diff ile) */
async function renderState(newState, { animate = true } = {}) {
    if (!newState) return;

    // UI active hand
    const cur = Number(newState.currentHand || 0);
    setActiveHand(cur);

    // İlk render: board boşsa, komple çiz
    const firstRender = !prevState;

    // Dealer
    const dealerCards = newState.dealerCards || [];
    const prevDealer = prevState?.dealerCards || [];
    const dealerHidden = !!newState.dealerHidden;

    if (firstRender) {
        dealerCardsEl.innerHTML = "";
        // dealer[0] open, dealer[1] hidden olabilir
        for (let i = 0; i < dealerCards.length; i++) {
            const open = !(i === 1 && dealerHidden);
            if (animate) await appendCard(dealerCardsEl, dealerCards[i], open);
            else {
                const tmp = document.createElement("div");
                tmp.className = "card-3d show" + (open ? " flipped" : "");
                const frontUrl = `https://deckofcardsapi.com/static/img/${cardVal(dealerCards[i].value)}${dealerCards[i].suit}.png`;
                tmp.innerHTML = `
                    <div class="card-face card-front" style="background: url('${frontUrl}') center/cover"></div>
                    <div class="card-face card-back"></div>`;
                dealerCardsEl.appendChild(tmp);
            }
        }
    } else {
        // dealer diff: yeni kart eklendiyse animasyonla ekle
        if (dealerCards.length > prevDealer.length) {
            for (let i = prevDealer.length; i < dealerCards.length; i++) {
                // dealerHidden false ise açık ekle
                const open = !(i === 1 && dealerHidden);
                if (animate) await appendCard(dealerCardsEl, dealerCards[i], open);
            }
        }

        // hole reveal
        if (prevState?.dealerHidden && !dealerHidden) {
            flipDealerHoleIfNeeded();
        }
    }

    // Hands
    const hands = newState.hands || [];
    const prevHands = prevState?.hands || [];

    // hand0
    if (firstRender) {
        hand0El.innerHTML = "";
        for (let i = 0; i < (hands[0]?.cards || []).length; i++) {
            if (animate) await appendCard(hand0El, hands[0].cards[i], true);
        }
    } else {
        const prev0 = (prevHands[0]?.cards || []);
        const now0 = (hands[0]?.cards || []);
        if (now0.length > prev0.length) {
            for (let i = prev0.length; i < now0.length; i++) {
                if (animate) await appendCard(hand0El, now0[i], true);
            }
        }
    }

    // hand1
    if (hands.length > 1) {
        hand1Box.style.display = "flex";

        if (firstRender) {
            hand1El.innerHTML = "";
            for (let i = 0; i < (hands[1]?.cards || []).length; i++) {
                if (animate) await appendCard(hand1El, hands[1].cards[i], true);
            }
        } else {
            const prev1 = (prevHands[1]?.cards || []);
            const now1 = (hands[1]?.cards || []);
            if (now1.length > prev1.length) {
                for (let i = prev1.length; i < now1.length; i++) {
                    if (animate) await appendCard(hand1El, now1[i], true);
                }
            }
        }
    } else {
        hand1Box.style.display = "none";
    }

    // Scores + bet
    updateScoreBadges(newState);

    // Actions
    applyAllowedActions(newState);

    // Insurance UI
    if (newState.insuranceOffered) {
        messageEl.innerText = "SİGORTA İSTER MİSİNİZ?";
        showInsurance(true);
        showControls(false);
    } else {
        showInsurance(false);
    }

    prevState = JSON.parse(JSON.stringify(newState));
}

function applyAllowedActions(st) {
    const a = st?.allowedActions || null;

    // fallback: client-side (sadece UI için). Asıl doğrulama sunucuda.
    const hands = st?.hands || [];
    const cur = Number(st?.currentHand || 0);
    const hand = hands[cur] || null;
    const cards = hand?.cards || [];
    const canDoubleFallback = (cards.length === 2);
    const canSplitFallback = (hands.length === 1 && cards.length === 2 && Number(cards[0]?.value) === Number(cards[1]?.value));

    const canHit = a ? !!a.hit : true;
    const canStand = a ? !!a.stand : true;
    const canDouble = a ? !!a.double : canDoubleFallback;
    const canSplit = a ? !!a.split : canSplitFallback;

    btnHit.style.display = canHit ? "block" : "none";
    btnStand.style.display = canStand ? "block" : "none";
    btnDouble.style.display = canDouble ? "block" : "none";
    btnSplit.style.display = canSplit ? "block" : "none";
}

/* --- Bakiye / session --- */
async function refreshMe() {
    const me = await apiFetch("/api/me", "GET");
    if (me.__ignored) return;
    balance = Number(me.balance || 0);
    balanceEl.innerText = fmt(balance);
}

async function tryResume() {
    // Opsiyonel: server /api/blackjack/state destekliyorsa oyun devam ettir
    try {
        const s = await apiFetch("/api/blackjack/state", "GET");
        if (s.__ignored) return;
        if (s.active && s.state && s.gameId) {
            gameId = s.gameId;
            state = s.state;
            prevState = null;
            initialBet = 0;
            chipsArea.style.display = "none";
            messageEl.innerText = "DEVAM EDİYOR...";
            clearBoard();
            await renderState(state, { animate: false });
            // Kontrolleri göster
            if (!state.insuranceOffered) {
                showControls(true);
                setControlsDisabled(false);
                startActionTimer();
            }
        }
        if (typeof s.balance !== "undefined") {
            balance = Number(s.balance || 0);
            balanceEl.innerText = fmt(balance);
        }
    } catch(_) {
        // desteklenmiyorsa sessiz geç
    }
}

/* --- Bahis (UI-only) --- */
window.addBet = (a) => {
    if (isProcessing) return;
    // betting modunda: gameId yokken
    if (gameId) return;
    if(initialBet + a > balance) return;
    playSound('chip');
    initialBet += a;
    balanceEl.innerText = fmt(balance - initialBet);
    betAmountEl.innerText = fmt(initialBet);
    if(!betCountdown && initialBet >= 1000) startBetCountdown();
};

window.cancelBet = () => {
    if (isProcessing) return;
    if (gameId) return;
    if(initialBet === 0) return;
    initialBet = 0;
    playSound('chip');
    balanceEl.innerText = fmt(balance);
    betAmountEl.innerText = "0";
    if(betCountdown) { clearInterval(betCountdown); betCountdown = null; }
    messageEl.innerText = "MC KULLAN (MİN: 1K)";
};

function startBetCountdown(){
    let s = 5;
    messageEl.innerText = `BAŞLIYOR (${s})`;
    playSound('tick');
    betCountdown = setInterval(() => {
        s--;
        if(s > 0) {
            messageEl.innerText = `BAŞLIYOR (${s})`;
            playSound('tick');
        } else {
            clearInterval(betCountdown);
            betCountdown = null;
            startGame();
        }
    }, 1000);
}

/* --- Aksiyon timer --- */
function startActionTimer(){
    if (actionTimer) clearInterval(actionTimer);
    let s = 10;
    messageEl.style.display = "block";
    messageEl.innerText = `KARAR SÜRESİ (${s})`;
    playSound('tick');

    actionTimer = setInterval(() => {
        s--;
        if(s > 0) {
            messageEl.innerText = `KARAR SÜRESİ (${s})`;
            playSound('tick');
        } else {
            clearInterval(actionTimer);
            actionTimer = null;
            // Süre biterse otomatik stand (sunucu doğrular)
            stand();
        }
    }, 1000);
}

function stopActionTimer(){
    if(actionTimer) clearInterval(actionTimer);
    actionTimer = null;
}

/* --- Oyun Başlat (SUNUCUDA) --- */
async function startGame(){
    if (isProcessing) return;
    if (gameId) return;
    if (initialBet < 1000) { messageEl.innerText = "MİNIMUM 1K"; return; }

    isProcessing = true;
    stopActionTimer();
    showControls(false);
    showInsurance(false);
    setControlsDisabled(true);

    chipsArea.style.display = "none";
    clearBoard();
    messageEl.innerText = "DAĞITILIYOR...";

    try {
        const started = await apiFetch("/api/blackjack/start", "POST", { bet: initialBet });
        if (started.__ignored) return;

        gameId = started.gameId;
        balance = Number(started.balance || balance);
        balanceEl.innerText = fmt(balance);

        state = started.state;
        prevState = null;

        // İlk dağıtım animasyonlu
        await renderState(state, { animate: true });

        // insurance varsa renderState zaten açıyor
        if (!state.insuranceOffered) {
            isProcessing = false;
            showControls(true);
            setControlsDisabled(false);
            startActionTimer();
        } else {
            // insurance kararı bekleniyor
            isProcessing = false;
        }
    } catch(e) {
        console.error(e);
        chipsArea.style.display = "flex";
        messageEl.innerText = "SUNUCU HATASI";
        // bet UI reset
        initialBet = 0;
        betAmountEl.innerText = "0";
        balanceEl.innerText = fmt(balance);
    } finally {
        isProcessing = false;
    }
}

/* --- Insurance --- */
btnInsYes.onclick = async () => {
    if(isProcessing) return;
    if(!gameId) return;
    isProcessing = true;
    setControlsDisabled(true);
    showInsurance(false);
    stopActionTimer();

    try {
        const r = await apiFetch("/api/blackjack/insurance", "POST", { gameId, take: true });
        if (r.__ignored) return;

        balance = Number(r.balance ?? balance);
        balanceEl.innerText = fmt(balance);

        state = r.state;
        await renderState(state, { animate: true });

        // Oyun çözülmüş olabilir
        if (r.resolved) {
            await handleResolved(r);
            return;
        }

        isProcessing = false;
        showControls(true);
        setControlsDisabled(false);
        startActionTimer();
    } catch(e) {
        console.error(e);
        messageEl.innerText = (e.message || "İŞLEM HATASI").toUpperCase();
    } finally {
        isProcessing = false;
    }
};

btnInsNo.onclick = async () => {
    if(isProcessing) return;
    if(!gameId) return;
    isProcessing = true;
    setControlsDisabled(true);
    showInsurance(false);
    stopActionTimer();

    try {
        const r = await apiFetch("/api/blackjack/insurance", "POST", { gameId, take: false });
        if (r.__ignored) return;

        balance = Number(r.balance ?? balance);
        balanceEl.innerText = fmt(balance);

        state = r.state;
        await renderState(state, { animate: true });

        if (r.resolved) {
            await handleResolved(r);
            return;
        }

        isProcessing = false;
        showControls(true);
        setControlsDisabled(false);
        startActionTimer();
    } catch(e) {
        console.error(e);
        messageEl.innerText = (e.message || "İŞLEM HATASI").toUpperCase();
    } finally {
        isProcessing = false;
    }
};

/* --- Actions --- */
async function doAction(action) {
    if(isProcessing) return;
    if(!gameId) return;

    isProcessing = true;
    stopActionTimer();
    showControls(false);
    setControlsDisabled(true);

    try {
        const r = await apiFetch("/api/blackjack/action", "POST", { gameId, action });
        if (r.__ignored) return;

        balance = Number(r.balance ?? balance);
        balanceEl.innerText = fmt(balance);

        state = r.state;
        await renderState(state, { animate: true });

        if (r.resolved) {
            await handleResolved(r);
            return;
        }

        // devam ediyorsa kontrolleri aç
        isProcessing = false;
        showControls(true);
        setControlsDisabled(false);
        startActionTimer();
    } catch(e) {
        console.error(e);
        messageEl.innerText = (e.message || "İŞLEM HATASI").toUpperCase();
        // Kullanıcı kilitlenmesin:
        isProcessing = false;
        showControls(true);
        setControlsDisabled(false);
        startActionTimer();
    }
}

btnHit.onclick = () => doAction("hit");

function stand() { doAction("stand"); }
btnStand.onclick = stand;

btnDouble.onclick = () => doAction("double");
btnSplit.onclick = () => doAction("split");

/* --- Resolve --- */
async function handleResolved(r) {
    // r: { payout, message, didWin, balance, state }
    showControls(false);
    showInsurance(false);
    setControlsDisabled(true);
    stopActionTimer();

    // dealer hole açık değilse aç
    if (state && state.dealerHidden === false) {
        flipDealerHoleIfNeeded();
        updateScoreBadges(state);
    }

    const payout = Number(r.payout || 0);
    const msg = (r.message || (payout > 0 ? `KAZANCINIZ: ${fmt(payout)}` : "KAYBETTİNİZ!")).toUpperCase();

    messageEl.innerText = msg;

    if (r.didWin) playSound("win");
    else playSound("lose");

    // kısa bekle, reset
    setTimeout(() => resetToBetting(), 3500);
}

function resetToBetting() {
    // sunucu zaten session kapattı varsayımıyla UI reset
    gameId = null;
    state = null;
    prevState = null;

    clearBoard();
    chipsArea.style.display = "flex";

    initialBet = 0;
    betAmountEl.innerText = "0";
    balanceEl.innerText = fmt(balance);

    messageEl.innerText = "MC KULLAN (MİN: 1K)";
    showControls(false);
    showInsurance(false);
    isProcessing = false;
}

/* --- AUTH bootstrap --- */
onAuthStateChanged(auth, async (user) => {
    if(!user) {
        await signInAnonymously(auth);
        return;
    }

    // ilk açılış
    try {
        await refreshMe();
        await tryResume();
    } catch(e) {
        console.warn(e);
        messageEl.innerText = "SUNUCU BAĞLANTISI YOK";
    }
});

/* Sayfa görünürlüğü: timer sapıtmasın */
document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
        stopActionTimer();
    } else {
        // aktif oyunda isek timer tekrar başlat
        if (gameId && !isProcessing && state && !state.insuranceOffered) {
            startActionTimer();
        }
    }
});
</script>
</body>
</html>
