<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>PlayMatrix Cyber | Ücretsiz Online Zeka ve Bulmaca Oyunu</title>
    <meta name="description" content="PlayMatrix Cyber'da sistemlere sız, nöron bağlantılarını kur ve zekanı test et. Hemen ücretsiz oyna, en yüksek düğüme (node) ulaş ve şifreleri kır!">
    <meta name="keywords" content="cyber oyun, zeka oyunu, bulmaca oyunu, ücretsiz oyun oyna, siber güvenlik oyunu, hacker oyunu, mantık oyunu, PlayMatrix, tarayıcı oyunları">
    <meta name="author" content="PlayMatrix Global">
    <meta name="robots" content="index, follow">
    <meta name="language" content="Turkish">
    <meta name="theme-color" content="#03050a">
    <link rel="canonical" href="https://playmatrix.com.tr/Cyber.html">

    <meta property="og:title" content="PlayMatrix Cyber | Zeka ve Strateji Oyunu">
    <meta property="og:description" content="Nöron ağlarını birleştir, sistemleri hackle ve zekanı sına! En yüksek seviyeye kim ulaşacak?">
    <meta property="og:image" content="https://playmatrix.com.tr/assets/cyber-promo.jpg">
    <meta property="og:url" content="https://playmatrix.com.tr/Cyber.html">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="PlayMatrix">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="PlayMatrix Cyber Oyna">
    <meta name="twitter:description" content="Bağlantıları kur ve matrisi çözmeye hemen başla. Ücretsiz tarayıcı oyunu!">

    <!-- (Opsiyonel) CSP: tasarımı bozmaz, sadece allowlist -->
    <meta http-equiv="Content-Security-Policy" content="
default-src 'self' https: data: blob:;
script-src 'self' https://www.gstatic.com https://www.googleapis.com 'unsafe-inline';
style-src 'self' https://fonts.googleapis.com https://cdnjs.cloudflare.com 'unsafe-inline';
img-src 'self' https: data: blob:;
media-src 'self' https: data: blob: https://assets.mixkit.co;
connect-src 'self' https://emirhan-siye.onrender.com https://*.googleapis.com https://*.gstatic.com https://*.firebaseapp.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com;
font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com data:;
">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Montserrat:wght@900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #00ffa3;
            --bg: #03050a;
            --glass: rgba(10, 15, 25, 0.9);
            --border: rgba(0, 255, 163, 0.2);
            --off: rgba(30, 41, 59, 0.7);
            --tile-size: 65px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg);
            color: white;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;
        }

        #neural-canvas {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: radial-gradient(circle at center, #0a1520 0%, #03050a 100%);
        }

        .top-bar {
            height: 65px;
            min-height: 65px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            background: var(--glass);
            backdrop-filter: blur(25px);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
        }

        .brand {
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 900;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(0, 255, 163, 0.5);
            white-space: nowrap;
        }

        .level-info {
            font-weight: 800;
            font-size: 12px;
            background: rgba(0,255,163,0.1);
            padding: 6px 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            white-space: nowrap;
        }

        .best-score-badge {
            color: var(--primary);
            opacity: 0.8;
            margin-left: 5px;
            padding-left: 5px;
            border-left: 1px solid var(--border);
        }

        .exit-btn {
            color: white;
            text-decoration: none;
            font-size: 11px;
            font-weight: 800;
            opacity: 0.6;
            padding: 8px;
            transition: 0.3s;
        }

        #game-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }

        #grid {
            display: grid;
            gap: 8px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            transition: 0.5s;
        }

        .tile {
            width: var(--tile-size);
            height: var(--tile-size);
            background: var(--off);
            border-radius: 12px;
            cursor: pointer;
            position: relative;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .tile:active { transform: scale(0.9); }

        .line {
            position: absolute;
            background: #475569;
            border-radius: 4px;
            transition: all 0.4s;
        }

        .tile.connected { background: rgba(0, 255, 163, 0.08); border-color: var(--border); }
        .tile.connected .line { background: var(--primary); box-shadow: 0 0 12px var(--primary); }

        .overlay {
            position: absolute; inset: 0; background: rgba(3,5,10,0.85);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000; backdrop-filter: blur(12px);
        }

        .modal {
            background: var(--glass); padding: 35px; border-radius: 28px;
            border: 1px solid var(--border); text-align: center; width: 85%; max-width: 340px;
        }

        .btn {
            width: 100%; padding: 16px; border-radius: 14px; border: none;
            background: var(--primary); color: #000; font-weight: 900;
            text-transform: uppercase; cursor: pointer; margin-top: 20px;
            font-size: 14px;
        }

        #win-status { font-size: 11px; letter-spacing: 2px; color: #fff; opacity: 0.5; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

    <h1 class="sr-only">PlayMatrix Cyber - Zeka ve Mantık Oyunu</h1>

    <canvas id="neural-canvas" aria-label="Nöron Ağı Arka Planı"></canvas>

    <header class="top-bar">
        <div class="brand"><i class="fa-solid fa-microchip" aria-hidden="true"></i> CYBER</div>
        <div class="level-info" aria-live="polite">
            NODE: <span id="level-num">1</span>
            <span class="best-score-badge">EN İYİ: <span id="best-score">1</span></span>
        </div>
        <a href="index.html" class="exit-btn" aria-label="Ana Sayfaya Dön"><i class="fa-solid fa-arrow-right-from-bracket" aria-hidden="true"></i></a>
    </header>

    <main id="game-wrapper">
        <div id="grid" aria-label="Oyun Bulmaca Izgarası"></div>

        <div id="win-overlay" class="overlay" style="display:none;" aria-live="assertive">
            <div class="modal">
                <span id="win-status">[DURUM: BAŞARILI]</span>
                <h2 id="win-title" style="color:var(--primary); font-family: Montserrat;">SİSTEM SIZILDI</h2>
                <p id="win-desc" style="margin-top:10px; opacity:0.7; font-size: 14px;">Nöron bağlantıları başarıyla kuruldu.</p>
                <button class="btn" id="nextLevelBtn" aria-label="Sonraki Seviyeye Geç">SONRAKİ NODE</button>
            </div>
        </div>

        <div id="start-overlay" class="overlay">
            <div class="modal">
                <h2 style="color:var(--primary); font-family: Montserrat;">BAĞLANTIYI KUR</h2>
                <p style="margin-top:10px; opacity:0.7; font-size: 14px;">Zihnini odakla ve tüm devreleri merkeze bağla.</p>
                <button class="btn" id="startBtn" aria-label="Oyunu Başlat">SİSTEMİ AÇ</button>
            </div>
        </div>
    </main>

<script type="module">
/**
 * ✅ SUNUCU-OTORİTER CYBER (mines.html mantığı)
 * - Random/level üretimi client’ta değil, SUNUCUDA
 * - Best score / level ilerlemesi localStorage yerine SUNUCUDA
 * - Client sadece render + rotate isteği atar
 *
 * Beklenen API (Render: https://emirhan-siye.onrender.com):
 *  GET  /api/cyber/state
 *    -> { ok:true, level:number, bestLevel:number, gridSize:number, tiles:[{type:0|1, rotation:0|90|180|270, targetRotation:0|90|180|270}] }
 *
 *  POST /api/cyber/rotate   { index:number }
 *    -> { ok:true, level, bestLevel, gridSize, tiles, solved:boolean }
 *
 *  POST /api/cyber/next
 *    -> { ok:true, level, bestLevel, gridSize, tiles }   // sadece solved ise ilerlet
 */

const API_BASE = "https://emirhan-siye.onrender.com";

/* URL temizliği (Cyber.html görünmesin) */
if (window.history.replaceState) window.history.replaceState(null, null, "/");

/* Firebase Auth (anon) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

let authReady = false;
let gameStarted = false;

/* DOM */
const gridEl = document.getElementById('grid');
const levelNumEl = document.getElementById('level-num');
const bestScoreEl = document.getElementById('best-score');
const startOverlayEl = document.getElementById('start-overlay');
const winOverlayEl = document.getElementById('win-overlay');
const startBtn = document.getElementById('startBtn');
const nextLevelBtn = document.getElementById('nextLevelBtn');

/* --- NÖRON ARKA PLAN ANİMASYONU --- */
const canvas = document.getElementById('neural-canvas');
const ctx = canvas.getContext('2d');
let particles = [];

function resizeBG() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeBG);
resizeBG();

class Particle {
    constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.vx = (Math.random() - 0.5) * 0.5;
        this.vy = (Math.random() - 0.5) * 0.5;
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        if(this.x < 0 || this.x > canvas.width) this.vx *= -1;
        if(this.y < 0 || this.y > canvas.height) this.vy *= -1;
    }
}
for(let i=0; i<40; i++) particles.push(new Particle());

function animateBG() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'rgba(0, 255, 163, 0.5)';
    ctx.strokeStyle = 'rgba(0, 255, 163, 0.1)';

    particles.forEach((p, i) => {
        p.update();
        ctx.beginPath();
        ctx.arc(p.x, p.y, 2, 0, Math.PI*2);
        ctx.fill();

        for(let j=i+1; j<particles.length; j++) {
            const p2 = particles[j];
            const dist = Math.hypot(p.x - p2.x, p.y - p2.y);
            if(dist < 150) {
                ctx.beginPath();
                ctx.moveTo(p.x, p.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.stroke();
            }
        }
    });

    requestAnimationFrame(animateBG);
}
animateBG();

/* --- OYUN SESLERİ --- */
const sounds = {
    rotate: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'),
    success: new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3'),
    start: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3')
};
Object.values(sounds).forEach(s => s.volume = 0.3);

function unlockAudio() {
    // iOS autoplay policy “unlock”
    Object.values(sounds).forEach(s => { try { s.play(); s.pause(); } catch {} });
}

/* --- DİNAMİK MESAJ SİSTEMİ --- */
const cyberTitles = [
    "SİSTEM SIZILDI", "GÜVENLİK AŞILDI", "AĞA ERİŞİLDİ", "VERİLER ÇEKİLDİ",
    "FIREWALL ÇÖKTÜ", "ŞİFRELEME KIRILDI", "NODE AKTİF", "PROTOKOL TAMAM",
    "KÖK ERİŞİMİ", "SİBER AĞ ÇÖZÜLDÜ"
];
const cyberDescs = [
    "Nöron bağlantıları başarıyla kuruldu.", "Ana sunucuya yetkisiz erişim sağlandı.",
    "Kriptografik anahtar başarıyla çözüldü.", "Güvenlik duvarı atlatıldı, sistem senin.",
    "Siber ağ protokolleri güncellendi.", "Karanlık ağ geçidi açıldı.",
    "Veri paketleri hedefe yönlendirildi.", "Hedef sistemin kontrolü sağlandı.",
    "Biyometrik kilitler devre dışı bırakıldı.", "Matris kodları deşifre edildi.",
    "Güvenlik kameraları döngüye alındı.", "İz bırakmadan ana belleğe sızıldı.",
    "Admin yetkileri ele geçirildi.", "Kuantum şifrelemesi bypass edildi.",
    "Sistem logları başarıyla temizlendi."
];
const cyberStatuses = ["[DURUM: BAŞARILI]", "[DURUM: GİZLİ]", "[DURUM: KRİTİK]", "[DURUM: STABİL]"];

function generateWinMessage(lvl) {
    const titleIndex = (lvl * 3) % cyberTitles.length;
    const descIndex  = (lvl * 7) % cyberDescs.length;
    const statusIndex= (lvl * 2) % cyberStatuses.length;

    document.getElementById('win-status').innerText = cyberStatuses[statusIndex];
    document.getElementById('win-title').innerText = `${cyberTitles[titleIndex]} [LVL ${lvl}]`;
    document.getElementById('win-desc').innerText  = cyberDescs[descIndex];
}

/* --- SUNUCU İLETİŞİMİ (ID Token) --- */
let lastReqId = 0;

async function apiFetch(path, method="GET", body=null) {
    if (!auth.currentUser) throw new Error("Oturum yok.");

    const reqId = ++lastReqId;
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 12000);

    const doFetch = async (forceRefresh=false) => {
        const token = await auth.currentUser.getIdToken(forceRefresh);
        return fetch(API_BASE + path, {
            method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
                "X-PlayMatrix-Game": "cyber",
                "X-Client-ReqId": String(reqId)
            },
            body: body ? JSON.stringify(body) : null,
            mode: "cors",
            signal: controller.signal
        });
    };

    try {
        let res = await doFetch(false);
        if (res.status === 401) res = await doFetch(true);

        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) throw new Error(data?.error || "Sunucu hatası.");

        // out-of-order koruması
        if (reqId !== lastReqId) return { __ignored: true };
        return data;
    } finally {
        clearTimeout(t);
    }
}

/* --- OYUN STATE --- */
let level = 1;
let bestLevel = 1;
let gridSize = 3;
let tiles = []; // {type, rotation, targetRotation, element}
let isGameLocked = false;
let isProcessingMove = false;

/* Taş boyutunu ekrana sığacak şekilde dinamik hesapla */
function calculateTileSize() {
    const maxWidth = window.innerWidth > 450 ? 400 : window.innerWidth * 0.85;
    const gapSize = 8;
    const totalGap = (gridSize - 1) * gapSize;

    let newSize = Math.floor((maxWidth - totalGap) / gridSize);
    if (newSize > 65) newSize = 65;
    if (newSize < 30) newSize = 30;

    document.documentElement.style.setProperty('--tile-size', `${newSize}px`);
}
window.addEventListener('resize', () => {
    calculateTileSize();
    // grid sadece boyut güncellesin
});

/* Çizgi render (değişmedi) */
function renderLines(type) {
    if(type === 0) return `<div class="line" style="width:100%; height:4px;"></div>`;
    return `<div class="line" style="width:55%; height:4px; right:0; top:50%; transform:translateY(-50%);"></div>
            <div class="line" style="width:4px; height:55%; left:50%; bottom:0; transform:translateX(-50%);"></div>`;
}

/* Client tarafı sadece VİZÜEL “connected” (otorite sunucu) */
function applyConnectedStyles() {
    let correctTilesCount = 0;

    tiles.forEach(t => {
        let isCorrect = false;

        if (t.type === 0) {
            if (t.rotation === 0 || t.rotation === 180) isCorrect = true;
        } else if (t.type === 1) {
            if (t.rotation === t.targetRotation) isCorrect = true;
        }

        if (isCorrect) {
            t.element.classList.add('connected');
            correctTilesCount++;
        } else {
            t.element.classList.remove('connected');
        }
    });

    return (correctTilesCount === tiles.length);
}

/* Grid’i state’e göre yeniden kur */
function renderGrid() {
    gridEl.innerHTML = '';
    gridEl.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
    calculateTileSize();

    const total = gridSize * gridSize;
    const newTiles = [];

    for (let i = 0; i < total; i++) {
        const st = tiles[i];
        const tileDiv = document.createElement('div');
        tileDiv.className = 'tile';
        tileDiv.setAttribute('role', 'button');
        tileDiv.setAttribute('aria-label', `Düğüm ${i+1}`);

        tileDiv.innerHTML = renderLines(st.type);
        tileDiv.style.transform = `rotate(${st.rotation}deg)`;

        tileDiv.addEventListener('click', () => rotateTile(i));

        gridEl.appendChild(tileDiv);
        newTiles.push({ ...st, element: tileDiv });
    }

    tiles = newTiles;
    applyConnectedStyles();
}

/* Sunucudan state çek */
function applyServerState(s) {
    level = Number(s.level || 1);
    bestLevel = Number(s.bestLevel || 1);
    gridSize = Number(s.gridSize || 3);

    levelNumEl.innerText = String(level);
    bestScoreEl.innerText = String(bestLevel);

    // tiles
    const incoming = Array.isArray(s.tiles) ? s.tiles : [];
    tiles = incoming.map(t => ({
        type: Number(t.type || 0),
        rotation: Number(t.rotation || 0) % 360,
        targetRotation: Number(t.targetRotation || 0) % 360,
        element: null
    }));

    isGameLocked = false;
    renderGrid();
}

/* Başlat */
async function startGame() {
    unlockAudio();
    try { sounds.start.currentTime = 0; sounds.start.play(); } catch {}
    startOverlayEl.style.display = 'none';
    gameStarted = true;

    // auth hazır değilse bekle
    if (!authReady || !auth.currentUser) return;

    try {
        const s = await apiFetch("/api/cyber/state", "GET");
        if (s.__ignored) return;
        applyServerState(s);
    } catch (e) {
        console.error(e);
        // Başlat overlay’i geri açmadan, kullanıcı UI bozulmasın:
        // sadece console’da kalsın.
    }
}

/* Rotate: server-otoriter */
async function rotateTile(index) {
    if (!gameStarted) return;
    if (isGameLocked) return;
    if (isProcessingMove) return;

    isProcessingMove = true;

    try {
        sounds.rotate.currentTime = 0;
        sounds.rotate.play();
    } catch {}

    try {
        const r = await apiFetch("/api/cyber/rotate", "POST", { index });
        if (r.__ignored) return;

        // server state’i uygula
        applyServerState({
            level: r.level,
            bestLevel: r.bestLevel,
            gridSize: r.gridSize,
            tiles: r.tiles
        });

        const solved = !!r.solved;

        if (solved) {
            isGameLocked = true;

            generateWinMessage(level);
            setTimeout(() => {
                try { sounds.success.currentTime = 0; sounds.success.play(); } catch {}
                winOverlayEl.style.display = 'flex';
            }, 250);
        }
    } catch (e) {
        console.error(e);
    } finally {
        isProcessingMove = false;
    }
}

/* Next: server sadece solved ise ilerletir */
async function nextLevel() {
    if (!gameStarted) return;

    try {
        const r = await apiFetch("/api/cyber/next", "POST", {});
        if (r.__ignored) return;

        winOverlayEl.style.display = 'none';
        applyServerState(r);
    } catch (e) {
        console.error(e);
    }
}

/* Button events (tasarım bozulmaz) */
startBtn.addEventListener('click', startGame);
nextLevelBtn.addEventListener('click', nextLevel);

/* Auth bootstrap */
onAuthStateChanged(auth, async (user) => {
    authReady = true;
    if (!user) {
        await signInAnonymously(auth);
        return;
    }
    // Kullanıcı start’a bastıysa ve auth sonra geldiyse
    if (gameStarted) {
        try {
            const s = await apiFetch("/api/cyber/state", "GET");
            if (!s.__ignored) applyServerState(s);
        } catch {}
    }
});
</script>

</body>
</html>
