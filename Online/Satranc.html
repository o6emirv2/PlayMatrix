<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<title>PlayMatrix VIP Satranç | Online Arena</title>
<meta name="description" content="PlayMatrix VIP Satranç ile rakiplerine karşı zekanı konuştur. Hilesiz, %100 online, ödüllü profesyonel satranç arenası!">
<meta name="keywords" content="satranç, online satranç, chess, playmatrix, vip satranç, çok oyunculu satranç, zeka oyunu, turnuva">
<meta name="author" content="PlayMatrix Global">
<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
<meta name="theme-color" content="#0b1118">

<meta property="og:locale" content="tr_TR">
<meta property="og:type" content="website">
<meta property="og:title" content="PlayMatrix VIP Satranç">
<meta property="og:description" content="Gerçek rakiplere karşı online satranç oyna. Şah-Mat yap, ödülleri topla!">
<meta property="og:site_name" content="PlayMatrix">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="PlayMatrix VIP Satranç">
<meta name="twitter:description" content="Tamamen hile korumalı, gerçek zamanlı online satranç arenası.">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<style>
:root{
    --bg:#0b1118;
    --bg2:#0a1525;
    --card:rgba(255,255,255,.06);
    --card2:rgba(255,255,255,.04);
    --stroke:rgba(255,255,255,.08);
    --gold:#d4af37;
    --gold2:#b9921d;
    --txt:#e5e7eb;
    --muted:#94a3b8;
    --good:#00ffa3;
    --warn:#f1c40f;
    --bad:#ff3b30;
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:radial-gradient(circle at 50% 20%, #12233d 0%, var(--bg2) 35%, var(--bg) 100%);
    color:var(--txt);
    overflow:hidden;
}

/* --- Intro --- */
#studioIntro{
    position:fixed; inset:0;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:radial-gradient(circle at 50% 40%, rgba(212,175,55,.18) 0%, rgba(10,21,37,.95) 40%, rgba(11,17,24,1) 100%);
    z-index:99999;
    transition:opacity .55s ease;
}
.intro-logo{
    display:flex; flex-direction:column; align-items:center; gap:12px;
    padding:24px 22px;
    border:1px solid rgba(212,175,55,.25);
    border-radius:18px;
    background:linear-gradient(145deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    box-shadow:0 24px 60px rgba(0,0,0,.45);
}
.intro-logo i{
    font-size:54px;
    background:linear-gradient(135deg, var(--gold), #fceabb);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    filter:drop-shadow(0 6px 14px rgba(212,175,55,.25));
}
.intro-logo h1{
    font-weight:900; letter-spacing:2px; text-align:center;
    line-height:1.02;
    color:var(--txt);
    text-transform:uppercase;
}
.intro-logo h1 span{ color:var(--gold); font-weight:900; }
.loader-track{
    width:min(420px, 84vw);
    height:8px;
    border-radius:999px;
    background:rgba(255,255,255,.08);
    margin-top:22px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.06);
}
.loader-fill{
    height:100%;
    width:0%;
    border-radius:999px;
    background:linear-gradient(90deg, rgba(212,175,55,.9), rgba(255,255,255,.25));
    transition:width .16s linear;
}
.btn-intro-start{
    margin-top:22px;
    width:min(420px,84vw);
    padding:15px 16px;
    border-radius:14px;
    border:1px solid rgba(212,175,55,.35);
    color:#0a1525;
    font-weight:900;
    letter-spacing:1px;
    background:linear-gradient(180deg, var(--gold) 0%, var(--gold2) 100%);
    box-shadow:0 16px 30px rgba(212,175,55,.15);
    cursor:pointer;
}
.btn-intro-start:active{ transform:translateY(1px) }

/* --- Modal --- */
.modal-overlay{
    position:fixed; inset:0;
    display:none;
    align-items:center; justify-content:center;
    background:rgba(0,0,0,.55);
    backdrop-filter:blur(10px);
    z-index:9999;
    padding:18px;
}
.modal-overlay.show{ display:flex; }
.modal-card{
    width:min(520px, 94vw);
    border-radius:18px;
    border:1px solid rgba(212,175,55,.35);
    background:linear-gradient(145deg, rgba(19,36,58,.92), rgba(14,26,43,.92));
    box-shadow:0 24px 70px rgba(0,0,0,.55);
    padding:26px 22px;
    transform:translateY(18px);
    opacity:0;
    transition:all .22s ease;
}
.modal-overlay.show .modal-card{ transform:translateY(0); opacity:1; }
.modal-icon{
    width:62px;height:62px;border-radius:16px;
    display:grid;place-items:center;
    margin:0 auto 12px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
    font-size:26px;
}
.modal-card h3{
    text-align:center;
    font-weight:900;
    letter-spacing:.8px;
    margin-bottom:8px;
}
.modal-card p{
    text-align:center;
    color:var(--muted);
    line-height:1.55;
    margin-bottom:14px;
}
.modal-close{
    width:100%;
    padding:14px 16px;
    border-radius:14px;
    border:1px solid rgba(212,175,55,.35);
    background:linear-gradient(180deg, var(--gold) 0%, var(--gold2) 100%);
    font-weight:900;
    cursor:pointer;
    color:#0a1525;
}
.modal-close:active{ transform:translateY(1px) }

/* --- Top Bar --- */
.top-bar{
    position:fixed;
    top:0; left:0; right:0;
    height:64px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    z-index:50;
    background:linear-gradient(180deg, rgba(0,0,0,.45) 0%, rgba(0,0,0,.05) 100%);
    border-bottom:1px solid rgba(255,255,255,.06);
    backdrop-filter: blur(10px);
}
.tb-left{display:flex;align-items:center;gap:10px}
.tb-logo{
    font-weight:900;
    letter-spacing:1.2px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(212,175,55,.28);
    background:rgba(255,255,255,.05);
}
.tb-logo span{ color:var(--gold); }
.tb-right{
    display:flex;
    align-items:center;
    gap:8px;
    min-width:0;
}
.balance-box{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.04);
    min-width:0;
    max-width: 56vw;
}
.balance-box b{
    font-weight:900;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:42vw;
}
.mc-icon{
    padding:6px 10px;
    border-radius:999px;
    background:linear-gradient(180deg, rgba(212,175,55,.9), rgba(185,146,29,.95));
    color:#0a1525;
    font-weight:900;
    font-size:12px;
    white-space:nowrap;
}
.action-icon-btn{
    width:44px;height:44px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.05);
    color:var(--txt);
    display:grid;place-items:center;
    cursor:pointer;
}
.action-icon-btn.red{
    border-color:rgba(255,59,48,.28);
    background:rgba(255,59,48,.10);
}
.action-icon-btn:active{ transform:translateY(1px) }

/* --- Layout --- */
#lobbyArea{
    position:absolute;
    top:64px; left:0; right:0; bottom:0;
    display:flex;
    flex-direction:column;
    padding:16px 14px;
    overflow:auto;
    gap:14px;
}
.lobby-header{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
}
.btn-create{
    flex:1;
    padding:14px 14px;
    border-radius:16px;
    border:1px solid rgba(212,175,55,.28);
    background:rgba(255,255,255,.04);
    color:var(--txt);
    font-weight:900;
    letter-spacing:.8px;
    cursor:pointer;
}
.btn-create i{ color:var(--gold); margin-right:8px; }
.room-list{
    display:flex; flex-direction:column; gap:10px;
}
.room-item{
    padding:14px 14px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.08);
    background:linear-gradient(145deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    display:flex; align-items:center; justify-content:space-between; gap:12px;
}
.room-left{
    display:flex; flex-direction:column; gap:6px;
    min-width:0;
}
.room-left b{
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.room-left span{
    color:var(--muted);
    font-size:12px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.room-btn{
    padding:12px 14px;
    border-radius:14px;
    border:1px solid rgba(212,175,55,.25);
    background:linear-gradient(180deg, rgba(212,175,55,.9), rgba(185,146,29,.95));
    color:#0a1525;
    font-weight:900;
    cursor:pointer;
    white-space:nowrap;
}
.room-btn.disabled{
    opacity:.55;
    cursor:not-allowed;
    filter:grayscale(.35);
}

/* --- Game Area --- */
#gameArea{
    position:absolute;
    top:64px; left:0; right:0; bottom:0;
    display:none;
    padding:14px 14px 18px;
    overflow:auto;
}
.game-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:12px;
}
.player-plate{
    flex:1;
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.04);
    min-width:0;
}
.player-plate.active{
    border-color:rgba(0,255,163,.22);
    box-shadow:0 0 0 2px rgba(0,255,163,.06) inset;
}
.avatar{
    width:36px;height:36px;border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.06);
    object-fit:cover;
}
.player-plate b{
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.status-box{
    padding:10px 12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.03);
    white-space:nowrap;
    font-weight:900;
    letter-spacing:.6px;
    font-size:12px;
}

/* Chessboard */
.board-wrap{
    display:flex;
    align-items:center;
    justify-content:center;
    margin-top:8px;
}
#chessboard{
    width:min(520px, 92vw);
    aspect-ratio:1/1;
    display:grid;
    grid-template-columns:repeat(8,1fr);
    border-radius:22px;
    overflow:hidden;
    border:1px solid rgba(212,175,55,.22);
    box-shadow:0 24px 70px rgba(0,0,0,.45);
    background:rgba(255,255,255,.02);
}
.square{
    display:grid;
    place-items:center;
    font-size:36px;
    user-select:none;
    -webkit-user-select:none;
}
.square.light{ background:rgba(255,255,255,.06); }
.square.dark{ background:rgba(0,0,0,.18); }
.square.sel{ outline:3px solid rgba(212,175,55,.7); outline-offset:-3px; }
.square.move{ box-shadow: inset 0 0 0 4px rgba(0,255,163,.35); }
.square.cap{ box-shadow: inset 0 0 0 4px rgba(255,59,48,.35); }

/* controls */
.game-controls{
    display:flex; gap:10px;
    width:min(520px, 92vw);
    margin:12px auto 0;
}
.ctrl-btn{
    flex:1;
    padding:14px 14px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.04);
    color:var(--txt);
    font-weight:900;
    cursor:pointer;
}
.ctrl-btn.red{
    border-color:rgba(255,59,48,.25);
    background:rgba(255,59,48,.10);
}

/* Sırası olmayan oyuncu tıklayamaz */
#chessboard.board-disabled{ pointer-events:none; filter: brightness(0.9); }
</style>
</head>
<body>

<div id="studioIntro">
    <div class="intro-logo">
        <i class="fa-solid fa-chess-knight"></i>
        <h1>VIP<br><span>SATRANÇ</span></h1>
    </div>
    <div class="loader-track" id="loaderTrack"><div class="loader-fill" id="loaderFill"></div></div>
    <button id="btnEnterGame" class="btn-intro-start">SİSTEME BAĞLAN</button>
</div>

<div id="matrixModal" class="modal-overlay">
    <div class="modal-card">
        <div id="matrixModalIcon" class="modal-icon"><i class="fa-solid fa-chess-king"></i></div>
        <h3 id="matrixModalTitle">Bilgi</h3>
        <p id="matrixModalDesc">Mesaj içeriği</p>
        <button class="modal-close" onclick="closeMatrixModal()">TAMAM</button>
    </div>
</div>

<header class="top-bar">
    <div class="tb-left">
        <div class="tb-logo">PM <span>CHESS</span></div>
    </div>
    <div class="tb-right">
        <div class="balance-box">
            <b id="ui-balance">Yükleniyor</b><div class="mc-icon">MC</div>
        </div>
        <button class="action-icon-btn" onclick="showHowToPlay()"><i class="fa-solid fa-circle-info"></i></button>
        <button class="action-icon-btn red" onclick="leaveGame()" aria-label="Lobiye Dön"><i class="fa-solid fa-right-from-bracket"></i></button>
    </div>
</header>

<div id="lobbyArea">
    <div class="lobby-header">
        <button class="btn-create" onclick="createRoom()"><i class="fa-solid fa-plus"></i> YENİ ODA KUR</button>
        <button class="btn-create" onclick="quickJoin()"><i class="fa-solid fa-bolt"></i> HIZLI KATIL</button>
    </div>

    <div class="room-list" id="roomList"></div>
</div>

<div id="gameArea">
    <div class="game-header">
        <div id="myPlate" class="player-plate">
            <img id="myAvatar" class="avatar" src="https://i.imgur.com/2yaf2wb.png" alt="Ben">
            <b id="myName">Sen</b>
        </div>
        <div class="status-box" id="gameStatusTxt">Hazır</div>
        <div id="oppPlate" class="player-plate">
            <img id="oppAvatar" class="avatar" src="https://i.imgur.com/2yaf2wb.png" alt="Rakip">
            <b id="oppName">Rakip</b>
        </div>
    </div>

    <div class="board-wrap">
        <div id="chessboard"></div>
    </div>

    <div class="game-controls">
        <button class="ctrl-btn" onclick="resignGame()"><i class="fa-solid fa-flag"></i> TESLİM OL</button>
        <button class="ctrl-btn red" onclick="leaveGame()"><i class="fa-solid fa-door-open"></i> LOBİYE DÖN</button>
    </div>
</div>

<script>
/* =========================
   Firebase Init
========================= */
const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

/* =========================
   API URL
========================= */
const API_URL = "";

/* =========================
   Helpers
========================= */
async function getIdToken(user){
    return await user.getIdToken();
}

async function fetchAPI(endpoint, method = 'GET', body = null) {
    if (!auth.currentUser) return null;
    const token = await getIdToken(auth.currentUser);
    const options = { method, headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } };
    if (body) options.body = JSON.stringify(body);
    const res = await fetch(`${API_URL}${endpoint}`, options);
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Sunucu hatası");
    return data;
}

// chess.js kütüphanesi bazı ortamlarda (CSP, network) yüklenmeyebilir.
// Bu fonksiyon Chess motorunu garantiler (fallback script-load).
async function ensureChessLib() {
    if (window.Chess) return;
    await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = "https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js";
        s.async = true;
        s.onload = resolve;
        s.onerror = () => reject(new Error("Chess motoru yüklenemedi (chess.js). İnternet/CSP kontrol edin."));
        document.head.appendChild(s);
    });
    if (!window.Chess) throw new Error("Chess motoru başlatılamadı.");
}

/* =========================
   Intro Loader
========================= */
let loadProg = 0;
const loadTimer = setInterval(() => {
    loadProg += 7;
    if (loadProg >= 100) { loadProg = 100; clearInterval(loadTimer); }
    document.getElementById('loaderFill').style.width = loadProg + '%';
}, 100);

document.getElementById('btnEnterGame').addEventListener('click', async () => {
    try { await ensureChessLib(); if (!gameLogic) gameLogic = new window.Chess(); } catch(e) { showMatrixModal('Hata', e.message, 'error'); return; }
    initAndUnlockAudio(); loadSoundFiles();     
    document.getElementById('studioIntro').style.opacity = '0';
    setTimeout(() => { document.getElementById('studioIntro').style.display = 'none'; initApp(); }, 600);
});

/* =========================
   Game Variables
========================= */
let userUid = null;
let currentRoomId = null;
let gameLogic = null;
let roomSeq = 0;
let myColor = 'w';
let selectedSq = null;
let validMovesForSelected = [];
let pollingInterval = null;
let pingInterval = null;
let lastFen = "";
let lastStatus = ""; 
let isProcessingMove = false;

/* =========================
   Modal
========================= */
window.showMatrixModal = (title, message, type = 'info', backToLobby = false) => {
    const icon = document.getElementById("matrixModalIcon");
    document.getElementById("matrixModalTitle").innerText = title;
    document.getElementById("matrixModalDesc").innerHTML = message;
    
    if(type === 'error') { icon.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i>'; icon.style.color = '#ff3b30'; } 
    else if(type === 'success') { icon.innerHTML = '<i class="fa-solid fa-trophy"></i>'; icon.style.color = '#00ffa3'; } 
    else { icon.innerHTML = '<i class="fa-solid fa-chess-knight"></i>'; icon.style.color = '#d4af37'; }
    
    const modal = document.getElementById('matrixModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);

    if (backToLobby) {
        document.querySelector('.modal-close').onclick = () => {
            closeMatrixModal();
            resetToLobby(); // Sayfayı yenilemeden lobiye dön
        };
    } else {
        document.querySelector('.modal-close').onclick = closeMatrixModal;
    }
};

window.closeMatrixModal = () => {
    const modal = document.getElementById('matrixModal');
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 300);
};

window.showHowToPlay = () => {
    showMatrixModal("Nasıl Oynanır?", `
        <div style="text-align:left; line-height:1.6; color:#cbd5e1;">
        • Hamle sırası sizde değilken taşlara dokunamazsınız.<br>
        • Hamleler sunucuda doğrulanır (hile/çift hamle engeli).<br>
        • Rakip çıkarsa otomatik lobiye dönersiniz.<br>
        </div>
    `, "info");
};

/* =========================
   Auth
========================= */
auth.onAuthStateChanged((user) => {
    if (!user) {
        // Projende login nerede ise oraya yönlendir
        window.location.href = "/";
        return;
    }
});

/* =========================
   App Init
========================= */
function initApp() {
    // Güvenli: Chess motoru hazır değilse tekrar dene
    if (!gameLogic && window.Chess) gameLogic = new window.Chess();
    userUid = auth.currentUser.uid;
    fetchBalance();
    startLobbyPolling();
}

async function fetchBalance() { 
    try { const res = await fetchAPI('/api/me'); if(res) document.getElementById("ui-balance").innerText = Math.floor(res.balance).toLocaleString('tr-TR'); } catch(e){} 
}

/* =========================
   Lobby
========================= */
function startLobbyPolling() {
    fetchLobby();
    pollingInterval = setInterval(fetchLobby, 3000);
}

async function fetchLobby() {
    if (currentRoomId) return; 
    try {
        const res = await fetchAPI('/api/chess/lobby?t=' + Date.now());
        const list = document.getElementById("roomList");
        list.innerHTML = "";
        
        if (!res || !res.rooms || res.rooms.length === 0) {
            list.innerHTML = `<div style="color:#94a3b8; text-align:center; margin-top:20px; font-size:13px;">Aktif oda bulunamadı. Yeni oda kurun!</div>`;
            return;
        }
        
        res.rooms.forEach(r => {
            const isMe = r.hostUid === userUid;
            
            const p1 = r.host;
            const p2 = r.guest === 'Bilinmeyen' ? '?' : r.guest;
            
            let statusText = '';
            let btnHtml = '';

            if (r.status === 'waiting') {
                statusText = 'Bekleniyor';
                btnHtml = isMe
                    ? `<button class="room-btn disabled">SENİN ODA</button>`
                    : `<button class="room-btn" onclick="joinRoom('${r.id}')">KATIL</button>`;
            } else {
                statusText = 'Aktif';
                btnHtml = `<button class="room-btn disabled">DOLU</button>`;
            }

            list.innerHTML += `
                <div class="room-item">
                    <div class="room-left">
                        <b>${p1} vs ${p2}</b>
                        <span>${statusText}</span>
                    </div>
                    ${btnHtml}
                </div>
            `;
        });

    } catch(e) {
        // sessiz
    }
}

window.createRoom = async () => {
    try {
        const res = await fetchAPI('/api/chess/create', 'POST', {});
        enterGame(res.room);
    } catch(e) { showMatrixModal("Hata", e.message, "error"); }
};

window.quickJoin = async () => {
    try {
        const res = await fetchAPI('/api/chess/join', 'POST', {});
        enterGame(res.room);
    } catch(e) { showMatrixModal("Hata", e.message, "error"); }
};

window.joinRoom = async (roomId) => {
    try {
        const res = await fetchAPI('/api/chess/join', 'POST', { roomId });
        enterGame(res.room);
    } catch(e) { showMatrixModal("Hata", e.message, "error"); }
};

/* =========================
   Game Enter / Polling
========================= */
function enterGame(room) {
    clearInterval(pollingInterval);
    currentRoomId = room.id;

    document.getElementById("lobbyArea").style.display = "none";
    document.getElementById("gameArea").style.display = "block";

    myColor = (room.host.uid === userUid) ? 'w' : 'b';
    lastFen = "";
    lastStatus = "";
    selectedSq = null;
    validMovesForSelected = [];
    isProcessingMove = false;

    syncBoardUI(room);

    pollGameState();
    pollingInterval = setInterval(pollGameState, 1500);

    pingServer();
    pingInterval = setInterval(pingServer, 5000);
}

async function pollGameState() {
    try {
        if (!currentRoomId || isProcessingMove) return;
        const res = await fetchAPI('/api/chess/state/' + currentRoomId + '?t=' + Date.now());
        if(!res || !res.room) return;

        if (res.room.status === 'abandoned') {
            showMatrixModal("Oyun Sonlandı", "Rakip oyundan ayrıldı. Lobiye yönlendiriliyorsunuz.", "error", true);
            return;
        }

        syncBoardUI(res.room);
    } catch(e) {
        // sessiz
    }
}

async function pingServer() {
    try {
        if (!currentRoomId) return;
        await fetchAPI('/api/chess/ping', 'POST', { roomId: currentRoomId });
    } catch(e) {}
}

function resetToLobby() {
    clearInterval(pollingInterval);
    clearInterval(pingInterval);
    currentRoomId = null;
    document.getElementById("gameArea").style.display = "none";
    document.getElementById("lobbyArea").style.display = "flex";
    fetchBalance();
    startLobbyPolling();
}

function setBoardInteractable(can) {
    const b = document.getElementById('chessboard');
    if (!b) return;
    if (can) b.classList.remove('board-disabled');
    else b.classList.add('board-disabled');
}

/* =========================
   Sound Engine
========================= */
let audioCtx = null;
let audioUnlocked = false; 
const sounds = {};
const sfxUrls = {
    move: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3',
    capture: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/capture.mp3',
    check: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-check.mp3',
    win: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-win.mp3',
    end: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-end.mp3',
};

function initAndUnlockAudio(){
    if(audioUnlocked) return;
    try{
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        g.gain.value = 0.0001;
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.01);
        audioUnlocked = true;
    }catch(e){}
}

async function loadSoundFiles(){
    if(!audioCtx) return;
    for(const k of Object.keys(sfxUrls)){
        try{
            const r = await fetch(sfxUrls[k]);
            const arr = await r.arrayBuffer();
            sounds[k] = await audioCtx.decodeAudioData(arr);
        }catch(e){}
    }
}

function playSfx(name){
    try{
        if(!audioCtx || !audioUnlocked || !sounds[name]) return;
        const src = audioCtx.createBufferSource();
        src.buffer = sounds[name];
        src.connect(audioCtx.destination);
        src.start(0);
    }catch(e){}
}

/* =========================
   UI Sync & Board
========================= */
function syncBoardUI(r) {
    const isHost = r.host.uid === userUid;
    const me = isHost ? r.host : (r.guest || {username:'Sen'});
    const opp = isHost ? (r.guest || {username:'Bekleniyor...'}) : r.host;

    document.getElementById("myName").innerText = me.username;
    if(me.avatar) document.getElementById("myAvatar").src = me.avatar;
    document.getElementById("myPlate").className = (r.turn === myColor) ? "player-plate active" : "player-plate";

    document.getElementById("oppName").innerText = opp.username;
    if(opp.avatar) document.getElementById("oppAvatar").src = opp.avatar;
    document.getElementById("oppPlate").className = (r.turn !== myColor && r.status === 'playing') ? "player-plate active" : "player-plate";

    const statusTxt = document.getElementById("gameStatusTxt");
    if (r.status === 'waiting') {
        statusTxt.innerText = "RAKİP BEKLENİYOR...";
        statusTxt.style.color = "#94a3b8";
    } else if (r.status === 'playing') {
        const myTurn = r.turn === myColor;
        statusTxt.innerText = myTurn ? "SIRA SENDE" : "SIRA RAKİPTE";
        statusTxt.style.color = myTurn ? "#00ffa3" : "#f1c40f";
    } else if (r.status === 'finished') {
        statusTxt.innerText = "OYUN BİTTİ";
        statusTxt.style.color = "#ff3b30";
        if(r.winner === 'draw') {
            showMatrixModal("BERABERE", "Oyun berabere bitti.", "info", true);
        } else {
            const iWon = (r.winner === 'white' && myColor === 'w') || (r.winner === 'black' && myColor === 'b');
            if (iWon) { playSfx('win'); showMatrixModal("KAZANDIN!", "Tebrikler! 5.000 MC Kazandın.", "success", true); }
            else { playSfx('end'); showMatrixModal("KAYBETTİN", "Rakip kazandı veya sen teslim oldun.", "error", true); }
        }
        return;
    }

    // Sunucu senkron (race-condition / çift hamle) koruması
    if (typeof r.seq === 'number') roomSeq = r.seq;

    const canInteract = (r.status === 'playing' && r.turn === myColor && !!r.guest);
    setBoardInteractable(canInteract);

    if (!canInteract) { selectedSq = null; validMovesForSelected = []; }

    if (r.fen !== lastFen || r.status !== lastStatus) {
        gameLogic.load(r.fen);
        drawBoard();
        
        if (lastFen !== "" && r.fen !== lastFen) {
            if (gameLogic.in_check()) playSfx('check');
            else if (r.fen.length < lastFen.length) playSfx('capture');
            else playSfx('move'); 
        }
        lastFen = r.fen;
        lastStatus = r.status;
    }
}

function drawBoard() {
    if (!gameLogic) return;
    const boardEl = document.getElementById("chessboard");
    boardEl.innerHTML = "";
    
    let board = gameLogic.board(); 
    if (myColor === 'b') board = board.slice().reverse().map(row => row.slice().reverse());

    for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
            const sq = (myColor === 'w')
                ? String.fromCharCode(97 + c) + (8 - r)
                : String.fromCharCode(97 + (7 - c)) + (r + 1);

            const isLight = (r + c) % 2 === 0;
            const piece = board[r][c];

            const div = document.createElement("div");
            div.className = "square " + (isLight ? "light" : "dark");
            div.dataset.sq = sq;

            if (selectedSq === sq) div.classList.add("sel");
            if (validMovesForSelected.some(m => m.to === sq)) div.classList.add(piece ? "cap" : "move");

            div.innerHTML = piece ? pieceToUnicode(piece) : "";
            div.addEventListener("click", () => handleSquareClick(sq));
            boardEl.appendChild(div);
        }
    }
}

function pieceToUnicode(p){
    const map = {
        pw:'♙', pb:'♟',
        rw:'♖', rb:'♜',
        nw:'♘', nb:'♞',
        bw:'♗', bb:'♝',
        qw:'♕', qb:'♛',
        kw:'♔', kb:'♚'
    };
    return map[p.type + p.color] || '';
}

/* =========================
   Moves
========================= */
async function handleSquareClick(sq) {
    // SIRA BİZDE DEĞİLSE TIKLAMALARI KESİNLİKLE ENGELLE
    if (isProcessingMove || gameLogic.turn() !== myColor) return;

    const moveObj = validMovesForSelected.find(m => m.to === sq);
    if (selectedSq && moveObj) {
        
        isProcessingMove = true;
        document.getElementById("gameStatusTxt").innerText = "HAMLE İLETİLİYOR...";
        
        const m = gameLogic.move({ from: moveObj.from, to: moveObj.to, promotion: 'q' });
        selectedSq = null;
        validMovesForSelected = [];
        drawBoard(); 
        
        if (gameLogic.in_check()) playSfx('check');
        else if (m && m.captured) playSfx('capture');
        else playSfx('move');

        try {
            // HATA KÖKTEN ÇÖZÜMÜ: SADECE FROM VE TO + SEQ GÖNDERİLİR
            const res = await fetchAPI('/api/chess/move', 'POST', { roomId: currentRoomId, seq: roomSeq, from: moveObj.from, to: moveObj.to, promotion: 'q' });
            lastFen = res.room.fen; 
            if (typeof res.room.seq === 'number') roomSeq = res.room.seq;
        } catch(e) {
            showMatrixModal("Hata", e.message, "error");
            gameLogic.load(lastFen); 
            drawBoard();
        }
        
        isProcessingMove = false;
        return;
    }

    // SIRA BİZDEYSE VE KENDİ TAŞIMIZSA SEÇİM YAP
    const pieceObj = gameLogic.get(sq);
    if (pieceObj && pieceObj.color === myColor) {
        selectedSq = sq;
        validMovesForSelected = gameLogic.moves({ square: sq, verbose: true });
        drawBoard();
    } else {
        selectedSq = null;
        validMovesForSelected = [];
        drawBoard();
    }
}

window.leaveGame = async () => {
    // Oyundan çık (sayfayı yenilemeden lobiye dön)
    if (!currentRoomId) { resetToLobby(); return; }
    try { await fetchAPI('/api/chess/leave', 'POST', { roomId: currentRoomId }); } catch(e) {}
    resetToLobby();
};

// Sayfa yenilenirse / arkaplana giderse rakibi bekletme: keepalive ile odadan ayrıl
async function tryLeaveRoomKeepalive() {
    try {
        if (!currentRoomId || !auth.currentUser) return;
        const token = await getIdToken(auth.currentUser);
        await fetch(`${API_URL}/api/chess/leave`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ roomId: currentRoomId }),
            keepalive: true
        });
    } catch(e) {}
}
window.addEventListener('pagehide', tryLeaveRoomKeepalive);
window.addEventListener('beforeunload', tryLeaveRoomKeepalive);

window.resignGame = async () => {
    if(!confirm("Teslim olmak istediğinize emin misiniz?")) return;
    try { await fetchAPI('/api/chess/resign', 'POST', { roomId: currentRoomId }); } catch(e) {}
};
</script>

</body>
</html>
