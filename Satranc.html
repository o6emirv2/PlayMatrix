<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<title>PlayMatrix | Ultra Profesyonel Online SatranÃ§ ArenasÄ±</title>
<meta name="description" content="PlayMatrix SatranÃ§ ArenasÄ±'nda arkadaÅŸlarÄ±nla veya rastgele rakiplerle hilesiz, ÅŸifreli veya aÃ§Ä±k odalarda online satranÃ§ oyna. Kazan, anÄ±nda 2.500 MC Coin Ã¶dÃ¼lÃ¼nÃ¼ kap!">
<meta name="keywords" content="online satranÃ§, playmatrix satranÃ§, ÅŸifreli satranÃ§ odasÄ±, Ã¼cretsiz satranÃ§ oyna, satranÃ§ mc coin, multiplayer satranÃ§, zeka oyunlarÄ±">
<meta name="author" content="PlayMatrix Global">
<meta name="robots" content="index, follow">
<meta name="theme-color" content="#04060b">

<meta property="og:title" content="PlayMatrix | Ultra Profesyonel Online SatranÃ§">
<meta property="og:description" content="GerÃ§ek zamanlÄ±, hilesiz satranÃ§ deneyimi. Odana ÅŸifre koy, rakibini davet et, ÅŸah mat yap ve 2.500 MC kazan!">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="PlayMatrix | SatranÃ§ ArenasÄ±">
<meta name="twitter:description" content="PlayMatrix'te hilesiz online satranÃ§ oyna ve kazan.">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* === PLAYMATRIX ANA DEÄžÄ°ÅžKENLERÄ° === */
:root {
    --primary: #00f0ff;
    --primary-glow: rgba(0, 240, 255, 0.5);
    --secondary: #0055ff;
    --accent: #ff007a;
    --bg-main: #04060b;
    --bg-surface: #0a0e17;
    --glass-bg: rgba(10, 14, 23, 0.85);
    --glass-border: rgba(255, 255, 255, 0.08);
    --text-primary: #ffffff;
    --text-secondary: #94a3b8;
    --success: #00ffa3;
    --danger: #ff4d4d;
    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    --input-bg: rgba(0, 0, 0, 0.4);
    
    /* Ã–ZEL SATRANÃ‡ RENKLERÄ° (PLAYMATRIX STÄ°LÄ°) */
    --board-light: #e0e7ee;
    --board-dark: #3a5a78;
    --board-border: #1a2938;
    --highlight: rgba(0, 240, 255, 0.5);
    --valid-move: rgba(0, 255, 163, 0.6);
}

html, body {
    width: 100vw; height: 100vh; margin: 0; padding: 0;
    overflow: hidden; touch-action: none; overscroll-behavior: none;
    -webkit-user-select: none; user-select: none;
    background: var(--bg-main); color: var(--text-primary);
    font-family: 'Inter', sans-serif;
}

/* === ÃœST BAR === */
.top-bar {
    position: fixed; top: 0; width: 100%; height: 70px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; background: var(--glass-bg);
    backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border-bottom: 1px solid var(--glass-border); z-index: 2000;
}
.brand-3d {
    font-family: 'Montserrat', sans-serif; font-size: 20px; font-weight: 900; 
    color: var(--text-primary); text-transform: uppercase; letter-spacing: 2px;
    text-shadow: 0 1px 0 var(--secondary), 0 2px 0 var(--secondary), 
                 0 4px 10px var(--primary-glow), 0 0 20px var(--primary-glow);
}
.top-actions { display: flex; gap: 10px; }
.info-btn {
    background: var(--bg-surface); color: var(--primary); border: 1px solid var(--primary); 
    padding: 8px 15px; border-radius: 10px; font-weight: 800; cursor: pointer; transition: 0.3s;
}
.info-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary-glow); }
.exit-btn {
    background: var(--danger); color: white; border: none; padding: 8px 15px;
    border-radius: 10px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 77, 77, 0.4);
}

/* === FERAH LOBÄ° TASARIMI === */
#lobbyArea {
    position: absolute; top: 70px; left: 0; width: 100%; height: calc(100vh - 70px);
    overflow-y: auto; padding: 20px; box-sizing: border-box;
    display: flex; flex-direction: column; align-items: center;
    background: radial-gradient(circle at top, rgba(0, 85, 255, 0.15) 0%, var(--bg-main) 80%);
}
.lobby-header { text-align: center; margin-bottom: 25px; margin-top: 10px; }
.lobby-header h1 { font-family: 'Montserrat', sans-serif; font-size: 32px; color: var(--primary); text-shadow: 0 0 15px var(--primary-glow); margin-bottom: 5px; }
.lobby-header p { color: var(--text-secondary); font-size: 14px; font-weight: 600; }
.main-create-btn {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: #fff; border: none; padding: 18px 40px; border-radius: 20px;
    font-size: 18px; font-weight: 900; letter-spacing: 2px; cursor: pointer;
    box-shadow: 0 10px 30px var(--primary-glow); transition: 0.3s;
    width: 100%; max-width: 450px; text-transform: uppercase;
}
.main-create-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px var(--primary-glow); }

.rooms-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px; width: 100%; max-width: 1000px; margin-top: 30px; padding-bottom: 50px;
}
.room-card {
    background: var(--glass-bg); border: 1px solid var(--glass-border);
    border-radius: 16px; padding: 20px; display: flex; justify-content: space-between;
    align-items: center; box-shadow: var(--card-shadow); transition: 0.3s;
    backdrop-filter: blur(10px);
}
.room-card:hover { border-color: var(--primary); transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,240,255,0.2); }
.room-info h3 { font-size: 16px; margin-bottom: 5px; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
.room-info p { font-size: 12px; color: var(--text-secondary); font-weight: 600; }
.join-btn {
    background: transparent; border: 2px solid var(--primary); color: var(--primary);
    padding: 8px 20px; border-radius: 10px; font-weight: 800; cursor: pointer; transition: 0.3s;
}
.join-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary-glow); }
.join-btn.private { border-color: #ffaa00; color: #ffaa00; }
.join-btn.private:hover { background: #ffaa00; color: #000; box-shadow: 0 0 15px rgba(255, 170, 0, 0.5); }

/* === OYUN Ä°Ã‡Ä° EKRAN === */
#gameArea {
    position: absolute; top: 70px; left: 0; width: 100vw; height: calc(100vh - 70px);
    display: none; flex-direction: column; align-items: center; justify-content: center;
    background: radial-gradient(circle at center, var(--bg-surface) 0%, var(--bg-main) 100%);
}
.player-info {
    width: 100%; max-width: 420px; display: flex; justify-content: space-between;
    align-items: center; padding: 12px 20px; background: var(--glass-bg);
    border-radius: 12px; margin: 10px 0; border: 1px solid var(--glass-border);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.3s;
}
.player-info.active-turn { border-color: var(--success); box-shadow: 0 0 20px rgba(0, 255, 163, 0.2); transform: scale(1.02); }
.player-name { font-weight: 800; font-size: 15px; display: flex; align-items: center; gap: 10px; }

/* === Ã–ZEL SATRANÃ‡ TAHTASI (PLAYMATRIX Ä°MZASI) === */
.board-wrapper {
    width: 100vw; max-width: 420px; aspect-ratio: 1; padding: 12px;
    background: linear-gradient(145deg, var(--board-border), #0f1722);
    border-radius: 12px; box-shadow: 0 25px 50px rgba(0,0,0,0.8), inset 0 0 15px rgba(0,240,255,0.2);
    border: 2px solid rgba(0, 240, 255, 0.3); position: relative;
}
/* SatranÃ§ TasarÄ±mÄ± Ä°mzasÄ±: Kenarlardaki Harfler/SayÄ±lar iÃ§in Ã–zel Alan */
.board-wrapper::before {
    content: "PLAYMATRIX PREMIUM CHESS";
    position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
    font-family: 'Montserrat', sans-serif; font-size: 10px; font-weight: 900;
    color: var(--primary); letter-spacing: 4px; opacity: 0.7;
}

#chessBoard {
    display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr);
    width: 100%; height: 100%; border: 2px solid #000; border-radius: 4px; overflow: hidden;
}
.square { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; }
.square.light { background-color: var(--board-light); }
.square.dark { background-color: var(--board-dark); }
.square.highlight { background-color: var(--highlight) !important; box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5); }
.square.last-move { background-color: rgba(255, 215, 0, 0.4) !important; }

/* TaÅŸ SeÃ§imi / GeÃ§erli Hamle TasarÄ±mÄ± */
.valid-move-dot { width: 25%; height: 25%; background-color: var(--valid-move); border-radius: 50%; position: absolute; pointer-events: none; box-shadow: 0 0 10px var(--valid-move); }
.valid-capture-ring { width: 85%; height: 85%; border: 5px solid var(--danger); border-radius: 50%; position: absolute; pointer-events: none; box-shadow: 0 0 10px var(--danger), inset 0 0 10px var(--danger); }

/* TAÅžLAR */
.piece { width: 95%; height: 95%; background-size: cover; background-position: center; cursor: pointer; z-index: 10; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.piece:active { transform: scale(1.15) translateY(-5px); filter: drop-shadow(0 15px 10px rgba(0,0,0,0.6)); }

/* KOORDÄ°NATLAR */
.coord { position: absolute; font-size: 11px; font-weight: 900; opacity: 0.8; pointer-events: none; }
.coord-rank { top: 3px; left: 3px; }
.coord-file { bottom: 3px; right: 3px; }
.square.dark .coord { color: var(--board-light); }
.square.light .coord { color: var(--board-dark); }

/* === PLAYMATRIX STANDART MODALLAR (TÃœM POPUPLAR Ä°Ã‡Ä°N) === */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    display: none; align-items: center; justify-content: center; z-index: 5000; opacity: 0;
    transition: opacity 0.3s ease;
}
.modal-overlay.show { opacity: 1; display: flex; }
.modal-card { 
    width: 90%; max-width: 420px; padding: 35px 30px; border-radius: 24px; 
    background: var(--bg-surface); border: 1px solid var(--glass-border); text-align: center; 
    box-shadow: 0 25px 50px rgba(0,0,0,0.6); transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
}
.modal-overlay.show .modal-card { transform: scale(1); }
.modal-close-btn { position: absolute; top: 20px; right: 20px; font-size: 20px; color: var(--text-secondary); cursor: pointer; transition: 0.3s; }
.modal-close-btn:hover { color: var(--danger); transform: rotate(90deg); }

.modal-card h2 { margin-bottom: 20px; font-size: 22px; font-weight: 900; color: var(--text-primary); letter-spacing: 0.5px; }
.modal-card input { 
    width: 100%; padding: 16px; margin-bottom: 15px; border-radius: 14px; 
    background: var(--input-bg); border: 1px solid var(--glass-border); 
    color: var(--text-primary); outline: none; text-align: center; font-size: 15px; transition: 0.3s; font-weight: 700;
}
.modal-card input:focus { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); }

.modal-btn { 
    width: 100%; padding: 16px; border-radius: 14px; border: none; 
    background: linear-gradient(135deg, var(--primary), var(--secondary)); 
    color: #fff; font-weight: 900; font-size: 15px; cursor: pointer; 
    box-shadow: 0 8px 20px var(--primary-glow); text-transform: uppercase; margin-top: 10px; transition: 0.3s;
}
.modal-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 25px var(--primary-glow); }
.modal-btn.secondary { background: var(--bg-main); border: 1px solid var(--primary); color: var(--primary); box-shadow: none; }
.modal-btn.secondary:hover { background: var(--primary); color: #000; box-shadow: 0 8px 20px var(--primary-glow); }

/* NASIL OYNANIR LÄ°STESÄ° */
.how-to-list { text-align: left; font-size: 13px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; }
.how-to-list li { margin-bottom: 10px; font-weight: 500; }
.how-to-list li span { color: var(--primary); font-weight: 800; }

/* TERFÄ° SEÃ‡ENEKLERÄ° */
.promo-options { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
.promo-piece {
    width: 60px; height: 60px; background-color: var(--board-light); border-radius: 12px;
    border: 2px solid var(--primary); display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}
.promo-piece:hover { transform: scale(1.1); box-shadow: 0 0 15px var(--primary-glow); }
.promo-piece img { width: 80%; height: 80%; }

/* YÃœKLENÄ°YOR */
#loading {
    position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-main);
    display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;
}
.loader-spinner { width: 50px; height: 50px; border: 5px solid var(--glass-border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<audio id="sfx-move" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3" preload="auto"></audio>
<audio id="sfx-capture" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/capture.mp3" preload="auto"></audio>
<audio id="sfx-check" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-check.mp3" preload="auto"></audio>
<audio id="sfx-start" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-start.mp3" preload="auto"></audio>
<audio id="sfx-end" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-end.mp3" preload="auto"></audio>

<div id="loading">
    <div class="loader-spinner"></div>
    <h3 style="margin-top: 20px; color: var(--primary);">PlayMatrix Arena HazÄ±rlanÄ±yor...</h3>
</div>

<header class="top-bar">
    <div class="brand-3d">PlayMatrix</div>
    <div class="top-actions">
        <button class="info-btn" onclick="openModal('howToModal')"><i class="fa-solid fa-circle-question"></i></button>
        <button class="exit-btn" id="exitGameBtn" style="display:none;" onclick="leaveRoom()"><i class="fa-solid fa-door-open"></i> Ã‡IKIÅž</button>
    </div>
</header>

<div id="lobbyArea">
    <div class="lobby-header">
        <h1>SATRANÃ‡ ARENASI</h1>
        <p>Hilesiz, Kusursuz, KazanÃ§lÄ± SatranÃ§ Deneyimi.</p>
    </div>
    
    <button class="main-create-btn" onclick="openModal('createRoomMenuModal')">
        <i class="fa-solid fa-chess-king"></i> ODA KUR VE OYNA
    </button>
    
    <div class="rooms-grid" id="roomsList">
        </div>
</div>

<div id="gameArea">
    <div class="player-info" id="opponentInfo">
        <div class="player-name"><i class="fa-solid fa-circle-user"></i> <span id="opponentName">Rakip Bekleniyor...</span></div>
    </div>
    
    <div class="board-wrapper">
        <div id="chessBoard"></div>
    </div>
    
    <div class="player-info" id="myInfo">
        <div class="player-name"><i class="fa-solid fa-circle-user" style="color:var(--primary);"></i> <span id="myName">Sen</span></div>
    </div>
</div>

<div class="modal-overlay" id="alertModal">
    <div class="modal-card">
        <div id="alertIcon" style="font-size: 55px; margin-bottom: 15px;"></div>
        <h2 id="alertTitle">Sistem MesajÄ±</h2>
        <p id="alertBody" style="color: var(--text-secondary); margin-bottom: 25px; font-size: 15px; font-weight: 600;"></p>
        <button class="modal-btn" onclick="closeModal('alertModal')">TAMAM</button>
    </div>
</div>

<div class="modal-overlay" id="howToModal">
    <div class="modal-card">
        <i class="fa-solid fa-xmark modal-close-btn" onclick="closeModal('howToModal')"></i>
        <h2><i class="fa-solid fa-chess" style="color:var(--primary);"></i> NASIL OYNANIR?</h2>
        <ul class="how-to-list">
            <li><span>1.</span> Lobby Ã¼zerinden "ODA KUR" butonuna basarak <b>AÃ§Ä±k</b> veya <b>Åžifreli</b> bir oda oluÅŸturabilirsin.</li>
            <li><span>2.</span> OdayÄ± kurduktan sonra rakibin gelmesini bekle. <b>Rakip gelmeden taÅŸlara dokunamazsÄ±n.</b></li>
            <li><span>3.</span> Oyun dÃ¼nya standartlarÄ±nda (En Passant, Rok vb.) iÅŸler. YapacaÄŸÄ±n hamleler hile korumasÄ±yla sunucuda denetlenir.</li>
            <li><span>4.</span> Rakibini ÅžAH MAT yaparsan sistem anÄ±nda hesabÄ±na <b>2.500 MC Coin</b> yÃ¼kler! Kaybedersen MC eksilmez.</li>
            <li><span>5.</span> Oyun bitmeden odadan Ã§Ä±karsan hÃ¼kmen maÄŸlup sayÄ±lÄ±rsÄ±n.</li>
        </ul>
        <button class="modal-btn" onclick="closeModal('howToModal')">ANLADIM</button>
    </div>
</div>

<div class="modal-overlay" id="createRoomMenuModal">
    <div class="modal-card">
        <i class="fa-solid fa-xmark modal-close-btn" onclick="closeModal('createRoomMenuModal')"></i>
        <h2>Oda TÃ¼rÃ¼nÃ¼ SeÃ§</h2>
        <p style="color:var(--text-secondary); font-size:13px; margin-bottom:20px; font-weight:600;">OluÅŸturmak istediÄŸin oda tipini belirle.</p>
        
        <button class="modal-btn" onclick="setupOpenRoom()"><i class="fa-solid fa-earth-americas"></i> AÃ‡IK ODA KUR</button>
        <button class="modal-btn secondary" onclick="openPrivateRoomForm()"><i class="fa-solid fa-lock"></i> ÅžÄ°FRELÄ° ODA KUR</button>
    </div>
</div>

<div class="modal-overlay" id="privateRoomFormModal">
    <div class="modal-card">
        <i class="fa-solid fa-xmark modal-close-btn" onclick="closeModal('privateRoomFormModal')"></i>
        <h2>Åžifreli Oda Kur</h2>
        <input type="text" id="prRoomName" placeholder="Oda Ä°smi (Min 3 Karakter)" maxlength="20">
        <input type="password" id="prRoomPass" placeholder="Oda Åžifresi (Min 5 Rakam)" maxlength="10">
        <button class="modal-btn" onclick="setupPrivateRoom()">ODAYI OLUÅžTUR</button>
    </div>
</div>

<div class="modal-overlay" id="joinPrivateModal">
    <div class="modal-card">
        <i class="fa-solid fa-xmark modal-close-btn" onclick="closeModal('joinPrivateModal')"></i>
        <h2>Åžifreli Odaya KatÄ±l</h2>
        <p id="joinPrivateRoomName" style="color:var(--primary); font-weight:800; margin-bottom:15px;"></p>
        <input type="password" id="joinRoomPass" placeholder="OdanÄ±n Åžifresini Girin">
        <button class="modal-btn" onclick="attemptJoinPrivate()">GÄ°RÄ°Åž YAP</button>
    </div>
</div>

<div class="modal-overlay" id="promoModal">
    <div class="modal-card">
        <h2>TaÅŸ Terfisi</h2>
        <p style="color:var(--text-secondary); font-size:14px; font-weight:600;">Piyonunu hangi taÅŸa dÃ¶nÃ¼ÅŸtÃ¼rmek istersin?</p>
        <div class="promo-options" id="promoOptions"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, query, where, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// OYUN DURUMLARI
let engine = new Chess();
let currentRoomId = null;
let currentRoomStatus = 'waiting'; 
let currentPrivateRoomData = null; // Åžifreli odaya girmeye Ã§alÄ±ÅŸÄ±rken tutulur
let myColor = 'w';
let userData = { uid: null, username: 'Misafir' };
let boardReversed = false;
let selectedSquare = null;
let lastMoveSquares = [];
let pendingPromotionMove = null;
let unsubscribeRoom = null;
let rewardGiven = false;

// TAÅž SVG LÄ°NKLERÄ°
const pieceTheme = {
    'w': {
        'p': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
        'n': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
        'b': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
        'r': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
        'q': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
        'k': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg'
    },
    'b': {
        'p': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
        'n': 'https://upload.wikimedia.org/wikipedia/commons/e/ea/Chess_ndt45.svg',
        'b': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
        'r': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
        'q': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
        'k': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg'
    }
};

// SES YÃ–NETÄ°MÄ°
const playSound = (type) => {
    try {
        const audio = document.getElementById(`sfx-${type}`);
        if(audio) { audio.currentTime = 0; audio.play().catch(()=>{}); }
    } catch(e){}
};

// ZOOM & SCROLL ENGELLEYÄ°CÄ°
document.addEventListener('touchmove', function (event) { if (event.scale !== 1) event.preventDefault(); }, { passive: false });
document.addEventListener('dblclick', function (event) { event.preventDefault(); }, { passive: false });

// GENEL MODAL YÃ–NETÄ°MÄ°
window.openModal = (id) => {
    const modal = document.getElementById(id);
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
};

window.closeModal = (id) => {
    const modal = document.getElementById(id);
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 300);
};

window.showMatrixModal = (title, message, type = 'info') => {
    const icon = document.getElementById("alertIcon");
    document.getElementById("alertTitle").innerText = title;
    document.getElementById("alertBody").innerText = message;
    
    if(type === 'error') icon.innerHTML = '<i class="fa-solid fa-circle-exclamation" style="color:var(--danger); filter:drop-shadow(0 0 10px rgba(255,77,77,0.5));"></i>';
    else if(type === 'success') icon.innerHTML = '<i class="fa-solid fa-circle-check" style="color:var(--success); filter:drop-shadow(0 0 10px rgba(0,255,163,0.5));"></i>';
    else icon.innerHTML = '<i class="fa-solid fa-circle-info" style="color:var(--primary); filter:drop-shadow(0 0 10px rgba(0,240,255,0.5));"></i>';
    
    openModal('alertModal');
};

// GÄ°RÄ°Åž KONTROLÃœ
onAuthStateChanged(auth, async (user) => {
    if (user) {
        userData.uid = user.uid;
        onSnapshot(doc(db, "users", user.uid), s => {
            if(s.exists()) {
                userData.username = s.data().username || "Oyuncu";
                document.getElementById("myName").innerText = userData.username;
            }
        });
        document.getElementById("loading").style.display = "none";
        listenToRooms();
    } else {
        document.getElementById("loading").style.display = "none";
        showMatrixModal("EriÅŸim Reddedildi", "SatranÃ§ arenasÄ±na girmek iÃ§in PlayMatrix hesabÄ±nÄ±zla giriÅŸ yapmalÄ±sÄ±nÄ±z.", "error");
        setTimeout(() => window.location.href = "index.html", 3000);
    }
});

// === SATRANÃ‡ Ã‡Ä°ZÄ°MÄ° ===
function drawBoard() {
    const boardDiv = document.getElementById("chessBoard");
    boardDiv.innerHTML = "";
    
    const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
    const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];
    
    let displayRanks = boardReversed ? [...ranks].reverse() : ranks;
    let displayFiles = boardReversed ? [...files].reverse() : files;

    for (let r = 0; r < 8; r++) {
        for (let f = 0; f < 8; f++) {
            const squareId = displayFiles[f] + displayRanks[r];
            const isLight = (r + f) % 2 === 0;
            const squareDiv = document.createElement("div");
            
            squareDiv.className = `square ${isLight ? 'light' : 'dark'}`;
            squareDiv.id = `sq-${squareId}`;
            squareDiv.dataset.sq = squareId;
            
            if(f === 0) squareDiv.innerHTML += `<div class="coord coord-rank">${displayRanks[r]}</div>`;
            if(r === 7) squareDiv.innerHTML += `<div class="coord coord-file">${displayFiles[f]}</div>`;

            squareDiv.onclick = () => handleSquareClick(squareId);
            boardDiv.appendChild(squareDiv);
        }
    }
    updatePieces();
}

function updatePieces() {
    document.querySelectorAll('.valid-move-dot, .valid-capture-ring').forEach(e => e.remove());
    document.querySelectorAll('.square').forEach(sq => {
        const div = sq.querySelector('.piece');
        if(div) div.remove();
        sq.classList.remove('highlight');
        if(!lastMoveSquares.includes(sq.dataset.sq)) sq.classList.remove('last-move');
    });

    const boardState = engine.board(); 
    const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
    const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];

    for (let r = 0; r < 8; r++) {
        for (let f = 0; f < 8; f++) {
            const piece = boardState[r][f];
            if (piece) {
                const sqId = files[f] + ranks[r];
                const sqDiv = document.getElementById(`sq-${sqId}`);
                if(sqDiv) {
                    const pieceDiv = document.createElement("div");
                    pieceDiv.className = "piece";
                    pieceDiv.style.backgroundImage = `url(${pieceTheme[piece.color][piece.type]})`;
                    sqDiv.appendChild(pieceDiv);
                }
            }
        }
    }
    
    if(lastMoveSquares.length === 2) {
        document.getElementById(`sq-${lastMoveSquares[0]}`)?.classList.add('last-move');
        document.getElementById(`sq-${lastMoveSquares[1]}`)?.classList.add('last-move');
    }
    
    // Aktif sÄ±ra efekti
    if(currentRoomStatus === 'playing') {
        if(engine.turn() === myColor) {
            document.getElementById("myInfo").classList.add("active-turn");
            document.getElementById("opponentInfo").classList.remove("active-turn");
        } else {
            document.getElementById("opponentInfo").classList.add("active-turn");
            document.getElementById("myInfo").classList.remove("active-turn");
        }
    }
}

// === HAMLE MANTIÄžI ===
function handleSquareClick(squareId) {
    // 1. KURAL: Rakip gelmeden taÅŸlara tÄ±klanamaz!
    if (currentRoomStatus !== 'playing') {
        showMatrixModal("LÃ¼tfen Bekleyin", "Rakibiniz odaya baÄŸlanmadan taÅŸlarla etkileÅŸime geÃ§emezsiniz.", "info");
        return;
    }
    
    if (!currentRoomId || engine.turn() !== myColor) return; 

    if (!selectedSquare) {
        const piece = engine.get(squareId);
        if (piece && piece.color === myColor) {
            selectedSquare = squareId;
            document.getElementById(`sq-${squareId}`).classList.add('highlight');
            showValidMoves(squareId);
        }
    } else {
        const piece = engine.get(squareId);
        if (piece && piece.color === myColor) {
            selectedSquare = squareId;
            updatePieces(); 
            document.getElementById(`sq-${squareId}`).classList.add('highlight');
            showValidMoves(squareId);
            return;
        }

        const moves = engine.moves({ square: selectedSquare, verbose: true });
        const move = moves.find(m => m.to === squareId);

        if (move) {
            if (move.flags.includes('p') || move.flags.includes('np') || move.flags.includes('cp')) {
                pendingPromotionMove = { from: selectedSquare, to: squareId };
                showPromotionModal();
            } else {
                executeMove({ from: selectedSquare, to: squareId, promotion: 'q' });
            }
        } else {
            selectedSquare = null;
            updatePieces();
        }
    }
}

function showValidMoves(squareId) {
    const moves = engine.moves({ square: squareId, verbose: true });
    moves.forEach(m => {
        const sqDiv = document.getElementById(`sq-${m.to}`);
        if(sqDiv) {
            if(engine.get(m.to)) sqDiv.innerHTML += `<div class="valid-capture-ring"></div>`;
            else sqDiv.innerHTML += `<div class="valid-move-dot"></div>`;
        }
    });
}

function showPromotionModal() {
    const container = document.getElementById("promoOptions");
    container.innerHTML = "";
    const pieces = ['q', 'r', 'n', 'b'];
    
    pieces.forEach(p => {
        const div = document.createElement("div");
        div.className = "promo-piece";
        div.innerHTML = `<img src="${pieceTheme[myColor][p]}" alt="Promotion">`;
        div.onclick = () => {
            closeModal('promoModal');
            executeMove({ from: pendingPromotionMove.from, to: pendingPromotionMove.to, promotion: p });
            pendingPromotionMove = null;
            selectedSquare = null;
        };
        container.appendChild(div);
    });
    
    openModal('promoModal');
}

async function executeMove(moveObj) {
    const move = engine.move(moveObj);
    if (move) {
        lastMoveSquares = [move.from, move.to];
        
        if(engine.in_check()) playSound('check');
        else if(move.captured) playSound('capture');
        else playSound('move');

        updatePieces();
        selectedSquare = null;

        try {
            await updateDoc(doc(db, "chess_rooms", currentRoomId), {
                fen: engine.fen(),
                lastMove: move,
                turn: engine.turn()
            });
            checkGameOver();
        } catch(e) {
            console.error(e);
        }
    }
}

// 2. KURAL: KAZANANA 2.500 MC Ã–DÃœL
async function checkGameOver() {
    if(engine.game_over() && !rewardGiven) {
        playSound('end');
        let msg = "Oyun bitti!";
        
        if(engine.in_checkmate()) {
            // Åžah mat ise kazanan, sÄ±rasÄ± OLMAYAN kiÅŸidir.
            let winnerColor = engine.turn() === 'w' ? 'b' : 'w';
            
            if(myColor === winnerColor) {
                rewardGiven = true;
                msg = "Tebrikler ÅžAH MAT! MÃ¼kemmel oyun.\n\nHesabÄ±nÄ±za 2.500 MC Coin Ã¶dÃ¼l eklendi.";
                try {
                    // Firebase Bakiyeyi ArttÄ±r
                    await updateDoc(doc(db, "users", userData.uid), { balance: increment(2500) });
                } catch(e) { console.error("Ã–dÃ¼l verilirken hata oluÅŸtu", e); }
                showMatrixModal("ðŸ† KAZANDINIZ!", msg, "success");
            } else {
                msg = "Maalesef ÅžAH MAT oldunuz. Rakibiniz oyunu kazandÄ±.";
                showMatrixModal("MaÃ§ Sonucu", msg, "error");
            }
        } 
        else if(engine.in_draw() || engine.in_stalemate()) {
            msg = "Oyun BERABERE bitti.";
            showMatrixModal("MaÃ§ Sonucu", msg, "info");
        }
        
        try { await updateDoc(doc(db, "chess_rooms", currentRoomId), { status: 'finished' }); } catch(e){}
    }
}

// === ODA KURMA SÄ°STEMÄ° (AÃ‡IK / ÅžÄ°FRELÄ°) ===

window.setupOpenRoom = () => {
    closeModal('createRoomMenuModal');
    createRoomDB(false, "", "");
};

window.openPrivateRoomForm = () => {
    closeModal('createRoomMenuModal');
    document.getElementById("prRoomName").value = "";
    document.getElementById("prRoomPass").value = "";
    openModal('privateRoomFormModal');
};

window.setupPrivateRoom = () => {
    const name = document.getElementById("prRoomName").value.trim();
    const pass = document.getElementById("prRoomPass").value.trim();
    
    if(name.length < 3) { showMatrixModal("Hata", "Oda ismi en az 3 karakter olmalÄ±dÄ±r.", "error"); return; }
    // Regex ile sadece rakam kontrolÃ¼ ve min 5
    if(!/^\d{5,}$/.test(pass)) { showMatrixModal("Hata", "Oda ÅŸifresi en az 5 RAKAMDAN oluÅŸmalÄ±dÄ±r.", "error"); return; }
    
    closeModal('privateRoomFormModal');
    createRoomDB(true, name, pass);
};

async function createRoomDB(isPrivate, roomName, password) {
    try {
        const roomRef = doc(collection(db, "chess_rooms"));
        await setDoc(roomRef, {
            status: 'waiting',
            hostUid: userData.uid,
            hostName: userData.username,
            guestUid: null,
            guestName: null,
            fen: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
            createdAt: Date.now(),
            turn: 'w',
            isPrivate: isPrivate,
            roomName: isPrivate ? roomName : `${userData.username}'in OdasÄ±`,
            password: password
        });
        joinGame(roomRef.id, 'w');
    } catch(e) {
        showMatrixModal("Hata", "Oda kurulamadÄ±: " + e.message, "error");
    }
}

// ODAYA GÄ°RÄ°Åž Ä°ÅžLEMLERÄ°
window.joinRoomCheck = (roomId, isPrivate, roomName, password) => {
    if(!isPrivate) {
        joinSpecificRoom(roomId);
    } else {
        currentPrivateRoomData = { id: roomId, pass: password };
        document.getElementById("joinPrivateRoomName").innerText = "Oda: " + roomName;
        document.getElementById("joinRoomPass").value = "";
        openModal('joinPrivateModal');
    }
};

window.attemptJoinPrivate = () => {
    const inputPass = document.getElementById("joinRoomPass").value.trim();
    if(inputPass === currentPrivateRoomData.pass) {
        closeModal('joinPrivateModal');
        joinSpecificRoom(currentPrivateRoomData.id);
    } else {
        showMatrixModal("Yetkisiz EriÅŸim", "GirdiÄŸiniz ÅŸifre hatalÄ±. LÃ¼tfen tekrar deneyin.", "error");
    }
};

async function joinSpecificRoom(roomId) {
    try {
        await updateDoc(doc(db, "chess_rooms", roomId), {
            status: 'playing',
            guestUid: userData.uid,
            guestName: userData.username
        });
        joinGame(roomId, 'b');
    } catch(e) {
        showMatrixModal("Hata", "Odaya katÄ±lÄ±namadÄ±!", "error");
    }
}

function joinGame(roomId, color) {
    currentRoomId = roomId;
    myColor = color;
    boardReversed = (color === 'b'); 
    rewardGiven = false;
    currentRoomStatus = 'waiting';
    
    document.getElementById("lobbyArea").style.display = "none";
    document.getElementById("gameArea").style.display = "flex";
    document.getElementById("exitGameBtn").style.display = "block";
    document.getElementById("opponentInfo").classList.remove("active-turn");
    document.getElementById("myInfo").classList.remove("active-turn");
    
    engine.reset();
    drawBoard();
    playSound('start');
    
    unsubscribeRoom = onSnapshot(doc(db, "chess_rooms", roomId), (snap) => {
        if(!snap.exists()) { leaveRoom(true); return; }
        
        const data = snap.data();
        currentRoomStatus = data.status;
        
        if(myColor === 'w') {
            document.getElementById("opponentName").innerText = data.guestName || "Rakip Bekleniyor...";
        } else {
            document.getElementById("opponentName").innerText = data.hostName || "Rakip";
        }

        if(data.fen !== engine.fen()) {
            engine.load(data.fen);
            if(data.lastMove) lastMoveSquares = [data.lastMove.from, data.lastMove.to];
            
            if(engine.in_check()) playSound('check');
            else if(data.lastMove && data.lastMove.captured) playSound('capture');
            else playSound('move');
            
            updatePieces();
            checkGameOver();
        }

        if(data.status === 'finished' && !rewardGiven) {
            document.getElementById("opponentName").innerText += " (Bitti)";
            if(myColor === 'w' && data.guestName === null) {
                // Rakip gelmeden iptal ettiysek bildirim yok
            }
        }
    });
}

window.leaveRoom = async (forced = false) => {
    if(unsubscribeRoom) unsubscribeRoom();
    
    if(currentRoomId && !forced) {
        try { await updateDoc(doc(db, "chess_rooms", currentRoomId), { status: 'finished' }); } catch(e){}
    }
    
    currentRoomId = null;
    currentRoomStatus = 'waiting';
    document.getElementById("lobbyArea").style.display = "flex";
    document.getElementById("gameArea").style.display = "none";
    document.getElementById("exitGameBtn").style.display = "none";
    
    if(forced) showMatrixModal("Oda KapatÄ±ldÄ±", "Rakip odadan ayrÄ±ldÄ± veya maÃ§ sona erdi.", "info");
};

// ANLIK LOBÄ° DÄ°NLEME (Sayfa Yenilemeden)
function listenToRooms() {
    const q = query(collection(db, "chess_rooms"), where("status", "==", "waiting"));
    onSnapshot(q, (snapshot) => {
        const list = document.getElementById("roomsList");
        list.innerHTML = "";
        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            if(data.hostUid === userData.uid) return; 
            
            const isPriv = data.isPrivate;
            const btnClass = isPriv ? "join-btn private" : "join-btn";
            const btnIcon = isPriv ? '<i class="fa-solid fa-lock"></i> ÅžÄ°FRELÄ° GÄ°RÄ°Åž' : 'KATIL';
            const iconColor = isPriv ? '#ffaa00' : 'var(--primary)';
            
            list.innerHTML += `
                <div class="room-card">
                    <div class="room-info">
                        <h3><i class="fa-solid fa-chess-knight" style="color:${iconColor};"></i> ${data.roomName || data.hostName}</h3>
                        <p>Bahis: 2.500 MC Ã–dÃ¼l | Kurucu: ${data.hostName}</p>
                    </div>
                    <button class="${btnClass}" onclick="joinRoomCheck('${docSnap.id}', ${isPriv}, '${data.roomName}', '${data.password}')">${btnIcon}</button>
                </div>
            `;
        });
        if(list.innerHTML === "") {
            list.innerHTML = `<p style="color:var(--text-secondary); width:100%; text-align:center; grid-column: 1 / -1; font-weight:600;">Åžu an aktif aÃ§Ä±k oda bulunmuyor. Kendi odanÄ± kur!</p>`;
        }
    });
}
</script>
</body>
</html>
