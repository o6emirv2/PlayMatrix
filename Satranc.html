<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<title>PlayMatrix | Ultra Profesyonel Satranç</title>
<meta name="description" content="PlayMatrix Satranç Arenası. Gerçek zamanlı, hilesiz ve profesyonel satranç deneyimi.">
<meta name="theme-color" content="#04060b">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* === PLAYMATRIX ANA DEĞİŞKENLERİ === */
:root {
    --primary: #00f0ff;
    --primary-glow: rgba(0, 240, 255, 0.5);
    --secondary: #0055ff;
    --accent: #ff007a;
    --bg-main: #04060b;
    --bg-surface: #0a0e17;
    --glass-bg: rgba(10, 14, 23, 0.85);
    --glass-border: rgba(255, 255, 255, 0.08);
    --text-primary: #ffffff;
    --text-secondary: #94a3b8;
    --success: #00ffa3;
    --danger: #ff4d4d;
    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    --input-bg: rgba(0, 0, 0, 0.4);
    
    /* GERÇEK SATRANÇ RENKLERİ */
    --board-light: #f0d9b5;
    --board-dark: #b58863;
    --highlight: rgba(255, 255, 51, 0.5);
    --valid-move: rgba(0, 0, 0, 0.15);
}

/* KESİN KAYDIRMA VE ZOOM ENGELLEYİCİ (MOBİL İÇİN) */
html, body {
    width: 100vw; height: 100vh;
    margin: 0; padding: 0;
    overflow: hidden; /* Ekranın hareket etmesini engeller */
    touch-action: none; /* Çift tık zoom ve kaydırmayı donanımsal engeller */
    overscroll-behavior: none;
    -webkit-user-select: none; user-select: none;
    background: var(--bg-main); color: var(--text-primary);
    font-family: 'Inter', sans-serif;
}

/* === ÜST BAR === */
.top-bar {
    position: fixed; top: 0; width: 100%; height: 70px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; background: var(--glass-bg);
    backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border-bottom: 1px solid var(--glass-border); z-index: 2000;
}
.brand-3d {
    font-family: 'Montserrat', sans-serif; font-size: 20px; font-weight: 900; 
    color: var(--text-primary); text-transform: uppercase; letter-spacing: 2px;
    text-shadow: 0 1px 0 var(--secondary), 0 2px 0 var(--secondary), 
                 0 4px 10px var(--primary-glow), 0 0 20px var(--primary-glow);
}
.exit-btn {
    background: var(--danger); color: white; border: none; padding: 8px 15px;
    border-radius: 10px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 77, 77, 0.4);
}

/* === FERAH LOBİ TASARIMI === */
#lobbyArea {
    position: absolute; top: 70px; left: 0; width: 100%; height: calc(100vh - 70px);
    overflow-y: auto; padding: 20px; box-sizing: border-box;
    display: flex; flex-direction: column; align-items: center;
}
.lobby-header { text-align: center; margin-bottom: 30px; margin-top: 20px; }
.lobby-header h1 { font-family: 'Montserrat', sans-serif; font-size: 28px; color: var(--primary); text-shadow: 0 0 15px var(--primary-glow); margin-bottom: 10px; }
.lobby-header p { color: var(--text-secondary); font-size: 14px; }
.create-room-btn {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: #fff; border: none; padding: 15px 30px; border-radius: 16px;
    font-size: 16px; font-weight: 900; letter-spacing: 1px; cursor: pointer;
    box-shadow: 0 10px 30px var(--primary-glow); transition: 0.3s;
    width: 100%; max-width: 400px; text-transform: uppercase;
}
.create-room-btn:active { transform: scale(0.95); }
.rooms-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px; width: 100%; max-width: 900px; margin-top: 30px;
}
.room-card {
    background: var(--bg-surface); border: 1px solid var(--glass-border);
    border-radius: 16px; padding: 20px; display: flex; justify-content: space-between;
    align-items: center; box-shadow: var(--card-shadow); transition: 0.3s;
}
.room-card:hover { border-color: var(--primary); transform: translateY(-3px); }
.room-info h3 { font-size: 16px; margin-bottom: 5px; color: var(--text-primary); }
.room-info p { font-size: 12px; color: var(--text-secondary); }
.join-btn {
    background: var(--bg-main); border: 1px solid var(--primary); color: var(--primary);
    padding: 8px 16px; border-radius: 10px; font-weight: 800; cursor: pointer;
    transition: 0.3s;
}
.join-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary-glow); }

/* === OYUN İÇİ EKRAN (SIFIR HAREKET) === */
#gameArea {
    position: absolute; top: 70px; left: 0; width: 100vw; height: calc(100vh - 70px);
    display: none; flex-direction: column; align-items: center; justify-content: center;
    background: radial-gradient(circle at center, var(--bg-surface) 0%, var(--bg-main) 100%);
}
.player-info {
    width: 100%; max-width: 400px; display: flex; justify-content: space-between;
    align-items: center; padding: 10px 20px; background: var(--glass-bg);
    border-radius: 12px; margin: 10px 0; border: 1px solid var(--glass-border);
}
.player-info.active-turn { border-color: var(--success); box-shadow: 0 0 15px rgba(0, 255, 163, 0.3); }
.player-name { font-weight: 800; font-size: 14px; display: flex; align-items: center; gap: 10px; }
.player-name i { font-size: 18px; }
.captured-pieces { display: flex; gap: 2px; font-size: 16px; }

/* === GERÇEK SATRANÇ TAHTASI TASARIMI === */
.board-container {
    width: 100vw; max-width: 400px; aspect-ratio: 1;
    background: var(--board-dark); border: 4px solid var(--bg-surface);
    border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.7);
    position: relative; overflow: hidden;
}
#chessBoard {
    display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr);
    width: 100%; height: 100%;
}
.square { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; }
.square.light { background-color: var(--board-light); }
.square.dark { background-color: var(--board-dark); }
.square.highlight { background-color: var(--highlight) !important; }
.square.last-move { background-color: rgba(155, 199, 0, 0.41) !important; }

/* Taşı Seçince Giden Nokta (Geçerli Hamle Göstergesi) */
.valid-move-dot {
    width: 30%; height: 30%; background-color: var(--valid-move);
    border-radius: 50%; position: absolute; pointer-events: none;
}
.valid-capture-ring {
    width: 80%; height: 80%; border: 4px solid var(--valid-move);
    border-radius: 50%; position: absolute; pointer-events: none;
}

/* TAŞLAR (Gerçekçi SVG'ler) */
.piece {
    width: 90%; height: 90%; background-size: cover; background-position: center;
    cursor: pointer; z-index: 10; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3));
    transition: transform 0.1s;
}
.piece:active { transform: scale(1.1); }

/* KOORDİNAT YAZILARI */
.coord { position: absolute; font-size: 10px; font-weight: 800; opacity: 0.7; pointer-events: none; }
.coord-rank { top: 2px; left: 2px; }
.coord-file { bottom: 2px; right: 2px; }
.square.dark .coord { color: var(--board-light); }
.square.light .coord { color: var(--board-dark); }

/* === PLAYMATRIX MODALLARI (STANDARTLARA UYGUN) === */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    display: none; align-items: center; justify-content: center; z-index: 5000; opacity: 0;
    transition: opacity 0.3s ease;
}
.modal-overlay.show { opacity: 1; display: flex; }
.modal-card { 
    width: 90%; max-width: 420px; padding: 35px 30px; border-radius: 28px; 
    background: var(--bg-surface); border: 1px solid var(--glass-border); text-align: center; 
    box-shadow: 0 25px 50px rgba(0,0,0,0.5); transform: scale(0.95); transition: transform 0.3s;
    position: relative;
}
.modal-overlay.show .modal-card { transform: scale(1); }
.modal-btn { 
    width: 100%; padding: 16px; border-radius: 14px; border: none; 
    background: linear-gradient(135deg, var(--primary), var(--secondary)); 
    color: #fff; font-weight: 900; font-size: 15px; cursor: pointer; 
    box-shadow: 0 8px 20px var(--primary-glow); text-transform: uppercase; margin-top: 15px;
}
.modal-btn.danger { background: linear-gradient(135deg, #ff4d4d, #cc0000); box-shadow: 0 8px 20px rgba(255,77,77,0.4); }

/* TERFİ MODALI ÖZEL TASARIMI */
.promo-options { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
.promo-piece {
    width: 60px; height: 60px; background-color: var(--board-light); border-radius: 12px;
    border: 2px solid var(--primary); display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.2s;
}
.promo-piece:hover { transform: scale(1.1); box-shadow: 0 0 15px var(--primary-glow); }
.promo-piece img { width: 80%; height: 80%; }

/* Yükleniyor Ekranı */
#loading {
    position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-main);
    display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;
}
.loader-spinner { width: 50px; height: 50px; border: 5px solid var(--glass-border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<audio id="sfx-move" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3" preload="auto"></audio>
<audio id="sfx-capture" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/capture.mp3" preload="auto"></audio>
<audio id="sfx-check" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-check.mp3" preload="auto"></audio>
<audio id="sfx-start" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-start.mp3" preload="auto"></audio>
<audio id="sfx-end" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-end.mp3" preload="auto"></audio>

<div id="loading">
    <div class="loader-spinner"></div>
    <h3 style="margin-top: 20px; color: var(--primary);">PlayMatrix Arena Yükleniyor...</h3>
</div>

<header class="top-bar">
    <div class="brand-3d">PlayMatrix</div>
    <button class="exit-btn" id="exitGameBtn" style="display:none;" onclick="leaveRoom()"><i class="fa-solid fa-door-open"></i> ÇIKIŞ</button>
</header>

<div id="lobbyArea">
    <div class="lobby-header">
        <h1>SATRANÇ ARENASI</h1>
        <p>Hilesiz, Kusursuz, Ultra Profesyonel Deneyim.</p>
    </div>
    <button class="create-room-btn" onclick="createRoom()"><i class="fa-solid fa-plus"></i> YENİ ODA KUR</button>
    <div class="rooms-grid" id="roomsList">
        </div>
</div>

<div id="gameArea">
    <div class="player-info" id="opponentInfo">
        <div class="player-name"><i class="fa-solid fa-circle-user"></i> <span id="opponentName">Bekleniyor...</span></div>
    </div>
    
    <div class="board-container">
        <div id="chessBoard"></div>
    </div>
    
    <div class="player-info" id="myInfo">
        <div class="player-name"><i class="fa-solid fa-circle-user" style="color:var(--primary);"></i> <span id="myName">Sen</span></div>
    </div>
</div>

<div class="modal-overlay" id="alertModal">
    <div class="modal-card">
        <div id="alertIcon" style="font-size: 50px; margin-bottom: 15px;"></div>
        <h2 id="alertTitle">Sistem Mesajı</h2>
        <p id="alertBody" style="color: var(--text-secondary); margin-bottom: 25px; font-size: 15px; font-weight: 500;"></p>
        <button class="modal-btn" onclick="closeModal('alertModal')">TAMAM</button>
    </div>
</div>

<div class="modal-overlay" id="promoModal">
    <div class="modal-card">
        <h2>Taş Terfisi</h2>
        <p style="color:var(--text-secondary); font-size:14px;">Piyonunu hangi taşa dönüştürmek istersin?</p>
        <div class="promo-options" id="promoOptions">
            </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script type="module">
// FIREBASE AYARLARI (index.html'den alındı)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// OYUN DEĞİŞKENLERİ
let engine = new Chess();
let currentRoomId = null;
let myColor = 'w'; // 'w' veya 'b'
let userData = { uid: null, username: 'Misafir' };
let boardReversed = false;
let selectedSquare = null;
let lastMoveSquares = [];
let pendingPromotionMove = null;
let unsubscribeRoom = null;

// SES EFEKTLERİ FONKSİYONU
const playSound = (type) => {
    try {
        const audio = document.getElementById(`sfx-${type}`);
        if(audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Ses çalma engellendi (kullanıcı etkileşimi gerek)"));
        }
    } catch(e){}
};

// ÇİFT TIK VE KAYDIRMA ENGELLEYİCİ (Ekstra Önlem)
document.addEventListener('touchmove', function (event) {
    if (event.scale !== 1) { event.preventDefault(); }
}, { passive: false });
document.addEventListener('dblclick', function (event) {
    event.preventDefault();
}, { passive: false });

// TAŞ SVG LİNKLERİ (Wikimedia Commons Standart Seti - Mükemmel Kalite)
const pieceTheme = {
    'w': {
        'p': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
        'n': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
        'b': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
        'r': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
        'q': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
        'k': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg'
    },
    'b': {
        'p': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
        'n': 'https://upload.wikimedia.org/wikipedia/commons/e/ea/Chess_ndt45.svg',
        'b': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
        'r': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
        'q': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
        'k': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg'
    }
};

// MODAL YÖNETİMİ
window.showMatrixModal = (title, message, type = 'info') => {
    const icon = document.getElementById("alertIcon");
    document.getElementById("alertTitle").innerText = title;
    document.getElementById("alertBody").innerText = message;
    
    if(type === 'error') icon.innerHTML = '<i class="fa-solid fa-circle-exclamation" style="color:var(--danger)"></i>';
    else if(type === 'success') icon.innerHTML = '<i class="fa-solid fa-circle-check" style="color:var(--success)"></i>';
    else icon.innerHTML = '<i class="fa-solid fa-circle-info" style="color:var(--primary)"></i>';
    
    document.getElementById("alertModal").style.display = 'flex';
    setTimeout(() => document.getElementById("alertModal").classList.add('show'), 10);
};

window.closeModal = (id) => {
    const modal = document.getElementById(id);
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 300);
};

// KİMLİK DOĞRULAMA KONTROLÜ
onAuthStateChanged(auth, async (user) => {
    if (user) {
        userData.uid = user.uid;
        // Kullanıcı adını Firestore'dan çek (PlayMatrix yapısına uygun)
        onSnapshot(doc(db, "users", user.uid), s => {
            if(s.exists()) {
                userData.username = s.data().username || "Oyuncu";
                document.getElementById("myName").innerText = userData.username;
            }
        });
        document.getElementById("loading").style.display = "none";
        listenToRooms();
    } else {
        // Oturum açılmamışsa uyarı ver
        document.getElementById("loading").style.display = "none";
        showMatrixModal("Erişim Reddedildi", "Satranç arenasına girmek için PlayMatrix hesabınızla giriş yapmalısınız.", "error");
        setTimeout(() => window.location.href = "index.html", 3000);
    }
});

// === SATRANÇ TAHTASI ÇİZİMİ ===
function drawBoard() {
    const boardDiv = document.getElementById("chessBoard");
    boardDiv.innerHTML = "";
    
    const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
    const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];
    
    let displayRanks = boardReversed ? [...ranks].reverse() : ranks;
    let displayFiles = boardReversed ? [...files].reverse() : files;

    for (let r = 0; r < 8; r++) {
        for (let f = 0; f < 8; f++) {
            const squareId = displayFiles[f] + displayRanks[r];
            const isLight = (r + f) % 2 === 0;
            
            const squareDiv = document.createElement("div");
            squareDiv.className = `square ${isLight ? 'light' : 'dark'}`;
            squareDiv.id = `sq-${squareId}`;
            squareDiv.dataset.sq = squareId;
            
            // Satır/Sütun isimleri (A-H, 1-8)
            if(f === 0) squareDiv.innerHTML += `<div class="coord coord-rank">${displayRanks[r]}</div>`;
            if(r === 7) squareDiv.innerHTML += `<div class="coord coord-file">${displayFiles[f]}</div>`;

            // Tıklama Olayı (Hamle / Seçim)
            squareDiv.onclick = () => handleSquareClick(squareId);

            boardDiv.appendChild(squareDiv);
        }
    }
    updatePieces();
}

// === TAŞLARI GÜNCELLE ===
function updatePieces() {
    // Önceki vurguları temizle
    document.querySelectorAll('.valid-move-dot, .valid-capture-ring').forEach(e => e.remove());
    document.querySelectorAll('.square').forEach(sq => {
        const div = sq.querySelector('.piece');
        if(div) div.remove();
        sq.classList.remove('highlight');
        if(!lastMoveSquares.includes(sq.dataset.sq)) sq.classList.remove('last-move');
    });

    const boardState = engine.board(); // 8x8 array from chess.js
    const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
    const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];

    for (let r = 0; r < 8; r++) {
        for (let f = 0; f < 8; f++) {
            const piece = boardState[r][f];
            if (piece) {
                const sqId = files[f] + ranks[r];
                const sqDiv = document.getElementById(`sq-${sqId}`);
                if(sqDiv) {
                    const pieceDiv = document.createElement("div");
                    pieceDiv.className = "piece";
                    pieceDiv.style.backgroundImage = `url(${pieceTheme[piece.color][piece.type]})`;
                    sqDiv.appendChild(pieceDiv);
                }
            }
        }
    }
    
    // Son hamleyi boya
    if(lastMoveSquares.length === 2) {
        document.getElementById(`sq-${lastMoveSquares[0]}`)?.classList.add('last-move');
        document.getElementById(`sq-${lastMoveSquares[1]}`)?.classList.add('last-move');
    }
    
    // Aktif sıra gösterimi
    if(engine.turn() === myColor) {
        document.getElementById("myInfo").classList.add("active-turn");
        document.getElementById("opponentInfo").classList.remove("active-turn");
    } else {
        document.getElementById("opponentInfo").classList.add("active-turn");
        document.getElementById("myInfo").classList.remove("active-turn");
    }
}

// === HAMLE LOGIC (SIFIR HATA VE HİLE KORUMALI) ===
function handleSquareClick(squareId) {
    if (!currentRoomId || engine.turn() !== myColor) return; // Benim sıram değilse iptal

    // 1. Durum: Bir taşı seçmek
    if (!selectedSquare) {
        const piece = engine.get(squareId);
        if (piece && piece.color === myColor) {
            selectedSquare = squareId;
            document.getElementById(`sq-${squareId}`).classList.add('highlight');
            showValidMoves(squareId);
        }
    } 
    // 2. Durum: Seçili taş varken başka bir yere tıklamak
    else {
        // Eğer kendi taşına tekrar tıkladıysa seçimi değiştir
        const piece = engine.get(squareId);
        if (piece && piece.color === myColor) {
            selectedSquare = squareId;
            updatePieces(); // Vurguları temizle
            document.getElementById(`sq-${squareId}`).classList.add('highlight');
            showValidMoves(squareId);
            return;
        }

        // Hamle denemesi
        const moves = engine.moves({ square: selectedSquare, verbose: true });
        const move = moves.find(m => m.to === squareId);

        if (move) {
            // Piyon Terfisi Kontrolü
            if (move.flags.includes('p') || move.flags.includes('np') || move.flags.includes('cp')) {
                pendingPromotionMove = { from: selectedSquare, to: squareId };
                showPromotionModal();
            } else {
                executeMove({ from: selectedSquare, to: squareId, promotion: 'q' });
            }
        } else {
            // Geçersiz hamle, seçimi iptal et
            selectedSquare = null;
            updatePieces();
        }
    }
}

// Geçerli hamleleri ekranda nokta olarak göster
function showValidMoves(squareId) {
    const moves = engine.moves({ square: squareId, verbose: true });
    moves.forEach(m => {
        const sqDiv = document.getElementById(`sq-${m.to}`);
        if(sqDiv) {
            if(engine.get(m.to)) {
                // Yeme hamlesi (Yuvarlak)
                sqDiv.innerHTML += `<div class="valid-capture-ring"></div>`;
            } else {
                // Boş kare (Nokta)
                sqDiv.innerHTML += `<div class="valid-move-dot"></div>`;
            }
        }
    });
}

function showPromotionModal() {
    const modal = document.getElementById("promoModal");
    const container = document.getElementById("promoOptions");
    container.innerHTML = "";
    const pieces = ['q', 'r', 'n', 'b'];
    
    pieces.forEach(p => {
        const div = document.createElement("div");
        div.className = "promo-piece";
        div.innerHTML = `<img src="${pieceTheme[myColor][p]}" alt="Promotion">`;
        div.onclick = () => {
            closeModal('promoModal');
            executeMove({ from: pendingPromotionMove.from, to: pendingPromotionMove.to, promotion: p });
            pendingPromotionMove = null;
            selectedSquare = null;
        };
        container.appendChild(div);
    });
    
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
}

// Hamleyi Uygula ve Firebase'e Gönder
async function executeMove(moveObj) {
    const move = engine.move(moveObj);
    if (move) {
        lastMoveSquares = [move.from, move.to];
        
        // Ses efekti
        if(engine.in_check()) playSound('check');
        else if(move.captured) playSound('capture');
        else playSound('move');

        updatePieces();
        selectedSquare = null;

        // Firebase Güncellemesi
        try {
            await updateDoc(doc(db, "chess_rooms", currentRoomId), {
                fen: engine.fen(),
                lastMove: move,
                turn: engine.turn()
            });
            checkGameOver();
        } catch(e) {
            console.error("Hamle gönderilemedi!", e);
        }
    }
}

function checkGameOver() {
    if(engine.game_over()) {
        playSound('end');
        let msg = "Oyun bitti!";
        if(engine.in_checkmate()) msg = `ŞAH MAT! ${engine.turn() === 'w' ? 'Siyah' : 'Beyaz'} Kazandı.`;
        else if(engine.in_draw()) msg = "Oyun BERABERE bitti.";
        else if(engine.in_stalemate()) msg = "Oyun PAT oldu (Berabere).";
        
        showMatrixModal("Maç Sonucu", msg, "info");
        
        // Odayı bitir
        updateDoc(doc(db, "chess_rooms", currentRoomId), { status: 'finished' });
    }
}

// === MULTIPLAYER ODA SİSTEMİ (FİREBASE) ===
window.createRoom = async () => {
    try {
        const roomRef = doc(collection(db, "chess_rooms"));
        await setDoc(roomRef, {
            status: 'waiting',
            hostUid: userData.uid,
            hostName: userData.username,
            guestUid: null,
            guestName: null,
            fen: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
            createdAt: Date.now(),
            turn: 'w'
        });
        joinGame(roomRef.id, 'w');
    } catch(e) {
        showMatrixModal("Hata", "Oda kurulamadı: " + e.message, "error");
    }
};

window.joinSpecificRoom = async (roomId) => {
    try {
        await updateDoc(doc(db, "chess_rooms", roomId), {
            status: 'playing',
            guestUid: userData.uid,
            guestName: userData.username
        });
        joinGame(roomId, 'b');
    } catch(e) {
        showMatrixModal("Hata", "Odaya katılınamadı!", "error");
    }
};

function joinGame(roomId, color) {
    currentRoomId = roomId;
    myColor = color;
    boardReversed = (color === 'b'); // Siyah ise tahtayı çevir
    
    document.getElementById("lobbyArea").style.display = "none";
    document.getElementById("gameArea").style.display = "flex";
    document.getElementById("exitGameBtn").style.display = "block";
    
    engine.reset();
    drawBoard();
    playSound('start');
    
    // Odayı Dinle
    unsubscribeRoom = onSnapshot(doc(db, "chess_rooms", roomId), (snap) => {
        if(!snap.exists()) {
            leaveRoom(true);
            return;
        }
        const data = snap.data();
        
        // İsimleri Güncelle
        if(myColor === 'w') {
            document.getElementById("opponentName").innerText = data.guestName || "Rakip Bekleniyor...";
        } else {
            document.getElementById("opponentName").innerText = data.hostName || "Rakip";
        }

        // Tahtayı Güncelle (Eğer hamleyi rakip yaptıysa)
        if(data.fen !== engine.fen()) {
            engine.load(data.fen);
            if(data.lastMove) lastMoveSquares = [data.lastMove.from, data.lastMove.to];
            
            // Rakibin hamlesi için ses
            if(engine.in_check()) playSound('check');
            else if(data.lastMove && data.lastMove.captured) playSound('capture');
            else playSound('move');
            
            updatePieces();
            checkGameOver();
        }

        if(data.status === 'finished') {
            document.getElementById("opponentName").innerText += " (Maç Bitti)";
        }
    });
}

window.leaveRoom = async (forced = false) => {
    if(unsubscribeRoom) unsubscribeRoom();
    
    if(currentRoomId && !forced) {
        // Eğer çıkıyorsak ve oyun bitmediyse odayı sil/bitir (Hile engelleme mantığı)
        try {
            await updateDoc(doc(db, "chess_rooms", currentRoomId), { status: 'finished' });
        } catch(e){}
    }
    
    currentRoomId = null;
    document.getElementById("lobbyArea").style.display = "flex";
    document.getElementById("gameArea").style.display = "none";
    document.getElementById("exitGameBtn").style.display = "none";
    
    if(forced) showMatrixModal("Oda Kapatıldı", "Rakip odadan ayrıldı veya bağlantı koptu.", "info");
};

// Lobi: Açık Odaları Dinle
function listenToRooms() {
    const q = query(collection(db, "chess_rooms"), where("status", "==", "waiting"));
    onSnapshot(q, (snapshot) => {
        const list = document.getElementById("roomsList");
        list.innerHTML = "";
        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            // Kendi kurduğumuz odayı lobide gizle (biz zaten içindeyizdir)
            if(data.hostUid === userData.uid) return; 
            
            list.innerHTML += `
                <div class="room-card">
                    <div class="room-info">
                        <h3><i class="fa-solid fa-chess-knight" style="color:var(--primary);"></i> ${data.hostName}</h3>
                        <p>Bahis: Dostluk Maçı | Mod: Klasik</p>
                    </div>
                    <button class="join-btn" onclick="joinSpecificRoom('${docSnap.id}')">KATIL</button>
                </div>
            `;
        });
        if(list.innerHTML === "") {
            list.innerHTML = `<p style="color:var(--text-secondary); width:100%; text-align:center;">Şu an aktif açık oda bulunmuyor. Sen bir tane kur!</p>`;
        }
    });
}

// Ultra Profesyonel Hile Koruması Hakkında Not:
// İstemci tarafında (burada) `engine.turn() === myColor` ile hamleler engellenir.
// %100 Server-side anti-cheat için Firebase Firestore Rules'a chess.js entegre edilemez, 
// bunun yerine Cloud Functions kullanarak hamle validasyonu yapılmalıdır.
// Şu anki yapı, tarayıcı konsolundan hile yapılmasını DOM bazında engeller.
</script>
</body>
</html>
