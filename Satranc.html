<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>PlayMatrix | Neon Chess Arena - Canlı Lobi</title>
<meta name="description" content="Dünyanın en gelişmiş siberpunk satranç arenası. Lobiye katıl, açık odaları gör, rakiplerini yen ve MC ödüllerini topla!">
<meta name="theme-color" content="#04060b">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Montserrat:wght@800;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<style>
/* === ULTRA TEMA DEĞİŞKENLERİ === */
:root {
    --primary: #00f0ff;
    --primary-glow: rgba(0, 240, 255, 0.6);
    --secondary: #0055ff;
    --accent: #ff007a;
    --bg-main: #04060b;
    --bg-surface: rgba(10, 14, 23, 0.85);
    --glass-border: rgba(255, 255, 255, 0.1);
    --text-primary: #ffffff;
    --text-secondary: #94a3b8;
    --success: #00ffa3;
    --danger: #ff4d4d;
    --board-dark: rgba(0, 85, 255, 0.2);
    --board-light: rgba(255, 255, 255, 0.03);
    --highlight: rgba(0, 240, 255, 0.5);
    --check-highlight: rgba(255, 0, 122, 0.6);
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
body { background: radial-gradient(circle at top, #0a1128 0%, var(--bg-main) 100%); color: var(--text-primary); overflow-x: hidden; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

/* === ÜST BAR === */
.top-bar { width: 100%; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: rgba(4, 6, 11, 0.8); backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border); z-index: 1000; position: fixed; top: 0; }
.back-btn { color: var(--text-secondary); text-decoration: none; font-size: 18px; transition: 0.3s; font-weight: 700; display: flex; align-items: center; gap: 8px; cursor: pointer; }
.back-btn:hover { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }
.brand-3d { font-family: 'Montserrat', sans-serif; font-size: 22px; font-weight: 900; color: #fff; text-transform: uppercase; letter-spacing: 3px; text-shadow: 0 2px 0 var(--secondary), 0 0 20px var(--primary-glow); }
.balance-pill { background: rgba(0,255,163,0.1); border: 1px solid rgba(0,255,163,0.3); padding: 5px 15px; border-radius: 20px; font-weight: 900; color: var(--success); display: flex; align-items: center; gap: 8px; box-shadow: 0 0 15px rgba(0,255,163,0.2); }

/* === LOBİ TASARIMI === */
.lobby-container { margin-top: 90px; width: 100%; max-width: 900px; padding: 20px; display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; }

.create-room-panel { background: var(--bg-surface); padding: 35px 25px; border-radius: 20px; border: 1px solid var(--glass-border); box-shadow: 0 10px 40px rgba(0,0,0,0.6); height: fit-content; text-align: center; position: relative; overflow: hidden; }
.create-room-panel::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--primary), var(--secondary)); }
.create-room-panel h2 { color: #fff; font-weight: 900; margin-bottom: 15px; font-size: 22px; letter-spacing: 1px; }

.bet-input { width: 100%; padding: 18px; margin-bottom: 25px; background: rgba(0,0,0,0.6); border: 2px solid var(--glass-border); color: var(--primary); border-radius: 12px; font-size: 20px; font-weight: 900; text-align: center; outline: none; transition: 0.3s; letter-spacing: 2px; }
.bet-input:focus { border-color: var(--primary); box-shadow: 0 0 20px var(--primary-glow); }

.rooms-panel { display: flex; flex-direction: column; gap: 15px; background: rgba(10, 14, 23, 0.4); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); }
.rooms-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; margin-bottom: 10px; }
.rooms-header h3 { font-size: 18px; font-weight: 900; color: #fff; display: flex; align-items: center; }
.live-pulse { display: inline-block; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; margin-right: 10px; animation: pulse 1s infinite alternate; box-shadow: 0 0 10px var(--danger); }
@keyframes pulse { from { opacity: 0.4; transform: scale(0.8); } to { opacity: 1; transform: scale(1.3); } }

.room-list { display: flex; flex-direction: column; gap: 15px; max-height: 60vh; overflow-y: auto; padding-right: 5px; }
.room-list::-webkit-scrollbar { width: 6px; } .room-list::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
.room-card { background: linear-gradient(90deg, rgba(10,14,23,0.95), rgba(0,85,255,0.15)); border: 1px solid var(--glass-border); border-left: 4px solid var(--primary); border-radius: 14px; padding: 20px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
.room-card:hover { transform: translateX(5px); border-color: var(--primary); box-shadow: 0 5px 25px rgba(0,240,255,0.15); }
.room-info h4 { font-size: 16px; font-weight: 800; color: #fff; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
.room-info p { font-size: 12px; color: var(--text-secondary); font-weight: 600; font-family: 'JetBrains Mono', monospace; }
.room-bet { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 900; color: var(--success); text-shadow: 0 0 15px rgba(0,255,163,0.4); }
.empty-lobby { text-align: center; padding: 40px 20px; color: var(--text-secondary); font-weight: 600; border: 1px dashed var(--glass-border); border-radius: 15px; line-height: 1.6; }

/* === BUTONLAR === */
.btn { width: 100%; padding: 16px; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #fff; font-weight: 900; font-size: 15px; letter-spacing: 1px; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px rgba(0, 85, 255, 0.4); text-transform: uppercase; }
.btn:hover { transform: translateY(-3px); box-shadow: 0 15px 30px var(--primary-glow); }
.btn-join { width: auto; padding: 12px 25px; font-size: 13px; }
.btn-cancel { background: transparent; border: 1px solid var(--danger); color: var(--danger); box-shadow: none; margin-top: 20px; }
.btn-cancel:hover { background: rgba(255,77,77,0.1); box-shadow: 0 0 15px rgba(255,77,77,0.3); }

/* === OYUN ARAYÜZÜ === */
.game-container { display: flex; flex-direction: column; align-items: center; margin-top: 90px; width: 100%; max-width: 650px; padding: 10px; display: none; }
.status-panel { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: var(--bg-surface); padding: 15px 20px; border-radius: 16px; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
.player-box { display: flex; flex-direction: column; gap: 5px; }
.player-name { font-weight: 800; font-size: 14px; display: flex; align-items: center; gap: 8px; color: var(--text-secondary); transition: 0.3s; }
.player-name.active { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }
.pool-amount { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 900; color: var(--success); text-shadow: 0 0 15px rgba(0,255,163,0.5); display: flex; flex-direction: column; align-items: center; }
.pool-amount span { font-size: 10px; color: var(--text-secondary); letter-spacing: 2px; text-shadow: none; text-transform: uppercase; }

/* === SATRANÇ TAHTASI === */
.board-wrapper { position: relative; padding: 25px; background: linear-gradient(145deg, #0a0e17, #04060b); border-radius: 16px; border: 2px solid rgba(0, 240, 255, 0.2); box-shadow: 0 20px 50px rgba(0,0,0,0.8), inset 0 0 30px rgba(0, 240, 255, 0.05); }
.coords-h { position: absolute; left: 25px; right: 25px; display: flex; justify-content: space-around; font-size: 10px; font-weight: 900; color: var(--text-secondary); }
.coords-h.top { top: 6px; } .coords-h.bottom { bottom: 6px; }
.coords-v { position: absolute; top: 25px; bottom: 25px; display: flex; flex-direction: column; justify-content: space-around; font-size: 10px; font-weight: 900; color: var(--text-secondary); }
.coords-v.left { left: 8px; } .coords-v.right { right: 8px; }

.chessboard { display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); width: 100%; max-width: 550px; aspect-ratio: 1; border: 2px solid rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
.square { display: flex; justify-content: center; align-items: center; font-size: 40px; cursor: pointer; position: relative; transition: all 0.2s ease; }
.square.dark { background: var(--board-dark); } .square.light { background: var(--board-light); }
.square.selected { background: var(--highlight) !important; box-shadow: inset 0 0 20px var(--primary); }
.square.in-check { background: var(--check-highlight) !important; box-shadow: inset 0 0 30px var(--accent); animation: pulseCheck 1s infinite alternate; }

.square.valid-move::before { content: ''; position: absolute; width: 25%; height: 25%; background: var(--primary); border-radius: 50%; opacity: 0.7; box-shadow: 0 0 15px var(--primary); z-index: 5; pointer-events: none; }
.square.valid-capture::before { content: ''; position: absolute; width: 85%; height: 85%; background: transparent; border: 4px solid var(--danger); border-radius: 50%; opacity: 0.8; box-shadow: 0 0 15px var(--danger); z-index: 5; pointer-events: none; }

.piece { text-shadow: 0 5px 10px rgba(0,0,0,0.8); cursor: pointer; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 10; font-family: 'Segoe UI Symbol', sans-serif; }
.piece:hover { transform: scale(1.15) translateY(-5px); }
.piece.white { color: #ffffff; text-shadow: 0 0 15px rgba(255,255,255,0.5), 0 5px 15px rgba(0,0,0,0.9); }
.piece.black { color: #000000; -webkit-text-stroke: 1px rgba(255, 0, 122, 0.5); text-shadow: 0 0 10px rgba(255,0,122,0.4), 0 5px 15px rgba(0,0,0,0.9); }

/* === MODALLAR === */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; z-index: 2000; }
.modal-card { width: 90%; max-width: 420px; background: var(--bg-surface); padding: 40px 30px; border-radius: 24px; border: 1px solid var(--glass-border); text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 30px rgba(0,240,255,0.1); position: relative; overflow: hidden; }
.radar { width: 70px; height: 70px; border: 3px solid var(--primary); border-radius: 50%; position: relative; animation: pulseRadar 2s infinite; margin: 0 auto; }
.radar::after { content:''; position: absolute; width: 100%; height: 100%; background: conic-gradient(transparent, var(--primary)); border-radius: 50%; animation: spin 2s linear infinite; }
@keyframes spin { 100% { transform: rotate(360deg); } }
@keyframes pulseRadar { 0% { box-shadow: 0 0 0 0 var(--primary-glow); } 100% { box-shadow: 0 0 0 25px transparent; } }
#countdown { font-size: 80px; font-weight: 900; color: var(--primary); text-shadow: 0 0 40px var(--primary-glow); margin-top: 10px; }

@media(max-width: 768px) {
    .lobby-container { grid-template-columns: 1fr; margin-top: 80px; }
    .square { font-size: 32px; } .board-wrapper{ padding: 15px; } .coords-h, .coords-v { font-size: 8px; }
}
</style>
</head>
<body>

<header class="top-bar">
    <div class="back-btn" id="lobbyBackBtn"><i class="fa-solid fa-chevron-left"></i> Ana Lobi</div>
    <div class="brand-3d">NEON CHESS</div>
    <div class="balance-pill"><i class="fa-solid fa-gem"></i> <span id="userBal">0</span></div>
</header>

<div class="lobby-container" id="lobbyArea">
    <div class="create-room-panel">
        <i class="fa-solid fa-chess-knight" style="font-size: 50px; color: var(--primary); margin-bottom: 20px; filter: drop-shadow(0 0 15px var(--primary));"></i>
        <h2>YENİ ARENA KUR</h2>
        <p style="color:var(--text-secondary); font-size:13px; margin-bottom:25px; line-height: 1.5;">Kendi odanı kur ve diğer ajanların sana meydan okumasını bekle.</p>
        <input type="number" id="betAmount" class="bet-input" placeholder="MC Miktarı" min="100" step="100">
        <button class="btn" id="createRoomAction">ODAYI OLUŞTUR</button>
    </div>

    <div class="rooms-panel">
        <div class="rooms-header">
            <h3><span class="live-pulse"></span> AÇIK ODALAR (CANLI)</h3>
        </div>
        <div class="room-list" id="roomList">
            <div class="empty-lobby">Odalar taranıyor...</div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="statusModal">
    <div class="modal-card">
        <div id="waitingArea" style="display:none;">
            <div class="radar"></div>
            <h3 style="color:var(--primary); margin-top:25px; font-weight:900;">Ajan Bekleniyor...</h3>
            <p style="color:var(--text-secondary); font-size:14px; margin-top:10px;">Odanız canlı lobiye yansıtıldı.</p>
            <button class="btn btn-cancel" id="cancelRoomAction">ODAYI KAPAT</button>
        </div>
        <div id="countdownArea" style="display:none;">
            <h3 style="color:#fff; margin-bottom:10px; font-weight:900;">SİSTEM EŞLEŞTİ!</h3>
            <div id="countdown">3</div>
        </div>
    </div>
</div>

<div class="game-container" id="gameArea">
    <div class="status-panel">
        <div class="player-box"><div class="player-name" id="playerTop">Rakip</div></div>
        <div class="pool-amount"><span>Ödül Havuzu</span><div id="poolAmount">0</div></div>
    </div>
    
    <div class="board-wrapper">
        <div class="coords-h top" id="coordHt"></div><div class="coords-v left" id="coordVl"></div>
        <div class="chessboard" id="board"></div>
        <div class="coords-v right" id="coordVr"></div><div class="coords-h bottom" id="coordHb"></div>
    </div>

    <div class="status-panel" style="margin-top: 15px;">
        <div class="player-box"><div class="player-name active" id="playerBottom">Sen</div></div>
        <div id="turnIndicator">Bekleniyor</div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, collection, addDoc, updateDoc, onSnapshot, query, where, getDocs, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// === GLOBAL STATE ===
const game = new Chess();
const boardEl = document.getElementById('board');
const sfx = {
    move: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3'),
    capture: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/capture.mp3'),
    check: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-check.mp3'),
    start: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/notify.mp3'),
    end: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-end.mp3')
};
const pieceUnicode = { 'p':'♟', 'n':'♞', 'b':'♝', 'r':'♜', 'q':'♛', 'k':'♚', 'P':'♙', 'N':'♘', 'B':'♗', 'R':'♖', 'Q':'♕', 'K':'♔' };

let myColor = 'w';
let currentRoomId = null;
let myUsername = "";
let myBalance = 0;
let selectedSquare = null;
let validMoves = [];
let lobbySub = null;
let roomSub = null;

// === AUTH & LOBBY ===
onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    const uDoc = await getDoc(doc(db, "users", user.uid));
    const data = uDoc.data();
    myUsername = data.username || "Ajan";
    myBalance = data.balance || 0;
    document.getElementById("userBal").innerText = myBalance.toLocaleString();
    initLobby();
});

function initLobby() {
    const q = query(collection(db, "chess_rooms"), where("status", "==", "waiting"));
    lobbySub = onSnapshot(q, (snap) => {
        const list = document.getElementById('roomList');
        list.innerHTML = '';
        if(snap.empty) {
            list.innerHTML = '<div class="empty-lobby">Açık oda yok. İlkini sen kur!</div>';
            return;
        }
        snap.forEach(d => {
            const data = d.data();
            if(data.whiteId === auth.currentUser.uid) return;
            const card = document.createElement('div');
            card.className = 'room-card';
            card.innerHTML = `
                <div class="room-info"><h4>${data.whiteName}</h4><p>ID: #${d.id.slice(0,6)}</p></div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="room-bet">${data.bet} MC</div>
                    <button class="btn btn-join join-action" data-id="${d.id}" data-bet="${data.bet}">KATIL</button>
                </div>`;
            list.appendChild(card);
        });
        
        // Event delegation for join buttons
        document.querySelectorAll('.join-action').forEach(btn => {
            btn.onclick = () => joinRoom(btn.dataset.id, parseInt(btn.dataset.bet));
        });
    });
}

// === ODA İŞLEMLERİ (CREATE / JOIN / CANCEL) ===
async function createRoom() {
    const bet = parseInt(document.getElementById('betAmount').value);
    if (!bet || bet < 100) { alert("Min 100 MC!"); return; }
    if (myBalance < bet) { alert("Yetersiz bakiye!"); return; }

    try {
        const docRef = await addDoc(collection(db, "chess_rooms"), {
            whiteId: auth.currentUser.uid,
            whiteName: myUsername,
            status: "waiting",
            bet: bet,
            fen: game.fen(),
            turn: 'w',
            createdAt: Date.now()
        });
        currentRoomId = docRef.id;
        myColor = 'w';
        
        document.getElementById('statusModal').style.display = 'flex';
        document.getElementById('waitingArea').style.display = 'block';
        
        roomSub = onSnapshot(doc(db, "chess_rooms", currentRoomId), (s) => {
            const data = s.data();
            if(data && data.status === "playing") startCountdown(data);
        });
    } catch (e) { console.error(e); alert("Oda kurulamadı!"); }
}

async function joinRoom(roomId, bet) {
    if (myBalance < bet) { alert("Yetersiz bakiye!"); return; }
    try {
        await updateDoc(doc(db, "chess_rooms", roomId), {
            blackId: auth.currentUser.uid,
            blackName: myUsername,
            status: "playing"
        });
        currentRoomId = roomId;
        myColor = 'b';
        const s = await getDoc(doc(db, "chess_rooms", roomId));
        startCountdown(s.data());
    } catch (e) { alert("Odaya girilemedi!"); }
}

async function cancelRoom() {
    if(currentRoomId && myColor === 'w') {
        if(roomSub) roomSub();
        await deleteDoc(doc(db, "chess_rooms", currentRoomId));
        currentRoomId = null;
    }
    document.getElementById('statusModal').style.display = 'none';
    document.getElementById('waitingArea').style.display = 'none';
}

// === GAMEPLAY ===
function startCountdown(data) {
    sfx.start.play();
    document.getElementById('waitingArea').style.display = 'none';
    document.getElementById('countdownArea').style.display = 'block';
    let c = 3;
    const t = setInterval(() => {
        c--;
        document.getElementById('countdown').innerText = c > 0 ? c : "GO!";
        if(c < 0) { clearInterval(t); setupGame(data); }
    }, 1000);
}

function setupGame(data) {
    document.getElementById('statusModal').style.display = 'none';
    document.getElementById('lobbyArea').style.display = 'none';
    document.getElementById('gameArea').style.display = 'flex';
    
    document.getElementById('playerTop').innerText = myColor === 'w' ? data.blackName : data.whiteName;
    document.getElementById('playerBottom').innerText = myUsername + ` (${myColor === 'w' ? 'B' : 'S'})`;
    document.getElementById('poolAmount').innerText = (data.bet * 2) + " MC";

    drawCoords();
    onSnapshot(doc(db, "chess_rooms", currentRoomId), (s) => {
        const d = s.data();
        if(d && d.fen !== game.fen()) {
            game.load(d.fen);
            game.in_check() ? sfx.check.play() : sfx.move.play();
            renderBoard();
        }
    });
    renderBoard();
}

function drawCoords() {
    const l = myColor === 'w' ? ['A','B','C','D','E','F','G','H'] : ['H','G','F','E','D','C','B','A'];
    const n = myColor === 'w' ? ['8','7','6','5','4','3','2','1'] : ['1','2','3','4','5','6','7','8'];
    document.getElementById('coordHt').innerHTML = document.getElementById('coordHb').innerHTML = l.map(x => `<span>${x}</span>`).join('');
    document.getElementById('coordVl').innerHTML = document.getElementById('coordVr').innerHTML = n.map(x => `<span>${x}</span>`).join('');
}

function renderBoard() {
    boardEl.innerHTML = '';
    const b = game.board();
    const rows = myColor === 'b' ? [7,6,5,4,3,2,1,0] : [0,1,2,3,4,5,6,7];
    const cols = myColor === 'b' ? [7,6,5,4,3,2,1,0] : [0,1,2,3,4,5,6,7];
    
    let checkSq = null;
    if(game.in_check()) {
        const turn = game.turn();
        for(let r=0; r<8; r++) for(let c=0; c<8; c++)
            if(b[r][c]?.type === 'k' && b[r][c]?.color === turn) checkSq = String.fromCharCode(97+c) + (8-r);
    }

    rows.forEach(r => {
        cols.forEach(c => {
            const id = String.fromCharCode(97+c) + (8-r);
            const p = b[r][c];
            const sq = document.createElement('div');
            sq.className = `square ${(r+c)%2 ? 'dark' : 'light'}`;
            if(selectedSquare === id) sq.classList.add('selected');
            if(checkSq === id) sq.classList.add('in-check');
            const mv = validMoves.find(x => x.to === id);
            if(mv) sq.classList.add(p ? 'valid-capture' : 'valid-move');
            
            if(p) {
                const pEl = document.createElement('div');
                pEl.className = `piece ${p.color === 'w' ? 'white' : 'black'}`;
                pEl.innerText = pieceUnicode[p.color === 'w' ? p.type.toUpperCase() : p.type];
                sq.appendChild(pEl);
            }
            sq.onclick = () => handleSq(id);
            boardEl.appendChild(sq);
        });
    });
    const ind = document.getElementById('turnIndicator');
    ind.innerText = game.turn() === myColor ? "SIRA SENDE" : "RAKİPTE";
}

async function handleSq(id) {
    if(game.turn() !== myColor || game.game_over()) return;
    const mv = validMoves.find(x => x.to === id);
    if(mv) {
        const cap = mv.flags.includes('c') || mv.flags.includes('e');
        game.move(mv);
        selectedSquare = null; validMoves = [];
        renderBoard();
        cap ? sfx.capture.play() : sfx.move.play();
        await updateDoc(doc(db, "chess_rooms", currentRoomId), { fen: game.fen(), turn: game.turn() });
        if(game.game_over()) { sfx.end.play(); alert("Oyun Bitti!"); }
    } else {
        const p = game.get(id);
        if(p?.color === myColor) {
            selectedSquare = id; validMoves = game.moves({ square: id, verbose: true });
        } else { selectedSquare = null; validMoves = []; }
        renderBoard();
    }
}

// === ACTIONS BINDING ===
document.getElementById('createRoomAction').onclick = createRoom;
document.getElementById('cancelRoomAction').onclick = cancelRoom;
document.getElementById('lobbyBackBtn').onclick = () => window.location.reload();
</script>
</body>
</html>
