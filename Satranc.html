<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PlayMatrix | Neon Chess Arena</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<style>
/* PlayMatrix Ana Değişkenleri */
:root {
    --primary: #00f0ff;
    --primary-glow: rgba(0, 240, 255, 0.5);
    --secondary: #0055ff;
    --accent: #ff007a;
    --bg-main: #04060b;
    --bg-surface: #0a0e17;
    --glass-bg: rgba(10, 14, 23, 0.75);
    --glass-border: rgba(255, 255, 255, 0.08);
    --text-primary: #ffffff;
    --text-secondary: #94a3b8;
    --success: #00ffa3;
    --danger: #ff4d4d;
    --board-dark: rgba(0, 85, 255, 0.15);
    --board-light: rgba(255, 255, 255, 0.05);
    --highlight: rgba(0, 240, 255, 0.4);
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; user-select: none; }
body { background: var(--bg-main); color: var(--text-primary); overflow-x: hidden; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

/* Üst Bar */
.top-bar { width: 100%; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--glass-bg); backdrop-filter: blur(25px); border-bottom: 1px solid var(--glass-border); z-index: 100; }
.back-btn { color: var(--text-primary); text-decoration: none; font-size: 20px; transition: 0.3s; }
.back-btn:hover { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }
.brand-3d { font-family: 'Montserrat', sans-serif; font-size: 20px; font-weight: 900; color: var(--text-primary); text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 2px 0 var(--secondary), 0 0 20px var(--primary-glow); }

/* Oyun Ekranı ve Satranç Tahtası */
.game-container { display: flex; flex-direction: column; align-items: center; margin-top: 30px; width: 100%; max-width: 600px; padding: 20px; }
.status-panel { width: 100%; display: flex; justify-content: space-between; margin-bottom: 20px; background: var(--bg-surface); padding: 15px; border-radius: 15px; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
.player-info { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 14px; }
.player-info.active { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }

.board-wrapper { position: relative; padding: 10px; background: var(--bg-surface); border-radius: 10px; border: 1px solid var(--glass-border); box-shadow: 0 0 30px rgba(0,0,0,0.6), 0 0 15px var(--primary-glow); }
.chessboard { display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); width: 100%; max-width: 500px; aspect-ratio: 1; border: 2px solid var(--primary); border-radius: 4px; overflow: hidden; }

.square { display: flex; justify-content: center; align-items: center; font-size: 35px; cursor: pointer; position: relative; transition: background 0.2s; }
.square.dark { background: var(--board-dark); }
.square.light { background: var(--board-light); }
.square.selected { background: var(--highlight); box-shadow: inset 0 0 15px var(--primary); }
.square.valid-move::after { content: ''; position: absolute; width: 15px; height: 15px; background: var(--primary); border-radius: 50%; opacity: 0.6; box-shadow: 0 0 10px var(--primary); }

/* Taş Tasarımları (Neon Efektli Unicode) */
.piece { text-shadow: 0 5px 10px rgba(0,0,0,0.8); cursor: pointer; transition: transform 0.2s; z-index: 10; }
.piece:hover { transform: scale(1.1); }
.piece.white { color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.6), 0 5px 10px rgba(0,0,0,0.8); }
.piece.black { color: #111; text-shadow: 0 0 5px rgba(255,0,122,0.8), 0 5px 10px rgba(0,0,0,0.8); -webkit-text-stroke: 1px var(--accent); }

/* Eşleştirme Modalı */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.modal-card { width: 90%; max-width: 400px; background: var(--bg-surface); padding: 30px; border-radius: 20px; border: 1px solid var(--primary); text-align: center; box-shadow: 0 0 40px var(--primary-glow); }
.modal-card h2 { margin-bottom: 20px; color: var(--primary); }
.bet-input { width: 100%; padding: 15px; margin-bottom: 20px; background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); color: #fff; border-radius: 10px; font-size: 16px; text-align: center; outline: none; }
.bet-input:focus { border-color: var(--primary); }
.btn { width: 100%; padding: 15px; border-radius: 10px; border: none; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #fff; font-weight: 800; cursor: pointer; transition: 0.3s; font-size: 16px; }
.btn:hover { box-shadow: 0 0 20px var(--primary-glow); transform: translateY(-2px); }

@media(max-width: 600px) { .square { font-size: 28px; } }
</style>
</head>
<body>

<header class="top-bar">
    <a href="index.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Lobi</a>
    <div class="brand-3d">NEON CHESS</div>
    <div style="font-weight:800; color:var(--success)"><span id="userBal">0</span> MC</div>
</header>

<div class="modal-overlay" id="matchmakingModal">
    <div class="modal-card">
        <h2><i class="fa-solid fa-chess-knight"></i> Arena Eşleştirme</h2>
        <p style="color:var(--text-secondary); margin-bottom:20px; font-size:14px;">Ortaya koymak istediğiniz MC miktarını girin veya bekleyen bir rakibe katılın.</p>
        <input type="number" id="betAmount" class="bet-input" placeholder="MC Miktarı (Örn: 1000)" min="100">
        <button class="btn" id="findMatchBtn">RAKİP BUL VEYA ODA KUR</button>
        <p id="matchStatus" style="margin-top:15px; color:var(--accent); font-weight:600; font-size:14px;"></p>
    </div>
</div>

<div class="game-container" style="display:none;" id="gameArea">
    <div class="status-panel">
        <div class="player-info" id="playerTop"><i class="fa-solid fa-user"></i> Rakip Bekleniyor...</div>
        <div class="player-info" style="color: var(--primary);"><i class="fa-solid fa-coins"></i> <span id="poolAmount">0</span> MC</div>
        <div class="player-info active" id="playerBottom"><i class="fa-solid fa-user-astronaut"></i> Sen</div>
    </div>
    
    <div class="board-wrapper">
        <div class="chessboard" id="board"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, collection, addDoc, updateDoc, onSnapshot, query, where, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const game = new Chess();
const boardEl = document.getElementById('board');
let myColor = 'w';
let currentRoomId = null;
let selectedSquare = null;
let validMoves = [];

const pieceUnicode = {
    'p': '♟', 'n': '♞', 'b': '♝', 'r': '♜', 'q': '♛', 'k': '♚',
    'P': '♙', 'N': '♘', 'B': '♗', 'R': '♖', 'Q': '♕', 'K': '♔'
};

// --- KULLANICI KONTROLÜ ---
onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    const userDoc = await getDoc(doc(db, "users", user.uid));
    document.getElementById("userBal").innerText = userDoc.data().balance.toLocaleString();
});

// --- TAHTA ÇİZİMİ ---
function renderBoard() {
    boardEl.innerHTML = '';
    const board = game.board();
    
    // Siyah oyuncuysa tahtayı ters çevir (Kendi taşları altta olsun)
    const rows = myColor === 'b' ? [7,6,5,4,3,2,1,0] : [0,1,2,3,4,5,6,7];
    const cols = myColor === 'b' ? [7,6,5,4,3,2,1,0] : [0,1,2,3,4,5,6,7];

    rows.forEach(r => {
        cols.forEach(c => {
            const squareId = String.fromCharCode(97 + c) + (8 - r);
            const piece = board[r][c];
            const isDark = (r + c) % 2 === 1;
            
            const sqEl = document.createElement('div');
            sqEl.className = `square ${isDark ? 'dark' : 'light'}`;
            sqEl.dataset.square = squareId;

            if (selectedSquare === squareId) sqEl.classList.add('selected');
            if (validMoves.some(m => m.to === squareId)) sqEl.classList.add('valid-move');

            if (piece) {
                const pEl = document.createElement('div');
                const pType = piece.color === 'w' ? piece.type.toUpperCase() : piece.type.toLowerCase();
                pEl.className = `piece ${piece.color === 'w' ? 'white' : 'black'}`;
                pEl.innerText = pieceUnicode[pType];
                sqEl.appendChild(pEl);
            }

            sqEl.onclick = () => handleSquareClick(squareId);
            boardEl.appendChild(sqEl);
        });
    });
}

// --- HAMLE MANTIĞI ---
async function handleSquareClick(square) {
    if (game.turn() !== myColor) return; // Sıra bende değilse çık
    
    const isMove = validMoves.find(m => m.to === square);
    
    if (isMove) {
        // Hamleyi yap
        game.move(isMove);
        selectedSquare = null;
        validMoves = [];
        renderBoard();
        
        // Firebase'i güncelle
        await updateDoc(doc(db, "chess_rooms", currentRoomId), {
            fen: game.fen(),
            turn: game.turn(),
            lastMove: Date.now()
        });

        checkGameOver();
    } else {
        // Taş seçimi
        const piece = game.get(square);
        if (piece && piece.color === myColor) {
            selectedSquare = square;
            validMoves = game.moves({ square: square, verbose: true });
        } else {
            selectedSquare = null;
            validMoves = [];
        }
        renderBoard();
    }
}

function checkGameOver() {
    if (game.game_over()) {
        let msg = "Oyun Bitti! Berabere.";
        if (game.in_checkmate()) {
            msg = game.turn() === myColor ? "Mat oldun! Kaybettin." : "ŞAH MAT! Kazandın.";
            // Not: Gerçek sistemde MC dağıtımı Cloud Functions üzerinden yapılmalıdır.
        }
        setTimeout(() => alert(msg), 500);
    }
}

// --- EŞLEŞTİRME SİSTEMİ (MATCHMAKING) ---
document.getElementById('findMatchBtn').onclick = async () => {
    const betStr = document.getElementById('betAmount').value;
    const bet = parseInt(betStr);
    const statusEl = document.getElementById('matchStatus');
    const user = auth.currentUser;

    if (!bet || bet < 100) { statusEl.innerText = "Minimum 100 MC girmelisiniz."; return; }
    
    // Bakiyeyi kontrol et (basit client-side kontrol)
    const uDoc = await getDoc(doc(db, "users", user.uid));
    if (uDoc.data().balance < bet) { statusEl.innerText = "Yetersiz Bakiye!"; return; }

    statusEl.innerText = "Ağ taranıyor... Uygun rakip aranıyor...";
    
    // Açık oda ara
    const roomsRef = collection(db, "chess_rooms");
    const q = query(roomsRef, where("status", "==", "waiting"), where("bet", "==", bet));
    const querySnapshot = await getDocs(q);

    if (!querySnapshot.empty) {
        // Odaya Siyah olarak katıl
        const roomDoc = querySnapshot.docs[0];
        currentRoomId = roomDoc.id;
        myColor = 'b';
        await updateDoc(doc(db, "chess_rooms", currentRoomId), {
            blackId: user.uid,
            status: "playing"
        });
        startGame();
    } else {
        // Yeni oda kur ve Beyaz olarak bekle
        const newRoom = await addDoc(roomsRef, {
            whiteId: user.uid,
            blackId: null,
            status: "waiting",
            bet: bet,
            fen: game.fen(),
            turn: 'w',
            createdAt: Date.now()
        });
        currentRoomId = newRoom.id;
        myColor = 'w';
        statusEl.innerText = "Oda kuruldu. Rakip bekleniyor...";
        startGame(); // Tahtayı aç ama hamle yapılamaz
    }
};

function startGame() {
    document.getElementById('matchmakingModal').style.display = 'none';
    document.getElementById('gameArea').style.display = 'flex';
    
    // Firebase dinleyicisini başlat
    onSnapshot(doc(db, "chess_rooms", currentRoomId), (snapshot) => {
        const data = snapshot.data();
        
        // Rakip katıldıysa UI güncelle
        if(data.status === "playing") {
            document.getElementById('playerTop').innerHTML = `<i class="fa-solid fa-user-ninja"></i> Rakip Bağa Bağlandı`;
            document.getElementById('poolAmount').innerText = (data.bet * 2).toLocaleString();
        }

        // FEN (Tahta durumu) güncellendiyse senkronize et
        if(data.fen && data.fen !== game.fen()) {
            game.load(data.fen);
            renderBoard();
            checkGameOver();
        }
    });

    renderBoard();
}
</script>
</body>
</html>
