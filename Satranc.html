<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<title>PlayMatrix | Ultra Satranç Arenası</title>
<meta name="description" content="Dünyanın en gelişmiş siberpunk satranç arenası. Hile korumalı, ultra profesyonel altyapı ile rakiplerini yen, MC ödüllerini topla!">
<meta name="keywords" content="online satranç, neon chess, multiplayer satranç oyna, playmatrix, mc kazan">
<meta name="theme-color" content="#04060b">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Montserrat:wght@800;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<style>
/* === GELİŞMİŞ TEMA DEĞİŞKENLERİ === */
:root {
    --primary: #00f0ff;
    --primary-glow: rgba(0, 240, 255, 0.5);
    --secondary: #0055ff;
    --accent: #ff007a;
    --bg-main: #04060b;
    --bg-surface: rgba(10, 14, 23, 0.95);
    --glass-border: rgba(255, 255, 255, 0.1);
    --text-primary: #ffffff;
    --text-secondary: #94a3b8;
    --success: #00ffa3;
    --danger: #ff4d4d;
    
    /* Profesyonel Satranç Tahtası Renkleri (Göz Yormayan) */
    --board-dark: #4b7399; 
    --board-light: #eae9d2;
    --highlight-move: rgba(0, 240, 255, 0.6);
    --highlight-check: rgba(255, 0, 122, 0.8);
}

/* === SIFIR HAREKET & SIFIR ZOOM KORUMASI === */
html, body { 
    margin: 0; padding: 0; box-sizing: border-box; 
    width: 100vw; height: 100vh; /* Tam ekran sabitlik */
    overflow: hidden; /* Sayfanın aşağı kaymasını engeller */
    background: radial-gradient(circle at top, #0a1128 0%, var(--bg-main) 100%); 
    color: var(--text-primary); font-family: 'Inter', sans-serif; 
    user-select: none; -webkit-tap-highlight-color: transparent;
    touch-action: none; /* Mobilde her türlü zoom ve kaydırmayı donanımsal engeller */
}

/* === ÜST BAR (SABİT) === */
.top-bar { 
    width: 100%; height: 70px; display: flex; align-items: center; justify-content: space-between; 
    padding: 0 15px; background: rgba(4, 6, 11, 0.95); backdrop-filter: blur(20px); 
    border-bottom: 1px solid var(--glass-border); z-index: 1000; flex-shrink: 0;
}
.brand-3d { font-family: 'Montserrat', sans-serif; font-size: 18px; font-weight: 900; letter-spacing: 2px; text-shadow: 0 0 15px var(--primary-glow); }
.back-btn { color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 5px; cursor: pointer; transition: 0.3s; }
.back-btn:hover { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }
.balance-pill { background: rgba(0,255,163,0.1); border: 1px solid rgba(0,255,163,0.3); padding: 5px 12px; border-radius: 20px; font-weight: 900; color: var(--success); display: flex; align-items: center; gap: 6px; font-family: 'JetBrains Mono', monospace; }

/* === ANA TAŞIYICI (SCROLL YALNIZCA LOBİ LİSTESİNDE) === */
.main-container { 
    width: 100%; height: calc(100vh - 70px); 
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    position: relative;
}

/* === FERAH LOBİ TASARIMI === */
.lobby-area {
    width: 100%; max-width: 900px; padding: 20px; 
    display: grid; grid-template-columns: 1fr 1.5fr; gap: 25px;
    height: 100%; overflow-y: auto; /* Lobi uzunsa kendi içinde kayar */
    touch-action: pan-y; /* Lobi içinde yukarı aşağı kaydırmaya izin ver */
}
.lobby-area::-webkit-scrollbar { width: 6px; } .lobby-area::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

.panel { background: var(--bg-surface); border-radius: 24px; border: 1px solid var(--glass-border); padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
.panel-title { display: flex; align-items: center; gap: 10px; color: #fff; font-size: 18px; font-weight: 900; margin-bottom: 20px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; }

.bet-input { width: 100%; padding: 18px; margin-bottom: 20px; background: rgba(0,0,0,0.6); border: 2px solid var(--glass-border); color: var(--primary); border-radius: 14px; text-align: center; font-size: 22px; font-weight: 900; outline: none; transition: 0.3s; }
.bet-input:focus { border-color: var(--primary); box-shadow: 0 0 20px var(--primary-glow); }

.room-list { display: flex; flex-direction: column; gap: 15px; }
.room-card { 
    background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(0,240,255,0.05)); 
    border: 1px solid var(--glass-border); border-left: 4px solid var(--primary); 
    border-radius: 16px; padding: 20px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; 
}
.room-card:hover { transform: translateX(5px); border-color: var(--primary); box-shadow: 0 5px 20px rgba(0,240,255,0.15); }
.room-info h4 { font-size: 16px; font-weight: 800; color: #fff; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
.room-info p { font-size: 12px; color: var(--text-secondary); font-weight: 600; font-family: 'JetBrains Mono', monospace; }
.room-bet { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 900; color: var(--success); text-shadow: 0 0 10px rgba(0,255,163,0.4); }

/* === OYUN ALANI (SIFIR TİTREŞİM, SABİT TAHTA) === */
.game-area { 
    display: none; width: 100%; height: 100%; flex-direction: column; 
    align-items: center; justify-content: center; padding: 10px;
}
.status-bar { 
    width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; 
    background: var(--bg-surface); padding: 12px 20px; border-radius: 12px; border: 1px solid var(--glass-border); 
    box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 10;
}
.player-name { font-weight: 800; font-size: 14px; display: flex; align-items: center; gap: 8px; color: var(--text-secondary); transition: 0.3s; }
.player-name.active { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }

/* SATRANÇ TAHTASI */
.board-wrapper {
    width: 100%; max-width: 500px; aspect-ratio: 1; /* Kare oranını kesin korur */
    background: #000; border: 4px solid var(--glass-border); border-radius: 8px; 
    box-shadow: 0 0 40px rgba(0,0,0,0.8); margin: 15px 0;
    display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr);
    overflow: hidden;
}
.square { display: flex; justify-content: center; align-items: center; position: relative; cursor: pointer; }
.square.dark { background: var(--board-dark); }
.square.light { background: var(--board-light); }
.square.selected { background: var(--highlight-move) !important; box-shadow: inset 0 0 20px var(--primary); }
.square.in-check { background: var(--highlight-check) !important; box-shadow: inset 0 0 30px var(--accent); }

/* Geçerli Hamle Göstergeleri (Merkezde Nokta veya Çerçeve) */
.square.valid-move::after { content: ''; position: absolute; width: 25%; height: 25%; background: rgba(0, 255, 163, 0.6); border-radius: 50%; box-shadow: 0 0 10px var(--success); pointer-events: none; z-index: 5; }
.square.valid-capture::after { content: ''; position: absolute; width: 85%; height: 85%; background: transparent; border: 4px solid var(--danger); border-radius: 50%; box-shadow: 0 0 10px var(--danger); pointer-events: none; z-index: 5; }

/* GERÇEKÇİ SVG TAŞLAR (Asla tıklamayı engellemez) */
.piece { width: 90%; height: 90%; object-fit: contain; pointer-events: none; z-index: 10; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.6)); }

/* === ÖZEL MATRİX MODALLAR (ALERT YERİNE) === */
.modal-overlay { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); 
    display: none; align-items: center; justify-content: center; z-index: 5000; 
}
.modal-card { 
    width: 90%; max-width: 400px; background: var(--bg-surface); padding: 40px 30px; 
    border-radius: 24px; border: 1px solid var(--glass-border); text-align: center; 
    box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 30px rgba(0,240,255,0.1); 
}
.modal-icon { font-size: 50px; margin-bottom: 20px; filter: drop-shadow(0 0 15px rgba(0, 240, 255, 0.5)); }

/* BUTONLAR */
.btn { width: 100%; padding: 16px; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #fff; font-weight: 900; font-size: 14px; letter-spacing: 1px; cursor: pointer; transition: 0.3s; text-transform: uppercase; box-shadow: 0 10px 20px rgba(0, 85, 255, 0.4); }
.btn:hover { transform: translateY(-3px); box-shadow: 0 15px 30px var(--primary-glow); }
.btn-join { width: auto; padding: 10px 25px; font-size: 13px; margin: 0; }
.btn-danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); box-shadow: none; margin-top: 15px; }

/* Radar Animasyonu */
.radar { width: 60px; height: 60px; border: 2px solid var(--primary); border-radius: 50%; position: relative; animation: pulseRadar 2s infinite; margin: 0 auto 20px; }
.radar::after { content:''; position: absolute; width: 100%; height: 100%; background: conic-gradient(transparent, var(--primary)); border-radius: 50%; animation: spin 2s linear infinite; }
@keyframes spin { 100% { transform: rotate(360deg); } }
@keyframes pulseRadar { 0% { box-shadow: 0 0 0 0 var(--primary-glow); } 100% { box-shadow: 0 0 0 25px transparent; } }

#countdownText { font-size: 80px; font-weight: 900; color: var(--primary); text-shadow: 0 0 40px var(--primary-glow); }

/* Mobil Düzenlemeler */
@media(max-width: 768px) { 
    .lobby-area { grid-template-columns: 1fr; } 
    .top-bar { height: 60px; }
    .main-container { height: calc(100vh - 60px); }
}
</style>
</head>
<body>

<header class="top-bar">
    <div class="back-btn" onclick="leaveToLobby()"><i class="fa-solid fa-chevron-left"></i> LOBİ</div>
    <div class="brand-3d">NEON CHESS</div>
    <div class="balance-pill"><i class="fa-solid fa-gem"></i> <span id="userBal">0</span></div>
</header>

<div class="main-container">
    
    <div class="lobby-area" id="lobbyArea">
        <div class="panel" style="text-align: center; height: fit-content;">
            <i class="fa-solid fa-chess-knight" style="font-size: 50px; color: var(--primary); margin-bottom: 15px; filter: drop-shadow(0 0 15px var(--primary));"></i>
            <h2 style="color:#fff; font-weight:900; font-size: 20px; letter-spacing: 1px;">YENİ SAVAŞ KUR</h2>
            <p style="color:var(--text-secondary); font-size:13px; margin: 15px 0;">Odanızı kurun ve diğer ajanların meydan okumasını bekleyin.</p>
            <input type="number" id="betAmount" class="bet-input" value="500" min="100" step="100">
            <button class="btn" id="btnCreateRoom">ODAYI OLUŞTUR</button>
        </div>

        <div class="panel">
            <div class="panel-title">
                <span style="display:inline-block; width:10px; height:10px; background:var(--danger); border-radius:50%; box-shadow:0 0 10px var(--danger); animation: pulse 1s infinite alternate;"></span>
                CANLI ODALAR
            </div>
            <div class="room-list" id="roomList">
                <div style="text-align:center; padding:30px; color:var(--text-secondary);">Ağ taranıyor...</div>
            </div>
        </div>
    </div>

    <div class="game-area" id="gameArea">
        <div class="status-bar">
            <div class="player-name" id="playerTop"><i class="fa-solid fa-user-ninja"></i> Rakip Ajan</div>
            <div style="font-family: 'JetBrains Mono', monospace; font-weight:900; color:var(--success); font-size: 16px;"><span id="poolAmount">0</span> MC</div>
        </div>
        
        <div class="board-wrapper" id="board"></div>

        <div class="status-bar" style="margin-top: 15px;">
            <div class="player-name active" id="playerBottom"><i class="fa-solid fa-user-astronaut"></i> Sen</div>
            <div id="turnIndicator" style="font-size: 12px; font-weight: 900; background:rgba(255,255,255,0.05); padding:5px 10px; border-radius:8px;">BAĞLANTI KURULUYOR</div>
        </div>
    </div>

</div>

<div class="modal-overlay" id="systemModal">
    <div class="modal-card">
        <div id="modalIcon" class="modal-icon"><i class="fa-solid fa-circle-info" style="color:var(--primary)"></i></div>
        <h2 id="modalTitle" style="color:#fff; font-weight:900; font-size:22px; margin-bottom:10px;">SİSTEM MESAJI</h2>
        <p id="modalBody" style="color:var(--text-secondary); font-size:14px; margin-bottom:20px; line-height: 1.5;"></p>
        <div id="modalButtons">
            <button class="btn" onclick="closeModal()">ANLAŞILDI</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="waitModal">
    <div class="modal-card">
        <div id="waitContent">
            <div class="radar"></div>
            <h3 style="color:var(--primary); font-weight:900;">Ajan Bekleniyor...</h3>
            <p style="color:var(--text-secondary); font-size:13px; margin-top:10px;">Odanız canlı lobiye yansıtıldı.</p>
            <button class="btn btn-danger" id="btnCancelRoom">İPTAL ET</button>
        </div>
        <div id="countdownContent" style="display:none;">
            <h3 style="color:#fff; margin-bottom:10px; font-weight:900; letter-spacing:2px;">SİSTEM EŞLEŞTİ!</h3>
            <div id="countdownText">3</div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, collection, addDoc, updateDoc, onSnapshot, query, where, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// === ULTRA PROFESYONEL SES EFEKTLERİ ===
const sfx = {
    move: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3'),
    capture: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/capture.mp3'),
    check: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-check.mp3'),
    start: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/notify.mp3'),
    end: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-end.mp3')
};
function playSFX(type) { try { sfx[type].currentTime = 0; sfx[type].play(); } catch(e){} }

// === OYUN MOTORU & GLOBAL STATE ===
const game = new Chess();
let myColor = 'w', currentRoomId = null, myUsername = "Ajan", myBalance = 0;
let selectedSquare = null, validMoves = [];
let roomListener = null;

// GERÇEKÇİ SVG TAŞ SETİ (Wikipedia Standardı)
const piecesSVG = {
    'wp': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
    'wn': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
    'wb': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
    'wr': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
    'wq': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
    'wk': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg',
    'bp': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
    'bn': 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
    'bb': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
    'br': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
    'bq': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
    'bk': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg'
};

// === MODAL YÖNETİMİ ===
window.showMatrixModal = (title, body, type = 'info', onOk = null) => {
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalBody').innerText = body;
    
    const icon = document.getElementById('modalIcon');
    if(type === 'error') icon.innerHTML = '<i class="fa-solid fa-triangle-exclamation" style="color:var(--danger)"></i>';
    else if(type === 'success') icon.innerHTML = '<i class="fa-solid fa-shield-check" style="color:var(--success)"></i>';
    else icon.innerHTML = '<i class="fa-solid fa-circle-info" style="color:var(--primary)"></i>';

    const btnArea = document.getElementById('modalButtons');
    btnArea.innerHTML = '';
    const okBtn = document.createElement('button');
    okBtn.className = 'btn'; okBtn.innerText = 'ANLAŞILDI';
    okBtn.onclick = () => { closeModal(); if(onOk) onOk(); };
    btnArea.appendChild(okBtn);

    document.getElementById('systemModal').style.display = 'flex';
};
window.closeModal = () => document.getElementById('systemModal').style.display = 'none';

// === AUTH & LOBİ YÜKLEME ===
onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    try {
        const uDoc = await getDoc(doc(db, "users", user.uid));
        const data = uDoc.data();
        myUsername = data.username || "Ajan_" + user.uid.slice(0,4);
        myBalance = data.balance || 0;
        document.getElementById("userBal").innerText = myBalance.toLocaleString();
        initLobby();
    } catch(e) { showMatrixModal("Bağlantı Hatası", "Kullanıcı verileri çekilemedi.", "error"); }
});

function initLobby() {
    const q = query(collection(db, "chess_rooms"), where("status", "==", "waiting"));
    onSnapshot(q, (snap) => {
        const list = document.getElementById('roomList');
        list.innerHTML = '';
        if(snap.empty) { 
            list.innerHTML = `
            <div style="text-align:center; padding:40px 20px; border:1px dashed var(--glass-border); border-radius:15px; color:var(--text-secondary);">
                <i class="fa-solid fa-radar" style="font-size:35px; color:var(--primary-glow); margin-bottom:15px;"></i><br>
                Şu an ağda açık bir oda bulunmuyor.<br>Kendi odanı kurarak savaşı başlat!
            </div>`; 
            return; 
        }
        
        let found = false;
        snap.forEach(d => {
            const data = d.data();
            if(data.whiteId === auth.currentUser.uid) return; // Kendi odasını görmesin
            found = true;
            const card = document.createElement('div');
            card.className = 'room-card';
            card.innerHTML = `
                <div class="room-info"><h4><i class="fa-solid fa-user-shield" style="color:var(--primary)"></i> ${data.whiteName}</h4><p>ID: #${d.id.slice(0,5).toUpperCase()}</p></div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="room-bet">${data.bet.toLocaleString()} MC</div>
                    <button class="btn btn-join join-btn" data-id="${d.id}" data-bet="${data.bet}">KATIL</button>
                </div>`;
            list.appendChild(card);
        });

        if(!found) {
            list.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-secondary); border:1px dashed var(--glass-border); border-radius:15px;">Sadece senin kurduğun oda aktif.<br>Rakip bekleniyor...</div>`;
        } else {
            // Buton Dinleyicileri
            document.querySelectorAll('.join-btn').forEach(btn => {
                btn.onclick = () => joinRoom(btn.dataset.id, parseInt(btn.dataset.bet));
            });
        }
    });
}

// === ODA OLUŞTURMA ===
document.getElementById('btnCreateRoom').onclick = async () => {
    const bet = parseInt(document.getElementById('betAmount').value);
    if (!bet || bet < 100) { showMatrixModal("Geçersiz Miktar", "Minimum 100 MC girmelisiniz.", "error"); return; }
    if (myBalance < bet) { showMatrixModal("Yetersiz Bakiye", "Banka hesabınız bu protokol için yetersiz.", "error"); return; }

    try {
        const docRef = await addDoc(collection(db, "chess_rooms"), {
            whiteId: auth.currentUser.uid,
            whiteName: myUsername,
            status: "waiting",
            bet: bet,
            fen: game.fen(),
            turn: 'w',
            createdAt: Date.now()
        });
        currentRoomId = docRef.id;
        myColor = 'w';
        
        document.getElementById('waitModal').style.display = 'flex';
        document.getElementById('waitContent').style.display = 'block';
        document.getElementById('countdownContent').style.display = 'none';

        roomListener = onSnapshot(doc(db, "chess_rooms", currentRoomId), (s) => {
            if(s.data()?.status === "playing") startCountdown(s.data());
        });
    } catch (e) { showMatrixModal("Kritik Hata", "Oda kurulamadı! Veritabanı yanıt vermiyor.", "error"); }
};

// === ODAYA KATILMA ===
async function joinRoom(roomId, bet) {
    if (myBalance < bet) { showMatrixModal("Yetersiz Bakiye", "Bu odaya girmek için MC'niz yetersiz.", "error"); return; }
    try {
        await updateDoc(doc(db, "chess_rooms", roomId), {
            blackId: auth.currentUser.uid,
            blackName: myUsername,
            status: "playing"
        });
        currentRoomId = roomId;
        myColor = 'b';
        const s = await getDoc(doc(db, "chess_rooms", roomId));
        startCountdown(s.data());
    } catch (e) { showMatrixModal("Bağlantı Koptu", "Odaya girilemedi. Başka bir ajan daha hızlı davranmış olabilir.", "error"); }
}

// === ODA İPTAL ===
document.getElementById('btnCancelRoom').onclick = async () => {
    if(currentRoomId && myColor === 'w') {
        if(roomListener) roomListener();
        await deleteDoc(doc(db, "chess_rooms", currentRoomId));
        currentRoomId = null;
    }
    document.getElementById('waitModal').style.display = 'none';
};

// === SAVAŞA GİRİŞ (GERİ SAYIM) ===
function startCountdown(data) {
    playSFX('start');
    if(roomListener && myColor === 'w') roomListener(); // Kurucuysa eski dinlemeyi iptal et
    
    document.getElementById('waitModal').style.display = 'flex';
    document.getElementById('waitContent').style.display = 'none';
    document.getElementById('countdownContent').style.display = 'block';
    
    let c = 3;
    document.getElementById('countdownText').innerText = c;
    const t = setInterval(() => {
        c--;
        if(c > 0) {
            document.getElementById('countdownText').innerText = c;
        } else {
            clearInterval(t);
            document.getElementById('waitModal').style.display = 'none';
            setupGameUI(data);
        }
    }, 1000);
}

// === ANA OYUN ARAYÜZÜ (GAME UI) ===
function setupGameUI(data) {
    document.getElementById('lobbyArea').style.display = 'none';
    document.getElementById('gameArea').style.display = 'flex';
    
    // Bilgi Yazımları
    const oppName = myColor === 'w' ? data.blackName : data.whiteName;
    document.getElementById('playerTop').innerHTML = `<i class="fa-solid fa-user-ninja"></i> ${oppName}`;
    document.getElementById('playerBottom').innerHTML = `<i class="fa-solid fa-user-astronaut"></i> Sen (${myColor === 'w' ? 'Beyaz' : 'Siyah'})`;
    document.getElementById('poolAmount').innerText = (data.bet * 2).toLocaleString();

    // Oyun Dinleyicisi & Hile Kontrolü
    onSnapshot(doc(db, "chess_rooms", currentRoomId), (snapshot) => {
        const roomState = snapshot.data();
        if(!roomState) return;

        if(roomState.fen && roomState.fen !== game.fen()) {
            const isLoadSuccess = game.load(roomState.fen);
            if(isLoadSuccess) {
                if(game.in_check()) playSFX('check'); else playSFX('move');
                renderBoard();
                checkGameOver();
            } else {
                console.error("YASADIŞI FEN BLOKE EDİLDİ!");
            }
        }
    });

    renderBoard();
}

// === KUSURSUZ TAHTA RENDER MANTIĞI ===
function renderBoard() {
    const boardDOM = document.getElementById('board');
    boardDOM.innerHTML = '';
    const boardState = game.board();
    
    // Yönlendirme (Siyahsa tahta ters çevrilir)
    const rows = myColor === 'b' ? [7,6,5,4,3,2,1,0] : [0,1,2,3,4,5,6,7];
    const cols = myColor === 'b' ? [7,6,5,4,3,2,1,0] : [0,1,2,3,4,5,6,7];

    let kingInCheckSq = null;
    if (game.in_check()) {
        const turn = game.turn();
        for (let r=0; r<8; r++) for (let c=0; c<8; c++) 
            if (boardState[r][c] && boardState[r][c].type === 'k' && boardState[r][c].color === turn) 
                kingInCheckSq = String.fromCharCode(97+c) + (8-r);
    }

    rows.forEach(r => {
        cols.forEach(c => {
            const sqId = String.fromCharCode(97+c) + (8-r);
            const piece = boardState[r][c];
            
            const sqEl = document.createElement('div');
            sqEl.className = `square ${(r+c)%2===1 ? 'dark' : 'light'}`;
            
            if (selectedSquare === sqId) sqEl.classList.add('selected');
            if (kingInCheckSq === sqId) sqEl.classList.add('in-check');
            
            const moveData = validMoves.find(m => m.to === sqId);
            if (moveData) {
                if(piece) sqEl.classList.add('valid-capture');
                else sqEl.classList.add('valid-move');
            }

            if (piece) {
                const img = document.createElement('img');
                img.src = piecesSVG[piece.color + piece.type];
                img.className = 'piece';
                sqEl.appendChild(img);
            }

            // Click listener
            sqEl.onclick = () => handleSquareClick(sqId);
            boardDOM.appendChild(sqEl);
        });
    });

    // Sıra Göstergesi
    const indicator = document.getElementById('turnIndicator');
    if(game.game_over()) {
        indicator.innerText = "SAVAŞ BİTTİ"; indicator.style.color = "var(--danger)";
    } else if(game.turn() === myColor) {
        indicator.innerText = "SIRA SENDE"; indicator.style.color = "var(--success)";
        document.getElementById('playerBottom').classList.add('active'); document.getElementById('playerTop').classList.remove('active');
    } else {
        indicator.innerText = "RAKİP DÜŞÜNÜYOR..."; indicator.style.color = "var(--accent)";
        document.getElementById('playerBottom').classList.remove('active'); document.getElementById('playerTop').classList.add('active');
    }
}

// === ÖZGÜR VE GÜVENLİ HAMLE İŞLEYİCİSİ ===
async function handleSquareClick(square) {
    if (game.turn() !== myColor || game.game_over()) return;
    
    const moveInfo = validMoves.find(m => m.to === square);
    
    if (moveInfo) {
        // Hamle yap
        const isCapture = moveInfo.flags.includes('c') || moveInfo.flags.includes('e');
        game.move(moveInfo);
        selectedSquare = null; validMoves = [];
        
        if(game.in_check()) playSFX('check'); else if(isCapture) playSFX('capture'); else playSFX('move');
        renderBoard();
        
        // Veritabanı Senkronizasyonu
        try { await updateDoc(doc(db, "chess_rooms", currentRoomId), { fen: game.fen(), turn: game.turn(), lastMove: Date.now() }); } catch(e) {}
        checkGameOver();
    } else {
        // Taş Seçme İşlemi
        const piece = game.get(square);
        if (piece && piece.color === myColor) {
            selectedSquare = square; 
            // Otomatik Vezir terfisi (q) eklendi, mobilde menü çıkartmayı engellemek için.
            validMoves = game.moves({ square: square, verbose: true }).map(m => ({...m, promotion: 'q'}));
        } else {
            selectedSquare = null; validMoves = [];
        }
        renderBoard();
    }
}

function checkGameOver() {
    if (game.game_over()) {
        playSFX('end');
        let msg = "Oyun Bitti! Berabere.";
        if (game.in_checkmate()) {
            msg = game.turn() === myColor ? "MAT OLDUN! Ne yazık ki kaybettin." : "ŞAH MAT! Kazandın.";
        }
        showMatrixModal("SAVAŞ SONUCU", msg, "info", () => {
            window.leaveToLobby();
        });
    }
}

// === GÜVENLİ ÇIKIŞ ===
window.leaveToLobby = () => {
    if(currentRoomId && document.getElementById('gameArea').style.display === 'flex') {
        showMatrixModal("DİKKAT", "Maç devam ederken çıkarsanız yenik sayılırsınız. Çıkmak istiyor musunuz?", "error", () => {
            window.location.reload();
        });
    } else {
        window.location.reload();
    }
};
</script>
</body>
</html>
