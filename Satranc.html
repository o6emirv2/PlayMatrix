<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<title>PlayMatrix | Ultra Profesyonel Online Satranç Arenası</title>
<meta name="description" content="PlayMatrix Satranç Arenası'nda arkadaşlarınla veya rastgele rakiplerle hilesiz, şifreli veya açık odalarda online satranç oyna. Kazan, anında 2.500 MC Coin ödülünü kap!">
<meta name="keywords" content="online satranç, playmatrix satranç, şifreli satranç odası, ücretsiz satranç oyna, satranç mc coin, multiplayer satranç, zeka oyunları">
<meta name="author" content="PlayMatrix Global">
<meta name="robots" content="index, follow">
<meta name="theme-color" content="#12161a">

<meta property="og:title" content="PlayMatrix | Ultra Profesyonel Online Satranç">
<meta property="og:description" content="Gerçek zamanlı, hilesiz satranç deneyimi. Odana şifre koy, rakibini davet et, şah mat yap ve 2.500 MC kazan!">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="PlayMatrix | Satranç Arenası">
<meta name="twitter:description" content="PlayMatrix'te hilesiz online satranç oyna ve kazan.">

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800;900&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* === ELİT SATRANÇ TASARIMI === */
:root {
    --gold: #d4af37;
    --gold-dark: #9e8123;
    --bg-dark: #12161a;
    --bg-panel: #1e242b;
    --text-light: #f3f4f6;
    --text-dim: #9ca3af;
    --danger: #ef4444;
    --success: #10b981;
    --board-light: #e4cda7;
    --board-dark: #a06e49;
    --board-border: #2a1b12;
    --highlight: rgba(212, 175, 55, 0.6);
    --valid-move: rgba(16, 185, 129, 0.8);
}

/* SIFIR KAYMA - SIFIR HATA ALTYAPISI */
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body {
    width: 100%; height: 100%;
    overflow: hidden; touch-action: none; overscroll-behavior: none;
    -webkit-user-select: none; user-select: none;
    background-color: var(--bg-dark); color: var(--text-light);
    font-family: 'Inter', sans-serif;
    display: flex; flex-direction: column; 
}

/* === ÜST BAR === */
.top-bar {
    height: 70px; width: 100%; flex-shrink: 0;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; background: #0c0f12;
    border-bottom: 2px solid var(--gold);
    box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 2000;
}
.brand-elite {
    font-family: 'Cinzel', serif; font-size: 24px; font-weight: 900; 
    color: var(--gold); letter-spacing: 2px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
}
.brand-elite span { color: var(--text-light); }
.top-actions { display: flex; gap: 12px; }
.btn-elite {
    background: var(--bg-panel); color: var(--gold); border: 1px solid var(--gold); 
    padding: 8px 16px; border-radius: 6px; font-weight: 700; cursor: pointer; transition: 0.3s;
    font-family: 'Inter', sans-serif; font-size: 13px; text-transform: uppercase;
}
.btn-elite:hover { background: var(--gold); color: #000; box-shadow: 0 0 10px rgba(212,175,55,0.4); }
.btn-danger {
    background: #4a1515; color: #ff6b6b; border: 1px solid #ff6b6b;
    padding: 8px 16px; border-radius: 6px; font-weight: 700; cursor: pointer; transition: 0.3s;
}
.btn-danger:hover { background: #ff6b6b; color: #000; }

/* === ANA İÇERİK === */
.main-container {
    flex: 1; width: 100%; position: relative;
    overflow-y: auto; overflow-x: hidden;
}

/* === LOBİ EKRANI === */
#lobbyArea {
    min-height: 100%; display: flex; flex-direction: column; align-items: center;
    padding: 30px 20px 50px 20px; 
    background: radial-gradient(circle at top, #1e252b 0%, var(--bg-dark) 100%);
}
.lobby-title {
    font-family: 'Cinzel', serif; font-size: 36px; color: var(--gold); 
    margin-bottom: 5px; text-shadow: 0 4px 10px rgba(0,0,0,0.8); text-align: center;
}
.lobby-desc { color: var(--text-dim); font-size: 14px; font-weight: 500; margin-bottom: 30px; text-align: center; }

.create-btn-gold {
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    color: #000; border: none; padding: 18px 45px; border-radius: 8px;
    font-size: 16px; font-weight: 900; letter-spacing: 1px; cursor: pointer;
    box-shadow: 0 8px 20px rgba(212,175,55,0.3); transition: 0.3s;
    width: 100%; max-width: 400px; display: flex; align-items: center; justify-content: center; gap: 10px;
}
.create-btn-gold:active { transform: scale(0.97); }

.rooms-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px; width: 100%; max-width: 900px; margin-top: 40px;
}
.room-card {
    background: var(--bg-panel); border-left: 4px solid var(--gold);
    border-radius: 6px; padding: 20px; display: flex; justify-content: space-between;
    align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.4); transition: 0.3s;
}
.room-card:hover { transform: translateY(-3px); background: #252d36; }
.room-info h3 { font-size: 16px; margin-bottom: 5px; color: var(--text-light); font-weight: 700; }
.room-info p { font-size: 12px; color: var(--gold); font-weight: 600; }
.room-info p span { color: var(--text-dim); }

/* === OYUN İÇİ EKRAN === */
#gameArea {
    min-height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center;
    background: linear-gradient(to bottom, #161b22, #0d1117); padding: 10px;
}
.player-tag {
    width: 100%; max-width: 440px; display: flex; justify-content: space-between;
    align-items: center; padding: 12px 20px; background: var(--bg-panel);
    border-radius: 8px; margin: 10px 0; border: 1px solid #333;
    transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}
.player-tag.active-turn { border-color: var(--gold); background: #252b32; box-shadow: 0 0 15px rgba(212,175,55,0.2); }
.player-name { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 10px; color: var(--text-light); }
.player-name i { color: var(--gold); font-size: 18px; }

/* === SATRANÇ TAHTASI === */
.board-container {
    width: 100vw; max-width: 440px; aspect-ratio: 1; padding: 15px;
    background: var(--board-border); border-radius: 4px; 
    box-shadow: 0 20px 40px rgba(0,0,0,0.8), inset 0 0 10px rgba(0,0,0,0.5);
    position: relative;
}
#chessBoard {
    display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr);
    width: 100%; height: 100%; border: 1px solid #111;
}
.square { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; }
.square.light { background-color: var(--board-light); }
.square.dark { background-color: var(--board-dark); }
.square.highlight { background-color: var(--highlight) !important; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.4); }
.square.last-move { background-color: rgba(255, 235, 59, 0.4) !important; }

/* Noktalar ve Taşlar */
.valid-move-dot { width: 30%; height: 30%; background-color: var(--valid-move); border-radius: 50%; position: absolute; pointer-events: none; }
.valid-capture-ring { width: 85%; height: 85%; border: 5px solid var(--danger); border-radius: 50%; position: absolute; pointer-events: none; }
.piece { width: 90%; height: 90%; background-size: cover; background-position: center; cursor: pointer; z-index: 10; filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.6)); transition: transform 0.1s; }
.piece:active { transform: scale(1.1) translateY(-4px); }

/* Koordinatlar */
.coord { position: absolute; font-size: 11px; font-weight: 800; opacity: 0.6; pointer-events: none; font-family: 'Inter', sans-serif;}
.coord-rank { top: 2px; left: 3px; }
.coord-file { bottom: 1px; right: 3px; }
.square.dark .coord { color: var(--board-light); }
.square.light .coord { color: var(--board-dark); }

/* === MODAL ALTYAPISI === */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
    display: none; align-items: center; justify-content: center; z-index: 5000; opacity: 0;
    transition: opacity 0.3s ease;
}
.modal-overlay.show { opacity: 1; display: flex; }
.modal-card { 
    width: 90%; max-width: 400px; padding: 30px; border-radius: 8px; 
    background: var(--bg-panel); border: 1px solid #333; border-top: 4px solid var(--gold);
    text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.9); 
    transform: scale(0.95); transition: transform 0.3s; position: relative;
}
.modal-overlay.show .modal-card { transform: scale(1); }
.modal-close-btn { position: absolute; top: 15px; right: 15px; font-size: 20px; color: var(--text-dim); cursor: pointer; transition: 0.3s; }
.modal-close-btn:hover { color: var(--danger); }

.modal-card h2 { margin-bottom: 15px; font-size: 20px; font-family: 'Cinzel', serif; color: var(--gold); }
.modal-card input { 
    width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 4px; 
    background: #111; border: 1px solid #444; color: var(--text-light); 
    outline: none; text-align: center; font-size: 15px; transition: 0.3s; font-family: 'Inter', sans-serif;
}
.modal-card input:focus { border-color: var(--gold); }

.how-to-list { text-align: left; font-size: 13px; color: var(--text-dim); line-height: 1.6; margin-bottom: 20px; list-style: none; }
.how-to-list li { margin-bottom: 12px; padding-left: 15px; position: relative; }
.how-to-list li::before { content: '■'; color: var(--gold); position: absolute; left: 0; font-size: 10px; top: 4px; }
.how-to-list li b { color: var(--text-light); }

.promo-options { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
.promo-piece {
    width: 60px; height: 60px; background-color: var(--board-light); border-radius: 4px;
    border: 2px solid var(--gold); display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.2s;
}
.promo-piece:hover { transform: scale(1.05); background-color: #fff; }
.promo-piece img { width: 85%; height: 85%; }

/* Yükleniyor */
#loading {
    position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-dark);
    display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;
}
.loader-spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<audio id="sfx-move" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3" preload="auto"></audio>
<audio id="sfx-capture" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/capture.mp3" preload="auto"></audio>
<audio id="sfx-check" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-check.mp3" preload="auto"></audio>
<audio id="sfx-start" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-start.mp3" preload="auto"></audio>
<audio id="sfx-end" src="https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-end.mp3" preload="auto"></audio>

<div id="loading">
    <div class="loader-spinner"></div>
    <h3 style="margin-top: 15px; color: var(--gold); font-family: 'Cinzel', serif;">ARENA HAZIRLANIYOR</h3>
</div>

<header class="top-bar">
    <div class="brand-elite">Play<span>Matrix</span></div>
    <div class="top-actions">
        <button class="btn-elite" onclick="openModal('howToModal')"><i class="fa-solid fa-book"></i> Kurallar</button>
        <button class="btn-danger" id="exitGameBtn" style="display:none;" onclick="leaveRoom()"><i class="fa-solid fa-flag"></i> ÇEKİL</button>
    </div>
</header>

<main class="main-container">
    
    <div id="lobbyArea">
        <h1 class="lobby-title">SATRANÇ KULÜBÜ</h1>
        <p class="lobby-desc">Büyük ustaların arenasına hoş geldin. Hilesiz, kesintisiz, kazançlı deneyim.</p>
        
        <button class="create-btn-gold" onclick="openModal('createRoomMenuModal')">
            <i class="fa-solid fa-chess-knight"></i> YENİ MASA KUR
        </button>
        
        <div class="rooms-grid" id="roomsList">
            </div>
    </div>

    <div id="gameArea">
        <div class="player-tag" id="opponentInfo">
            <div class="player-name"><i class="fa-solid fa-user-shield"></i> <span id="opponentName">Rakip Bekleniyor...</span></div>
        </div>
        
        <div class="board-container">
            <div id="chessBoard"></div>
        </div>
        
        <div class="player-tag" id="myInfo">
            <div class="player-name"><i class="fa-solid fa-user-shield" style="color:var(--gold);"></i> <span id="myName">Sen</span></div>
        </div>
    </div>

</main>

<div class="modal-overlay" id="alertModal">
    <div class="modal-card">
        <div id="alertIcon" style="font-size: 50px; margin-bottom: 15px;"></div>
        <h2 id="alertTitle">Sistem Mesajı</h2>
        <p id="alertBody" style="color: var(--text-dim); margin-bottom: 25px; font-size: 14px; font-weight: 500;"></p>
        <button class="btn-elite" style="width:100%; padding:14px;" onclick="closeModal('alertModal')">TAMAM</button>
    </div>
</div>

<div class="modal-overlay" id="howToModal">
    <div class="modal-card">
        <i class="fa-solid fa-xmark modal-close-btn" onclick="closeModal('howToModal')"></i>
        <h2>NASIL OYNANIR?</h2>
        <ul class="how-to-list">
            <li>"YENİ MASA KUR" ile <b>Açık</b> veya <b>Şifreli</b> bir oyun masası oluşturun.</li>
            <li>Rakibiniz masaya oturmadan taşları hareket ettiremezsiniz.</li>
            <li>Oyun <b>%100 hile korumalıdır</b>. Tüm hamleler doğrulanır. Yasadışı veri gönderimi tespit edilirse maç anında iptal olur.</li>
            <li>Rakibini <b>ŞAH MAT</b> yapan oyuncu anında <b>2.500 MC</b> ödül kazanır.</li>
            <li>Oyundan çıkan veya "Çekil" butonuna basan taraf hükmen mağlup olur.</li>
        </ul>
        <button class="btn-elite" style="width:100%; padding:14px;" onclick="closeModal('howToModal')">ANLADIM</button>
    </div>
</div>

<div class="modal-overlay" id="createRoomMenuModal">
    <div class="modal-card">
        <i class="fa-solid fa-xmark modal-close-btn" onclick="closeModal('createRoomMenuModal')"></i>
        <h2>Masa Türü Seçin</h2>
        <p style="color:var(--text-dim); font-size:13px; margin-bottom:20px;">Lütfen oluşturmak istediğiniz masanın erişim türünü belirleyin.</p>
        
        <button class="create-btn-gold" style="margin-bottom: 10px;" onclick="setupOpenRoom()"><i class="fa-solid fa-globe"></i> AÇIK MASA</button>
        <button class="btn-elite" style="width:100%; padding:18px;" onclick="openPrivateRoomForm()"><i class="fa-solid fa-lock"></i> ŞİFRELİ MASA</button>
    </div>
</div>

<div class="modal-overlay" id="privateRoomFormModal">
    <div class="modal-card">
        <i class="fa-solid fa-xmark modal-close-btn" onclick="closeModal('privateRoomFormModal')"></i>
        <h2>Şifreli Masa Kur</h2>
        <input type="text" id="prRoomName" placeholder="Masa İsmi (Min 3 Karakter)" maxlength="20">
        <input type="password" id="prRoomPass" placeholder="Masa Şifresi (Min 5 Rakam)" maxlength="10">
        <button class="create-btn-gold" onclick="setupPrivateRoom()">MASAYI AÇ</button>
    </div>
</div>

<div class="modal-overlay" id="joinPrivateModal">
    <div class="modal-card">
        <i class="fa-solid fa-xmark modal-close-btn" onclick="closeModal('joinPrivateModal')"></i>
        <h2>Masaya Katıl</h2>
        <p id="joinPrivateRoomName" style="color:var(--gold); font-weight:700; margin-bottom:15px;"></p>
        <input type="password" id="joinRoomPass" placeholder="Masanın Şifresini Girin">
        <button class="create-btn-gold" onclick="attemptJoinPrivate()">OTUR</button>
    </div>
</div>

<div class="modal-overlay" id="promoModal">
    <div class="modal-card">
        <h2>Taş Terfisi</h2>
        <p style="color:var(--text-dim); font-size:13px;">Piyonunu hangi taşa dönüştürmek istersin?</p>
        <div class="promo-options" id="promoOptions"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, query, where, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// OYUN DURUMLARI
let engine = new Chess();
let currentRoomId = null;
let currentRoomStatus = 'waiting'; 
let currentPrivateRoomData = null;
let myColor = 'w';
let userData = { uid: null, username: 'Misafir' };
let boardReversed = false;
let selectedSquare = null;
let lastMoveSquares = [];
let pendingPromotionMove = null;
let unsubscribeRoom = null;
let rewardGiven = false;

// TAŞ SVG LİNKLERİ
const pieceTheme = {
    'w': {
        'p': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
        'n': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
        'b': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
        'r': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
        'q': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
        'k': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg'
    },
    'b': {
        'p': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
        'n': 'https://upload.wikimedia.org/wikipedia/commons/e/ea/Chess_ndt45.svg',
        'b': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
        'r': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
        'q': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
        'k': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg'
    }
};

// SES YÖNETİMİ
const playSound = (type) => {
    try {
        const audio = document.getElementById(`sfx-${type}`);
        if(audio) { audio.currentTime = 0; audio.play().catch(()=>{}); }
    } catch(e){}
};

// SIKI ZOOM/KAYDIRMA ENGELİ
document.addEventListener('touchmove', function (event) { if (event.scale !== 1) event.preventDefault(); }, { passive: false });
document.addEventListener('dblclick', function (event) { event.preventDefault(); }, { passive: false });

// MODAL YÖNETİMİ
window.openModal = (id) => {
    const modal = document.getElementById(id);
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
};

window.closeModal = (id) => {
    const modal = document.getElementById(id);
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 300);
};

window.showMatrixModal = (title, message, type = 'info') => {
    const icon = document.getElementById("alertIcon");
    document.getElementById("alertTitle").innerText = title;
    document.getElementById("alertBody").innerText = message;
    
    if(type === 'error') icon.innerHTML = '<i class="fa-solid fa-triangle-exclamation" style="color:var(--danger);"></i>';
    else if(type === 'success') icon.innerHTML = '<i class="fa-solid fa-medal" style="color:var(--gold);"></i>';
    else icon.innerHTML = '<i class="fa-solid fa-circle-info" style="color:var(--text-light);"></i>';
    
    openModal('alertModal');
};

// GİRİŞ KONTROLÜ
onAuthStateChanged(auth, async (user) => {
    if (user) {
        userData.uid = user.uid;
        onSnapshot(doc(db, "users", user.uid), s => {
            if(s.exists()) {
                userData.username = s.data().username || "Oyuncu";
                document.getElementById("myName").innerText = userData.username;
            }
        });
        document.getElementById("loading").style.display = "none";
        listenToRooms();
    } else {
        document.getElementById("loading").style.display = "none";
        showMatrixModal("Erişim Reddedildi", "Satranç arenasına girmek için PlayMatrix hesabınızla giriş yapmalısınız.", "error");
        setTimeout(() => window.location.href = "index.html", 3000);
    }
});

// ==== HAYALET ODA VE BAĞLANTI KOPMASI KORUMASI ====
window.addEventListener('beforeunload', () => {
    if (currentRoomId && currentRoomStatus === 'playing') {
        // Eğer maç ortasında sayfa kapanır/yenilenirse odayı bitir
        updateDoc(doc(db, "chess_rooms", currentRoomId), { status: 'finished' }).catch(()=>{});
    }
});

// === SATRANÇ ÇİZİMİ ===
function drawBoard() {
    const boardDiv = document.getElementById("chessBoard");
    boardDiv.innerHTML = "";
    
    const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
    const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];
    
    let displayRanks = boardReversed ? [...ranks].reverse() : ranks;
    let displayFiles = boardReversed ? [...files].reverse() : files;

    for (let r = 0; r < 8; r++) {
        for (let f = 0; f < 8; f++) {
            const squareId = displayFiles[f] + displayRanks[r];
            const isLight = (r + f) % 2 === 0;
            const squareDiv = document.createElement("div");
            
            squareDiv.className = `square ${isLight ? 'light' : 'dark'}`;
            squareDiv.id = `sq-${squareId}`;
            squareDiv.dataset.sq = squareId;
            
            if(f === 0) squareDiv.innerHTML += `<div class="coord coord-rank">${displayRanks[r]}</div>`;
            if(r === 7) squareDiv.innerHTML += `<div class="coord coord-file">${displayFiles[f]}</div>`;

            squareDiv.onclick = () => handleSquareClick(squareId);
            boardDiv.appendChild(squareDiv);
        }
    }
    updatePieces();
}

function updatePieces() {
    document.querySelectorAll('.valid-move-dot, .valid-capture-ring').forEach(e => e.remove());
    document.querySelectorAll('.square').forEach(sq => {
        const div = sq.querySelector('.piece');
        if(div) div.remove();
        sq.classList.remove('highlight');
        if(!lastMoveSquares.includes(sq.dataset.sq)) sq.classList.remove('last-move');
    });

    const boardState = engine.board(); 
    const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
    const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];

    for (let r = 0; r < 8; r++) {
        for (let f = 0; f < 8; f++) {
            const piece = boardState[r][f];
            if (piece) {
                const sqId = files[f] + ranks[r];
                const sqDiv = document.getElementById(`sq-${sqId}`);
                if(sqDiv) {
                    const pieceDiv = document.createElement("div");
                    pieceDiv.className = "piece";
                    pieceDiv.style.backgroundImage = `url(${pieceTheme[piece.color][piece.type]})`;
                    sqDiv.appendChild(pieceDiv);
                }
            }
        }
    }
    
    if(lastMoveSquares.length === 2) {
        document.getElementById(`sq-${lastMoveSquares[0]}`)?.classList.add('last-move');
        document.getElementById(`sq-${lastMoveSquares[1]}`)?.classList.add('last-move');
    }
    
    if(currentRoomStatus === 'playing') {
        if(engine.turn() === myColor) {
            document.getElementById("myInfo").classList.add("active-turn");
            document.getElementById("opponentInfo").classList.remove("active-turn");
        } else {
            document.getElementById("opponentInfo").classList.add("active-turn");
            document.getElementById("myInfo").classList.remove("active-turn");
        }
    }
}

// === HAMLE MANTIĞI ===
function handleSquareClick(squareId) {
    if (currentRoomStatus !== 'playing') {
        showMatrixModal("Uyarı", "Rakibiniz masaya oturmadan taşları oynatamazsınız.", "info");
        return;
    }
    
    if (!currentRoomId || engine.turn() !== myColor) return; 

    if (!selectedSquare) {
        const piece = engine.get(squareId);
        if (piece && piece.color === myColor) {
            selectedSquare = squareId;
            document.getElementById(`sq-${squareId}`).classList.add('highlight');
            showValidMoves(squareId);
        }
    } else {
        const piece = engine.get(squareId);
        if (piece && piece.color === myColor) {
            selectedSquare = squareId;
            updatePieces(); 
            document.getElementById(`sq-${squareId}`).classList.add('highlight');
            showValidMoves(squareId);
            return;
        }

        const moves = engine.moves({ square: selectedSquare, verbose: true });
        const move = moves.find(m => m.to === squareId);

        if (move) {
            if (move.flags.includes('p') || move.flags.includes('np') || move.flags.includes('cp')) {
                pendingPromotionMove = { from: selectedSquare, to: squareId };
                showPromotionModal();
            } else {
                executeMove({ from: selectedSquare, to: squareId });
            }
        } else {
            selectedSquare = null;
            updatePieces();
        }
    }
}

function showValidMoves(squareId) {
    const moves = engine.moves({ square: squareId, verbose: true });
    moves.forEach(m => {
        const sqDiv = document.getElementById(`sq-${m.to}`);
        if(sqDiv) {
            if(engine.get(m.to)) sqDiv.innerHTML += `<div class="valid-capture-ring"></div>`;
            else sqDiv.innerHTML += `<div class="valid-move-dot"></div>`;
        }
    });
}

// ==== PİYON TERFİ (PROMOTION) DÜZELTİLDİ ====
function showPromotionModal() {
    const container = document.getElementById("promoOptions");
    container.innerHTML = "";
    const pieces = ['q', 'r', 'n', 'b']; // Vezir, Kale, At, Fil
    
    pieces.forEach(p => {
        const div = document.createElement("div");
        div.className = "promo-piece";
        div.innerHTML = `<img src="${pieceTheme[myColor][p]}" alt="Promotion">`;
        div.onclick = () => {
            closeModal('promoModal');
            // Promotion verisini executeMove'a TAM formatta iletiyoruz
            executeMove({ from: pendingPromotionMove.from, to: pendingPromotionMove.to, promotion: p });
            pendingPromotionMove = null;
            selectedSquare = null;
        };
        container.appendChild(div);
    });
    
    openModal('promoModal');
}

async function executeMove(moveObj) {
    const move = engine.move(moveObj);
    if (move) {
        lastMoveSquares = [move.from, move.to];
        
        if(engine.in_check()) playSound('check');
        else if(move.captured) playSound('capture');
        else playSound('move');

        updatePieces();
        selectedSquare = null;

        // HAMLE VERİSİ FİREBASE'E GÖNDERİLİRKEN SIKILAŞTIRILDI
        try {
            await updateDoc(doc(db, "chess_rooms", currentRoomId), {
                fen: engine.fen(),
                lastMoveData: { from: move.from, to: move.to, promotion: move.promotion || null },
                turn: engine.turn()
            });
            checkGameOver();
        } catch(e) {
            console.error(e);
        }
    }
}

// OYUN BİTİŞ KONTROLÜ
async function checkGameOver() {
    if(engine.game_over() && !rewardGiven) {
        playSound('end');
        let msg = "Maç sona erdi!";
        
        if(engine.in_checkmate()) {
            let winnerColor = engine.turn() === 'w' ? 'b' : 'w';
            
            if(myColor === winnerColor) {
                rewardGiven = true;
                msg = "Tebrikler ŞAH MAT! Mükemmel oyun.\n\nHesabınıza 2.500 MC Ödül Eklendi.";
                try {
                    await updateDoc(doc(db, "users", userData.uid), { balance: increment(2500) });
                } catch(e) { console.error(e); }
                showMatrixModal("KAZANDINIZ", msg, "success");
            } else {
                msg = "Şah Mat oldunuz. Rakibiniz oyunu kazandı.";
                showMatrixModal("KAYBETTİNİZ", msg, "error");
            }
        } 
        else if(engine.in_draw() || engine.in_stalemate()) {
            msg = "Oyun BERABERE bitti.";
            showMatrixModal("BERABERE", msg, "info");
        }
        
        try { await updateDoc(doc(db, "chess_rooms", currentRoomId), { status: 'finished' }); } catch(e){}
    }
}

// === ODA KURMA SİSTEMİ ===
window.setupOpenRoom = () => {
    closeModal('createRoomMenuModal');
    createRoomDB(false, "", "");
};

window.openPrivateRoomForm = () => {
    closeModal('createRoomMenuModal');
    document.getElementById("prRoomName").value = "";
    document.getElementById("prRoomPass").value = "";
    openModal('privateRoomFormModal');
};

window.setupPrivateRoom = () => {
    const name = document.getElementById("prRoomName").value.trim();
    const pass = document.getElementById("prRoomPass").value.trim();
    
    if(name.length < 3) { showMatrixModal("Hata", "Masa ismi en az 3 karakter olmalıdır.", "error"); return; }
    if(!/^\d{5,}$/.test(pass)) { showMatrixModal("Hata", "Masa şifresi en az 5 RAKAMDAN oluşmalıdır.", "error"); return; }
    
    closeModal('privateRoomFormModal');
    createRoomDB(true, name, pass);
};

async function createRoomDB(isPrivate, roomName, password) {
    try {
        const roomRef = doc(collection(db, "chess_rooms"));
        await setDoc(roomRef, {
            status: 'waiting',
            hostUid: userData.uid,
            hostName: userData.username,
            guestUid: null,
            guestName: null,
            fen: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
            createdAt: Date.now(),
            turn: 'w',
            isPrivate: isPrivate,
            roomName: isPrivate ? roomName : `${userData.username}'in Masası`,
            password: password
        });
        joinGame(roomRef.id, 'w');
    } catch(e) {
        showMatrixModal("Hata", "Masa kurulamadı: " + e.message, "error");
    }
}

// ODAYA GİRİŞ
window.joinRoomCheck = (roomId, isPrivate, roomName, password) => {
    if(!isPrivate) {
        joinSpecificRoom(roomId);
    } else {
        currentPrivateRoomData = { id: roomId, pass: password };
        document.getElementById("joinPrivateRoomName").innerText = roomName;
        document.getElementById("joinRoomPass").value = "";
        openModal('joinPrivateModal');
    }
};

window.attemptJoinPrivate = () => {
    const inputPass = document.getElementById("joinRoomPass").value.trim();
    if(inputPass === currentPrivateRoomData.pass) {
        closeModal('joinPrivateModal');
        joinSpecificRoom(currentPrivateRoomData.id);
    } else {
        showMatrixModal("Yetkisiz Erişim", "Girdiğiniz şifre hatalı. Lütfen tekrar deneyin.", "error");
    }
};

async function joinSpecificRoom(roomId) {
    try {
        await updateDoc(doc(db, "chess_rooms", roomId), {
            status: 'playing',
            guestUid: userData.uid,
            guestName: userData.username
        });
        joinGame(roomId, 'b');
    } catch(e) {
        showMatrixModal("Hata", "Masaya oturulamadı!", "error");
    }
}

function joinGame(roomId, color) {
    currentRoomId = roomId;
    myColor = color;
    boardReversed = (color === 'b'); 
    rewardGiven = false;
    currentRoomStatus = 'waiting';
    
    document.getElementById("lobbyArea").style.display = "none";
    document.getElementById("gameArea").style.display = "flex";
    document.getElementById("exitGameBtn").style.display = "block";
    document.getElementById("opponentInfo").classList.remove("active-turn");
    document.getElementById("myInfo").classList.remove("active-turn");
    
    engine.reset();
    drawBoard();
    playSound('start');
    
    unsubscribeRoom = onSnapshot(doc(db, "chess_rooms", roomId), (snap) => {
        if(!snap.exists()) { leaveRoom(true); return; }
        
        const data = snap.data();
        currentRoomStatus = data.status;
        
        if(myColor === 'w') {
            document.getElementById("opponentName").innerText = data.guestName || "Rakip Bekleniyor...";
        } else {
            document.getElementById("opponentName").innerText = data.hostName || "Rakip";
        }

        // ==== GÜÇLENDİRİLMİŞ HİLE KORUMASI (ANTI-CHEAT) ====
        if(data.fen !== engine.fen() && data.status !== 'waiting') {
            
            // Eğer veritabanı "sıra sende" diyorsa, rakibin gönderdiği hamleyi doğrula
            if(data.turn === myColor && data.lastMoveData) {
                let tempEngine = new Chess(engine.fen()); // Sistemin o an bildiği KESİN/GÜVENLİ tahta
                
                // Rakibin gönderdiği objeyle test hamlesi yap
                let testMove = tempEngine.move(data.lastMoveData);
                
                // EĞER hamle kuraldışıysa VEYA test sonucunda oluşan yeni tahta ile, rakibin iddia ettiği tahta uyuşmuyorsa
                if(!testMove || tempEngine.fen() !== data.fen) {
                    showMatrixModal("Hile Tespit Edildi!", "Sistem veri manipülasyonu algıladı. Rakibiniz veya bağlantınız yasadışı bir hamle gönderdi. Maç güvenlik sebebiyle iptal edildi.", "error");
                    leaveRoom(true);
                    return;
                }
            }
            
            // Testten geçti, tahtayı güvenle yükle
            engine.load(data.fen);
            if(data.lastMoveData) lastMoveSquares = [data.lastMoveData.from, data.lastMoveData.to];
            
            if(engine.in_check()) playSound('check');
            else if(data.lastMoveData && data.lastMoveData.captured) playSound('capture');
            else playSound('move');
            
            updatePieces();
            checkGameOver();
        }

        if(data.status === 'finished' && !rewardGiven) {
            document.getElementById("opponentName").innerText += " (Bitti)";
        }
    });
}

window.leaveRoom = async (forced = false) => {
    if(unsubscribeRoom) unsubscribeRoom();
    
    if(currentRoomId && !forced) {
        try { await updateDoc(doc(db, "chess_rooms", currentRoomId), { status: 'finished' }); } catch(e){}
    }
    
    currentRoomId = null;
    currentRoomStatus = 'waiting';
    document.getElementById("lobbyArea").style.display = "flex";
    document.getElementById("gameArea").style.display = "none";
    document.getElementById("exitGameBtn").style.display = "none";
    
    if(forced) showMatrixModal("Masa Kapatıldı", "Bağlantı koptu, kural ihlali yapıldı veya maç sona erdi.", "info");
};

// ANLIK LOBİ 
function listenToRooms() {
    const q = query(collection(db, "chess_rooms"), where("status", "==", "waiting"));
    onSnapshot(q, (snapshot) => {
        const list = document.getElementById("roomsList");
        list.innerHTML = "";
        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            if(data.hostUid === userData.uid) return; 
            
            const isPriv = data.isPrivate;
            const btnIcon = isPriv ? '<i class="fa-solid fa-lock"></i> ŞİFRELİ' : 'OTUR';
            
            list.innerHTML += `
                <div class="room-card">
                    <div class="room-info">
                        <h3><i class="fa-solid fa-chess" style="color:var(--gold);"></i> ${data.roomName || data.hostName}</h3>
                        <p>2.500 MC Ödül <span>| Kurucu: ${data.hostName}</span></p>
                    </div>
                    <button class="btn-elite" onclick="joinRoomCheck('${docSnap.id}', ${isPriv}, '${data.roomName}', '${data.password}')">${btnIcon}</button>
                </div>
            `;
        });
        
        // ==== ODA LİSTELEME TASARIM HATASI ÇÖZÜMÜ ====
        if(list.innerHTML === "") {
            list.innerHTML = `<p style="color:var(--text-dim); width:100%; text-align:center; grid-column: 1 / -1; padding: 20px 0; font-weight: 500;">Şu an açık bir masa yok. Kendi masanı kur!</p>`;
        }
    });
}
</script>
</body>
</html>
