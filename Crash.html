<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>PlayMatrix Crash | Ücretsiz Online Katlama ve Casino Oyunu</title>
    <meta name="description" content="PlayMatrix Crash oyna! Şansını dene, grafiğin yükselişini izle ve patlamadan önce MC'ni katlayarak çek. Kesintisiz, ücretsiz ve online casino deneyimi seni bekliyor.">
    <meta name="keywords" content="crash oyunu, online crash, katlama oyunu, ücretsiz casino, PlayMatrix, mc kazan, tarayıcı oyunları, kripto oyun">
    <meta name="author" content="PlayMatrix Global">
    <meta name="robots" content="index, follow">
    <meta name="language" content="Turkish">
    <meta name="theme-color" content="#02040a">
    <link rel="canonical" href="https://playmatrix.com.tr/Crash.html">

    <meta property="og:title" content="PlayMatrix Crash | Online Katlama Oyunu">
    <meta property="og:description" content="Grafik patlamadan önce kazancını çek, MC'ni anında katla! PlayMatrix'te kesintisiz Crash heyecanına katıl.">
    <meta property="og:image" content="https://playmatrix.com.tr/assets/crash-promo.jpg">
    <meta property="og:url" content="https://playmatrix.com.tr/Crash.html">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="PlayMatrix">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="PlayMatrix Crash Oyna">
    <meta name="twitter:description" content="Bahsini yap, x değerini izle ve zamanında çıkarak MC kazanmaya başla!">

    <script>
        if (window.history.replaceState) {
            window.history.replaceState(null, null, "/");
        }
    </script>

    <!-- CSP: tasarımı bozmaz, sadece güvenlik için allowlist -->
    <meta http-equiv="Content-Security-Policy" content="
default-src 'self' https: data: blob:;
script-src 'self' https://www.gstatic.com https://www.googleapis.com 'unsafe-inline';
style-src 'self' https://fonts.googleapis.com 'unsafe-inline';
img-src 'self' https: data: blob:;
media-src 'self' https: data: blob:;
connect-src 'self' https://emirhan-siye.onrender.com https://*.googleapis.com https://*.gstatic.com https://*.firebaseapp.com https://identitytoolkit.googleapis.com;
font-src 'self' https://fonts.gstatic.com data:;
">

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', sans-serif; }
        body { background: #02040a; color: white; height: 100vh; overflow: hidden; }

        /* SEO İÇİN GİZLİ H1 SINIFI (Tasarımı bozmaz, Google okur) */
        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;
        }

        /* ÜST BAR VE MC COIN TASARIMI */
        .top-bar {
            position: fixed; top: 0; width: 100%; height: 70px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px; background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px); border-bottom: 2px solid #4fd1ff; z-index: 1000;
        }
        .brand { font-family: 'Orbitron', sans-serif; font-size: 18px; font-weight: 900; background: linear-gradient(90deg, #4fd1ff, #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .right-menu { display: flex; gap: 8px; align-items: center; }

        .user-pill-mini {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255,255,255,0.05); padding: 5px 12px;
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
        }
        .balance-info { display: flex; align-items: center; }
        .balance-info b { font-size: 14px; color: #00ffa3; font-family: 'Inter', monospace; font-weight: 700; }
        .mc-chip {
            width: 22px; height: 22px;
            background: radial-gradient(circle at 30% 30%, #4fd1ff, #0055ff);
            border-radius: 50%; margin-left: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 8px; font-weight: 900; color: #fff;
            box-shadow: 0 0 10px rgba(79, 209, 255, 0.3);
            border: 1.2px solid rgba(255,255,255,0.2);
            font-family: 'Inter', sans-serif;
        }

        .back-btn { background: #d63031; color: white; padding: 8px 15px; border-radius: 10px; font-weight: 800; font-size: 11px; border: none; cursor: pointer; transition: 0.3s; margin-left: 5px; }

        .history {
            position: fixed; top: 70px; width: 100%; height: 40px;
            display: flex; align-items: center; gap: 8px; padding: 0 15px;
            background: rgba(0,0,0,0.4); overflow-x: auto; scrollbar-width: none; z-index: 900;
        }
        .history span { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 800; font-family: 'Orbitron'; }

        .game-container { position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 240px); z-index: 1; }
        canvas { width: 100%; height: 100%; }

        .multiplier-display {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none; z-index: 10; width: 100%;
        }
        .x-value {
            font-family: 'Orbitron', sans-serif; font-size: 80px; font-weight: 900; color: #fff;
            text-shadow: 0 0 25px rgba(79, 209, 255, 0.7);
        }
        .status-text { font-family: 'Orbitron'; font-size: 14px; color: #4fd1ff; letter-spacing: 3px; margin-bottom: 5px; }
        .crashed-text { color: #ff2a4d !important; text-shadow: 0 0 20px #ff2a4d; animation: shake 0.4s infinite; }

        @keyframes shake {
            0% { transform: translate(1px, 1px); } 50% { transform: translate(-2px, -1px); } 100% { transform: translate(1px, 1px); }
        }

        .bottom-panel {
            position: fixed; bottom: 0; width: 100%; height: 240px;
            background: #080c18; border-top: 2px solid #161d36;
            display: flex; justify-content: center; align-items: center; gap: 10px; padding: 15px; z-index: 1000;
        }
        .bet-card {
            background: #111827; flex: 1; max-width: 190px; height: 100%;
            border-radius: 20px; padding: 12px; display: flex; flex-direction: column; gap: 10px;
            border: 1px solid #1f2937;
        }
        .bet-card input {
            width: 100%; background: #030712; border: 2px solid #1f2937; border-radius: 12px;
            color: #4fd1ff; padding: 12px; text-align: center; font-size: 18px; font-weight: 800; font-family: 'Orbitron'; outline: none;
        }

        .auto-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 10px; }
        .auto-row span { font-size: 10px; font-weight: 800; color: #94a3b8; }

        .switch { position: relative; width: 38px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00ffa3; }
        input:checked + .slider:before { transform: translateX(18px); }

        .main-btn {
            width: 100%; flex-grow: 1; border: none; border-radius: 14px; color: white; font-weight: 900;
            font-size: 14px; cursor: pointer; transition: 0.2s;
            text-transform: uppercase; font-family: 'Orbitron';
        }
        .btn-bet { background: linear-gradient(180deg, #6366f1, #4338ca); box-shadow: 0 4px 0 #312e81; }
        .btn-cancel { background: linear-gradient(180deg, #ef4444, #b91c1c); box-shadow: 0 4px 0 #7f1d1d; }
        .btn-cashout { background: linear-gradient(180deg, #10b981, #047857); box-shadow: 0 4px 0 #064e3b; }
        .main-btn:active { transform: translateY(2px); box-shadow: none; }
        .main-btn:disabled { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; }

        @media (max-width: 400px) { .x-value { font-size: 55px; } .bottom-panel { height: 210px; } }

        /* SİSTEM BAŞLATMA OVERLAY (ses kilidi) */
        .start-overlay {
            position: fixed; inset: 0; background: rgba(2,4,10,0.95);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999; backdrop-filter: blur(10px); flex-direction: column;
        }
        .start-modal {
            background: rgba(10,15,25,0.95); padding: 40px; border-radius: 20px;
            text-align: center; border: 2px solid #4fd1ff; box-shadow: 0 0 30px rgba(79,209,255,0.2);
            width: 85%; max-width: 350px;
        }
    </style>
</head>
<body>

<h1 class="sr-only">PlayMatrix Crash - Ücretsiz Online Katlama Oyunu</h1>

<div id="start-overlay" class="start-overlay">
    <div class="start-modal">
        <h2 style="font-family:'Orbitron'; color:#4fd1ff; font-size: 24px; margin-bottom: 10px; text-shadow: 0 0 15px rgba(79,209,255,0.5);">CRASH PROTOKOLÜ</h2>
        <p style="font-size: 12px; color: #94a3b8; margin-bottom: 25px; font-family: 'Inter';">Sesleri ve oyun motorunu aktifleştirmek için sistemi başlatın.</p>
        <button id="systemStartBtn" aria-label="Sistemi Başlat"
                style="width: 100%; padding: 15px; border-radius: 12px; border: none; background: linear-gradient(90deg, #00ffa3, #00b894); color: #000; font-weight: 900; font-family: 'Orbitron'; font-size: 16px; cursor: pointer; text-transform: uppercase;">
            SİSTEMİ BAŞLAT
        </button>
    </div>
</div>

<header class="top-bar">
    <div class="brand">CRASH</div>
    <nav class="right-menu" aria-label="Üst Menü">
        <div class="user-pill-mini">
            <div class="balance-info">
                <b id="balance">0</b>
                <div class="mc-chip">MC</div>
            </div>
        </div>

        <div class="user-pill-mini" style="border-color: #ffcc00;">
            <div class="balance-info">
                <b id="betTotal" style="color:#ffcc00">0</b>
                <div class="mc-chip" style="background: radial-gradient(circle at 30% 30%, #ffcc00, #ff8a00); box-shadow: 0 0 10px rgba(255, 204, 0, 0.3);">MC</div>
            </div>
        </div>
        <button class="back-btn" onclick="window.history.back()" aria-label="Geri Dön">GERİ</button>
    </nav>
</header>

<main>
    <div class="history" id="history" aria-label="Geçmiş Çarpanlar"></div>

    <div class="game-container">
        <canvas id="gameCanvas" aria-label="Crash Oyun Ekranı"></canvas>
        <div class="multiplier-display" aria-live="polite">
            <div class="status-text" id="statusText">SİSTEM HAZIRLANIR...</div>
            <div class="x-value" id="multiplier">1.00x</div>
        </div>
    </div>

    <div class="bottom-panel">
        <div class="bet-card">
            <input type="number" id="betInput1" value="100" aria-label="1. Bahis Miktarı">
            <div class="auto-row">
                <span>OTO</span>
                <label class="switch">
                    <input type="checkbox" id="autoSwitch1" aria-label="1. Otomatik Bahis">
                    <span class="slider"></span>
                </label>
            </div>
            <button id="btn1" class="main-btn btn-bet" aria-label="Birinci Bahsi Yap">MC KULLAN</button>
        </div>

        <div class="bet-card">
            <input type="number" id="betInput2" value="200" aria-label="2. Bahis Miktarı">
            <div class="auto-row">
                <span>OTO</span>
                <label class="switch">
                    <input type="checkbox" id="autoSwitch2" aria-label="2. Otomatik Bahis">
                    <span class="slider"></span>
                </label>
            </div>
            <button id="btn2" class="main-btn btn-bet" aria-label="İkinci Bahsi Yap">MC KULLAN</button>
        </div>
    </div>
</main>

<script type="module">
/**
 * ✅ Güvenli Crash Entegrasyonu (Sunucu Otoriter)
 * - Client artık crash point / ödeme hesaplamaz
 * - Bakiye client’tan Firestore ile değişmez
 * - Tüm bahis / iptal / cashout sunucuda yapılır
 * - Firebase ID Token -> Render API (Bearer)
 *
 * Beklenen API (öneri sözleşme):
 *  GET  /api/me
 *    -> { ok:true, balance:number }
 *
 *  GET  /api/crash/state
 *    -> {
 *        ok:true,
 *        balance:number,
 *        roundId:string,
 *        phase:'COUNTDOWN'|'FLYING'|'CRASHED',
 *        countdown:number,          // COUNTDOWN için saniye
 *        multiplier:number,         // FLYING/CRASHED için mevcut/son değer
 *        history:number[],          // en yeni başta
 *        bets: {                    // kullanıcıya özel
 *          "1": { activeBet:number, status:'NONE'|'PLACED'|'CASHED'|'LOST' },
 *          "2": { activeBet:number, status:'NONE'|'PLACED'|'CASHED'|'LOST' }
 *        }
 *      }
 *
 *  POST /api/crash/bet      { box:1|2, amount:number }
 *    -> { ok:true, balance:number, bets:{...} }
 *
 *  POST /api/crash/cancel   { box:1|2 }
 *    -> { ok:true, balance:number, bets:{...} }
 *
 *  POST /api/crash/cashout  { box:1|2 }
 *    -> { ok:true, balance:number, payout:number, at:number, bets:{...} }
 */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* Render API */
const API_BASE = "https://emirhan-siye.onrender.com";

/* Firebase */
const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

/* DOM */
const balanceEl = document.getElementById('balance');
const betTotalEl = document.getElementById('betTotal');
const statusTextEl = document.getElementById('statusText');
const multiplierEl = document.getElementById('multiplier');
const historyEl = document.getElementById('history');

const betInput1 = document.getElementById('betInput1');
const betInput2 = document.getElementById('betInput2');
const btn1 = document.getElementById('btn1');
const btn2 = document.getElementById('btn2');

const autoSwitch1 = document.getElementById('autoSwitch1');
const autoSwitch2 = document.getElementById('autoSwitch2');

let auto1 = false, auto2 = false;

/* Ses sistemi */
let audioCtx = null;
function initAudio() {
    try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if(!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        // iOS unlock ping
        const buffer = audioCtx.createBuffer(1, 1, 22050);
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start(0);
    } catch (e) {
        console.error("Ses sistemi başlatılamadı:", e);
    }
}
function playSfx(type) {
    if(!audioCtx) return;
    if(audioCtx.state === 'suspended') audioCtx.resume();
    if(audioCtx.state !== 'running') return;

    const now = audioCtx.currentTime;

    if(type==='countdown') {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.type = 'triangle';
        o.frequency.setValueAtTime(500, now);
        g.gain.setValueAtTime(0.3, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        o.start(now); o.stop(now + 0.1);
    }
    if(type==='crash') {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(300, now);
        o.frequency.exponentialRampToValueAtTime(50, now + 0.5);
        g.gain.setValueAtTime(0.5, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
        o.start(now); o.stop(now + 0.5);
    }
    if(type==='cash') {
        [0, 0.1].forEach((d, i) => {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.type = 'square';
            o.frequency.setValueAtTime(800 + (i * 400), now + d);
            g.gain.setValueAtTime(0.2, now + d);
            g.gain.exponentialRampToValueAtTime(0.01, now + d + 0.2);
            o.start(now + d); o.stop(now + d + 0.2);
        });
    }
    if(type==='bet') {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.type = 'sine';
        o.frequency.setValueAtTime(600, now);
        o.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
        g.gain.setValueAtTime(0.3, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
        o.start(now); o.stop(now + 0.15);
    }
}

/* Start overlay */
let gameStarted = false;
document.getElementById('systemStartBtn').addEventListener('click', () => {
    initAudio();
    document.getElementById('start-overlay').style.display = 'none';
    gameStarted = true;
    if (authReady) startSyncLoop();
});

/* Güvenli API fetch (token + 401 refresh + timeout + out-of-order) */
let lastReqId = 0;
async function apiFetch(path, method="GET", body=null) {
    if (!auth.currentUser) throw new Error("Oturum yok.");

    const reqId = ++lastReqId;
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 12000);

    const doFetch = async (forceRefresh=false) => {
        const token = await auth.currentUser.getIdToken(forceRefresh);
        return fetch(API_BASE + path, {
            method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
                "X-PlayMatrix-Game": "crash",
                "X-Client-ReqId": String(reqId)
            },
            body: body ? JSON.stringify(body) : null,
            mode: "cors",
            signal: controller.signal
        });
    };

    try {
        let res = await doFetch(false);
        if (res.status === 401) res = await doFetch(true);

        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) throw new Error(data?.error || "Sunucu hatası.");

        if (reqId !== lastReqId) return { __ignored: true };
        return data;
    } finally {
        clearTimeout(t);
    }
}

/* Canvas / animasyon */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let width, height, stars = [];

function initStars() {
    stars = [];
    for(let i=0; i<100; i++) stars.push({x: Math.random()*width, y: Math.random()*height, s: Math.random()*2});
}
function resize() {
    width = canvas.width = canvas.offsetWidth;
    height = canvas.height = canvas.offsetHeight;
    initStars();
}
window.addEventListener('resize', resize);
resize();

/* Oyun state (sunucudan) */
let authReady = false;
let phase = "COUNTDOWN";           // 'COUNTDOWN'|'FLYING'|'CRASHED'
let roundId = null;
let balance = 0;

let serverMultiplier = 1.00;       // sunucudan gelen
let displayMultiplier = 1.00;      // ekranda yumuşatılmış
let lastPhase = null;

let countdown = 0;
let history = [];

let bets = {
    "1": { activeBet: 0, status: "NONE" },
    "2": { activeBet: 0, status: "NONE" }
};

let lineProgress = 0;

/* işlem kilitleri */
let isProcessing1 = false;
let isProcessing2 = false;

/* UI yardımcı */
const fmt = (n) => Math.floor(Number(n||0)).toLocaleString('tr-TR');
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function setCrashedUI(isCrashed) {
    if (isCrashed) multiplierEl.classList.add('crashed-text');
    else multiplierEl.classList.remove('crashed-text');
}

function renderHistory(list) {
    // list: en yeni başta
    historyEl.innerHTML = "";
    (list || []).slice(0, 15).forEach(val => {
        const span = document.createElement('span');
        span.innerText = Number(val).toFixed(2) + "x";
        span.style.color = Number(val) < 2 ? "#ff4757" : "#00b894";
        historyEl.appendChild(span);
    });
}

function updateTopBar() {
    balanceEl.innerText = fmt(balance);
    const total = (Number(bets["1"]?.activeBet||0) + Number(bets["2"]?.activeBet||0));
    betTotalEl.innerText = fmt(total);
}

function setInputsDisabled(disabled) {
    betInput1.disabled = disabled;
    betInput2.disabled = disabled;
}

function updateButtons() {
    const apply = (boxNum) => {
        const b = (boxNum === 1) ? btn1 : btn2;
        const active = Number(bets[String(boxNum)]?.activeBet || 0);
        const processing = (boxNum === 1) ? isProcessing1 : isProcessing2;

        if (processing) {
            b.disabled = true;
            b.innerText = "İşleniyor...";
            b.className = "main-btn";
            return;
        }

        if (phase === "COUNTDOWN") {
            b.disabled = false;
            if (active > 0) {
                b.innerText = "İPTAL";
                b.className = "main-btn btn-cancel";
            } else {
                b.innerText = "MC KULLAN";
                b.className = "main-btn btn-bet";
            }
            return;
        }

        if (phase === "FLYING") {
            if (active > 0) {
                b.disabled = false;
                const est = Math.floor(active * displayMultiplier);
                b.innerText = `ÇEK MC ${fmt(est)}`;
                b.className = "main-btn btn-cashout";
            } else {
                b.disabled = true;
                b.innerText = "UÇUYOR";
                b.className = "main-btn";
            }
            return;
        }

        // CRASHED
        b.disabled = true;
        b.innerText = "BEKLE";
        b.className = "main-btn";
    };

    apply(1);
    apply(2);
}

/* sunucu state -> UI */
function applyServerState(s) {
    if (!s) return;

    // balance
    if (typeof s.balance !== "undefined") balance = Number(s.balance || 0);

    // phase
    phase = s.phase || phase;
    roundId = s.roundId || roundId;

    // countdown / multiplier
    countdown = Number(s.countdown || 0);
    serverMultiplier = Number(s.multiplier || 1.0);

    // bets
    if (s.bets) {
        bets["1"] = { ...bets["1"], ...(s.bets["1"] || s.bets[1] || {}) };
        bets["2"] = { ...bets["2"], ...(s.bets["2"] || s.bets[2] || {}) };
        bets["1"].activeBet = Number(bets["1"].activeBet || 0);
        bets["2"].activeBet = Number(bets["2"].activeBet || 0);
    }

    // history
    if (Array.isArray(s.history)) {
        history = s.history.slice(0);
        renderHistory(history);
    }

    // Phase transition SFX / UI
    if (lastPhase !== phase) {
        if (phase === "CRASHED") playSfx('crash');
        if (phase === "COUNTDOWN") {
            // reset çizgi
            lineProgress = 0;
            setCrashedUI(false);
        }
        lastPhase = phase;
    }

    // status text + multiplier text
    if (phase === "COUNTDOWN") {
        setInputsDisabled(false);
        setCrashedUI(false);
        statusTextEl.innerText = "BEKLENİYOR";
        // countdown göstergesi: sunucu saniye veriyorsa onu yaz
        multiplierEl.innerText = (countdown > 0 ? `${countdown}s` : "5s");
    } else if (phase === "FLYING") {
        setInputsDisabled(true);
        setCrashedUI(false);
        statusTextEl.innerText = "UÇUŞTA";
        multiplierEl.innerText = displayMultiplier.toFixed(2) + "x";
    } else { // CRASHED
        setInputsDisabled(true);
        setCrashedUI(true);
        statusTextEl.innerText = "PATLADI";
        multiplierEl.innerText = serverMultiplier.toFixed(2) + "x";
    }

    updateTopBar();
    updateButtons();
}

/* Yumuşatma: polling jitter olmasın */
function animateDisplayMultiplier() {
    // displayMultiplier -> serverMultiplier
    const diff = serverMultiplier - displayMultiplier;
    displayMultiplier += diff * 0.25; // smoothing
    displayMultiplier = Math.max(1.0, displayMultiplier);

    if (phase === "FLYING") {
        // çizgi ilerleyişi (görsel)
        lineProgress = clamp(lineProgress + 0.0025, 0, 1);
        multiplierEl.innerText = displayMultiplier.toFixed(2) + "x";
    } else {
        // countdown/crashed state’te multiplier text applyServerState içinde set ediliyor
    }

    requestAnimationFrame(animateDisplayMultiplier);
}
requestAnimationFrame(animateDisplayMultiplier);

/* Canvas çizim loop */
function draw() {
    ctx.fillStyle = "#02050e";
    ctx.fillRect(0,0,width,height);

    ctx.fillStyle = "white";
    stars.forEach(s => {
        s.y += (phase === "FLYING" ? displayMultiplier * 0.4 : 0.2);
        if(s.y > height) s.y = 0;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.s, 0, Math.PI*2);
        ctx.fill();
    });

    if(phase === "FLYING") {
        ctx.save();
        ctx.shadowBlur = 15; ctx.shadowColor = "#4fd1ff";
        ctx.strokeStyle = "#4fd1ff"; ctx.lineWidth = 4; ctx.lineCap = "round";

        const startX = 0, startY = height;
        const cpX = width * 0.5;
        const cpY = height * (1 - (displayMultiplier / 10));
        const endX = width * (0.85 + (lineProgress * 0.15));
        const endY = height * (0.8 - (lineProgress * 0.6));

        ctx.setLineDash([width * 2]);
        ctx.lineDashOffset = (width * 2) * (1 - lineProgress);

        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.quadraticCurveTo(cpX, Math.max(0, cpY), endX, Math.max(0, endY));
        ctx.stroke();
        ctx.restore();
    }

    requestAnimationFrame(draw);
}
draw();

/* Bet / Cancel / Cashout (sunucu) */
async function placeBet(box) {
    if (!gameStarted) return;
    if (phase !== "COUNTDOWN") return;

    const input = (box === 1) ? betInput1 : betInput2;
    const amount = Math.floor(parseInt(input.value, 10)) || 0;
    if (amount <= 0) return;

    if (box === 1) isProcessing1 = true;
    if (box === 2) isProcessing2 = true;
    updateButtons();

    try {
        const r = await apiFetch("/api/crash/bet", "POST", { box, amount });
        if (r.__ignored) return;

        if (typeof r.balance !== "undefined") balance = Number(r.balance || 0);
        if (r.bets) {
            bets["1"] = { ...bets["1"], ...(r.bets["1"] || r.bets[1] || {}) };
            bets["2"] = { ...bets["2"], ...(r.bets["2"] || r.bets[2] || {}) };
            bets["1"].activeBet = Number(bets["1"].activeBet || 0);
            bets["2"].activeBet = Number(bets["2"].activeBet || 0);
        }

        playSfx('bet');
        updateTopBar();
    } catch (e) {
        console.error(e);
    } finally {
        if (box === 1) isProcessing1 = false;
        if (box === 2) isProcessing2 = false;
        updateButtons();
    }
}

async function cancelBet(box) {
    if (!gameStarted) return;
    if (phase !== "COUNTDOWN") return;

    if (box === 1) isProcessing1 = true;
    if (box === 2) isProcessing2 = true;
    updateButtons();

    try {
        const r = await apiFetch("/api/crash/cancel", "POST", { box });
        if (r.__ignored) return;

        if (typeof r.balance !== "undefined") balance = Number(r.balance || 0);
        if (r.bets) {
            bets["1"] = { ...bets["1"], ...(r.bets["1"] || r.bets[1] || {}) };
            bets["2"] = { ...bets["2"], ...(r.bets["2"] || r.bets[2] || {}) };
            bets["1"].activeBet = Number(bets["1"].activeBet || 0);
            bets["2"].activeBet = Number(bets["2"].activeBet || 0);
        }

        updateTopBar();
    } catch (e) {
        console.error(e);
    } finally {
        if (box === 1) isProcessing1 = false;
        if (box === 2) isProcessing2 = false;
        updateButtons();
    }
}

async function cashout(box) {
    if (!gameStarted) return;
    if (phase !== "FLYING") return;

    if (box === 1) isProcessing1 = true;
    if (box === 2) isProcessing2 = true;
    updateButtons();

    try {
        const r = await apiFetch("/api/crash/cashout", "POST", { box });
        if (r.__ignored) return;

        if (typeof r.balance !== "undefined") balance = Number(r.balance || 0);
        if (r.bets) {
            bets["1"] = { ...bets["1"], ...(r.bets["1"] || r.bets[1] || {}) };
            bets["2"] = { ...bets["2"], ...(r.bets["2"] || r.bets[2] || {}) };
            bets["1"].activeBet = Number(bets["1"].activeBet || 0);
            bets["2"].activeBet = Number(bets["2"].activeBet || 0);
        }

        if (Number(r.payout || 0) > 0) playSfx('cash');
        updateTopBar();
    } catch (e) {
        console.error(e);
    } finally {
        if (box === 1) isProcessing1 = false;
        if (box === 2) isProcessing2 = false;
        updateButtons();
    }
}

/* Button click logic (phase + activeBet’e göre doğru action) */
btn1.onclick = async () => {
    const active = Number(bets["1"]?.activeBet || 0);
    if (phase === "COUNTDOWN") {
        if (active > 0) return cancelBet(1);
        return placeBet(1);
    }
    if (phase === "FLYING") {
        if (active > 0) return cashout(1);
    }
};
btn2.onclick = async () => {
    const active = Number(bets["2"]?.activeBet || 0);
    if (phase === "COUNTDOWN") {
        if (active > 0) return cancelBet(2);
        return placeBet(2);
    }
    if (phase === "FLYING") {
        if (active > 0) return cashout(2);
    }
};

autoSwitch1.onchange = (e) => auto1 = !!e.target.checked;
autoSwitch2.onchange = (e) => auto2 = !!e.target.checked;

/* Sync loop: phase’e göre daha sık/seyrek */
let syncTimer = null;
let syncing = false;

async function syncOnce() {
    if (!gameStarted) return;
    if (!auth.currentUser) return;
    if (syncing) return;

    syncing = true;
    try {
        const s = await apiFetch("/api/crash/state", "GET");
        if (s.__ignored) return;

        // apply state
        applyServerState(s);

        // Auto-bet: COUNTDOWN'da aktif bet yoksa bas
        if (phase === "COUNTDOWN") {
            if (auto1 && Number(bets["1"]?.activeBet||0) === 0 && !isProcessing1) {
                // küçük gecikme: spam önle
                setTimeout(() => { if (phase === "COUNTDOWN") placeBet(1); }, 60);
            }
            if (auto2 && Number(bets["2"]?.activeBet||0) === 0 && !isProcessing2) {
                setTimeout(() => { if (phase === "COUNTDOWN") placeBet(2); }, 60);
            }
        }

    } catch (e) {
        // bağlantı gidince UI donmasın
        statusTextEl.innerText = "BAĞLANTI...";
    } finally {
        syncing = false;
    }
}

function startSyncLoop() {
    if (syncTimer) return;

    // İlk me
    apiFetch("/api/me", "GET").then(r => {
        if (!r.__ignored) {
            balance = Number(r.balance || 0);
            updateTopBar();
        }
    }).catch(()=>{});

    // state loop
    syncOnce();
    syncTimer = setInterval(() => {
        // uçuşta daha sık
        syncOnce();
    }, 250);
}

/* auth bootstrap */
onAuthStateChanged(auth, async (user) => {
    authReady = true;
    if (!user) {
        await signInAnonymously(auth);
        return;
    }
    // user geldi; eğer oyun başlatıldıysa sync başlat
    if (gameStarted) startSyncLoop();
});

/* visibility: arka plana gidince gereksiz spam azalt */
document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
        if (syncTimer) { clearInterval(syncTimer); syncTimer = null; }
    } else {
        if (gameStarted && auth.currentUser) startSyncLoop();
    }
});
</script>

</body>
</html>
