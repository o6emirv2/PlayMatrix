<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PlayMatrix VIP BlackJack</title>

<style>
    /* RESET VE TEMEL STİLLER */
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;}
    
    body {
        height:100vh; width: 100vw; overflow:hidden;
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
        background-color: #0b3d22;
        background-image: 
            radial-gradient(ellipse at 50% 30%, rgba(255, 255, 255, 0.15) 0%, rgba(0, 0, 0, 0.6) 80%),
            repeating-radial-gradient(rgba(0,0,0,0.1) 0, rgba(0,0,0,0.1) 2px, transparent 2px, transparent 4px),
            linear-gradient(180deg, #094726 0%, #062b16 100%);
        box-shadow: inset 0 0 100px rgba(0,0,0,0.9); 
        color:white; touch-action:manipulation; display: flex; flex-direction: column;
    }

    /* ÜST BAR */
    .top-bar {
        position:fixed; top:0; left: 0; right: 0; height:70px;
        display:flex; align-items:center; justify-content:space-between;
        padding:0 15px; background: rgba(5, 10, 5, 0.95); 
        border-bottom: 2px solid #d4af37; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        z-index:1000; width: 100%; box-sizing: border-box;
    }

    .brand {
        font-size:1.1rem; font-weight:900; color: #d4af37;
        letter-spacing: 1px; font-family: 'Arial Black', sans-serif;
        text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); white-space: nowrap;
    }

    .right-menu { display:flex; gap:8px; align-items: center; flex-wrap: nowrap; }
    
    .user-pill-mini { 
        display: flex; align-items: center; gap: 6px; 
        background: rgba(255,255,255,0.05); padding: 5px 10px; 
        border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); 
        white-space: nowrap;
    }
    .balance-info { display: flex; align-items: center; }
    .balance-info b { font-size: 13px; color: #00ffa3; font-family: 'Inter', monospace; font-weight: 700; }
    
    .mc-chip {
        width: 20px; height: 20px;
        background: radial-gradient(circle at 30% 30%, #4fd1ff, #0055ff);
        border-radius: 50%; margin-left: 5px;
        display: flex; align-items: center; justify-content: center;
        font-size: 8px; font-weight: 900; color: #fff;
        box-shadow: 0 0 10px rgba(79, 209, 255, 0.3);
        border: 1.2px solid rgba(255,255,255,0.2);
    }

    .back-btn {
        background: linear-gradient(180deg, #e74c3c, #c0392b); color: white; 
        text-decoration: none; padding: 6px 10px;
        border-radius: 4px; font-size: 0.7rem; font-weight: 900;
        clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
        border: 1px solid #ff7675; white-space: nowrap;
    }

    /* OYUN ALANI */
    .game-container { 
        flex: 1; display: flex; flex-direction: column; justify-content: space-between; 
        padding: 85px 0 20px 0; perspective: 1000px; position: relative;
    }
    
    .game-container::after {
        content: ''; position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
        width: 150vw; height: 300px; border-radius: 50%;
        border-top: 2px dashed rgba(212, 175, 55, 0.3); 
        pointer-events: none; z-index: 1;
    }

    .area { width: 100%; text-align: center; z-index: 2; position: relative; }
    .dealer-title { 
        font-size: 15px; letter-spacing: 5px; font-weight: 800; color: #d4af37; 
        margin-bottom: 5px; text-transform: uppercase; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }
    .score-badge { 
        background: rgba(0,0,0,0.8); color: #fff; padding: 4px 15px; 
        border-radius: 20px; font-size: 14px; font-weight: 700;
        border: 1px solid #d4af37; display: inline-block; margin-bottom: 10px; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }

    .cards-wrapper { 
        display: flex; justify-content: center; gap: -25px; 
        min-height: 110px; padding: 0 10px; flex-wrap: nowrap; 
        position: relative; z-index: 5;
    }
    
    .card-3d {
        width: 75px; height: 105px; position: relative;
        transform-style: preserve-3d;
        transform: translate(350px, -250px) rotateZ(45deg) scale(0.4);
        opacity: 0; margin-left: -40px; 
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1), opacity 0.3s;
        filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.6));
    }
    .card-3d:first-child { margin-left: 0; }

    .card-3d.show { transform: translate(0, 0) rotateZ(0deg) scale(1); opacity: 1; }
    .card-3d.flipped { transform: translate(0, 0) rotateY(180deg); }

    .card-face {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden; border-radius: 6px;
        border: 1px solid rgba(255,255,255,0.2);
    }

    .card-front { background: white; transform: rotateY(180deg); }
    .card-back { background: url('https://deckofcardsapi.com/static/img/back.png') no-repeat center/cover; }

    #message { 
        font-size: 20px; font-weight: 900; color: #fff; 
        text-shadow: 0 4px 15px rgba(0,0,0,0.9), 0 0 20px rgba(212, 175, 55, 0.5); 
        height: 35px; display: flex; align-items: center; justify-content: center;
        letter-spacing: 1px; z-index: 10; position: relative;
    }

    .controls { display: none; gap: 20px; justify-content: center; margin-bottom: 15px; z-index: 10; position: relative; }
    .btn { 
        padding: 14px 30px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); 
        font-weight: 900; font-size: 16px; color: white; cursor: pointer; letter-spacing: 1px;
        transition: 0.2s; text-transform: uppercase;
    }
    #hit { background: linear-gradient(180deg, #2ecc71, #27ae60); box-shadow: 0 6px 0 #1e8449, 0 10px 20px rgba(0,0,0,0.5); }
    #stand { background: linear-gradient(180deg, #e74c3c, #c0392b); box-shadow: 0 6px 0 #922b21, 0 10px 20px rgba(0,0,0,0.5); }
    .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.5), 0 5px 10px rgba(0,0,0,0.5) !important; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

    .chips-area { display: flex; justify-content: center; gap: 10px; padding-bottom: 25px; align-items: center; flex-wrap: wrap; z-index: 10; position: relative;}
    
    .chip {
        width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-weight: 900; font-size: 14px; cursor: pointer; transition: transform 0.1s;
        border: 4px dashed rgba(0,0,0,0.3); 
        box-shadow: inset 0 0 10px rgba(255,255,255,0.3), 0 8px 15px rgba(0,0,0,0.6), 0 2px 0 #333;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .chip:active { transform: scale(0.9) translateY(4px); box-shadow: 0 2px 5px rgba(0,0,0,0.6); }
    
    .c250 { background: radial-gradient(circle, #f5f6fa 40%, #dcdde1 100%); color: #2f3640; border-color: #7f8fa6; }
    .c500 { background: radial-gradient(circle, #4cd137 40%, #44bd32 100%); color: #fff; border-color: #2f3640; }
    .c1k { background: radial-gradient(circle, #e84118 40%, #c23616 100%); color: #fff; border-color: #2f3640; }
    .c2k { background: radial-gradient(circle, #2f3640 40%, #192a56 100%); color: #d4af37; border-color: #d4af37; }
    
    .cancel-btn {
        width: 50px; height: 50px; border-radius: 50%; background: #c0392b; color: white;
        display: flex; align-items: center; justify-content: center; font-weight: 800;
        font-size: 10px; cursor: pointer; border: 2px solid #e74c3c; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .cancel-btn:active { transform: scale(0.9); }
    .disabled { opacity: 0.4; pointer-events: none; filter: grayscale(0.8); }

    /* BAŞLANGIÇ MODALI */
    .start-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.95);
        display: flex; align-items: center; justify-content: center;
        z-index: 9999; backdrop-filter: blur(15px); flex-direction: column;
    }
    .start-modal {
        background: linear-gradient(180deg, #111 0%, #222 100%); padding: 40px; border-radius: 20px; 
        text-align: center; border: 2px solid #d4af37; box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
        width: 85%; max-width: 350px;
    }

    /* UYARI MODALI */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
        display: none; align-items: center; justify-content: center; z-index: 9999;
    }
    .modal-content {
        background: #111; border: 2px solid #d4af37; border-radius: 20px;
        width: 85%; max-width: 320px; padding: 25px; text-align: center;
        box-shadow: 0 0 40px rgba(0,0,0,0.8);
    }
    .modal-icon { font-size: 40px; margin-bottom: 15px; color: #e74c3c; }
    .modal-text { font-weight: 700; font-size: 16px; line-height: 1.5; margin-bottom: 20px; color:#fff;}
    .modal-btn {
        background: linear-gradient(180deg, #d4af37, #aa8a29); color: #000; padding: 12px 30px; border-radius: 10px;
        font-weight: 900; border: none; cursor: pointer; font-size: 14px; text-transform: uppercase;
    }
</style>
</head>
<body>

<div id="sys-start-overlay" class="start-overlay">
    <div class="start-modal">
        <h2 style="font-family:'Arial Black', sans-serif; color:#d4af37; font-size: 22px; margin-bottom: 10px; text-shadow: 0 0 15px rgba(212,175,55,0.5);">VIP CASINO</h2>
        <p style="font-size: 13px; color: #bbb; margin-bottom: 25px;">Gerçekçi masa seslerini ve kurupiyer algoritmasını aktifleştirmek için masaya oturun.</p>
        <button id="systemStartBtn" style="width: 100%; padding: 15px; border-radius: 12px; border: none; background: linear-gradient(90deg, #d4af37, #f1c40f); color: #000; font-weight: 900; font-size: 16px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 15px rgba(212,175,55,0.4);">Masaya Otur</button>
    </div>
</div>

<div id="alertModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-icon" id="modalIcon">⚠️</div>
        <div class="modal-text" id="modalMsg">Hata oluştu.</div>
        <button class="modal-btn" onclick="document.getElementById('alertModal').style.display='none'">TAMAM</button>
    </div>
</div>

<div class="top-bar">
    <div class="brand">BLACKJACK</div>
    <div class="right-menu">
        <div class="user-pill-mini">
            <div class="balance-info">
                <b id="balance">0</b>
                <div class="mc-chip">MC</div>
            </div>
        </div>
        
        <div class="user-pill-mini" style="border-color: #ffcc00;">
            <div class="balance-info">
                <b id="betAmount" style="color:#ffcc00">0</b>
                <div class="mc-chip" style="background: radial-gradient(circle at 30% 30%, #ffcc00, #ff8a00); box-shadow: 0 0 10px rgba(255, 204, 0, 0.3);">MC</div>
            </div>
        </div>

        <a href="index.html" class="back-btn">ÇIKIŞ</a>
    </div>
</div>

<div class="game-container">
    <div class="area">
        <div class="dealer-title">KURUPİYER</div>
        <div class="score-badge">Toplam: <span id="dealerScore">0</span></div>
        <div id="dealerCards" class="cards-wrapper"></div>
    </div>

    <div class="area">
        <div id="message">BAHİS YAPIN (MİN: 250)</div>
        <div class="controls" id="controls">
            <button id="hit" class="btn">KART ÇEK</button>
            <button id="stand" class="btn">KAL</button>
        </div>
    </div>

    <div class="area">
        <div id="playerCards" class="cards-wrapper"></div>
        <div class="score-badge">Toplam: <span id="playerScore">0</span></div>
    </div>

    <div class="chips-area" id="chipsArea">
        <div class="cancel-btn" id="cancelBet" onclick="cancelBet()">İPTAL</div>
        <div class="chip c250" onclick="addBet(250)">250</div>
        <div class="chip c500" onclick="addBet(500)">500</div>
        <div class="chip c1k" onclick="addBet(1000)">1K</div>
        <div class="chip c2k" onclick="addBet(2000)">2K</div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let balance = 0; 
let localBet = 0; 
let userRef = null;
let gameState = "loading"; 
let betCountdown = null;
let actionTimer = null;
let isProcessing = false; 
let deck = [], player = [], dealer = [], dealerHidden = true;

const messageEl = document.getElementById("message");

window.showModal = (msg, isSuccess = false) => {
    document.getElementById("modalIcon").innerText = isSuccess ? "✅" : "⚠️";
    document.getElementById("modalIcon").style.color = isSuccess ? "#2ecc71" : "#e74c3c";
    document.getElementById("modalMsg").innerText = msg;
    document.getElementById("alertModal").style.display = "flex";
}

// --- PROFESYONEL SES MOTORU ---
const sounds = {};
let audioCtx = null;

async function initAudio() {
    if (audioCtx) return;
    try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const buffer = audioCtx.createBuffer(1, 1, 22050);
        const source = audioCtx.createBufferSource();
        source.buffer = buffer; source.connect(audioCtx.destination); source.start(0);

        // Çip sesi hariç, BUST, TİCK (Geri Sayım) ve DİĞER sesler MP3 yapıldı.
        const urls = {
            card: 'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3', // Kart
            win: 'https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3',  // Kazanma
            lose: 'https://assets.mixkit.co/active_storage/sfx/2802/2802-preview.mp3', // Patlama / Kaybetme
            tick: 'https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'  // Geri Sayım / Tick
        };
        
        for (const [name, url] of Object.entries(urls)) {
            fetch(url).then(res => res.arrayBuffer()).then(buf => audioCtx.decodeAudioData(buf))
            .then(decoded => sounds[name] = decoded).catch(e => console.warn(`Ses yüklenemedi: ${name}`));
        }
    } catch(e) { console.error("Ses açılamadı:", e); }
}

document.getElementById('systemStartBtn').addEventListener('click', () => {
    initAudio();
    document.getElementById('sys-start-overlay').style.display = 'none';
});

function playSound(name) {
    if (!audioCtx) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    // Çip sesi için orijinal Oscillator dokunulmadı
    if (name === 'chip') {
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine'; osc.frequency.setValueAtTime(350, now);
        gain.gain.setValueAtTime(0.5, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(now); osc.stop(now + 0.05);
        
        const osc2 = audioCtx.createOscillator();
        const gain2 = audioCtx.createGain();
        osc2.type = 'triangle'; osc2.frequency.setValueAtTime(2500, now);
        gain2.gain.setValueAtTime(0.1, now);
        gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.03);
        osc2.connect(gain2); gain2.connect(audioCtx.destination);
        osc2.start(now); osc2.stop(now + 0.03);
        return;
    }
    
    // Diğer sesler Buffer'dan çalınır
    if(sounds[name]) {
        const source = audioCtx.createBufferSource();
        source.buffer = sounds[name];
        source.connect(audioCtx.destination);
        source.start(0);
    }
}

// --- FİREBASE DİNLEYİCİSİ ---
onAuthStateChanged(auth, user => {
    if(!user) { signInAnonymously(auth); return; }
    userRef = doc(db, "users", user.uid);
    onSnapshot(userRef, snap => {
        if(snap.exists()) {
            balance = snap.data().balance || 0;
            if(gameState === "loading" || gameState === "betting") {
                document.getElementById("balance").innerText = balance.toLocaleString('tr-TR');
                if(gameState === "loading") gameState = "betting";
            }
        }
    });
});

// --- BAHİS SİSTEMİ ---
window.addBet = (amount) => {
    if(gameState !== "betting" || isProcessing) return;
    if(localBet + amount > balance) { showModal("BAKİYENİZ YETERSİZ!"); return; }
    if(localBet + amount > 50000) { showModal("MAKSİMUM BAHİS 50.000 MC!"); return; }
    
    playSound('chip');
    localBet += amount;
    
    document.getElementById("balance").innerText = (balance - localBet).toLocaleString('tr-TR');
    document.getElementById("betAmount").innerText = localBet.toLocaleString('tr-TR');
    
    if(!betCountdown && localBet >= 250) startBetCountdown();
};

window.cancelBet = () => {
    if(gameState !== "betting" || localBet === 0 || isProcessing) return;
    localBet = 0;
    playSound('chip');
    document.getElementById("balance").innerText = balance.toLocaleString('tr-TR');
    document.getElementById("betAmount").innerText = "0";
    if(betCountdown) { clearInterval(betCountdown); betCountdown = null; }
    messageEl.innerText = "BAHİS YAPIN (MİN: 250)";
};

function startBetCountdown(){
    let s = 5;
    messageEl.innerText = "KARTLAR DAĞITILIYOR: " + s;
    playSound('tick'); // Geri Sayım Sesi
    betCountdown = setInterval(() => {
        s--;
        if(s > 0) {
            messageEl.innerText = "KARTLAR DAĞITILIYOR: " + s;
            playSound('tick');
        } else { 
            clearInterval(betCountdown); 
            betCountdown = null; 
            startGame(); 
        }
    }, 1000);
}

// --- DESTE VE KART YÖNETİMİ ---
function createDeck(){
    const s=["H","D","C","S"], v=[1,2,3,4,5,6,7,8,9,10,11,12,13];
    deck = [];
    for(let d=0; d<4; d++) {
        s.forEach(x => v.forEach(y => deck.push({suit:x, value:y})));
    }
    deck.sort(() => Math.random() - 0.5); 
}

// Kart görselleri için 10'un sıfır olarak API'den çekilmesi gerekir. 
function cardVal(v){ let m = {1:"A", 10:"0", 11:"J", 12:"Q", 13:"K"}; return m[v] || v; }

function total(hand){
    let t=0, aces=0;
    hand.forEach(c => { 
        let v = c.value > 10 ? 10 : (c.value === 1 ? 11 : c.value); 
        if(v===11) aces++; 
        t += v; 
    });
    while(t > 21 && aces > 0){ t -= 10; aces--; }
    return t;
}

function updateScores(){
    document.getElementById("playerScore").innerText = total(player);
    if(dealer.length === 0) {
        document.getElementById("dealerScore").innerText = "0";
    } else {
        let dScore = dealerHidden ? 
            (dealer[0].value > 10 ? 10 : (dealer[0].value === 1 ? 11 : dealer[0].value)) : 
            total(dealer);
        document.getElementById("dealerScore").innerText = dScore;
    }
}

async function draw(hand, divId, isHidden = false, forceCard = null){
    playSound('card');
    let card = forceCard ? forceCard : deck.pop();
    hand.push(card);
    
    const cardCont = document.createElement("div");
    cardCont.className = "card-3d";
    
    // API için doğru dönüştürme (0 = 10 değerindeki kart)
    let valStr = cardVal(card.value);
    
    cardCont.innerHTML = `
        <div class="card-face card-front" style="background: url('https://deckofcardsapi.com/static/img/${valStr}${card.suit}.png') center/cover"></div>
        <div class="card-face card-back"></div>
    `;
    document.getElementById(divId).appendChild(cardCont);
    
    return new Promise(resolve => {
        setTimeout(() => { 
            cardCont.classList.add("show"); 
            if(!isHidden) {
                setTimeout(() => {
                    cardCont.classList.add("flipped");
                    updateScores();
                    resolve();
                }, 150); 
            } else {
                updateScores();
                resolve();
            }
        }, 50);
    });
}

// --- OYUN AKIŞI ---
async function startGame(){
    if(localBet < 250) { messageEl.innerText = "MİNİMUM 250 MC!"; return; }
    
    isProcessing = true;
    gameState = "playing"; 
    
    document.getElementById("chipsArea").classList.add("disabled");
    document.getElementById("dealerCards").innerHTML = "";
    document.getElementById("playerCards").innerHTML = "";
    player = []; dealer = []; dealerHidden = true;
    messageEl.innerText = "";
    
    createDeck(); 
    
    try {
        await updateDoc(userRef, { balance: increment(-localBet) });
    } catch(e) {
        showModal("Bağlantı hatası, bahis alınamadı.");
        resetBoard();
        return;
    }

    await draw(player, "playerCards"); await delay(300);
    await draw(dealer, "dealerCards"); await delay(300);
    await draw(player, "playerCards"); await delay(300);
    await draw(dealer, "dealerCards", true);

    const pTotal = total(player);
    const dTotal = total(dealer);

    if(pTotal === 21) { 
        messageEl.innerText = "BLACKJACK!"; 
        playSound('win');
        await delay(1000); 
        
        dealerHidden = false;
        const cards = document.getElementById("dealerCards").querySelectorAll('.card-3d');
        if(cards[1]) cards[1].classList.add("flipped");
        updateScores();
        await delay(1000);
        
        if(dTotal === 21) {
            endGame("BERABERE (PUSH)", 1); 
        } else {
            endGame("BLACKJACK KAZANCI!", 2.5); 
        }
    } else { 
        isProcessing = false; // Kilit açıldı, oyuncu karar verebilir.
        document.getElementById("controls").style.display = "flex"; 
        startActionTimer(); 
    }
}

// --- OYUNCU KARAR AŞAMASI ---
function startActionTimer(){
    let s = 10;
    messageEl.innerText = "KARAR SÜRESİ (" + s + ")";
    playSound('tick');
    if (actionTimer) clearInterval(actionTimer);
    
    actionTimer = setInterval(() => {
        s--;
        if(s > 0) {
            messageEl.innerText = "KARAR SÜRESİ (" + s + ")";
            if(s <= 3) playSound('tick'); // Son 3 saniye uyarısı
        }
        else { 
            clearInterval(actionTimer); actionTimer = null; 
            if(gameState === "playing" && !isProcessing) {
                messageEl.innerText = ""; // SÜRE YAZISI GİDER
                stand(); 
            }
        }
    }, 1000);
}

document.getElementById("hit").onclick = async () => {
    if(gameState !== "playing" || isProcessing) return;
    isProcessing = true; 
    
    if(actionTimer) { clearInterval(actionTimer); actionTimer = null; }
    messageEl.innerText = ""; // Karar verildiği an süre yazısı gider.
    document.getElementById("controls").style.display = "none";
    
    await draw(player, "playerCards");
    
    if(total(player) >= 21) {
        dealerTurn(); 
    } else { 
        isProcessing = false; 
        document.getElementById("controls").style.display = "flex"; 
        startActionTimer(); 
    }
};

const stand = () => { 
    if(gameState !== "playing" || isProcessing) return;
    isProcessing = true; 
    
    if(actionTimer) { clearInterval(actionTimer); actionTimer = null; }
    messageEl.innerText = ""; // Karar verildiği an süre yazısı gider.
    document.getElementById("controls").style.display="none"; 
    dealerTurn(); 
};
document.getElementById("stand").onclick = stand;

// --- KURUPIYER ALGORİTMASI ---
async function dealerTurn(){
    gameState = "dealer_turn";
    dealerHidden = false;
    
    const cards = document.getElementById("dealerCards").querySelectorAll('.card-3d');
    if(cards[1]) cards[1].classList.add("flipped");
    updateScores();
    playSound('card'); 
    await delay(1000);

    const pScore = total(player);
    
    if(pScore <= 21) {
        while(total(dealer) < 17) {
            let cheatCard = null;
            let cheatChance = localBet >= 10000 ? 0.70 : (localBet >= 5000 ? 0.40 : 0);
            
            if (Math.random() < cheatChance) {
                const currentD = total(dealer);
                let bestIdx = deck.findIndex(c => {
                    let v = c.value > 10 ? 10 : (c.value === 1 ? 11 : c.value);
                    return (currentD + v <= 21) && (currentD + v >= 17 || currentD + v > pScore);
                });
                if (bestIdx !== -1) {
                    cheatCard = deck.splice(bestIdx, 1)[0]; 
                }
            }

            await draw(dealer, "dealerCards", false, cheatCard); 
            await delay(800); 
        }
    }
    
    endGameLogic();
}

async function endGameLogic(){
    gameState = "resolving";
    let p = total(player);
    let d = total(dealer);
    let m = 0; 
    let txt = "";

    if(p > 21) { 
        txt = "PATLADIN! (KASA KAZANDI)"; 
        playSound('lose');
    }
    else if(d > 21) { 
        txt = "KASA PATLADI! KAZANDIN!"; 
        m = 2; 
        playSound('win'); 
    }
    else if(p > d) { 
        txt = "KAZANDIN!"; 
        m = 2; 
        playSound('win'); 
    }
    else if(d > p) { 
        txt = "KAYBETTİN!"; 
        playSound('lose');
    }
    else { 
        txt = "BERABERE (PUSH)"; 
        m = 1; 
    }
    
    endGame(txt, m);
}

async function endGame(text, multiplier) {
    messageEl.innerText = text;

    if(multiplier > 0) {
        let winAmount = Math.floor(localBet * multiplier);
        try {
            await updateDoc(userRef, { balance: increment(winAmount) });
        } catch(e) { console.error("Ödeme hatası:", e); }
    }

    await delay(3500);
    resetBoard();
}

function resetBoard() {
    document.getElementById("dealerCards").innerHTML = "";
    document.getElementById("playerCards").innerHTML = "";
    document.getElementById("dealerScore").innerText = "0";
    document.getElementById("playerScore").innerText = "0";
    
    localBet = 0; 
    document.getElementById("betAmount").innerText = "0";
    
    document.getElementById("balance").innerText = balance.toLocaleString('tr-TR');
    document.getElementById("chipsArea").classList.remove("disabled");
    messageEl.innerText = "BAHİS YAPIN (MİN: 250)";
    
    isProcessing = false;
    gameState = "betting";
}

function delay(ms){ return new Promise(r => setTimeout(r, ms)); }

</script>
</body>
</html>
