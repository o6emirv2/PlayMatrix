<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<title>PlayMatrix VIP Lüks BlackJack | Ücretsiz Online Casino 21 Oyna</title>
<meta name="description" content="PlayMatrix VIP Lüks Blackjack oyna! Şansını dene, 21'i bul, krupiyeyi yen ve anında MC kazan. Kesintisiz ve indirmesiz online casino deneyimi seni bekliyor.">
<meta name="keywords" content="blackjack oyna, online blackjack, ücretsiz casino, 21 oyna, PlayMatrix, VIP casino, tarayıcı oyunları, mc kazan">
<meta name="author" content="PlayMatrix Global">
<meta name="robots" content="index, follow">
<meta name="language" content="Turkish">
<meta name="theme-color" content="#0d5c2e">
<link rel="canonical" href="https://playmatrix.com.tr/BlackJack.html">

<meta property="og:title" content="PlayMatrix VIP Lüks Blackjack Oyna">
<meta property="og:description" content="21'e ulaş, krupiyeyi alt et ve binlerce MC kazan! PlayMatrix'te kesintisiz casino heyecanına hemen katıl.">
<meta property="og:image" content="https://playmatrix.com.tr/assets/blackjack-promo.jpg">
<meta property="og:url" content="https://playmatrix.com.tr/BlackJack.html">
<meta property="og:type" content="website">
<meta property="og:site_name" content="PlayMatrix">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="PlayMatrix VIP Blackjack Oyna">
<meta name="twitter:description" content="Masaya otur, kartlarını çek ve 21'i bularak MC kazanmaya başla!">

<script>
  if (window.history.replaceState) window.history.replaceState(null, null, "/");
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;}
body{height:100vh;width:100vw;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto, Helvetica, Arial, sans-serif;
background: radial-gradient(circle at 50% -20%, rgba(212,175,55,0.15) 0%, transparent 50%),
            radial-gradient(circle at 50% 50%, #0d5c2e 0%, #073b1c 60%, #031c0c 100%);
color:white;touch-action:manipulation;display:flex;flex-direction:column;}
.top-bar{position:fixed;top:0;left:0;right:0;height:65px;display:flex;align-items:center;justify-content:space-between;
padding:0 10px;background: linear-gradient(to bottom, #1a1a1a 0%, #000000 100%);border-bottom: 2px solid #d4af37;z-index:1000;
box-shadow: 0 4px 20px rgba(0,0,0,0.8);}
h1.brand{margin:0;padding:0;font-size: clamp(0.9rem, 4vw, 1.1rem);font-weight:900;color:#d4af37;letter-spacing:1px;
font-family:'Times New Roman', Times, serif;white-space:nowrap;flex-shrink:0;text-shadow: 0 2px 4px rgba(0,0,0,1);}
.right-menu{display:flex;gap:5px;align-items:center;flex-wrap:nowrap;overflow:hidden;justify-content:flex-end;flex:1;margin-left:10px;}
.user-pill-mini{display:flex;align-items:center;gap:4px;background: linear-gradient(145deg, #222, #111);padding:4px 8px;border-radius:15px;
border:1px solid rgba(212,175,55,0.4);white-space:nowrap;flex-shrink:1;min-width:0;}
.balance-info{display:flex;align-items:center;overflow:hidden;}
.balance-info b{font-size: clamp(11px, 3.5vw, 13px);color:#00ffa3;font-family:monospace;font-weight:700;text-overflow:ellipsis;overflow:hidden;}
.mc-chip{width:16px;height:16px;flex-shrink:0;background: radial-gradient(circle at 30% 30%, #4fd1ff, #0055ff);border-radius:50%;margin-left:4px;
display:flex;align-items:center;justify-content:center;font-size:6px;font-weight:900;color:#fff;box-shadow:0 0 8px rgba(79, 209, 255, 0.4);
border:1px solid rgba(255,255,255,0.4);}
.back-btn{background: linear-gradient(to bottom, #ff4b4b, #cc0000);color:white;text-decoration:none;padding:5px 8px;border-radius:6px;
font-size: clamp(0.6rem, 2.5vw, 0.7rem);font-weight:900;flex-shrink:0;border:1px solid #7a0000;box-shadow:0 2px 5px rgba(0,0,0,0.5);}
.game-container{flex:1;display:flex;flex-direction:column;justify-content:space-between;padding:80px 0 20px 0;perspective:1200px;position:relative;overflow-y:auto;}
.area{width:100%;text-align:center;}
.dealer-title{font-size:14px;letter-spacing:4px;font-weight:900;color:#d4af37;margin-bottom:5px;text-shadow:0 2px 4px rgba(0,0,0,0.9);
font-family:'Times New Roman', Times, serif;}
.score-badge{background: linear-gradient(to bottom, rgba(30,30,30,0.9), rgba(10,10,10,0.9));color:#ffd700;padding:4px 18px;border-radius:20px;
font-size:12px;font-weight:bold;border:1px solid #d4af37;display:inline-block;margin-bottom:10px;box-shadow:0 4px 10px rgba(0,0,0,0.8),
inset 0 1px 3px rgba(255,255,255,0.1);}
.cards-wrapper{display:flex;justify-content:center;flex-wrap:wrap;gap:5px;margin-left:-15px;min-height:105px;padding:0 10px;}
.card-3d{width:65px;height:95px;position:relative;transform-style:preserve-3d;opacity:1;margin-left:-20px;}
.card-3d:first-child{margin-left:0;}
.card-3d.show{opacity:1;}
.card-3d.flipped{transform: rotateY(180deg);transition: transform 0.4s ease-in-out;}
.card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:6px;box-shadow:-4px 4px 12px rgba(0,0,0,0.7);}
.card-front{background:white;transform: rotateY(180deg);}
.card-back{background:url('https://deckofcardsapi.com/static/img/back.png') no-repeat center/cover;}
.action-area{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:85px;z-index:10;margin-top:10px;}
#message{font-size:14px;font-weight:900;color:#fff;text-shadow:0 2px 5px rgba(0,0,0,1);margin-bottom:10px;text-transform:uppercase;
background: linear-gradient(90deg, transparent, rgba(0,0,0,0.7), transparent);padding:5px 30px;border-radius:5px;letter-spacing:1px;}
.controls{display:none;gap:10px;justify-content:center;flex-wrap:wrap;width:100%;max-width:400px;padding:0 10px;}
.btn{padding:10px 18px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);font-weight:900;font-size:13px;color:white;cursor:pointer;
text-transform:uppercase;letter-spacing:1px;box-shadow:0 5px 15px rgba(0,0,0,0.5), inset 0 2px 2px rgba(255,255,255,0.2);transition: all 0.1s;}
#hit{background: linear-gradient(to bottom, #2ecc71, #229954);border-color:#1e8449;}
#stand{background: linear-gradient(to bottom, #e74c3c, #c0392b);border-color:#922b21;}
#double{background: linear-gradient(to bottom, #f1c40f, #d4ac0d);color:#000;border-color:#b7950b;}
#split{background: linear-gradient(to bottom, #9b59b6, #8e44ad);border-color:#76448a;}
.btn:active:not(:disabled){transform: translateY(4px);box-shadow: 0 1px 2px rgba(0,0,0,0.8), inset 0 2px 2px rgba(0,0,0,0.4);}
.btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important;}
.hands-container{display:flex;justify-content:center;flex-wrap:wrap;gap:15px;width:100%;transition:0.3s;}
.hand-box{display:flex;flex-direction:column;align-items:center;transition:0.3s;padding:10px;border-radius:10px;border:2px solid transparent;}
.hand-box.active{border:2px solid #d4af37;background: radial-gradient(circle, rgba(212,175,55,0.15), transparent);
box-shadow:0 0 20px rgba(212,175,55,0.2), inset 0 0 15px rgba(212,175,55,0.1);}
.chips-area{display:flex;justify-content:center;gap:8px;padding-bottom:20px;align-items:center;flex-wrap:wrap;transition:opacity 0.3s;}
.chip{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;cursor:pointer;transition:transform 0.1s;
border:4px dashed #d4af37;box-shadow:0 6px 12px rgba(0,0,0,0.6), inset 0 0 10px rgba(0,0,0,0.8);}
.chip:active{transform:scale(0.9);}
.c1k{background: radial-gradient(circle, #f0f0f0 30%, #a0a0a0 90%);color:#000;border-color:#666;}
.c3k{background: radial-gradient(circle, #2ecc71 30%, #176634 90%);color:#fff;border-color:#fff;}
.c5k{background: radial-gradient(circle, #e74c3c 30%, #7a160d 90%);color:#fff;border-color:#fff;}
.c15k{background: radial-gradient(circle, #3498db 30%, #154360 90%);color:#fff;border-color:#fff;}
.c20k{background: radial-gradient(circle, #9b59b6 30%, #4a235a 90%);color:#fff;border-color:#d4af37;}
.c50k{background: radial-gradient(circle, #333 30%, #000 90%);color:#d4af37;border-color:#d4af37;}
.cancel-btn{width:45px;height:45px;border-radius:50%;background: linear-gradient(to bottom, #555, #222);color:white;display:flex;align-items:center;justify-content:center;
font-weight:800;font-size:10px;cursor:pointer;border:2px solid #888;box-shadow:0 4px 8px rgba(0,0,0,0.6);}
.modal-overlay{position:fixed;inset:0;background: rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter: blur(8px);}
.modal-content{background: linear-gradient(to bottom, #1a1a1a, #0a0a0a);border:2px solid #d4af37;border-radius:15px;width:90%;max-width:380px;padding:25px;text-align:center;
box-shadow:0 0 40px rgba(212, 175, 55, 0.3);}
.rules-text{font-size:13px;color:#ccc;margin-bottom:20px;text-align:left;line-height:1.6;background: rgba(0,0,0,0.5);padding:15px;border-radius:10px;border:1px solid #333;}
</style>
</head>
<body>

<div id="sys-start-overlay" class="modal-overlay">
  <div class="modal-content">
    <h2 style="color:#d4af37; margin-bottom: 15px; letter-spacing: 2px; font-family: 'Times New Roman', Times, serif;">VIP LÜKS CASINO</h2>
    <div class="rules-text">
      <b>VIP Blackjack (21) Kuralları:</b><br>
      • Amacınız, kartlarınızın toplam değerini 21'e ulaştırmak veya 21'i geçmeden krupiyeden daha yüksek bir skor elde etmektir.<br>
      • 21'i geçerseniz anında kaybedersiniz (PATLADI).<br>
      • <b>Kart Değerleri:</b> Vale (J), Kız (Q), Papaz (K) 10 değerindedir. As (A) durumuna göre 1 veya 11 sayılır.<br><br>
      <span style="color: #ff4b4b; font-weight: bold;">ÖNEMLİ UYARI:</span>
      Lütfen stabil bir internet kullanın. Bağlantı kopukluğu, sayfayı yenileme veya oyundan düşme durumunda yatırdığınız MC <b>kesinlikle iade edilmeyecektir.</b>
    </div>
    <button id="systemStartBtn"
      style="width: 100%; padding: 15px; border-radius: 10px; border: none; background: linear-gradient(to bottom, #f1c40f, #d4ac0d); color: #000; font-weight: 900; font-size: 14px; cursor: pointer; box-shadow: 0 4px 15px rgba(212,175,55,0.4); text-transform: uppercase;"
      aria-label="Oyuna Başla">Masaya Otur</button>
  </div>
</div>

<header class="top-bar">
  <h1 class="brand">VIP BLACKJACK</h1>
  <nav class="right-menu" aria-label="Kullanıcı Menüsü">
    <div class="user-pill-mini">
      <div class="balance-info"><b id="balance">0</b></div>
      <div class="mc-chip">MC</div>
    </div>
    <div class="user-pill-mini" style="border-color: #ffcc00; background: linear-gradient(145deg, #332800, #1a1400);">
      <div class="balance-info"><b id="betAmount" style="color:#ffcc00">0</b></div>
      <div class="mc-chip" style="background: orange; box-shadow: 0 0 8px rgba(255, 165, 0, 0.4);">MC</div>
    </div>
    <a href="https://playmatrix.com.tr" class="back-btn" aria-label="Ana Sayfaya Dön">ÇIKIŞ</a>
  </nav>
</header>

<main class="game-container">
  <div class="area">
    <div class="dealer-title">KURUPİYER</div>
    <div class="score-badge">Toplam: <span id="dealerScore">0</span></div>
    <div id="dealerCards" class="cards-wrapper"></div>
  </div>

  <div class="action-area">
    <div id="message" aria-live="polite">MC KULLAN (MİN: 1K)</div>
    <div class="controls" id="controls">
      <button id="hit" class="btn" aria-label="Kart Çek">ÇEK</button>
      <button id="stand" class="btn" aria-label="Dur">KAL</button>
      <button id="double" class="btn" aria-label="Bahsi İkiye Katla">2X</button>
      <button id="split" class="btn" aria-label="Kartları Böl">BÖL</button>
    </div>
    <div class="controls" id="insurance-controls">
      <button id="ins-yes" class="btn" style="background: linear-gradient(to bottom, #2ecc71, #229954);" aria-label="Sigorta Al">EVET</button>
      <button id="ins-no" class="btn" style="background: linear-gradient(to bottom, #e74c3c, #c0392b);" aria-label="Sigorta Alma">HAYIR</button>
    </div>
  </div>

  <div class="hands-container" id="playerArea">
    <div class="hand-box active" id="hand0-box">
      <div id="hand0" class="cards-wrapper"></div>
      <div class="score-badge">Toplam: <span id="score0">0</span></div>
    </div>
    <div class="hand-box" id="hand1-box" style="display:none;">
      <div id="hand1" class="cards-wrapper"></div>
      <div class="score-badge">Toplam: <span id="score1">0</span></div>
    </div>
  </div>

  <div class="chips-area" id="chipsArea" aria-label="Bahis Çipleri">
    <div class="cancel-btn" onclick="cancelBet()" aria-label="Bahsi Temizle">SİL</div>
    <div class="chip c1k" onclick="addBet(1000)">1K</div>
    <div class="chip c3k" onclick="addBet(3000)">3K</div>
    <div class="chip c5k" onclick="addBet(5000)">5K</div>
    <div class="chip c15k" onclick="addBet(15000)">15K</div>
    <div class="chip c20k" onclick="addBet(20000)">20K</div>
    <div class="chip c50k" onclick="addBet(50000)">50K</div>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const API_URL = "https://SENIN-SERVER-ADRESIN.com"; // <-- BURAYI DÜZENLE

const firebaseConfig = {
  apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
  authDomain:"emirhan-site.firebaseapp.com",
  projectId:"emirhan-site",
  storageBucket:"emirhan-site.firebasestorage.app",
  messagingSenderId:"668871888390",
  appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const messageEl = document.getElementById("message");
const balanceEl = document.getElementById("balance");
const betAmountEl = document.getElementById("betAmount");

const dealerCardsEl = document.getElementById("dealerCards");
const dealerScoreEl = document.getElementById("dealerScore");

const hand0El = document.getElementById("hand0");
const hand1El = document.getElementById("hand1");
const hand0Box = document.getElementById("hand0-box");
const hand1Box = document.getElementById("hand1-box");

const score0El = document.getElementById("score0");
const score1El = document.getElementById("score1");

const controlsEl = document.getElementById("controls");
const insControls = document.getElementById("insurance-controls");
const chipsArea = document.getElementById("chipsArea");

const hitBtn = document.getElementById("hit");
const standBtn = document.getElementById("stand");
const doubleBtn = document.getElementById("double");
const splitBtn = document.getElementById("split");
const insYesBtn = document.getElementById("ins-yes");
const insNoBtn = document.getElementById("ins-no");

let balance = 0;
let initialBet = 0;
let gameState = "loading";
let betCountdown = null;
let actionTimer = null;
let isProcessing = false;
let seq = 0;

// Audio
const sounds = {};
let audioCtx = null;

async function initAudio() {
  window.AudioContext = window.AudioContext || window.webkitAudioContext;
  audioCtx = new AudioContext();
  const urls = {
    card: 'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3',
    win: 'https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3',
    lose: 'https://assets.mixkit.co/active_storage/sfx/2043/2043-preview.mp3',
    tick: 'https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3',
    chip: 'https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3'
  };
  for (const [name, url] of Object.entries(urls)) {
    try {
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      sounds[name] = await audioCtx.decodeAudioData(arrayBuffer);
    } catch {}
  }
}

function playSound(name) {
  if (!audioCtx || !sounds[name]) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const source = audioCtx.createBufferSource();
  source.buffer = sounds[name];
  if (name === 'card') source.playbackRate.value = 0.95 + Math.random() * 0.1;
  source.connect(audioCtx.destination);
  source.start(0);
}

document.getElementById('systemStartBtn').addEventListener('click', async () => {
  await initAudio();
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  const buffer = audioCtx.createBuffer(1, 1, 22050);
  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  src.connect(audioCtx.destination);
  src.start(0);
  document.getElementById('sys-start-overlay').style.display = 'none';
});

async function fetchAPI(endpoint, method = "GET", body = null, timeoutMs = 8000) {
  if (!auth.currentUser) throw new Error("Oturum yok!");
  const token = await auth.currentUser.getIdToken();

  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);

  try {
    const res = await fetch(`${API_URL}${endpoint}`, {
      method,
      signal: ctrl.signal,
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      body: body ? JSON.stringify(body) : null,
    });

    const ct = res.headers.get("content-type") || "";
    const data = ct.includes("application/json") ? await res.json() : {};
    if (!res.ok || data.ok === false) throw new Error(data.error || "Sunucu hatası.");
    return data;
  } finally {
    clearTimeout(t);
  }
}

function setControlsDisabled(disabled) {
  document.querySelectorAll('.controls .btn').forEach(btn => btn.disabled = disabled);
}

function cardVal(v){ return {1:"A", 10:"0", 11:"J", 12:"Q", 13:"K"}[v] || v; }
function cardImg(c){
  if(!c) return "https://deckofcardsapi.com/static/img/back.png";
  return `https://deckofcardsapi.com/static/img/${cardVal(c.value)}${c.suit}.png`;
}
function score(cards){
  if(!Array.isArray(cards)) return 0;
  let total=0, aces=0;
  for(const c of cards){
    let v = c.value > 10 ? 10 : (c.value === 1 ? 11 : c.value);
    if (v === 11) aces++;
    total += v;
  }
  while(total > 21 && aces > 0){ total -= 10; aces--; }
  return total;
}

function clearBoard(){
  dealerCardsEl.innerHTML = "";
  hand0El.innerHTML = "";
  hand1El.innerHTML = "";
  hand1Box.style.display = "none";
  dealerScoreEl.textContent = "0";
  score0El.textContent = "0";
  score1El.textContent = "0";
  hand0Box.classList.remove("active");
  hand1Box.classList.remove("active");
}

function renderCards(container, cards, hideSecond=false){
  container.innerHTML = "";
  (cards || []).forEach((c, idx) => {
    const cardCont = document.createElement("div");
    cardCont.className = "card-3d show flipped";
    const img = (hideSecond && idx === 1) ? "https://deckofcardsapi.com/static/img/back.png" : cardImg(c);
    cardCont.innerHTML = `
      <div class="card-face card-front" style="background:url('${img}') center/cover"></div>
      <div class="card-face card-back"></div>`;
    container.appendChild(cardCont);
  });
}

function renderState(payload){
  if(!payload || !payload.state){
    clearBoard();
    chipsArea.style.display = "flex";
    controlsEl.style.display = "none";
    insControls.style.display = "none";
    messageEl.textContent = "MC KULLAN (MİN: 1K)";
    gameState = "betting";
    initialBet = 0;
    betAmountEl.textContent = "0";
    seq = 0;
    return;
  }

  const st = payload.state;
  seq = st.seq || 0;

  if (st.message) messageEl.textContent = st.message;

  const dealerHidden = !!st.dealerHidden;
  renderCards(dealerCardsEl, st.dealer, dealerHidden);
  if (dealerHidden) {
    const first = st.dealer?.[0];
    dealerScoreEl.textContent = first ? score([first]) : 0;
  } else {
    dealerScoreEl.textContent = score((st.dealer || []).filter(Boolean));
  }

  const hands = st.hands || [];
  const h0 = hands[0]?.cards || [];
  const h1 = hands[1]?.cards || [];

  renderCards(hand0El, h0, false);
  score0El.textContent = score(h0);

  if (hands.length > 1) {
    hand1Box.style.display = "flex";
    renderCards(hand1El, h1, false);
    score1El.textContent = score(h1);
  } else {
    hand1Box.style.display = "none";
  }

  let totalBet = (st.insuranceBet || 0);
  hands.forEach(h => totalBet += (h.bet || 0));
  betAmountEl.textContent = totalBet.toLocaleString('tr-TR');

  if (st.gameState === "playing") {
    chipsArea.style.display = "none";
    if (st.insuranceOffered) {
      insControls.style.display = "flex";
      controlsEl.style.display = "none";
      setControlsDisabled(false);
      return;
    } else {
      insControls.style.display = "none";
      controlsEl.style.display = "flex";
    }

    hand0Box.classList.remove("active");
    hand1Box.classList.remove("active");
    const idx = st.currentHandIdx || 0;
    (idx === 0 ? hand0Box : hand1Box).classList.add("active");

    const curHand = hands[idx] || hands[0];
    const cards = curHand?.cards || [];
    doubleBtn.style.display = (cards.length === 2) ? "block" : "none";

    let okSplit = false;
    if (hands.length === 1 && cards.length === 2) {
      const v1 = cards[0].value > 10 ? 10 : cards[0].value;
      const v2 = cards[1].value > 10 ? 10 : cards[1].value;
      okSplit = v1 === v2;
    }
    splitBtn.style.display = okSplit ? "block" : "none";

    startActionTimer();
  } else {
    controlsEl.style.display = "none";
    insControls.style.display = "none";
    chipsArea.style.display = "flex";

    if (st.gameState === "finished") {
      const win = st.lastResult?.didWin;
      if (win) playSound('win'); else playSound('lose');

      setTimeout(async () => {
        await refreshMe();
        renderState(null);
      }, 2000);
    }
  }
}

async function refreshMe(){
  const me = await fetchAPI("/api/me", "GET");
  balance = me.balance || 0;
  balanceEl.textContent = balance.toLocaleString('tr-TR');
}

// Betting
window.addBet = (a) => {
  if (gameState !== "betting" || isProcessing) return;
  if (initialBet + a > balance) return;
  playSound('chip');
  initialBet += a;
  balanceEl.textContent = (balance - initialBet).toLocaleString('tr-TR');
  betAmountEl.textContent = initialBet.toLocaleString('tr-TR');
  if (!betCountdown && initialBet >= 1000) startBetCountdown();
};

window.cancelBet = () => {
  if (gameState !== "betting" || initialBet === 0 || isProcessing) return;
  playSound('chip');
  initialBet = 0;
  balanceEl.textContent = balance.toLocaleString('tr-TR');
  betAmountEl.textContent = "0";
  if (betCountdown) { clearInterval(betCountdown); betCountdown = null; }
  messageEl.textContent = "MC KULLAN (MİN: 1K)";
};

function startBetCountdown(){
  let s = 5;
  messageEl.textContent = `BAŞLIYOR (${s})`;
  playSound('tick');
  betCountdown = setInterval(async () => {
    s--;
    if (s > 0) {
      messageEl.textContent = `BAŞLIYOR (${s})`;
      playSound('tick');
    } else {
      clearInterval(betCountdown);
      betCountdown = null;
      await startGameServer();
    }
  }, 1000);
}

async function startGameServer(){
  try {
    isProcessing = true;
    const st = await fetchAPI("/api/bj/start", "POST", { bet: initialBet });
    await refreshMe();
    clearBoard();
    renderState(st);
    playSound('card');
  } catch (e) {
    // Escape exploit kapalı -> burada hata mesajı görünür:
    // "Hala devam eden aktif bir oyununuz var..."
    messageEl.textContent = e.message;
    window.cancelBet();
    // Kullanıcı isterse state ile masasına dönebilir:
    try {
      const resume = await fetchAPI("/api/bj/state", "GET");
      if (resume && resume.state) renderState(resume);
    } catch {}
  } finally {
    isProcessing = false;
  }
}

// Action timer
function startActionTimer(){
  let s = 10;
  if (actionTimer) clearInterval(actionTimer);
  messageEl.style.display = "block";
  messageEl.textContent = `KARAR SÜRESİ (${s})`;
  playSound('tick');

  actionTimer = setInterval(() => {
    s--;
    if (s > 0) {
      messageEl.textContent = `KARAR SÜRESİ (${s})`;
      playSound('tick');
    } else {
      clearInterval(actionTimer);
      doAction("stand");
    }
  }, 1000);
}
function stopActionTimer(){
  if (actionTimer) clearInterval(actionTimer);
  actionTimer = null;
}

// Actions
async function doAction(action){
  if (isProcessing) return;
  try {
    isProcessing = true;
    stopActionTimer();
    setControlsDisabled(true);

    const st = await fetchAPI("/api/bj/action", "POST", { action, seq });
    await refreshMe();

    if (action === "hit" || action === "double" || action === "split") playSound('card');
    renderState(st);
  } catch (e) {
    messageEl.textContent = e.message;
  } finally {
    isProcessing = false;
    setControlsDisabled(false);
  }
}

hitBtn.onclick = () => doAction("hit");
standBtn.onclick = () => doAction("stand");
doubleBtn.onclick = () => doAction("double");
splitBtn.onclick = () => doAction("split");
insYesBtn.onclick = () => doAction("insurance_yes");
insNoBtn.onclick = () => doAction("insurance_no");

// Auth boot + resume
onAuthStateChanged(auth, async (user) => {
  if (!user) { await signInAnonymously(auth); return; }
  await refreshMe();

  try {
    const st = await fetchAPI("/api/bj/state", "GET");
    if (st && st.state) {
      renderState(st);
      gameState = "playing";
      return;
    }
  } catch {}

  gameState = "betting";
  messageEl.textContent = "MC KULLAN (MİN: 1K)";
});
</script>

</body>
</html>
