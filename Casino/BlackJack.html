
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PlayMatrix VIP BlackJack | Sunucu Tabanlı</title>
<style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;}
    body {
        height:100vh; width: 100vw; overflow:hidden;
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto, Helvetica, Arial, sans-serif;
        background: radial-gradient(circle at 50% -20%, rgba(212,175,55,0.15) 0%, transparent 50%),
                    radial-gradient(circle at 50% 50%, #0d5c2e 0%, #073b1c 60%, #031c0c 100%);
        color:white; touch-action:manipulation; display: flex; flex-direction: column;
    }
    .top-bar { position:fixed; top:0; left:0; right:0; height:65px; display:flex; align-items:center; justify-content:space-between; padding:0 10px; background: linear-gradient(to bottom, #1a1a1a 0%, #000000 100%); border-bottom: 2px solid #d4af37; z-index:1000; box-shadow: 0 4px 20px rgba(0,0,0,0.8); }
    h1.brand { margin: 0; padding: 0; font-size: clamp(0.9rem, 4vw, 1.1rem); font-weight:900; color: #d4af37; letter-spacing: 1px; font-family: 'Times New Roman', Times, serif; white-space: nowrap; flex-shrink: 0; }
    .right-menu { display:flex; gap:5px; align-items: center; justify-content: flex-end; flex: 1; margin-left: 10px; }
    .user-pill-mini { display: flex; align-items: center; gap: 4px; background: linear-gradient(145deg, #222, #111); padding: 4px 8px; border-radius: 15px; border: 1px solid rgba(212,175,55,0.4); white-space: nowrap; }
    .balance-info b { font-size: clamp(11px, 3.5vw, 13px); color: #00ffa3; font-family: monospace; font-weight: 700; }
    .mc-chip { width: 16px; height: 16px; flex-shrink: 0; background: radial-gradient(circle at 30% 30%, #4fd1ff, #0055ff); border-radius: 50%; margin-left: 4px; display: flex; align-items: center; justify-content: center; font-size: 6px; font-weight: 900; color: #fff; box-shadow: 0 0 8px rgba(79, 209, 255, 0.4); border: 1px solid rgba(255,255,255,0.4); }
    .back-btn { background: linear-gradient(to bottom, #ff4b4b, #cc0000); color: white; text-decoration: none; padding: 5px 8px; border-radius: 6px; font-size: clamp(0.6rem, 2.5vw, 0.7rem); font-weight: 900; flex-shrink: 0; border: 1px solid #7a0000; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
    .game-container { flex: 1; display: flex; flex-direction: column; justify-content: space-between; padding: 80px 0 20px 0; perspective: 1200px; position: relative; overflow-y: auto; }
    .area { width: 100%; text-align: center; }
    .dealer-title { font-size: 14px; letter-spacing: 4px; font-weight: 900; color: #d4af37; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.9); font-family: 'Times New Roman', Times, serif; }
    .score-badge { background: linear-gradient(to bottom, rgba(30,30,30,0.9), rgba(10,10,10,0.9)); color: #ffd700; padding: 4px 18px; border-radius: 20px; font-size: 12px; font-weight: bold; border: 1px solid #d4af37; display: inline-block; margin-bottom: 10px; }
    .cards-wrapper { display: flex; justify-content: center; flex-wrap: wrap; gap: 5px; margin-left: -15px; min-height: 105px; padding: 0 10px; }
    .card-3d { width: 65px; height: 95px; position: relative; transform-style: preserve-3d; margin-left: -20px; transition: transform 0.3s; }
    .card-3d:first-child { margin-left: 0; }
    .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 6px; box-shadow: -4px 4px 12px rgba(0,0,0,0.7); background: white; }
    .card-back { background: repeating-linear-gradient(45deg, #b30000, #b30000 5px, #fff 5px, #fff 10px); border: 2px solid #fff; }
    .card-front { display: flex; flex-direction: column; justify-content: space-between; padding: 4px; font-weight: bold; }
    .card-front .top-val { text-align: left; font-size: 14px; line-height: 1; }
    .card-front .center-suit { text-align: center; font-size: 32px; line-height: 1; margin-top: 10px; }
    .card-front .bottom-val { text-align: right; font-size: 14px; line-height: 1; transform: rotate(180deg); }
    .suit-red { color: #d32f2f; }
    .suit-black { color: #212121; }
    .action-area { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 85px; z-index: 10; margin-top: 10px;}
    #message { font-size: 14px; font-weight: 900; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,1); margin-bottom: 10px; text-transform: uppercase; background: linear-gradient(90deg, transparent, rgba(0,0,0,0.7), transparent); padding: 5px 30px; border-radius: 5px; letter-spacing: 1px; }
    .controls { display: none; gap: 10px; justify-content: center; flex-wrap: wrap; width: 100%; max-width: 400px; padding: 0 10px;}
    .btn { padding: 10px 18px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); font-weight: 900; font-size: 13px; color: white; cursor: pointer; text-transform: uppercase; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: all 0.1s; }
    #hitBtn { background: linear-gradient(to bottom, #2ecc71, #229954); }
    #standBtn { background: linear-gradient(to bottom, #e74c3c, #c0392b); }
    #doubleBtn { background: linear-gradient(to bottom, #f1c40f, #d4ac0d); color: #000; }
    #splitBtn { background: linear-gradient(to bottom, #9b59b6, #8e44ad); }
    .btn:active:not(:disabled) { transform: translateY(4px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .hands-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; width: 100%; transition: 0.3s; }
    .hand-box { display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 10px; border: 2px solid transparent;}
    .hand-box.active { border: 2px solid #d4af37; background: radial-gradient(circle, rgba(212,175,55,0.15), transparent); }
    .chips-area { display: flex; justify-content: center; gap: 8px; padding-bottom: 20px; align-items: center; flex-wrap: wrap;}
    .chip { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 13px; cursor: pointer; border: 4px dashed #d4af37; box-shadow: 0 6px 12px rgba(0,0,0,0.6); }
    .chip:active { transform: scale(0.9); }
    .c1k { background: radial-gradient(circle, #f0f0f0 30%, #a0a0a0 90%); color: #000; border-color: #666;}
    .c3k { background: radial-gradient(circle, #2ecc71 30%, #176634 90%); color: #fff; border-color: #fff;}
    .c5k { background: radial-gradient(circle, #e74c3c 30%, #7a160d 90%); color: #fff; border-color: #fff;}
    .c15k { background: radial-gradient(circle, #3498db 30%, #154360 90%); color: #fff; border-color: #fff;}
    .c20k { background: radial-gradient(circle, #9b59b6 30%, #4a235a 90%); color: #fff; border-color: #d4af37;}
    .c50k { background: radial-gradient(circle, #333 30%, #000 90%); color: #d4af37; border-color: #d4af37;}
    .cancel-btn { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(to bottom, #555, #222); color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 10px; cursor: pointer; border: 2px solid #888; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(8px); }
    .modal-content { background: linear-gradient(to bottom, #1a1a1a, #0a0a0a); border: 2px solid #d4af37; border-radius: 15px; width: 90%; max-width: 380px; padding: 25px; text-align: center; }
</style>
</head>
<body>

<div id="sys-start-overlay" class="modal-overlay">
    <div class="modal-content">
        <h2 style="color:#d4af37; margin-bottom: 15px;">VIP LÜKS CASINO</h2>
        <div style="font-size: 13px; color: #ccc; margin-bottom: 20px; text-align: left; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; border: 1px solid #333;">
            <b>%100 Sunucu Korumalı Sistem:</b><br>
            • Tüm işlemler sunucuda şifreli olarak işlenir.<br>
            • Kullanıcı kaydınız yoksa ana sayfaya yönlendirilirsiniz.
        </div>
        <button id="systemStartBtn" style="width: 100%; padding: 15px; border-radius: 10px; border: none; background: linear-gradient(to bottom, #f1c40f, #d4ac0d); font-weight: 900; cursor: pointer;">MASAYA OTUR</button>
    </div>
</div>

<header class="top-bar">
    <h1 class="brand">VIP BLACKJACK</h1>
    <nav class="right-menu">
        <div class="user-pill-mini">
            <div class="balance-info"><b id="ui-balance">Yükleniyor...</b></div>
            <div class="mc-chip">MC</div>
        </div>
        <div class="user-pill-mini" style="border-color: #ffcc00; background: linear-gradient(145deg, #332800, #1a1400);">
            <div class="balance-info"><b id="ui-betAmount" style="color:#ffcc00">0</b></div>
            <div class="mc-chip" style="background: orange;">MC</div>
        </div>
        <a href="/" class="back-btn">ÇIKIŞ</a>
    </nav>
</header>

<main class="game-container">
    <div class="area">
        <div class="dealer-title">KURUPİYER</div>
        <div class="score-badge">Toplam: <span id="ui-dealerScore">?</span></div>
        <div id="ui-dealerCards" class="cards-wrapper"></div>
    </div>
    <div class="action-area">
        <div id="ui-message">MC KULLAN (MİN: 1K)</div>
        <div class="controls" id="controls-main">
            <button id="hitBtn" class="btn">ÇEK</button>
            <button id="standBtn" class="btn">KAL</button>
            <button id="doubleBtn" class="btn">2X</button>
            <button id="splitBtn" class="btn">BÖL</button>
        </div>
        <div class="controls" id="controls-ins">
            <button id="insYesBtn" class="btn" style="background: linear-gradient(to bottom, #2ecc71, #229954);">SİGORTA AL</button>
            <button id="insNoBtn" class="btn" style="background: linear-gradient(to bottom, #e74c3c, #c0392b);">GEÇ</button>
        </div>
    </div>
    <div class="hands-container" id="ui-playerHands"></div>
    <div class="chips-area" id="ui-chipsArea">
        <div class="cancel-btn" id="cancelBetBtn">SİL</div>
        <div class="chip c1k" data-val="1000">1K</div>
        <div class="chip c3k" data-val="3000">3K</div>
        <div class="chip c5k" data-val="5000">5K</div>
        <div class="chip c15k" data-val="15000">15K</div>
        <div class="chip c20k" data-val="20000">20K</div>
        <div class="chip c50k" data-val="50000">50K</div>
    </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, getIdToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const API_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" ? "http://localhost:3000" : "https://emirhan-siye.onrender.com";

let userBalance = 0; let pendingBet = 0; let betTimer = null; let currentSeq = 0; let isWaitingServer = false;

async function fetchAPI(endpoint, method = 'GET', body = null) {
    if (!auth.currentUser) { window.location.href = '/'; return; }
    const token = await getIdToken(auth.currentUser);
    const options = { method, headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } };
    if (body) options.body = JSON.stringify(body);
    const res = await fetch(`${API_URL}${endpoint}`, options);
    const data = await res.json();
    
    if (data.redirect || res.status === 401 || res.status === 403) {
        window.location.href = '/'; 
        throw new Error("Ana sayfaya yönlendiriliyorsunuz.");
    }
    
    if (!data.ok) throw new Error(data.error || "Sunucu hatası");
    return data;
}

function createCardHTML(card) {
    if(!card) return '';
    const suitsMap = { 'H': { sym: '♥', cls: 'suit-red' }, 'D': { sym: '♦', cls: 'suit-red' }, 'C': { sym: '♣', cls: 'suit-black' }, 'S': { sym: '♠', cls: 'suit-black' } };
    const valsMap = { 1: "A", 11: "J", 12: "Q", 13: "K" };
    return `<div class="card-face card-front ${suitsMap[card.suit].cls}"><div class="top-val">${valsMap[card.value] || card.value}</div><div class="center-suit">${suitsMap[card.suit].sym}</div><div class="bottom-val">${valsMap[card.value] || card.value}</div></div>`;
}

function calculateVisibleScore(cards) {
    if(!cards || cards.length === 0) return 0;
    let t = 0, a = 0;
    cards.forEach(c => { if(!c) return; let v = c.value > 10 ? 10 : (c.value === 1 ? 11 : c.value); if(v === 11) a++; t += v; });
    while(t > 21 && a > 0) { t -= 10; a--; } return t;
}

function renderState(state) {
    currentSeq = state.seq;
    const dArea = document.getElementById("ui-dealerCards"); dArea.innerHTML = "";
    state.dealer.forEach((card, i) => {
        const isHidden = state.dealerHidden && i === 1;
        const div = document.createElement("div"); div.className = `card-3d`;
        
        // GÖRSEL BUG DÜZELTİLDİ: Kapalı kart için sahte içerik yerine sadece saf CSS arka yüz
        if (isHidden) {
            div.innerHTML = `<div class="card-face card-back" style="transform: rotateY(0deg);"></div>`;
        } else {
            div.innerHTML = createCardHTML(card);
        }
        dArea.appendChild(div);
    });
    document.getElementById("ui-dealerScore").innerText = state.dealerHidden && state.dealer[0] ? calculateVisibleScore([state.dealer[0]]) : calculateVisibleScore(state.dealer);

    const pArea = document.getElementById("ui-playerHands"); pArea.innerHTML = ""; let totalTableBet = 0;
    state.hands.forEach((hand, i) => {
        totalTableBet += hand.bet || 0;
        const box = document.createElement("div"); box.className = `hand-box ${(i === state.currentHandIdx && state.gameState === 'playing') ? 'active' : ''}`;
        const cWrap = document.createElement("div"); cWrap.className = "cards-wrapper";
        hand.cards.forEach(card => { const div = document.createElement("div"); div.className = "card-3d"; div.innerHTML = createCardHTML(card); cWrap.appendChild(div); });
        const scoreDiv = document.createElement("div"); scoreDiv.className = "score-badge"; scoreDiv.innerText = `Toplam: ${calculateVisibleScore(hand.cards)} ${hand.status === 'bust' ? '(PATLADI)' : ''}`;
        box.appendChild(cWrap); box.appendChild(scoreDiv); pArea.appendChild(box);
    });

    document.getElementById("ui-chipsArea").style.display = (state.gameState === 'finished' || !state.gameState) ? "flex" : "none";
    if(state.gameState === 'playing' && !state.insuranceOffered) {
        document.getElementById("controls-main").style.display = "flex"; document.getElementById("controls-ins").style.display = "none";
        const curHand = state.hands[state.currentHandIdx];
        document.getElementById("doubleBtn").style.display = (curHand.cards.length === 2) ? "block" : "none";
        document.getElementById("splitBtn").style.display = (state.hands.length === 1 && curHand.cards.length === 2 && curHand.cards[0].value === curHand.cards[1].value) ? "block" : "none";
    } else if (state.insuranceOffered) {
        document.getElementById("controls-main").style.display = "none"; document.getElementById("controls-ins").style.display = "flex";
    } else { document.getElementById("controls-main").style.display = "none"; document.getElementById("controls-ins").style.display = "none"; }

    if (state.gameState === 'resolving') { document.getElementById("ui-message").innerText = "SONUÇ BEKLENİYOR..."; setTimeout(pollState, 1500); } 
    else if (state.gameState === 'finished') { document.getElementById("ui-message").innerText = state.message; document.getElementById("ui-betAmount").innerText = "0"; pendingBet = 0; fetchBalance(); } 
    else { document.getElementById("ui-message").innerText = state.message || "OYUN DEVAM EDİYOR"; document.getElementById("ui-betAmount").innerText = totalTableBet.toLocaleString('tr-TR'); }
}

async function pollState() { try { const res = await fetchAPI('/api/bj/state'); if(res && res.state) renderState(res.state); } catch(e) { console.error(e); } }
async function fetchBalance() { try { const res = await fetchAPI('/api/me'); if(res) { userBalance = res.balance; document.getElementById("ui-balance").innerText = userBalance.toLocaleString('tr-TR'); } } catch(e) { console.error(e); } }

async function startNewGame() {
    if(pendingBet < 1000) return;
    isWaitingServer = true; document.getElementById("ui-chipsArea").style.display = "none"; document.getElementById("ui-message").innerText = "MASA HAZIRLANIYOR...";
    try {
        const res = await fetchAPI('/api/bj/start', 'POST', { bet: pendingBet });
        fetchBalance(); 
        if (res.state) renderState(res.state); // Gecikmesiz render
    } catch(e) { alert(e.message); document.getElementById("ui-chipsArea").style.display = "flex"; pendingBet = 0; document.getElementById("ui-betAmount").innerText = "0"; document.getElementById("ui-message").innerText = "MC KULLAN (MİN: 1K)"; }
    isWaitingServer = false;
}

async function sendAction(actionStr) {
    if(isWaitingServer) return;
    isWaitingServer = true; document.getElementById("controls-main").style.display = "none"; document.getElementById("controls-ins").style.display = "none";
    try {
        const res = await fetchAPI('/api/bj/action', 'POST', { action: actionStr, seq: currentSeq });
        if(['split', 'double', 'insurance_yes'].includes(actionStr)) fetchBalance();
        if (res.state) renderState(res.state); // Gecikmesiz render
    } catch(e) { alert(e.message); pollState(); }
    isWaitingServer = false;
}

document.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', () => {
        if(isWaitingServer) return;
        const val = parseInt(chip.getAttribute('data-val')); if (pendingBet + val > userBalance) return;
        pendingBet += val; document.getElementById("ui-betAmount").innerText = pendingBet.toLocaleString('tr-TR'); document.getElementById("ui-balance").innerText = (userBalance - pendingBet).toLocaleString('tr-TR');
        if(betTimer) clearTimeout(betTimer); document.getElementById("ui-message").innerText = "BAHİS ONAYI BEKLENİYOR..."; betTimer = setTimeout(startNewGame, 1500);
    });
});
document.getElementById("cancelBetBtn").addEventListener('click', () => { if(betTimer) clearTimeout(betTimer); pendingBet = 0; document.getElementById("ui-betAmount").innerText = "0"; document.getElementById("ui-balance").innerText = userBalance.toLocaleString('tr-TR'); document.getElementById("ui-message").innerText = "MC KULLAN (MİN: 1K)"; });
document.getElementById("hitBtn").onclick = () => sendAction('hit');
document.getElementById("standBtn").onclick = () => sendAction('stand');
document.getElementById("doubleBtn").onclick = () => sendAction('double');
document.getElementById("splitBtn").onclick = () => sendAction('split');
document.getElementById("insYesBtn").onclick = () => sendAction('insurance_yes');
document.getElementById("insNoBtn").onclick = () => sendAction('insurance_no');

document.getElementById('systemStartBtn').addEventListener('click', () => { document.getElementById('sys-start-overlay').style.display='none'; fetchBalance(); pollState(); });

onAuthStateChanged(auth, user => { if(!user) window.location.href = '/'; });
</script>
</body>
</html>
