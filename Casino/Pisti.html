<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<title>PlayMatrix Pişti | Ücretsiz Kart Oyunu ve Casino</title>
<meta name="description" content="PlayMatrix Pişti oyna! Akıllı krupiyere karşı şansını ve yeteneğini test et. Hemen masaya otur, kartlarını at, pişti yap ve anında MC kazan.">
<meta name="keywords" content="pişti oyna, casino oyunu, PlayMatrix, mc kazan, online kart oyunları">
<meta name="author" content="PlayMatrix Global">
<meta name="robots" content="index, follow">
<meta name="theme-color" content="#0a0a0f">

<style>
    :root {
        --primary: #4fd1ff;
        --bg-dark: #0a0a0f;
        --table-bg: radial-gradient(circle at center, #115e33, #072e18 80%);
        --text-light: #e0e0e0;
    }

    * { margin:0; padding:0; box-sizing:border-box; user-select:none; -webkit-tap-highlight-color:transparent; }
    
    body {
        height:100vh; overflow:hidden; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg-dark); color: white; display:flex; flex-direction:column; align-items:center;
    }

    /* ÜST BAR - TAŞMA KORUMALI */
    .top-bar {
        position:fixed; top:0; width:100%; height:60px; display:flex; align-items:center; justify-content:space-between;
        padding:0 15px; background: rgba(10, 15, 30, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #1e2642; z-index:1000;
    }
    .brand { font-size:18px; font-weight:900; background:linear-gradient(90deg,var(--primary),#fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .right-menu { display:flex; gap:8px; align-items:center; min-width: 0; flex: 1; justify-content: flex-end;}
    
    .user-pill-mini { 
        display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.05); padding: 5px 10px; 
        border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); max-width: 120px;
    }
    .balance-info { display: flex; align-items: center; overflow: hidden; width: 100%; justify-content: flex-end;}
    .balance-info b { font-size: 13px; color: #00ffa3; font-family: monospace; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .mc-chip {
        width: 18px; height: 18px; flex-shrink: 0; background: radial-gradient(circle at 30% 30%, var(--primary), #0055ff);
        border-radius: 50%; margin-left: 5px; display: flex; align-items: center; justify-content: center;
        font-size: 7px; font-weight: 900; color: #fff; box-shadow: 0 0 8px rgba(79, 209, 255, 0.3);
    }
    .back-btn { background: #ff3b30; color: white; text-decoration: none; padding: 6px 12px; border-radius: 10px; font-size: 11px; font-weight: 900; flex-shrink: 0; }

    /* PRAGMATIC AÇILIŞ EKRANI */
    #introScreen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a2a6c, #0a0a0f);
        z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
        transition: opacity 0.5s ease;
    }
    .intro-logo { font-size: 48px; font-weight: 900; color: #fff; text-shadow: 0 0 20px var(--primary); margin-bottom: 20px; animation: pulse 2s infinite; }
    .how-to-play { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); max-width: 320px; text-align: center; margin-bottom: 30px; }
    .how-to-play h3 { color: #ffcc00; margin-bottom: 10px; }
    .how-to-play p { font-size: 14px; color: var(--text-light); line-height: 1.5; }
    .play-btn-main { background: linear-gradient(to bottom, #4fd1ff, #007aff); border: none; padding: 15px 60px; border-radius: 30px; font-size: 20px; font-weight: 900; color: white; cursor: pointer; box-shadow: 0 10px 20px rgba(0, 122, 255, 0.4); transition: transform 0.2s; }
    .play-btn-main:active { transform: scale(0.95); }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    /* OYUN ALANI */
    .score-board { margin-top: 75px; font-weight: bold; color: #ffcc00; font-size: 14px; background: rgba(0,0,0,0.5); padding: 6px 20px; border-radius: 20px; border: 1px solid rgba(255,204,0,0.3); }

    .table {
        width: 95%; max-width: 600px; height: 420px; border-radius: 200px; position: relative;
        background: var(--table-bg); box-shadow: inset 0 0 80px rgba(0,0,0,0.8), 0 15px 50px rgba(0,0,0,0.6);
        margin-top: 30px; border: 12px solid #2d1f14;
    }

    .table-cards { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:75px; height:105px; }
    .stack-card { width:75px; position:absolute; left:0; top:0; border-radius: 6px; box-shadow: -2px 2px 5px rgba(0,0,0,0.5); }

    .hand, .computer { position:absolute; left:50%; transform:translateX(-50%); display:flex; gap:8px; width: max-content; padding: 10px; }
    .hand { bottom: -60px; }
    .computer { top: -60px; }

    .card { width: 70px; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
    .hand .card:hover { transform: translateY(-15px); box-shadow: 0 10px 20px rgba(0,0,0,0.6); }
    .card.disabled { pointer-events: none; opacity: 0.8; }

    /* ANİMASYONLAR */
    .card-throw { position: fixed; width: 70px; border-radius: 6px; z-index: 2000; transition: all 0.4s cubic-bezier(.25,.8,.25,1); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
    
    #pistiDisplay {
        position: fixed; top: 40%; left: 50%; transform: translate(-50%,-50%); font-size: 90px; font-weight: 900; color: #fff;
        background: linear-gradient(to bottom, #fff, #ffcc00, #ff0000); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 20px rgba(255, 0, 0, 0.8)); display: none; z-index: 9999; pointer-events: none; animation: pistiIn 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes pistiIn { 0% { transform: translate(-50%,-50%) scale(0); opacity: 0; } 50% { transform: translate(-50%,-50%) scale(1.2) rotate(-5deg); opacity: 1; } 100% { transform: translate(-50%,-50%) scale(1); opacity: 0; } }

    /* BAHİS ÇİPLERİ */
    .chips { position:fixed; bottom: 30px; display:flex; gap:12px; background: rgba(0,0,0,0.4); padding: 12px 20px; border-radius: 40px; backdrop-filter: blur(8px); }
    .chip { 
        width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
        font-weight: 900; cursor: pointer; border: 3px dashed rgba(255,255,255,0.4); font-size: 11px;
        transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    .chip:active { transform: scale(0.9); }
    .chip.disabled { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; pointer-events: none; }
    
    .c-cancel { background: #e74c3c; color: #fff; border-style: solid; }
    .c100 { background: radial-gradient(#fff, #ccc); color:#000; } 
    .c500 { background: radial-gradient(#2ecc71, #27ae60); color:#fff; } 
    .c2000 { background: radial-gradient(#3498db, #2980b9); color:#fff; } 
    .c10k { background: radial-gradient(#f1c40f, #f39c12); color:#fff; }

    .action-btn {
        position:fixed; bottom: 100px; padding: 15px 50px; background: linear-gradient(to right, #00ffa3, #00b8ff);
        border: none; border-radius: 30px; font-weight: 900; color: #000; cursor: pointer; font-size: 18px;
        box-shadow: 0 5px 20px rgba(0, 255, 163, 0.4); display: none; text-transform: uppercase;
    }

    /* PROFESYONEL MODAL */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 8, 15, 0.85);
        display: none; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(5px);
    }
    .modal-box {
        background: linear-gradient(145deg, #1e253c, #0f1322); padding: 30px; border-radius: 20px;
        width: 85%; max-width: 340px; text-align: center; border: 1px solid rgba(79, 209, 255, 0.3);
        box-shadow: 0 15px 50px rgba(0,0,0,0.8), inset 0 0 20px rgba(79, 209, 255, 0.1);
        transform: scale(0.8); opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .modal-overlay.active { display: flex; }
    .modal-overlay.active .modal-box { transform: scale(1); opacity: 1; }
    .modal-title { color: #fff; font-size: 24px; font-weight: 900; margin-bottom: 10px; }
    .modal-desc { color: #a0aec0; font-size: 16px; margin-bottom: 25px; white-space: pre-line; }
    .modal-btn { background: var(--primary); color: #000; border: none; padding: 12px 0; width: 100%; border-radius: 12px; font-weight: 800; font-size: 16px; cursor: pointer; }
    
    .loading-spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none;}
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<header class="top-bar">
    <div class="brand">PİŞTİ</div>
    <nav class="right-menu">
        <div class="user-pill-mini">
            <div class="balance-info"><b id="uiBalance">Yükleniyor...</b><div class="mc-chip">MC</div></div>
        </div>
        <div class="user-pill-mini" style="border-color: #ffcc00; display:none;" id="betPill">
            <div class="balance-info"><b id="uiBet" style="color:#ffcc00">0</b><div class="mc-chip" style="background: radial-gradient(circle at 30% 30%, #ffcc00, #ff8a00);">MC</div></div>
        </div>
        <a href="index.html" class="back-btn">GERİ</a>
    </nav>
</header>

<div id="introScreen">
    <div class="intro-logo">PİŞTİ PRO</div>
    <div class="how-to-play">
        <h3>Nasıl Oynanır?</h3>
        <p>1. Bahsini seç ve masaya otur.<br>
           2. Yerle aynı değerli kartı atarak veya 'Vale' (J) atarak yerdeki kartları topla.<br>
           3. Yerde tek kart varken aynısını atarsan <b>PİŞTİ</b> yaparsın!<br>
           4. Oyun sonunda rakibinden fazla puan toplayan kazanır.</p>
    </div>
    <button class="play-btn-main" onclick="closeIntro()">OYUNA GİR</button>
</div>

<main style="display: flex; flex-direction: column; align-items: center; width: 100%;">
    <div class="score-board">SİZ: <span id="ps">0</span> — KRUPİYE: <span id="cs">0</span></div>

    <div class="table" id="tableArea">
        <div class="computer" id="computerHand"></div>
        <div class="table-cards" id="tableCards"></div>
        <div class="hand" id="playerHand"></div>
    </div>

    <div id="pistiDisplay">PİŞTİ!</div>
    <div class="loading-spinner" id="loader"></div>

    <div class="chips" id="chipsArea" style="display:none;">
        <div class="chip c-cancel" onclick="clearBet()">İPTAL</div>
        <div class="chip c100" id="chip100" onclick="addBet(100)">100</div>
        <div class="chip c500" id="chip500" onclick="addBet(500)">500</div>
        <div class="chip c2000" id="chip2000" onclick="addBet(2000)">2K</div>
        <div class="chip c10k" id="chip10000" onclick="addBet(10000)">10K</div>
    </div>

    <button class="action-btn" id="startBtn" onclick="startGame()">MASAYA OTUR</button>
</main>

<div class="modal-overlay" id="customModal">
    <div class="modal-box">
        <div class="modal-title" id="modalTitle">Bilgi</div>
        <div class="modal-desc" id="modalDesc">İçerik</div>
        <button class="modal-btn" onclick="closeModal()">TAMAM</button>
    </div>
</div>

<script type="module">
// Firebase Auth (Sadece Token Almak İçin Kullanılır, DB İşlemi Yoktur)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// YÜKSEK KALİTELİ SES DOSYALARI (Oyun Deneyimi)
const sfx = {
    chip: new Audio("https://actions.google.com/sounds/v1/foley/casino_chip_lay_on_table.ogg"),
    deal: new Audio("https://actions.google.com/sounds/v1/foley/sliding_paper_across_desk.ogg"),
    throw: new Audio("https://actions.google.com/sounds/v1/foley/paper_flutter.ogg"),
    capture: new Audio("https://actions.google.com/sounds/v1/impacts/crash.ogg"),
    win: new Audio("https://actions.google.com/sounds/v1/cartoon/cartoon_cowbell.ogg"),
    lose: new Audio("https://actions.google.com/sounds/v1/cartoon/descending_brass_whistle.ogg"),
    pisti: new Audio("https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg")
};

let userToken = null;
let balance = 0, currentBet = 0;
let gameState = null;
let actionLock = false;

function playSound(name) {
    if(sfx[name]) { sfx[name].currentTime = 0; sfx[name].volume = 0.6; sfx[name].play().catch(()=>{}); }
}

onAuthStateChanged(auth, async (user) => {
    if (user) {
        userToken = await user.getIdToken();
        await fetchBalance();
        await checkGameState();
    } else {
        window.location.href = "login.html";
    }
});

// API YARDIMCILARI
async function apiCall(endpoint, method = 'GET', body = null) {
    if(!userToken) return {ok: false, error: 'Oturum yok'};
    const opt = { method, headers: { 'Authorization': `Bearer ${userToken}`, 'Content-Type': 'application/json' }};
    if(body) opt.body = JSON.stringify(body);
    try {
        const res = await fetch(endpoint, opt);
        return await res.json();
    } catch(e) { return {ok: false, error: 'Sunucu bağlantı hatası.'}; }
}

async function fetchBalance() {
    const res = await apiCall('/api/me');
    if(res.ok) { balance = res.balance; updateUI(); }
}

// UI GÜNCELLEMELERİ
function updateUI() {
    document.getElementById("uiBalance").innerText = balance.toLocaleString('tr-TR');
    document.getElementById("uiBet").innerText = currentBet.toLocaleString('tr-TR');
    
    if(!gameState || gameState.status !== 'playing') {
        [100, 500, 2000, 10000].forEach(val => {
            const el = document.getElementById("chip" + val);
            if (balance < val || currentBet + val > 50000) el.classList.add("disabled");
            else el.classList.remove("disabled");
        });
        
        if(currentBet >= 100) {
            document.getElementById("startBtn").style.display = "block";
        } else {
            document.getElementById("startBtn").style.display = "none";
        }
    }
}

window.closeIntro = function() {
    playSound('chip');
    document.getElementById("introScreen").style.opacity = "0";
    setTimeout(() => {
        document.getElementById("introScreen").style.display = "none";
        if(!gameState || gameState.status !== 'playing') {
            document.getElementById("chipsArea").style.display = "flex";
            document.getElementById("betPill").style.display = "flex";
        }
    }, 500);
}

window.addBet = function(amount) {
    if (gameState && gameState.status === 'playing') return;
    if (balance < amount || currentBet + amount > 50000) return;
    currentBet += amount;
    balance -= amount; // Tarayıcıda geçici düş (Gerçek düşüm start'ta sunucuda olacak)
    playSound('chip');
    updateUI();
}

window.clearBet = function() {
    if (gameState && gameState.status === 'playing') return;
    balance += currentBet;
    currentBet = 0;
    playSound('chip');
    updateUI();
}

// OYUN DURUMU KONTROLÜ
async function checkGameState() {
    const res = await apiCall('/api/pisti/state');
    if(res.ok && res.state && res.state.status === 'playing') {
        gameState = res.state;
        document.getElementById("chipsArea").style.display = "none";
        document.getElementById("startBtn").style.display = "none";
        document.getElementById("betPill").style.display = "flex";
        currentBet = gameState.bet;
        renderBoard();
    } else {
        document.getElementById("chipsArea").style.display = "flex";
        document.getElementById("betPill").style.display = "flex";
    }
    updateUI();
}

// OYUNU BAŞLAT
window.startGame = async function() {
    if(currentBet < 100) return showModal("Hata", "Min bahis 100 MC olmalıdır.");
    document.getElementById("loader").style.display = "block";
    document.getElementById("startBtn").style.display = "none";
    document.getElementById("chipsArea").style.display = "none";
    actionLock = true;

    const res = await apiCall('/api/pisti/start', 'POST', { bet: currentBet });
    document.getElementById("loader").style.display = "none";
    
    if(res.ok) {
        gameState = res.state;
        playSound('deal');
        renderBoard();
        actionLock = false;
    } else {
        balance += currentBet; // Hata varsa bakiyeyi geri ekle
        currentBet = 0;
        updateUI();
        document.getElementById("chipsArea").style.display = "flex";
        showModal("Hata", res.error);
        actionLock = false;
    }
}

// KART ÇİZİMİ
function renderBoard() {
    if(!gameState) return;
    
    const ph = document.getElementById("playerHand");
    const ch = document.getElementById("computerHand");
    const tc = document.getElementById("tableCards");
    
    ph.innerHTML = ""; ch.innerHTML = ""; tc.innerHTML = "";
    document.getElementById("ps").innerText = gameState.playerScore;
    document.getElementById("cs").innerText = gameState.botScore;

    // Oyuncu Kartları
    gameState.playerHand.forEach((c, i) => {
        let img = document.createElement("img");
        img.src = `https://deckofcardsapi.com/static/img/${c}.png`;
        img.className = actionLock ? "card disabled" : "card";
        img.onclick = () => playCard(i);
        ph.appendChild(img);
    });

    // Bot Kartları (Kapalı)
    for(let i=0; i<gameState.botCardCount; i++) {
        let img = document.createElement("img");
        img.src = "https://deckofcardsapi.com/static/img/back.png";
        img.className = "card";
        ch.appendChild(img);
    }

    // Yerdeki Kartlar
    gameState.tableCards.forEach((c, i) => {
        let img = document.createElement("img");
        // Sadece en üstteki kartı ve varsa ilk kapalı kartları göster (Sunucu hepsini gönderiyor, biz görselleştiriyoruz)
        img.src = (i === gameState.tableCards.length - 1) ? `https://deckofcardsapi.com/static/img/${c}.png` : "https://deckofcardsapi.com/static/img/back.png";
        img.className = "stack-card";
        img.style.transform = `rotate(${Math.random() * 10 - 5}deg) translate(${i*1.5}px, ${i*1.5}px)`;
        img.style.zIndex = i;
        tc.appendChild(img);
    });
}

// KART OYNAMA (API İSTEĞİ)
window.playCard = async function(index) {
    if(actionLock || !gameState) return;
    actionLock = true;
    
    // Anında UI tepkisi (Görsel olarak kartı uçur)
    const cardEl = document.querySelectorAll("#playerHand img")[index];
    if(cardEl) cardEl.style.opacity = "0";
    playSound('throw');

    const res = await apiCall('/api/pisti/play', 'POST', { cardIndex: index });
    
    if(!res.ok) {
        showModal("Senkronizasyon Hatası", res.error);
        await checkGameState();
        actionLock = false;
        return;
    }

    // 1. Oyuncu animasyonu
    if(res.log.playerAction.isPisti) { playSound('pisti'); showPistiText(); }
    else if(res.log.playerAction.captured) { playSound('capture'); }
    
    // Gecikmeli Bot animasyonu ve UI güncellemesi
    setTimeout(() => {
        if(res.log.botAction) {
            playSound('throw');
            if(res.log.botAction.isPisti) { setTimeout(() => { playSound('pisti'); showPistiText(); }, 400); }
            else if(res.log.botAction.captured) { setTimeout(() => { playSound('capture'); }, 400); }
        }
        
        gameState = res.state;
        renderBoard();

        if(res.log.roundOver) {
            playSound('deal');
            setTimeout(renderBoard, 500); // Yeni kartlar geldi
        }

        if(res.log.gameOver) {
            handleGameOver(res.log);
        } else {
            actionLock = false;
        }
    }, 800);
}

function showPistiText() {
    const el = document.getElementById("pistiDisplay");
    el.style.display = "block";
    el.style.animation = "none";
    void el.offsetWidth; // Reflow
    el.style.animation = "pistiIn 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
    setTimeout(() => { el.style.display = "none"; }, 1400);
}

function handleGameOver(log) {
    gameState = null;
    let title = "", desc = "";
    
    if(log.winAmount > currentBet) {
        playSound('win');
        title = "TEBRİKLER!";
        desc = `Krupiyeyi mağlup ettiniz.\nKazanç: ${log.winAmount.toLocaleString('tr-TR')} MC`;
    } else if(log.winAmount === currentBet) {
        title = "BERABERE";
        desc = "Oyun berabere bitti.\nBahsiniz iade edildi.";
    } else {
        playSound('lose');
        title = "KAYBETTİNİZ";
        desc = "Krupiye daha yüksek puan topladı.";
    }

    currentBet = 0;
    fetchBalance(); // Sunucudan güncel bakiyeyi çek
    
    setTimeout(() => {
        showModal(title, desc);
        document.getElementById("chipsArea").style.display = "flex";
        renderBoard(); // Masayı temizler (gameState null olduğu için)
        actionLock = false;
    }, 1000);
}

// MODAL YÖNETİMİ
window.showModal = function(title, desc) {
    document.getElementById("modalTitle").innerText = title;
    document.getElementById("modalDesc").innerText = desc;
    document.getElementById("customModal").classList.add("active");
}
window.closeModal = function() {
    document.getElementById("customModal").classList.remove("active");
}
</script>
</body>
</html>
