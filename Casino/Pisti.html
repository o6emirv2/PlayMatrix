<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <title>PlayMatrix PiÅŸti Pro | Profesyonel Casino & Kart Oyunu</title>
    <meta name="description" content="PlayMatrix PiÅŸti Pro ile Ã¼st dÃ¼zey bir casino deneyimi yaÅŸa! GerÃ§ek kurallar, yÃ¼ksek kazanÃ§lar ve profesyonel altyapÄ±. Hemen oyna!">
    <meta name="keywords" content="piÅŸti oyna, profesyonel casino, PlayMatrix, mc kazan, online kart oyunu, iskambil, canlÄ± casino">
    <meta name="author" content="PlayMatrix Global">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#000000">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Oswald:wght@500;700&display=swap');

        :root {
            --pm-orange: #ff8a00;
            --pm-light: #ffffff;
            --table-felt: radial-gradient(circle at center, #0a6b32 0%, #032b12 100%);
            --table-border: #1a0f08;
            --glass-bg: rgba(0, 0, 0, 0.6);
        }

        * { margin:0; padding:0; box-sizing:border-box; user-select:none; -webkit-tap-highlight-color:transparent; }
        
        body {
            height:100vh; overflow:hidden; font-family: 'Montserrat', sans-serif;
            background: #050505; color: white; display:flex; flex-direction:column; align-items:center;
        }

        /* PRAGMATIC STYLE AÃ‡ILIÅž EKRANI */
        #pragmaticIntro {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000;
            z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }

        .center-logo {
            text-align: center; margin-top: -30px; transform: scale(1.2); animation: pulseLogo 2s infinite alternate;
        }
        .center-logo svg { width: 70px; height: auto; margin-bottom: 10px; fill: var(--pm-orange); }
        .center-logo h1 { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 32px; letter-spacing: 2px; line-height: 1.1;}
        .center-logo h1 span { color: var(--pm-orange); }
        
        .loading-container { width: 220px; height: 4px; background: #333; margin-top: 50px; border-radius: 2px; overflow: hidden; position: relative;}
        .loading-fill { height: 100%; width: 0%; background: var(--pm-orange); transition: width 0.1s linear; }
        
        @keyframes pulseLogo { 0% { transform: scale(1.1); filter: drop-shadow(0 0 10px rgba(255,138,0,0.2)); } 100% { transform: scale(1.2); filter: drop-shadow(0 0 20px rgba(255,138,0,0.6)); } }

        /* NASIL OYNANIR EKRANI */
        #howToPlayScreen {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; padding: 20px; text-align: center;
        }
        .htp-box {
            background: rgba(20,20,20,0.9); border: 1px solid var(--pm-orange); padding: 25px;
            border-radius: 15px; max-width: 380px; box-shadow: 0 10px 40px rgba(255,138,0,0.2);
        }
        .htp-box h2 { color: var(--pm-orange); margin-bottom: 20px; font-size: 24px; font-weight: 900; letter-spacing: 1px;}
        .htp-box ul { list-style: none; text-align: left; font-size: 14px; line-height: 1.6; color: #ddd; margin-bottom: 25px;}
        .htp-box ul li { margin-bottom: 12px; padding-left: 20px; position: relative;}
        .htp-box ul li::before { content: 'â™ '; position: absolute; left: 0; color: var(--pm-orange); font-size: 16px;}
        .htp-box ul li b { color: #fff; }
        .htp-box ul li i { color: #00ffa3; font-style: normal; font-weight: 700;}
        
        .play-btn-huge {
            background: linear-gradient(180deg, #ffb347 0%, #ff7b00 100%); color: #000;
            border: none; padding: 15px 40px; font-size: 18px; font-weight: 900; border-radius: 30px;
            cursor: pointer; box-shadow: 0 5px 15px rgba(255,123,0,0.4); text-transform: uppercase; transition: 0.2s;
        }
        .play-btn-huge:active { transform: scale(0.95); }

        /* ÃœST BAR */
        .top-bar {
            position: fixed; top: 0; width: 100%; height: 60px; background: rgba(5,5,5,0.9);
            backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 1000;
        }
        .back-btn {
            background: transparent; color: #888; border: 1px solid #333; padding: 6px 15px;
            border-radius: 8px; font-size: 12px; font-weight: 700; text-decoration: none; transition: 0.2s;
        }
        .back-btn:active { background: #333; color: white; }
        
        .balance-container {
            display: flex; align-items: center; background: rgba(255,255,255,0.05);
            padding: 6px 12px; border-radius: 20px; max-width: 50%; border: 1px solid rgba(255,255,255,0.1);
        }
        .balance-val {
            font-size: 15px; font-weight: 900; color: #00ffa3; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis; max-width: 120px; text-align: right; margin-right: 6px;
        }
        .currency-badge {
            background: var(--pm-orange); color: #000; font-size: 9px; font-weight: 900;
            padding: 3px 6px; border-radius: 6px; flex-shrink: 0;
        }

        /* MASA VE OYUN ALANI */
        .game-wrapper {
            margin-top: 70px; width: 100%; display: flex; flex-direction: column; align-items: center;
        }
        .score-board {
            display: flex; gap: 20px; margin-bottom: 15px; background: var(--glass-bg);
            padding: 8px 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
        }
        .score-item { font-size: 12px; font-weight: 700; color: #aaa; }
        .score-item span { font-size: 16px; font-weight: 900; color: var(--pm-orange); margin-left: 5px; }

        .table {
            width: 94%; max-width: 500px; height: 420px; border-radius: 210px; position: relative;
            background: var(--table-felt); box-shadow: inset 0 0 50px rgba(0,0,0,0.8), 0 20px 50px rgba(0,0,0,0.5);
            border: 12px solid var(--table-border);
        }

        /* KART DÄ°ZÄ°LÄ°MLERÄ° */
        .card {
            width: 65px; height: 93px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: absolute; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background-size: cover; background-position: center; border: 1px solid rgba(255,255,255,0.2);
        }
        .card.playable { cursor: pointer; }
        .card.playable:active { transform: scale(0.9); }
        .card.disabled { pointer-events: none; filter: brightness(0.6); }

        .player-hand, .bot-hand, .table-center { position: absolute; left: 50%; transform: translateX(-50%); width: 280px; height: 100px; display: flex; justify-content: center; align-items: center;}
        .player-hand { bottom: -40px; z-index: 10; }
        .bot-hand { top: -30px; }
        .table-center { top: 50%; transform: translate(-50%, -50%); width: 80px; height: 110px;}

        /* BAHÄ°S Ã‡Ä°PLERÄ° VE BUTON */
        .bet-controls {
            position: fixed; bottom: 30px; display: flex; flex-direction: column; align-items: center; gap: 15px; width: 100%;
        }
        .chips-row { display: flex; gap: 10px; background: var(--glass-bg); padding: 10px 20px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(5px);}
        .chip {
            width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 900; color: white; cursor: pointer; border: 3px dashed rgba(255,255,255,0.4);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 5px 10px rgba(0,0,0,0.5); text-shadow: 1px 1px 2px #000; transition: 0.2s;
        }
        .chip:active { transform: scale(0.85); }
        .chip.c-100 { background: radial-gradient(circle, #8e8e8e, #4a4a4a); }
        .chip.c-500 { background: radial-gradient(circle, #2ecc71, #1b7a41); }
        .chip.c-2k { background: radial-gradient(circle, #3498db, #1d5b85); }
        .chip.c-10k { background: radial-gradient(circle, #f1c40f, #947a06); }
        
        .current-bet-display {
            font-size: 14px; font-weight: 700; color: #aaa; background: rgba(0,0,0,0.8); padding: 5px 15px; border-radius: 20px;
        }
        .current-bet-display span { color: var(--pm-orange); font-weight: 900; font-size: 16px;}

        .action-btn {
            background: linear-gradient(180deg, #00ffa3 0%, #00b8ff 100%); color: #000; border: none;
            padding: 15px 60px; font-size: 20px; font-weight: 900; border-radius: 30px; text-transform: uppercase;
            box-shadow: 0 5px 20px rgba(0, 255, 163, 0.4); cursor: pointer; transition: 0.2s;
        }
        .action-btn:active { transform: scale(0.95); }
        .action-btn:disabled { background: #555; color: #888; box-shadow: none; pointer-events: none; }

        /* PÄ°ÅžTÄ° EFEKTÄ° */
        #pistiAnim {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.1);
            font-size: 80px; font-weight: 900; color: #fff; opacity: 0; pointer-events: none; z-index: 9999;
            background: linear-gradient(180deg, #fff, #ffcc00, #ff3b30); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 10px 20px rgba(255, 0, 0, 0.8));
        }
        @keyframes showPisti { 
            0% { transform: translate(-50%, -50%) scale(0.1); opacity: 0; }
            30% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; filter: drop-shadow(0 0 50px red); }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        /* CUSTOM MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 100000;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-content {
            background: linear-gradient(145deg, #1a1a1a, #0a0a0a); padding: 30px; border-radius: 20px;
            width: 85%; max-width: 340px; text-align: center; border: 1px solid rgba(255,138,0,0.3);
            transform: translateY(30px); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0,0,0,0.9);
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-title { font-size: 24px; font-weight: 900; color: #fff; margin-bottom: 10px; }
        .modal-title.win { color: #00ffa3; }
        .modal-title.lose { color: #ff3b30; }
        .modal-desc { font-size: 15px; color: #aaa; margin-bottom: 25px; white-space: pre-line; line-height: 1.5;}
        .modal-btn { background: var(--pm-orange); color: #000; border: none; padding: 12px 0; width: 100%; border-radius: 12px; font-weight: 900; font-size: 16px; cursor: pointer;}
    </style>
</head>
<body>

<div id="pragmaticIntro">
    <div class="center-logo">
        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
        <h1>PLAYMATRIX<br><span>PRO</span></h1>
    </div>
    <div class="loading-container" id="loadingBarCont"><div class="loading-fill" id="loadingFill"></div></div>

    <div id="howToPlayScreen">
        <div class="htp-box">
            <h2>PÄ°ÅžTÄ° NASIL OYNANIR?</h2>
            <ul>
                <li><b>AmacÄ±nÄ±z:</b> Yerdeki kartlarla eÅŸleÅŸen kartÄ± atarak en Ã§ok puanÄ± toplamak.</li>
                <li><b>Kart Toplama:</b> Yerdeki en Ã¼st kartÄ±n <i>aynÄ±sÄ±nÄ±</i> veya <b>Vale (J)</b> atarsanÄ±z yerdeki tÃ¼m kartlarÄ± alÄ±rsÄ±nÄ±z.</li>
                <li><b>PiÅŸti Yapmak:</b> Yerde <i>sadece bir kart</i> varken aynÄ±sÄ±nÄ± atarsanÄ±z <b>PÄ°ÅžTÄ° (10 Puan)</b> yaparsÄ±nÄ±z. Vale ile piÅŸti <b>20 Puan</b> verir.</li>
                <li><b>Puanlama:</b> As (1), Vale (1), Sinek 2 (2) ve Karo 10 (3) puandÄ±r.</li>
                <li>Oyun sonu elinde daha Ã§ok kart olan <b>+3 Puan</b> kazanÄ±r.</li>
            </ul>
            <button class="play-btn-huge" onclick="closeIntro()">OYUNA BAÅžLA</button>
        </div>
    </div>
</div>

<header class="top-bar">
    <a href="https://playmatrix.com.tr" class="back-btn">LOBÄ°YE DÃ–N</a>
    <div class="balance-container">
        <div class="balance-val" id="uiBalance">0</div>
        <div class="currency-badge">MC</div>
    </div>
</header>

<main class="game-wrapper">
    <div class="score-board">
        <div class="score-item">SÄ°Z <span id="uiPlayerScore">0</span></div>
        <div class="score-item">KRUPÄ°YE <span id="uiBotScore">0</span></div>
    </div>

    <div class="table">
        <div class="bot-hand" id="botHand"></div>
        <div class="table-center" id="tableCenter"></div>
        <div class="player-hand" id="playerHand"></div>
    </div>
</main>

<div id="pistiAnim">PÄ°ÅžTÄ°!</div>

<div class="bet-controls" id="betControls">
    <div class="current-bet-display" id="betDisplayWrap" style="display:none;">
        BAHÄ°S: <span id="uiCurrentBet">0</span> MC
        <button onclick="clearBet()" style="background:transparent; border:none; color:#ff3b30; font-weight:bold; margin-left:10px; cursor:pointer;">[SÄ±fÄ±rla]</button>
    </div>
    
    <div class="chips-row" id="chipsRow">
        <div class="chip c-100" onclick="addBet(100)">100</div>
        <div class="chip c-500" onclick="addBet(500)">500</div>
        <div class="chip c-2k" onclick="addBet(2000)">2K</div>
        <div class="chip c-10k" onclick="addBet(10000)">10K</div>
    </div>

    <button class="action-btn" id="startBtn" disabled onclick="startGame()">OYNA</button>
</div>

<div class="modal-overlay" id="customModal">
    <div class="modal-content">
        <div class="modal-title" id="modalTitle">Bilgi</div>
        <div class="modal-desc" id="modalDesc">Ä°Ã§erik</div>
        <button class="modal-btn" onclick="closeModal()">TAMAM</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Profesyonel Sesler
const sfx = {
    deal: new Audio("https://freesound.org/data/previews/240/240776_4107740-lq.mp3"), 
    throw: new Audio("https://freesound.org/data/previews/240/240776_4107740-lq.mp3"), 
    capture: new Audio("https://freesound.org/data/previews/434/434472_5121236-lq.mp3"), 
    win: new Audio("https://freesound.org/data/previews/270/270319_5123851-lq.mp3"), 
    pisti: new Audio("https://freesound.org/data/previews/411/411420_5121236-lq.mp3") 
};

let userToken = null;
let balance = 0;
let currentBet = 0;
let gameState = null;
let actionLock = true; // Intro bitene kadar kitli

// Intro YÃ¼kleme Animasyonu
let loadProgress = 0;
const loadInt = setInterval(() => {
    loadProgress += Math.random() * 15;
    if(loadProgress >= 100) {
        loadProgress = 100;
        clearInterval(loadInt);
        document.getElementById('loadingBarCont').style.display = 'none';
        document.getElementById('howToPlayScreen').style.display = 'flex';
    }
    document.getElementById('loadingFill').style.width = loadProgress + '%';
}, 100);

window.closeIntro = function() {
    const intro = document.getElementById('pragmaticIntro');
    intro.style.opacity = '0';
    setTimeout(() => { 
        intro.style.visibility = 'hidden'; 
        actionLock = false;
        checkGameState(); 
    }, 800);
}

onAuthStateChanged(auth, async (user) => {
    if (user) {
        userToken = await user.getIdToken();
        await fetchBalance();
    } else {
        window.location.href = "login.html";
    }
});

async function apiCall(endpoint, method = 'GET', body = null) {
    if(!userToken) return {ok: false, error: 'Oturum yok'};
    const opt = { method, headers: { 'Authorization': `Bearer ${userToken}`, 'Content-Type': 'application/json' }};
    if(body) opt.body = JSON.stringify(body);
    try { const res = await fetch(endpoint, opt); return await res.json(); } 
    catch(e) { return {ok: false, error: 'BaÄŸlantÄ± hatasÄ±.'}; }
}

async function fetchBalance() {
    const res = await apiCall('/api/me');
    if(res.ok) { 
        balance = res.balance || 0; 
        updateUI(); 
    }
}

function updateUI() {
    // Bakiyeyi formatla, undefined gelirse 0 yazsÄ±n
    document.getElementById("uiBalance").innerText = (balance || 0).toLocaleString('tr-TR');
    document.getElementById("uiCurrentBet").innerText = currentBet.toLocaleString('tr-TR');
    
    const startBtn = document.getElementById("startBtn");
    const chipsRow = document.getElementById("chipsRow");
    const betDisplay = document.getElementById("betDisplayWrap");

    if(!gameState || gameState.status !== 'playing') {
        chipsRow.style.display = "flex";
        betDisplay.style.display = currentBet > 0 ? "block" : "none";
        startBtn.style.display = "block";
        startBtn.disabled = currentBet < 100;
    } else {
        chipsRow.style.display = "none";
        startBtn.style.display = "none";
        betDisplay.style.display = "none"; 
    }
    
    if(gameState) {
        document.getElementById("uiPlayerScore").innerText = gameState.playerScore || 0;
        document.getElementById("uiBotScore").innerText = gameState.botScore || 0;
    }
}

window.addBet = function(amount) {
    if (balance < amount || currentBet + amount > 50000) return;
    currentBet += amount;
    balance -= amount; // AnÄ±nda UI'da gÃ¶ster
    playSound('deal');
    updateUI();
}

window.clearBet = function() {
    balance += currentBet; // Ä°ptalde bakiyeyi geri ekle
    currentBet = 0;
    playSound('deal');
    updateUI();
}

async function checkGameState() {
    const res = await apiCall('/api/pisti/state');
    // Bakiye server'dan gelirse anÄ±nda eÅŸitle
    if (res.balance !== undefined) balance = res.balance;

    if(res.ok && res.state && res.state.status === 'playing') {
        gameState = res.state;
        renderBoard(false);
    }
    updateUI();
}

window.startGame = async function() {
    if(currentBet < 100) return;
    actionLock = true;
    document.getElementById("startBtn").innerText = "BAÅžLIYOR...";
    
    const res = await apiCall('/api/pisti/start', 'POST', { bet: currentBet });
    document.getElementById("startBtn").innerText = "OYNA";
    
    if(res.ok) {
        if (res.balance !== undefined) balance = res.balance; // Sunucudan dÃ¼ÅŸÃ¼lmÃ¼ÅŸ bakiyeyi al
        gameState = res.state;
        updateUI();
        renderBoard(true); 
        setTimeout(() => { actionLock = false; }, 1500);
    } else {
        showModal("Hata", res.error, "lose");
        balance += currentBet; currentBet = 0; updateUI(); // Hata varsa bakiyeyi geri ver
        actionLock = false;
    }
}

function playSound(name) {
    if(sfx[name]) { sfx[name].currentTime = 0; sfx[name].volume = 0.5; sfx[name].play().catch(()=>{}); }
}

function getCardImg(code) {
    if(!code || code === 'back') return "https://deckofcardsapi.com/static/img/back.png";
    return `https://deckofcardsapi.com/static/img/${code}.png`;
}

function renderBoard(animateDeal = false) {
    if(!gameState) return;
    const ph = document.getElementById("playerHand");
    const bh = document.getElementById("botHand");
    const tc = document.getElementById("tableCenter");
    
    ph.innerHTML = ""; bh.innerHTML = ""; tc.innerHTML = "";

    // Table Cards
    if (gameState.tableCards) {
        gameState.tableCards.forEach((c, i) => {
            let img = document.createElement("div");
            img.className = "card";
            img.style.backgroundImage = `url(${getCardImg(c)})`;
            img.style.transform = `rotate(${Math.random() * 20 - 10}deg) translate(${i*3}px, ${i*3}px)`;
            img.style.zIndex = i;
            tc.appendChild(img);
        });
    }

    // Bot Hand
    for(let i=0; i< (gameState.botCardCount || 0); i++) {
        let img = document.createElement("div");
        img.className = "card";
        img.style.backgroundImage = `url(${getCardImg('back')})`;
        img.style.left = `${i * 35}px`;
        bh.appendChild(img);
    }

    // Player Hand
    if (gameState.playerHand) {
        gameState.playerHand.forEach((c, i) => {
            let img = document.createElement("div");
            img.className = "card playable";
            img.style.backgroundImage = `url(${getCardImg(c)})`;
            img.style.left = `${i * 50}px`;
            img.onclick = () => playCard(i, img);
            if(animateDeal) {
                img.style.top = "-200px"; img.style.opacity = "0";
                setTimeout(() => {
                    img.style.top = "0px"; img.style.opacity = "1"; playSound('deal');
                }, i * 150);
            }
            ph.appendChild(img);
        });
    }
}

window.playCard = async function(index, el) {
    if(actionLock || !gameState) return;
    actionLock = true;
    
    // GÃ¶rsel fÄ±rlatma
    el.style.top = "-180px";
    el.style.left = "100px";
    el.classList.remove("playable");
    playSound('throw');

    const res = await apiCall('/api/pisti/play', 'POST', { cardIndex: index });
    
    if(!res.ok) { showModal("Hata", res.error, "lose"); checkGameState(); actionLock = false; return; }

    const log = res.log;
    
    setTimeout(() => {
        if(log.playerAction.captured) {
            playSound('capture');
            document.getElementById("tableCenter").innerHTML = ""; 
            if(log.playerAction.isPisti) { playSound('pisti'); triggerPistiAnim(); }
        } 

        gameState = res.state;
        if (res.balance !== undefined) balance = res.balance; // GÃ¼ncel bakiyeyi eÅŸitle
        updateUI();
        
        // Botun hamlesini gÃ¶ster (Gecikmeli)
        setTimeout(() => {
            if(log.botAction) {
                playSound('throw');
                const bh = document.getElementById("botHand");
                if(bh && bh.lastChild) {
                    bh.lastChild.style.backgroundImage = `url(${getCardImg(log.botAction.card)})`;
                    bh.lastChild.style.top = "180px";
                    bh.lastChild.style.zIndex = "100";
                }
                
                setTimeout(() => {
                    if(log.botAction.captured) {
                        playSound('capture');
                        if(log.botAction.isPisti) { playSound('pisti'); triggerPistiAnim(); }
                    }
                    gameState = res.state;
                    if (res.balance !== undefined) balance = res.balance; // Tekrar bakiye gÃ¼venliÄŸi
                    renderBoard();
                    updateUI();
                    
                    if(log.roundOver) {
                        setTimeout(() => { renderBoard(true); actionLock = false; }, 800);
                    } else if(log.gameOver) {
                        handleGameOver(log);
                    } else {
                        actionLock = false;
                    }
                }, 800);
            } else {
                 if(log.roundOver) { setTimeout(() => { renderBoard(true); actionLock = false; }, 800); }
                 else if(log.gameOver) { handleGameOver(log); }
                 else { actionLock = false; }
            }
        }, 1000);

    }, 500); 
}

function triggerPistiAnim() {
    const el = document.getElementById("pistiAnim");
    el.style.animation = 'none';
    el.offsetHeight; // Reflow
    el.style.animation = 'showPisti 1.5s ease-out forwards';
}

function handleGameOver(log) {
    gameState = null;
    let title, desc, type;
    
    if(log.winAmount > currentBet) {
        playSound('win');
        title = "ðŸ† TEBRÄ°KLER!"; type = "win";
        desc = `Krupiyeyi maÄŸlup ettiniz.\n\nKazanÄ±lan: ${log.winAmount.toLocaleString('tr-TR')} MC`;
    } else if(log.winAmount === currentBet) {
        title = "ðŸ¤ BERABERE"; type = "win";
        desc = "Oyun berabere bitti.\nBahsiniz iade edildi.";
    } else {
        title = "ðŸ’¥ KAYBETTÄ°NÄ°Z"; type = "lose";
        desc = "Krupiye daha yÃ¼ksek puan topladÄ±.\nÅžansÄ±nÄ±zÄ± tekrar deneyin.";
    }

    currentBet = 0;
    
    setTimeout(() => {
        renderBoard();
        showModal(title, desc, type);
        actionLock = false;
    }, 1000);
}

window.showModal = function(title, desc, type="win") {
    const mt = document.getElementById("modalTitle");
    mt.innerText = title;
    mt.className = `modal-title ${type}`;
    document.getElementById("modalDesc").innerText = desc;
    document.getElementById("customModal").classList.add("active");
}
window.closeModal = function() {
    document.getElementById("customModal").classList.remove("active");
    updateUI();
}
</script>
</body>
</html>
