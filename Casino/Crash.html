<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>PlayMatrix Crash | Profesyonel VIP Casino</title>
    <meta name="description" content="PlayMatrix Crash | Güvenli, adil ve hızlı çarpan oyunu. Roket yükseldikçe kazan, patlamadan önce çekil!">
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        /* GENEL VIP CASINO RESET VE TEMA */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        html, body { background: #0b1118; color: #ffffff; height: 100vh; width: 100vw; overflow: hidden; overscroll-behavior: none; font-family: 'Inter', sans-serif; }

        /* PROFESYONEL İNTRO */
        #studioIntro {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #070b10;
            z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }
        .intro-logo { transform: scale(1.1); animation: breathe 2s infinite alternate; text-align: center; }
        .intro-logo i { font-size: 65px; color: #00e701; margin-bottom: 15px; filter: drop-shadow(0 0 15px rgba(0,231,1,0.5)); }
        .intro-logo h1 { font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 32px; letter-spacing: 3px; color: #fff; text-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        .intro-logo h1 span { color: #00e701; }
        
        .loader-track { width: 200px; height: 3px; background: #1a2430; margin-top: 40px; border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); }
        .loader-fill { height: 100%; width: 0%; background: #00e701; transition: width 0.1s linear; box-shadow: 0 0 10px #00e701; }
        .btn-intro-start { display: none; margin-top: 30px; padding: 12px 35px; background: #00e701; color: #000; border: none; border-radius: 8px; font-weight: 900; font-size: 14px; cursor: pointer; text-transform: uppercase; font-family: 'Orbitron'; box-shadow: 0 4px 15px rgba(0,231,1,0.3); transition: 0.2s; }
        .btn-intro-start:active { transform: scale(0.95); box-shadow: none; }

        @keyframes breathe { 0% { transform: scale(1); filter: brightness(1); } 100% { transform: scale(1.05); filter: brightness(1.2); } }

        /* ÜST BAR (TOP BAR) */
        .top-bar { 
            position: fixed; top: 0; left: 0; width: 100%; height: 65px; background: #121a24;
            border-bottom: 1px solid #1f2c3b; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .tb-left { display: flex; align-items: center; gap: 15px; }
        .tb-logo { font-family: 'Orbitron', sans-serif; font-size: 16px; font-weight: 900; color: #fff; letter-spacing: 1px; }
        .tb-logo span { color: #00e701; }
        
        .tb-right { display: flex; align-items: center; gap: 10px; }
        .balance-box { display: flex; align-items: center; background: #0b1118; padding: 6px 12px; border-radius: 8px; border: 1px solid #1f2c3b; }
        .balance-box b { font-size: 14px; color: #00e701; font-family: 'Inter', monospace; font-weight: 800; }
        .mc-icon { background: #00e701; color: #000; font-size: 9px; font-weight: 900; padding: 3px 6px; border-radius: 4px; margin-left: 8px; }
        
        .action-icon-btn { 
            background: #1f2c3b; color: #94a3b8; border: none; width: 34px; height: 34px; 
            border-radius: 8px; font-size: 14px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; text-decoration: none;
        }
        .action-icon-btn:active { transform: scale(0.9); background: #2a3a4d; color: #fff; }
        .action-icon-btn.red:active { background: #ef4444; color: #fff; }

        /* CRASH GEÇMİŞİ (GERÇEK RENKLER) */
        .history-bar { 
            position: fixed; top: 65px; left: 0; width: 100%; height: 45px; background: #0e151d;
            display: flex; align-items: center; padding: 0 10px; overflow-x: auto; gap: 8px;
            scrollbar-width: none; border-bottom: 1px solid #1f2c3b; z-index: 900;
        }
        .history-bar::-webkit-scrollbar { display: none; }
        .hist-pill { 
            padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 800; 
            font-family: 'Inter', sans-serif; background: #1a2430; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .hist-red { color: #ff3b30; background: rgba(255,59,48,0.1); border: 1px solid rgba(255,59,48,0.2); }
        .hist-green { color: #00e701; background: rgba(0,231,1,0.1); border: 1px solid rgba(0,231,1,0.2); }
        .hist-gold { color: #f59e0b; background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.2); }

        /* OYUN ALANI (CANVAS) */
        .game-area { 
            position: absolute; top: 110px; left: 0; width: 100%; height: calc(100vh - 350px);
            background: radial-gradient(circle at center, #121a24 0%, #0b1118 100%);
            z-index: 1; overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }

        /* MERKEZİ ÇARPAN EKRANI */
        .multiplier-core { position: relative; z-index: 10; text-align: center; pointer-events: none; }
        .phase-text { font-family: 'Orbitron', sans-serif; font-size: 13px; color: #94a3b8; letter-spacing: 2px; margin-bottom: 5px; text-transform: uppercase; }
        .multiplier-val { font-family: 'Inter', sans-serif; font-size: 85px; font-weight: 900; color: #fff; line-height: 1; text-shadow: 0 0 30px rgba(255,255,255,0.2); transition: color 0.2s; }
        .val-flying { color: #00e701; text-shadow: 0 0 40px rgba(0,231,1,0.5); }
        .val-crashed { color: #ff3b30; text-shadow: 0 0 40px rgba(255,59,48,0.5); animation: shake 0.3s ease-in-out; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px) translateY(-2px); } 75% { transform: translateX(5px) translateY(2px); } }

        /* ALT PANEL (BAHİS KONTROLLERİ) */
        .bottom-controls { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 240px; background: #121a24;
            border-top: 1px solid #1f2c3b; padding: 15px; display: flex; gap: 10px; justify-content: center; z-index: 1000;
        }
        .bet-box { 
            background: #1a2430; flex: 1; max-width: 300px; border-radius: 12px; padding: 12px;
            display: flex; flex-direction: column; justify-content: space-between; border: 1px solid #2a3a4d;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
        }
        .bet-input-wrap { position: relative; width: 100%; background: #0b1118; border-radius: 8px; border: 1px solid #2a3a4d; overflow: hidden;}
        .bet-input-wrap input { 
            width: 100%; background: transparent; border: none; color: #fff; padding: 15px; 
            text-align: center; font-size: 18px; font-weight: 800; font-family: 'Inter'; outline: none;
        }
        
        /* PROFESYONEL BUTONLAR (MC KULLAN - İPTAL - ÇEK) */
        .action-btn { 
            width: 100%; min-height: 55px; border: none; border-radius: 8px; font-weight: 900; 
            font-size: 16px; cursor: pointer; transition: 0.1s; text-transform: uppercase; font-family: 'Inter'; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; gap: 8px; flex-direction: column; line-height: 1.2;
        }
        .action-btn span { font-size: 11px; font-weight: 600; opacity: 0.8; text-transform: none; font-family: 'Inter';}
        
        .btn-bet { background: #00e701; color: #000; box-shadow: 0 4px 0 #009900; }
        .btn-bet:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-cancel { background: #ff3b30; color: #fff; box-shadow: 0 4px 0 #990000; }
        .btn-cancel:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-cashout { background: #f59e0b; color: #000; box-shadow: 0 4px 0 #b45309; animation: pulseCashout 1.5s infinite; }
        .btn-cashout:active { transform: translateY(4px); box-shadow: none; }

        .btn-disabled { background: #2a3a4d !important; color: #64748b !important; box-shadow: 0 4px 0 #1f2c3b !important; cursor: not-allowed; animation: none;}
        
        @keyframes pulseCashout { 0% { filter: brightness(1); } 50% { filter: brightness(1.2); } 100% { filter: brightness(1); } }

        /* BİLGİ MODALI */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 10000; opacity: 0; transition: opacity 0.3s; }
        .modal-card { background: #121a24; border: 1px solid #2a3a4d; width: 90%; max-width: 360px; border-radius: 16px; padding: 25px; transform: scale(0.9); transition: 0.3s; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .modal-card h3 { color: #fff; font-family: 'Orbitron'; font-size: 18px; margin-bottom: 15px; border-bottom: 1px solid #2a3a4d; padding-bottom: 10px; }
        .modal-card p { font-size: 13px; color: #94a3b8; line-height: 1.6; margin-bottom: 10px; }
        .modal-card p b { color: #00e701; }
        .modal-close { background: #1a2430; color: #fff; border: none; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; margin-top: 15px; cursor: pointer; transition: 0.2s;}
        .modal-close:active { background: #2a3a4d; }

        @media (max-width: 400px) { 
            .multiplier-val { font-size: 65px; } 
            .bottom-controls { height: 210px; padding: 10px; } 
            .game-area { height: calc(100vh - 320px); } 
            .bet-box { padding: 8px; } 
            .bet-input-wrap input { padding: 10px; font-size: 15px; } 
            .action-btn { min-height: 48px; font-size: 14px; }
        }
    </style>
</head>
<body>

<div id="studioIntro">
    <div class="intro-logo">
        <i class="fa-solid fa-rocket"></i>
        <h1>PLAYMATRIX<br><span>CRASH</span></h1>
    </div>
    <div class="loader-track" id="loaderTrack"><div class="loader-fill" id="loaderFill"></div></div>
    <button id="btnEnterGame" class="btn-intro-start">SİSTEME BAĞLAN</button>
</div>

<div id="infoModal" class="modal-overlay">
    <div class="modal-card" id="infoCard">
        <h3>NASIL OYNANIR?</h3>
        <p><i class="fa-solid fa-check" style="color:#00e701; margin-right:5px;"></i> Bahis süresi içinde bakiyenizi girip <b>MC KULLAN</b> butonuna basın.</p>
        <p><i class="fa-solid fa-rocket" style="color:#4fd1ff; margin-right:5px;"></i> Oyun başladığındaçarpan sürekli artar. Gidebildiği yere kadar yükselir.</p>
        <p><i class="fa-solid fa-hand-pointer" style="color:#f59e0b; margin-right:5px;"></i> Roket patlamadan (CRASH) önce <b>ÇEK</b> butonuna basarsanız kazanırsınız!</p>
        <p style="color:#ff3b30; font-size:11px; margin-top:15px;"><i class="fa-solid fa-triangle-exclamation"></i> Dikkat: Bahisler sunucuya iletildikten sonra iptal edilemez.</p>
        <button class="modal-close" onclick="closeInfoModal()">ANLADIM</button>
    </div>
</div>

<div id="alertModal" class="modal-overlay">
    <div class="modal-card" id="alertCard" style="text-align:center;">
        <i class="fa-solid fa-circle-exclamation" style="font-size:40px; color:#ff3b30; margin-bottom:15px;"></i>
        <h3 id="alertTitle" style="color:#ff3b30; border:none; padding:0;">HATA</h3>
        <p id="alertMsg" style="font-weight:bold; color:#fff; font-size:14px;"></p>
        <button class="modal-close" onclick="closeAlertModal()">KAPAT</button>
    </div>
</div>

<header class="top-bar">
    <div class="tb-left">
        <div class="tb-logo">PM <span>CRASH</span></div>
    </div>
    <div class="tb-right">
        <div class="balance-box">
            <b id="uiBalance">...</b><div class="mc-icon">MC</div>
        </div>
        <button class="action-icon-btn" onclick="openInfoModal()"><i class="fa-solid fa-circle-info"></i></button>
        <a href="/" class="action-icon-btn red"><i class="fa-solid fa-right-from-bracket"></i></a>
    </div>
</header>

<div class="history-bar" id="uiHistory"></div>

<main class="game-area">
    <canvas id="crashCanvas"></canvas>
    <div class="multiplier-core">
        <div class="phase-text" id="uiPhase">YÜKLENİYOR...</div>
        <div class="multiplier-val" id="uiMultiplier">1.00x</div>
    </div>
</main>

<div class="bottom-controls">
    <div class="bet-box">
        <div class="bet-input-wrap">
            <input type="number" id="inpBet1" value="100" min="10" step="10">
        </div>
        <button id="btnAction1" class="action-btn btn-bet">MC KULLAN</button>
    </div>

    <div class="bet-box">
        <div class="bet-input-wrap">
            <input type="number" id="inpBet2" value="200" min="10" step="10">
        </div>
        <button id="btnAction2" class="action-btn btn-bet">MC KULLAN</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, getIdToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
        authDomain:"emirhan-site.firebaseapp.com",
        projectId:"emirhan-site",
        storageBucket:"emirhan-site.firebasestorage.app",
        messagingSenderId:"668871888390",
        appId:"1:668871888390:web:76568bda84cb1641f7bd87"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const API_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" ? "http://localhost:3000" : "https://emirhan-siye.onrender.com";

    // DOM ELEMENTS
    const elBal = document.getElementById("uiBalance");
    const elMult = document.getElementById("uiMultiplier");
    const elPhase = document.getElementById("uiPhase");
    const elHist = document.getElementById("uiHistory");
    const btn1 = document.getElementById("btnAction1");
    const btn2 = document.getElementById("btnAction2");
    const inp1 = document.getElementById("inpBet1");
    const inp2 = document.getElementById("inpBet2");

    // MODAL YÖNETİMİ
    window.openInfoModal = () => { document.getElementById('infoModal').style.display='flex'; setTimeout(()=>document.getElementById('infoModal').style.opacity='1',10); }
    window.closeInfoModal = () => { document.getElementById('infoModal').style.opacity='0'; setTimeout(()=>document.getElementById('infoModal').style.display='none',300); }
    window.openAlertModal = (msg) => { document.getElementById('alertMsg').innerText=msg; document.getElementById('alertModal').style.display='flex'; setTimeout(()=>document.getElementById('alertModal').style.opacity='1',10); }
    window.closeAlertModal = () => { document.getElementById('alertModal').style.opacity='0'; setTimeout(()=>document.getElementById('alertModal').style.display='none',300); }

    // PROFESYONEL SES MOTORU (WEB AUDIO API - SIFIR GECİKME)
    let audioCtx = null;
    const sounds = {};
    const sfxUrls = {
        tick: 'https://freesound.org/data/previews/256/256113_3263906-lq.mp3', // Geri sayım
        launch: 'https://freesound.org/data/previews/146/146725_2437358-lq.mp3', // Uçuş başlangıcı
        win: 'https://freesound.org/data/previews/270/270319_5123851-lq.mp3', // Para Çekme
        crash: 'https://freesound.org/data/previews/170/170144_2437358-lq.mp3' // Patlama
    };

    async function loadAudio() {
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            for (let [key, url] of Object.entries(sfxUrls)) {
                const res = await fetch(url);
                const buf = await res.arrayBuffer();
                sounds[key] = await audioCtx.decodeAudioData(buf);
            }
        } catch(e) {}
    }

    function playSfx(name) {
        if(!audioCtx || !sounds[name]) return;
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const src = audioCtx.createBufferSource();
        src.buffer = sounds[name];
        
        const gainNode = audioCtx.createGain();
        gainNode.gain.value = name === 'tick' ? 0.3 : 0.6; // Tick sesini kıs
        
        src.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        src.start(0);
    }

    // INTRO LOGIC
    let loadProg = 0;
    const loadInt = setInterval(() => {
        loadProg += Math.random() * 20;
        if(loadProg >= 100) {
            loadProg = 100; clearInterval(loadInt);
            document.getElementById('loaderTrack').style.display = 'none';
            document.getElementById('btnEnterGame').style.display = 'block';
        }
        document.getElementById('loaderFill').style.width = loadProg + '%';
    }, 100);

    document.getElementById('btnEnterGame').addEventListener('click', () => {
        loadAudio(); // Ses motorunu kullanıcı etkileşimi ile başlat (Tarayıcı politikası)
        document.getElementById('studioIntro').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('studioIntro').style.display = 'none';
            initGame();
        }, 600);
    });

    // STATE VARIABLES
    let gameStarted = false;
    let serverOffset = 0;
    let sPhase = "WAITING";
    let lastPhase = "";
    let sStartTime = 0;
    let sCrashPoint = 1.00;
    let myBets = {}; 
    let currentMult = 1.00;
    let isProc1 = false; let isProc2 = false;
    let lastTick = -1;

    async function api(endpoint, method='GET', body=null) {
        if(!auth.currentUser) return null;
        const token = await getIdToken(auth.currentUser);
        const opt = { method, headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'} };
        if(body) opt.body = JSON.stringify(body);
        const res = await fetch(API_URL+endpoint, opt);
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || "Hata");
        return data;
    }

    function initGame() {
        gameStarted = true;
        api('/api/me').then(d => { if(d) elBal.innerText = d.balance.toLocaleString('tr-TR'); }).catch(()=>{});
        sync();
        setInterval(sync, 500); // Polling (Güvenli Sunucu Mimarisi gereği korunmuştur)
    }

    async function sync() {
        if(!gameStarted) return;
        try {
            const d = await api('/api/crash/state');
            if(!d) return;
            serverOffset = Date.now() - d.state.serverNow;
            sPhase = d.state.phase;
            sStartTime = d.state.startTime;
            myBets = d.state.myBets || {};
            sCrashPoint = d.state.crashPoint || 1.00;

            // GEÇMİŞİ ÇİZ (Profesyonel Renkler)
            elHist.innerHTML = "";
            d.state.history.forEach(v => {
                let c = v < 2 ? 'hist-red' : (v < 10 ? 'hist-green' : 'hist-gold');
                elHist.innerHTML += `<div class="hist-pill ${c}">${v.toFixed(2)}x</div>`;
            });

            // FAZ GEÇİŞ TETİKLEYİCİLERİ
            if (sPhase !== lastPhase) {
                updateBtns();
                if(sPhase === 'FLYING') playSfx('launch');
                if(sPhase === 'CRASHED') { playSfx('crash'); createExplosion(); }
                lastPhase = sPhase;
            }
        } catch(e) {}
    }

    // PROFESYONEL CANVAS ÇİZİM MOTORU
    const cvs = document.getElementById('crashCanvas');
    const ctx = cvs.getContext('2d');
    let W, H;
    let particles = [];
    let endX=0, endY=0;

    function resize() { W = cvs.width = cvs.offsetWidth; H = cvs.height = cvs.offsetHeight; }
    window.addEventListener('resize', resize); resize();

    function createExplosion() {
        for(let i=0; i<30; i++) {
            particles.push({
                x: endX, y: endY,
                vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15,
                life: 1, size: Math.random()*4 + 2, 
                c: Math.random() > 0.5 ? '#ff3b30' : '#ffaa00'
            });
        }
    }

    // Roket/İmleç Çizimi
    function drawRocket(x, y, angle) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle);
        
        // Ateş
        ctx.fillStyle = '#f59e0b';
        ctx.beginPath(); ctx.moveTo(-10, -5); ctx.lineTo(-25 - Math.random()*10, 0); ctx.lineTo(-10, 5); ctx.fill();

        // Gövde (Ok / Uzay Mekiği)
        ctx.fillStyle = '#ffffff';
        ctx.shadowBlur = 15; ctx.shadowColor = '#00e701';
        ctx.beginPath(); ctx.moveTo(15, 0); ctx.lineTo(-10, 10); ctx.lineTo(-5, 0); ctx.lineTo(-10, -10); ctx.closePath(); ctx.fill();
        
        ctx.restore();
    }

    function render() {
        ctx.clearRect(0,0,W,H);
        const now = Date.now() - serverOffset;

        // Kayan Grid Arka Plan (Hız hissi)
        ctx.strokeStyle = 'rgba(255,255,255,0.03)';
        ctx.lineWidth = 1;
        let speed = sPhase === 'FLYING' ? (now*0.05) % 50 : 0;
        for(let x = -speed; x < W; x+=50) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
        for(let y = (now*0.02)%50; y < H; y+=50) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

        if (sPhase === 'COUNTDOWN') {
            let left = Math.max(0, (sStartTime - now) / 1000);
            let sec = Math.floor(left);
            if(sec !== lastTick && sec <= 5 && sec > 0) { playSfx('tick'); lastTick = sec; }

            elPhase.innerText = "BAHİSLER AÇIK";
            elMult.innerText = left.toFixed(1) + "s";
            elMult.className = "multiplier-val"; 
            particles = [];
            
            // Başlangıç noktasında bekle
            endX = W*0.1; endY = H*0.9;
            drawRocket(endX, endY, -Math.PI/4);

        } else if (sPhase === 'FLYING') {
            let elapsed = Math.max(0, now - sStartTime) / 1000;
            currentMult = 1 + Math.pow(elapsed * 0.18, 1.35);
            
            elPhase.innerText = "UÇUŞTA";
            elMult.innerText = currentMult.toFixed(2) + "x";
            elMult.className = "multiplier-val val-flying";
            
            // Profesyonel Eğri Hesaplama (Logaritmik Görünüm)
            let visualProg = Math.min(1, elapsed / 8); 
            endX = W*0.1 + (W*0.8) * visualProg;
            let yProg = currentMult / (currentMult + 3); 
            endY = H*0.9 - (H*0.7) * yProg;

            let prevX = W*0.1 + (W*0.8) * Math.min(1, (elapsed-0.1)/8);
            let prevMult = 1 + Math.pow(Math.max(0, elapsed-0.1)*0.18, 1.35);
            let prevY = H*0.9 - (H*0.7) * (prevMult/(prevMult+3));
            let angle = Math.atan2(endY - prevY, endX - prevX);

            // Çizgi Çizimi
            ctx.beginPath();
            ctx.moveTo(W*0.1, H*0.9);
            ctx.quadraticCurveTo(W*0.5, endY+50, endX, endY);
            ctx.strokeStyle = '#00e701';
            ctx.lineWidth = 4;
            ctx.shadowBlur = 10; ctx.shadowColor = '#00e701';
            ctx.stroke();
            ctx.shadowBlur = 0; // reset

            drawRocket(endX, endY, angle);

            // Dinamik Çekim Butonu Güncellemesi
            if(myBets.box1 && !myBets.box1.cashed && !isProc1) { btn1.innerHTML = `ÇEK<br><span>${Math.floor(myBets.box1.bet * currentMult)} MC</span>`; }
            if(myBets.box2 && !myBets.box2.cashed && !isProc2) { btn2.innerHTML = `ÇEK<br><span>${Math.floor(myBets.box2.bet * currentMult)} MC</span>`; }

        } else if (sPhase === 'CRASHED') {
            elPhase.innerText = "PATLADI";
            elMult.innerText = sCrashPoint.toFixed(2) + "x";
            elMult.className = "multiplier-val val-crashed";

            // Çizgiyi Kırmızı Yap
            ctx.beginPath();
            ctx.moveTo(W*0.1, H*0.9);
            ctx.quadraticCurveTo(W*0.5, endY+50, endX, endY);
            ctx.strokeStyle = '#ff3b30'; ctx.lineWidth = 4; ctx.stroke();

            // Parçacık Animasyonu (Patlama)
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                if(p.life <= 0) { particles.splice(i, 1); return; }
                ctx.globalAlpha = p.life;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fillStyle = p.c; ctx.fill();
            });
            ctx.globalAlpha = 1;
        }

        requestAnimationFrame(render);
    }
    render();

    // BUTON KONTROL MANTIĞI (MC KULLAN - İPTAL - ÇEK)
    function updateBtns() {
        const u = (box) => {
            const btn = box === 1 ? btn1 : btn2;
            const isProc = box === 1 ? isProc1 : isProc2;
            const bData = myBets[`box${box}`];

            if(isProc) { btn.className = "action-btn btn-disabled"; btn.innerHTML = "İŞLENİYOR..."; return; }

            if(sPhase === 'COUNTDOWN') {
                if(bData) {
                    // Bahis yapıldıysa İPTAL (Fakat backend desteklemediği için görsel olarak kilitli)
                    btn.className = "action-btn btn-cancel btn-disabled";
                    btn.innerHTML = `İPTAL<br><span>(ONAYLANDI)</span>`;
                } else {
                    btn.className = "action-btn btn-bet";
                    btn.innerHTML = `MC KULLAN<br><span>BAHİS YAP</span>`;
                }
            } 
            else if(sPhase === 'FLYING') {
                if(bData && !bData.cashed) {
                    btn.className = "action-btn btn-cashout"; 
                    // InnerHTML render döngüsünde anlık güncelleniyor.
                } else if(bData && bData.cashed) {
                    btn.className = "action-btn btn-disabled";
                    btn.style.background = "#00e701"; btn.style.color = "#000";
                    btn.innerHTML = `KAZANILDI<br><span>${bData.win} MC</span>`;
                } else {
                    btn.className = "action-btn btn-disabled";
                    btn.innerHTML = `BEKLEYİNİZ`;
                }
            } 
            else if(sPhase === 'CRASHED') {
                if(bData && bData.cashed) {
                    btn.className = "action-btn btn-disabled";
                    btn.style.background = "#00e701"; btn.style.color = "#000";
                    btn.innerHTML = `KAZANILDI<br><span>${bData.win} MC</span>`;
                } else if(bData && !bData.cashed) {
                    btn.className = "action-btn btn-cancel btn-disabled";
                    btn.innerHTML = `KAYBEDİLDİ<br><span>-${bData.bet} MC</span>`;
                } else {
                    btn.className = "action-btn btn-disabled";
                    btn.innerHTML = `BEKLEYİNİZ`;
                }
            }
        };
        u(1); u(2);
    }

    async function action(box) {
        if(box===1 && isProc1) return;
        if(box===2 && isProc2) return;

        if (sPhase === 'COUNTDOWN') {
            // Bahis Yapma
            const amt = Math.floor((box===1 ? inp1 : inp2).value);
            if(amt < 10) return openAlertModal("Minimum bahis 10 MC olmalıdır.");
            if(myBets[`box${box}`]) return openAlertModal("Bahisler sunucuya iletildikten sonra iptal edilemez.");
            
            box===1 ? isProc1=true : isProc2=true; updateBtns();
            try {
                const res = await api('/api/crash/bet', 'POST', { box, amount: amt });
                myBets = res.myBets;
                api('/api/me').then(d=>{if(d) elBal.innerText=d.balance.toLocaleString('tr-TR');});
            } catch(e) { openAlertModal(e.message); }
            box===1 ? isProc1=false : isProc2=false; updateBtns();
        } 
        else if (sPhase === 'FLYING') {
            // Çekim Yapma
            if(!myBets[`box${box}`] || myBets[`box${box}`].cashed) return;
            box===1 ? isProc1=true : isProc2=true; updateBtns();
            try {
                const res = await api('/api/crash/cashout', 'POST', { box });
                myBets = res.myBets;
                playSfx('win');
                api('/api/me').then(d=>{if(d) elBal.innerText=d.balance.toLocaleString('tr-TR');});
            } catch(e) { openAlertModal(e.message); }
            box===1 ? isProc1=false : isProc2=false; updateBtns();
        }
    }

    btn1.onclick = () => action(1);
    btn2.onclick = () => action(2);

</script>
</body>
</html>
