<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="description" content="PlayMatrix Crash | Güvenli, adil ve hızlı çarpan oyunu. Roket yükseldikçe kazan, patlamadan önce çekil!">
    <meta name="keywords" content="crash oyunu, casino, playmatrix, çarpan oyunu, kripto oyun, güvenli bahis, roket oyunu">
    <meta name="author" content="PlayMatrix">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#02050e">
    
    <meta property="og:title" content="PlayMatrix Crash | Gerçek Çarpan Heyecanı">
    <meta property="og:description" content="Kazanmak için roketin yükselişine katıl, patlamadan önce nakde çevir. %100 Provably Fair ve güvenli!">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="PlayMatrix">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="PlayMatrix Crash Oyunu">
    <meta name="twitter:description" content="Güvenli, adil ve anlık çarpan oyunu. Hemen oyna!">

    <title>PlayMatrix - Crash</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <script>
        if (window.history.replaceState) { window.history.replaceState(null, null, "/"); }
    </script>

    <style>
        /* GENEL DÜZEN VE SIFIR KAYMA KORUMASI */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', sans-serif; user-select: none; }
        html, body { background: #02050e; color: white; height: 100vh; width: 100vw; overflow: hidden; overscroll-behavior: none; touch-action: none; }

        .top-bar { position: fixed; top: 0; left: 0; right: 0; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: rgba(2, 5, 14, 0.95); backdrop-filter: blur(20px); border-bottom: 2px solid #4fd1ff; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.8); }
        .brand { font-family: 'Orbitron', sans-serif; font-size: 18px; font-weight: 900; background: linear-gradient(90deg, #4fd1ff, #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 1px; }
        .right-menu { display: flex; gap: 8px; align-items: center; }
        
        .user-pill-mini { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 5px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); }
        .balance-info { display: flex; align-items: center; }
        .balance-info b { font-size: 14px; color: #00ffa3; font-family: 'Inter', monospace; font-weight: 700; }
        .mc-chip { width: 22px; height: 22px; background: radial-gradient(circle at 30% 30%, #4fd1ff, #0055ff); border-radius: 50%; margin-left: 6px; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 900; color: #fff; box-shadow: 0 0 10px rgba(79, 209, 255, 0.3); border: 1.2px solid rgba(255,255,255,0.2); font-family: 'Inter', sans-serif; }

        .back-btn { background: linear-gradient(to bottom, #ff4b4b, #cc0000); color: white; text-decoration: none; padding: 8px 15px; border-radius: 10px; font-weight: 800; font-size: 11px; border: 1px solid #7a0000; cursor: pointer; transition: 0.3s; margin-left: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        .history { position: fixed; top: 70px; width: 100%; height: 40px; display: flex; align-items: center; gap: 8px; padding: 0 15px; background: rgba(0,0,0,0.4); overflow-x: auto; scrollbar-width: none; z-index: 900; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .history::-webkit-scrollbar { display: none; }
        .history span { padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 800; font-family: 'Orbitron'; background: rgba(255,255,255,0.05); }

        /* MERKEZİ OYUN ALANI */
        /* TopBar(70) + History(40) = 110px. Panel=240px. Kalan = 100vh - 350px. */
        .game-container { position: absolute; top: 110px; left: 0; width: 100%; height: calc(100vh - 350px); z-index: 1; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }

        /* KUSURSUZ MERKEZLEME (ABSOLUTE DEAD CENTER) */
        .multiplier-display { 
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            text-align: center; 
            pointer-events: none; 
            z-index: 10; 
            width: 100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .status-text { font-family: 'Orbitron'; font-size: 14px; color: #4fd1ff; letter-spacing: 4px; margin-bottom: 5px; text-transform: uppercase; text-shadow: 0 2px 4px #000; }
        .x-value { font-family: 'Orbitron', sans-serif; font-size: 90px; font-weight: 900; color: #fff; text-shadow: 0 0 30px rgba(79, 209, 255, 0.6); transition: transform 0.1s; line-height: 1; }
        
        .crashed-text { color: #ff2a4d !important; text-shadow: 0 0 30px rgba(255, 42, 77, 0.8); animation: shake 0.4s infinite; }

        /* İBRE / HIZ GÖSTERGESİ */
        .speedometer { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); width: 15px; height: 60%; max-height: 200px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(79, 209, 255, 0.15); overflow: hidden; z-index: 10; display: flex; flex-direction: column-reverse; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .speed-fill { width: 100%; height: 0%; background: linear-gradient(to top, #00ffa3, #4fd1ff, #ff4b4b); transition: height 0.1s ease-out; box-shadow: 0 0 10px rgba(79, 209, 255, 0.5); }
        
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-2px, -1px); } 100% { transform: translate(1px, 1px); } }

        /* ALT PANEL - SIFIR GECİKME BUTONLARI */
        .bottom-panel { position: fixed; bottom: 0; left: 0; width: 100%; height: 240px; background: linear-gradient(to top, #02050e, #080c18); border-top: 2px solid #161d36; display: flex; justify-content: center; align-items: center; gap: 10px; padding: 15px; z-index: 1000; box-shadow: 0 -10px 20px rgba(0,0,0,0.5); }
        .bet-card { background: linear-gradient(145deg, #111827, #0a0f1a); flex: 1; max-width: 220px; height: 100%; border-radius: 16px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; gap: 8px; border: 1px solid #1f2937; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5); }
        .bet-card input { width: 100%; background: #030712; border: 2px solid #1f2937; border-radius: 12px; color: #4fd1ff; padding: 12px; text-align: center; font-size: 20px; font-weight: 900; font-family: 'Orbitron'; outline: none; transition: border 0.3s; }
        .bet-card input:focus { border-color: #4fd1ff; }
        
        .auto-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.4); padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .auto-row span { font-size: 11px; font-weight: 800; color: #94a3b8; letter-spacing: 1px; }

        .switch { position: relative; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        input:checked + .slider { background-color: #00ffa3; }
        input:checked + .slider:before { transform: translateX(18px); }

        .main-btn { width: 100%; flex-grow: 1; min-height: 45px; border: none; border-radius: 12px; color: white; font-weight: 900; font-size: 15px; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; text-transform: uppercase; font-family: 'Orbitron'; letter-spacing: 1px; touch-action: manipulation; }
        .btn-bet { background: linear-gradient(180deg, #6366f1, #4338ca); box-shadow: 0 5px 0 #312e81; }
        .btn-cancel { background: linear-gradient(180deg, #10b981, #047857); box-shadow: 0 5px 0 #064e3b; }
        .btn-cashout { background: linear-gradient(180deg, #f59e0b, #d97706); box-shadow: 0 5px 0 #b45309; }
        .btn-loss { background: linear-gradient(180deg, #ef4444, #b91c1c); box-shadow: 0 5px 0 #7f1d1d; }
        
        .main-btn:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 1px 0 rgba(0,0,0,0.5); }
        .main-btn:disabled { opacity: 0.6; filter: grayscale(0.8); cursor: not-allowed; transform: none !important; box-shadow: 0 5px 0 rgba(0,0,0,0.3) !important; }

        @media (max-width: 400px) { 
            .x-value { font-size: 70px; } 
            .bottom-panel { height: 220px; padding: 10px; } 
            .game-container { height: calc(100vh - 330px); } /* Telefonlar İçin Kusursuz Ortalama Ayarı */
            .bet-card { padding: 10px; gap: 8px;} 
            .bet-card input { padding: 10px; font-size: 16px; } 
            .speedometer { display: none; } 
        }

        /* AÇIKLAYICI NASIL OYNANIR EKRANI */
        .start-overlay { position: fixed; inset: 0; background: rgba(2,5,14,0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(15px); touch-action: none; transition: opacity 0.5s; }
        
        .animated-border-box {
            position: relative; width: 90%; max-width: 380px; border-radius: 16px; padding: 4px;
            background: linear-gradient(45deg, #4fd1ff, #00ffa3, #4fd1ff, #6366f1);
            background-size: 300% 300%; animation: gradientBorder 3s ease infinite;
            box-shadow: 0 0 40px rgba(79, 209, 255, 0.5); transform: scale(0.9);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards, gradientBorder 3s ease infinite;
        }

        @keyframes popIn { to { transform: scale(1); } }
        @keyframes gradientBorder { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .start-modal { background: linear-gradient(to bottom, #0a0f1a, #000); border-radius: 12px; padding: 25px; text-align: center; width: 100%; height: 100%; }
        .modal-title { color: #4fd1ff; margin-bottom: 15px; font-family: 'Orbitron', sans-serif; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 2px 5px rgba(79,209,255,0.6); }
        
        .info-list { font-size: 13px; color: #ddd; margin-bottom: 25px; text-align: left; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; border: 1px solid #1f2937; line-height: 1.6; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); font-family: 'Inter', sans-serif; }
        .info-list b { color: #4fd1ff; }
        .info-list .highlight { color: #00ffa3; font-weight: bold; }
        .info-list .highlight-red { color: #ff4b4b; font-weight: bold; }

        .btn-start-game { width: 100%; padding: 15px; border-radius: 8px; border: none; background: linear-gradient(to bottom, #00ffa3, #00b894); font-weight: 900; color: #000; font-size: 16px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,255,163,0.3); text-transform: uppercase; font-family: 'Orbitron'; transition: 0.2s; }
        .btn-start-game:active { transform: translateY(3px); box-shadow: none; }
    </style>
</head>
<body>

<div id="start-overlay" class="start-overlay">
    <div class="animated-border-box">
        <div class="start-modal">
            <h2 class="modal-title">Nasıl Oynanır?</h2>
            <div class="info-list">
                <b>1. Bahis Yap:</b> Süre dolmadan bahis miktarını gir ve <span class="highlight">MC KULLAN</span> butonuna bas.<br>
                <b>2. Yükselişi İzle:</b> Çarpan uçuşa geçtiğinde (1.00x'ten itibaren) saniyeler içinde katlanır.<br>
                <b>3. Zamanında Çek:</b> Sistem aniden patlamadan (<span class="highlight-red">CRASH</span>) olmadan önce <span class="highlight">ÇEK</span> butonuna basarak kazancını al!<br>
                <div style="margin-top: 15px; text-align: center; color: #94a3b8; font-size: 11px;">
                    <i>Oyun deneyimi ve ses efektleri için cihazınızın sesini açınız.</i>
                </div>
            </div>
            <button id="systemStartBtn" class="btn-start-game">BAŞLA</button>
        </div>
    </div>
</div>

<header class="top-bar">
    <div class="brand">CRASH</div>
    <nav class="right-menu">
        <div class="user-pill-mini">
            <div class="balance-info"><b id="balance">Yükleniyor...</b><div class="mc-chip">MC</div></div>
        </div>
        <a href="/" class="back-btn">ÇIKIŞ</a>
    </nav>
</header>

<main>
    <div class="history" id="history"></div>
    
    <div class="game-container">
        <div class="speedometer"><div class="speed-fill" id="speedFill"></div></div>
        
        <canvas id="gameCanvas"></canvas>
        
        <div class="multiplier-display">
            <div class="status-text" id="statusText">SUNUCU BEKLENİYOR</div>
            <div class="x-value" id="multiplier">1.00x</div>
        </div>
    </div>

    <div class="bottom-panel">
        <div class="bet-card">
            <input type="number" id="betInput1" value="100" min="10">
            <div class="auto-row"><span>OTO BAHİS</span><label class="switch"><input type="checkbox" id="autoSwitch1"><span class="slider"></span></label></div>
            <button id="btn1" class="main-btn btn-bet">MC KULLAN</button>
        </div>
        <div class="bet-card">
            <input type="number" id="betInput2" value="200" min="10">
            <div class="auto-row"><span>OTO BAHİS</span><label class="switch"><input type="checkbox" id="autoSwitch2"><span class="slider"></span></label></div>
            <button id="btn2" class="main-btn btn-bet">MC KULLAN</button>
        </div>
    </div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, getIdToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
        authDomain:"emirhan-site.firebaseapp.com",
        projectId:"emirhan-site",
        storageBucket:"emirhan-site.firebasestorage.app",
        messagingSenderId:"668871888390",
        appId:"1:668871888390:web:76568bda84cb1641f7bd87"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const API_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" ? "http://localhost:3000" : "https://emirhan-siye.onrender.com";

    // DOM CACHING (Performans ve Sıfır Gecikme İçin)
    const elBalance = document.getElementById("balance");
    const elMultiplier = document.getElementById('multiplier');
    const elStatusText = document.getElementById('statusText');
    const elBtn1 = document.getElementById('btn1');
    const elBtn2 = document.getElementById('btn2');
    const elInput1 = document.getElementById('betInput1');
    const elInput2 = document.getElementById('betInput2');
    const elSpeed = document.getElementById('speedFill');

    // GERÇEKÇİ SES MOTORU YÜKLEMESİ
    let audioCtx = null;
    const sounds = {};
    const urls = {
        bet: 'https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3', 
        tick: 'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3', 
        fly: 'https://assets.mixkit.co/active_storage/sfx/1444/1444-preview.mp3', 
        crash: 'https://assets.mixkit.co/active_storage/sfx/170/170-preview.mp3', 
        win: 'https://assets.mixkit.co/active_storage/sfx/2004/2004-preview.mp3'  
    };

    function initAudio() {
        if (audioCtx) return;
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            for (const [name, url] of Object.entries(urls)) {
                fetch(url).then(res => res.arrayBuffer()).then(buf => audioCtx.decodeAudioData(buf)).then(decoded => sounds[name] = decoded).catch(e=>{});
            }
        } catch (e) {}
    }

    // Ses Çakışmasını Engellemek İçin currentTime kontrolü
    let lastSoundTime = { bet: 0, tick: 0, fly: 0, crash: 0, win: 0 };
    function playSfx(name) {
        if(!audioCtx || !sounds[name]) return;
        if(audioCtx.state === 'suspended') audioCtx.resume();
        
        const now = Date.now();
        if (now - lastSoundTime[name] < 200) return; 
        lastSoundTime[name] = now;

        const source = audioCtx.createBufferSource();
        source.buffer = sounds[name];
        source.connect(audioCtx.destination);
        source.start(0);
    }

    // OYUN DURUMU DEĞİŞKENLERİ
    let gameStarted = false;
    let userBalance = 0;
    let serverOffset = 0;
    let sPhase = "WAITING";
    let lastPhase = "";
    let sStartTime = 0;
    let sCrashPoint = 1.00;
    let myBets = {}; 
    let currentMultiplierDisplay = 1.00;
    let lineProgress = 0;

    let auto1 = false; let auto2 = false;
    let processing1 = false; let processing2 = false;
    let autoBetFiredForRound = false;

    // SUNUCU İSTEKLERİ
    async function fetchAPI(endpoint, method = 'GET', body = null) {
        if (!auth.currentUser) return null;
        const token = await getIdToken(auth.currentUser);
        const options = { method, headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } };
        if (body) options.body = JSON.stringify(body);
        const res = await fetch(`${API_URL}${endpoint}`, options);
        const data = await res.json();
        if (data.redirect) window.location.href = '/';
        if (!data.ok) throw new Error(data.error || "Sunucu hatası");
        return data;
    }

    async function fetchBalance() {
        try {
            const data = await fetchAPI('/api/me');
            if(data) {
                userBalance = data.balance;
                elBalance.innerText = userBalance.toLocaleString('tr-TR');
            }
        } catch(e) {}
    }

    async function syncState() {
        if (!gameStarted) return;
        try {
            const data = await fetchAPI('/api/crash/state');
            if(!data) return;
            const st = data.state;
            serverOffset = Date.now() - st.serverNow;
            
            if(sPhase !== 'COUNTDOWN' && st.phase === 'COUNTDOWN') autoBetFiredForRound = false;
            
            sPhase = st.phase;
            sStartTime = st.startTime;
            myBets = st.myBets || {};
            sCrashPoint = st.crashPoint || 1.00;

            renderHistory(st.history);
            
            // Faz değişimi
            if (sPhase !== lastPhase) {
                updateControls();
                if(sPhase === 'FLYING') playSfx('fly'); 
                lastPhase = sPhase;
            }

            // OTO BAHİS KONTROLÜ
            if (sPhase === 'COUNTDOWN' && !autoBetFiredForRound) {
                if(auto1 && !myBets.box1) handleAction(1, true);
                if(auto2 && !myBets.box2) handleAction(2, true);
                autoBetFiredForRound = true;
            }
        } catch (e) {}
    }

    function renderHistory(histArray) {
        const hDiv = document.getElementById('history');
        hDiv.innerHTML = "";
        histArray.forEach(val => {
            const span = document.createElement('span');
            span.innerText = val.toFixed(2) + "x";
            span.style.color = val < 2 ? "#ff4757" : "#00ffa3";
            hDiv.appendChild(span);
        });
    }

    // YENİ PROFESYONEL ARKA PLAN VE ÇİZİM MOTORU
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { alpha: false }); 
    let width, height;
    let bgGlow = 0;
    let particles = [];
    let stars = [];
    let lastPointX = 0, lastPointY = 0;
    
    function initStars() {
        stars = [];
        for(let i=0; i<80; i++) {
            stars.push({ x: Math.random()*width, y: Math.random()*height, s: Math.random()*1.5 + 0.5, speed: Math.random()*2 + 1 });
        }
    }

    function resize() { width=canvas.width=canvas.offsetWidth; height=canvas.height=canvas.offsetHeight; initStars(); }
    window.addEventListener('resize', resize); resize();

    function createExplosion(x, y) {
        for(let i=0; i<40; i++) {
            particles.push({
                x: x, y: y,
                vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20,
                life: 1, size: Math.random()*5 + 2, 
                color: Math.random() > 0.5 ? '#ff2a4d' : '#ffaa00'
            });
        }
    }

    let lastSec = -1;
    function draw() {
        // Profesyonel Radial Arka Plan
        bgGlow = sPhase === 'FLYING' ? Math.min(0.8, bgGlow + 0.01) : Math.max(0, bgGlow - 0.05);
        const bgGrad = ctx.createRadialGradient(width/2, height, 10, width/2, height, height);
        bgGrad.addColorStop(0, `rgba(79, 209, 255, ${0.05 + (bgGlow * 0.15)})`);
        bgGrad.addColorStop(1, "#02050e");
        ctx.fillStyle = bgGrad; 
        ctx.fillRect(0,0,width,height);

        // Uçuş Efekti (Warp Speed / Yıldızlar)
        ctx.fillStyle = "rgba(255, 255, 255, 0.6)";
        stars.forEach(s => {
            let currentSpeed = sPhase === "FLYING" ? s.speed * (1 + currentMultiplierDisplay * 0.2) : s.speed * 0.2;
            if(sPhase === "CRASHED") currentSpeed = 0;
            s.y += currentSpeed;
            if(s.y > height) { s.y = 0; s.x = Math.random() * width; }
            
            ctx.beginPath();
            if (sPhase === "FLYING" && currentMultiplierDisplay > 1.1) {
                ctx.rect(s.x, s.y, s.s, s.s + currentSpeed * 2); // Işık hüzmesi
            } else {
                ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); // Nokta
            }
            ctx.fill();
        });

        const now = Date.now() - serverOffset;

        if (sPhase === 'COUNTDOWN') {
            const left = Math.max(0, (sStartTime - now) / 1000).toFixed(1);
            const currSec = Math.floor(left);
            if(currSec !== lastSec && currSec <= 5 && currSec > 0) { playSfx('tick'); lastSec = currSec; }
            
            elMultiplier.innerText = left + "s";
            if (elMultiplier.classList.contains('crashed-text')) elMultiplier.classList.remove('crashed-text');
            if (elStatusText.innerText !== "BAHİSLER AÇIK") elStatusText.innerText = "BAHİSLER AÇIK";
            
            lineProgress = 0; currentMultiplierDisplay = 1.00; particles = [];
            lastPointX = 0; lastPointY = height;
            elSpeed.style.height = "0%"; // İbre Sıfırla
        } 
        else if (sPhase === 'FLYING') {
            const elapsed = Math.max(0, now - sStartTime) / 1000;
            currentMultiplierDisplay = 1 + Math.pow(elapsed * 0.18, 1.35);
            elMultiplier.innerText = currentMultiplierDisplay.toFixed(2) + "x";
            if (elMultiplier.classList.contains('crashed-text')) elMultiplier.classList.remove('crashed-text');
            if (elStatusText.innerText !== "YÜKSELİYOR") elStatusText.innerText = "YÜKSELİYOR";
            
            // İbre Güncellemesi (Maksimum 10x'te dolar)
            let speedPercent = (currentMultiplierDisplay / 10) * 100;
            if(speedPercent > 100) speedPercent = 100;
            elSpeed.style.height = `${speedPercent}%`;

            // Profesyonel Çizgi Animasyonu
            if(lineProgress < 1) lineProgress += 0.005;
            
            const cpY = height * (1 - (currentMultiplierDisplay / 15)); 
            const endX = width * (0.85 + (lineProgress * 0.15)); 
            const endY = height * (0.8 - (lineProgress * 0.6));
            
            lastPointX = endX; lastPointY = endY;

            // Degrade Dolgu (Neon Gölge Etkisi)
            const grad = ctx.createLinearGradient(0, height, 0, endY);
            grad.addColorStop(0, "rgba(79, 209, 255, 0)");
            grad.addColorStop(1, "rgba(79, 209, 255, 0.4)");
            
            ctx.beginPath();
            ctx.moveTo(0, height);
            ctx.quadraticCurveTo(width * 0.5, Math.max(0, cpY), endX, Math.max(0, endY));
            ctx.lineTo(endX, height);
            ctx.fillStyle = grad;
            ctx.fill();

            // Parlayan Çizgi
            ctx.save(); 
            ctx.shadowBlur = 20; ctx.shadowColor = "#4fd1ff"; 
            ctx.strokeStyle = "#4fd1ff"; ctx.lineWidth = 5; ctx.lineCap = "round";
            ctx.beginPath(); ctx.moveTo(0, height); ctx.quadraticCurveTo(width * 0.5, Math.max(0, cpY), endX, Math.max(0, endY)); 
            ctx.stroke(); 
            
            // Roket Noktası
            ctx.beginPath(); ctx.arc(endX, Math.max(0, endY), 6, 0, Math.PI*2);
            ctx.fillStyle = "#fff"; ctx.fill();
            ctx.restore();
            
            // DOM GÜNCELLEMESİ (Performanslı)
            if (myBets.box1 && !myBets.box1.cashed && !processing1) { elBtn1.innerText = `ÇEK MC ${Math.floor(myBets.box1.bet * currentMultiplierDisplay)}`; }
            if (myBets.box2 && !myBets.box2.cashed && !processing2) { elBtn2.innerText = `ÇEK MC ${Math.floor(myBets.box2.bet * currentMultiplierDisplay)}`; }
        } 
        else if (sPhase === 'CRASHED') {
            if(lastSec !== -2) { 
                playSfx('crash'); 
                createExplosion(lastPointX, lastPointY); // Patlama Efekti
                lastSec = -2; 
            }
            elMultiplier.innerText = sCrashPoint.toFixed(2) + "x";
            if (!elMultiplier.classList.contains('crashed-text')) elMultiplier.classList.add('crashed-text');
            if (elStatusText.innerText !== "PATLADI") elStatusText.innerText = "PATLADI";

            // Partikül Çizimi (Kıvılcımlar)
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life -= 0.03;
                if(p.life <= 0) { particles.splice(i, 1); return; }
                ctx.globalAlpha = p.life;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fillStyle = p.color; ctx.fill();
                ctx.globalAlpha = 1;
            });
        }

        requestAnimationFrame(draw);
    }
    draw();

    // SADECE DURUM DEĞİŞTİĞİNDE ÇALIŞIR (Sıfır Gecikme Anti-Lag)
    function updateControls() {
        const u = (box) => {
            const btn = box === 1 ? elBtn1 : elBtn2;
            const isProc = box === 1 ? processing1 : processing2;
            const betData = myBets[`box${box}`];

            if (isProc) { btn.disabled = true; btn.innerText = "İŞLENİYOR..."; btn.className = "main-btn"; return; }

            if (sPhase === 'COUNTDOWN') {
                if (betData) { btn.disabled = true; btn.innerText = "ONAYLANDI"; btn.className = "main-btn btn-cancel"; } 
                else { btn.disabled = false; btn.innerText = "MC KULLAN"; btn.className = "main-btn btn-bet"; }
            } 
            else if (sPhase === 'FLYING') {
                if (betData && !betData.cashed) {
                    btn.disabled = false; btn.className = "main-btn btn-cashout"; // Çarpan draw'da güncellenir
                } else if (betData && betData.cashed) {
                    btn.disabled = true; btn.innerText = `KAZANDIN: ${betData.win}`; btn.className = "main-btn btn-cancel"; btn.style.background = "#00b894";
                } else {
                    btn.disabled = true; btn.innerText = "UÇUYOR"; btn.className = "main-btn";
                }
            } 
            else if (sPhase === 'CRASHED') {
                if (betData && betData.cashed) {
                    btn.disabled = true; btn.innerText = `KAZANDIN: ${betData.win}`; btn.className = "main-btn btn-cancel"; btn.style.background = "#00b894";
                } else if (betData && !betData.cashed) {
                    btn.disabled = true; btn.innerText = "KAYBETTİN"; btn.className = "main-btn btn-loss";
                } else {
                    btn.disabled = true; btn.innerText = "BEKLEYİN"; btn.className = "main-btn";
                }
            }
        };
        u(1); u(2);
    }

    async function handleAction(box, isAuto = false) {
        if(box === 1 && processing1) return;
        if(box === 2 && processing2) return;

        if (sPhase === 'COUNTDOWN') {
            const amount = Math.floor((box === 1 ? elInput1 : elInput2).value) || 0;
            if (amount < 10) return;
            
            if(box===1) processing1 = true; else processing2 = true; updateControls(); // ANINDA TEPKİ
            
            try {
                const res = await fetchAPI('/api/crash/bet', 'POST', { box, amount });
                myBets = res.myBets;
                if(!isAuto) playSfx('bet'); // Bahis Sesi
                fetchBalance();
            } catch(e) { alert(e.message); }
            
            if(box===1) processing1 = false; else processing2 = false; updateControls();
        } 
        else if (sPhase === 'FLYING') {
            if(box===1) processing1 = true; else processing2 = true; updateControls(); // ANINDA TEPKİ
            
            try {
                const res = await fetchAPI('/api/crash/cashout', 'POST', { box });
                myBets = res.myBets;
                playSfx('win'); // Kazanma Sesi
                fetchBalance();
            } catch(e) {}
            
            if(box===1) processing1 = false; else processing2 = false; updateControls();
        }
    }

    document.getElementById('systemStartBtn').addEventListener('click', () => {
        initAudio(); 
        document.getElementById('start-overlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('start-overlay').style.display = 'none'; 
            gameStarted = true; fetchBalance(); syncState();
            setInterval(syncState, 500); 
        }, 500);
    });

    elBtn1.onclick = () => handleAction(1);
    elBtn2.onclick = () => handleAction(2);
    document.getElementById('autoSwitch1').onchange = (e) => auto1 = e.target.checked;
    document.getElementById('autoSwitch2').onchange = (e) => auto2 = e.target.checked;

    onAuthStateChanged(auth, user => { if(!user) window.location.href = '/'; });
</script>
</body>
</html>
