<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>PlayMatrix Mines | VIP Casino MayÄ±n TarlasÄ±</title>
    <meta name="description" content="PlayMatrix Mines ile elmaslarÄ± bul, Ã§arpanÄ± katla! %100 Provably Fair, gÃ¼venli ve donmasÄ±z casino mayÄ±n tarlasÄ± deneyimi. Hemen oyna!">
    <meta name="keywords" content="mines oyunu, casino, playmatrix, mayÄ±n tarlasÄ±, kripto oyun, gÃ¼venli bahis, Ã§arpan oyunu, online casino">
    <meta name="author" content="PlayMatrix Global">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="theme-color" content="#0b1118">
    
    <meta property="og:locale" content="tr_TR">
    <meta property="og:type" content="website">
    <meta property="og:title" content="PlayMatrix Mines | ElmaslarÄ± Bul ve Kazan">
    <meta property="og:description" content="KutularÄ± aÃ§, elmaslarÄ± topla, mayÄ±nlardan kaÃ§. GerÃ§ek casino standartlarÄ±nda eÅŸsiz Mines heyecanÄ±.">
    <meta property="og:site_name" content="PlayMatrix">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="PlayMatrix Mines Oyunu">
    <meta name="twitter:description" content="GÃ¼venli, adil ve anlÄ±k kazanÃ§ oyunu. ÅžansÄ±nÄ± hemen dene.">

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        /* SIFIR KAYMA, %100 RESPONSIVE VE ZOOM KORUMASI RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        html, body { 
            background: #0b1118; color: #ffffff; height: 100vh; width: 100vw; 
            overflow: hidden; overscroll-behavior: none; font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Ã‡Ä°FT TIK ZOOM ENGELÄ° (CSS) */
        }

        /* PROFESYONEL Ä°NTRO (AÃ‡ILIÅž EKRANI) */
        #studioIntro {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #070b10;
            z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }
        .intro-logo { transform: scale(1.1); animation: breathe 2s infinite alternate; text-align: center; }
        .intro-logo i { font-size: 65px; color: #00f0ff; margin-bottom: 15px; filter: drop-shadow(0 0 15px rgba(0,240,255,0.5)); }
        .intro-logo h1 { font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 32px; letter-spacing: 3px; color: #fff; text-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        .intro-logo h1 span { color: #00f0ff; }
        
        .loader-track { width: 220px; height: 4px; background: #1a2430; margin-top: 40px; border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); }
        .loader-fill { height: 100%; width: 0%; background: #00f0ff; transition: width 0.1s linear; box-shadow: 0 0 10px #00f0ff; }
        .btn-intro-start { display: none; margin-top: 30px; padding: 15px 40px; background: linear-gradient(to bottom, #00f0ff, #0055ff); color: #fff; border: none; border-radius: 12px; font-weight: 900; font-size: 15px; cursor: pointer; text-transform: uppercase; font-family: 'Orbitron'; box-shadow: 0 5px 20px rgba(0,240,255,0.4); transition: 0.2s; letter-spacing: 1px; }
        .btn-intro-start:active { transform: scale(0.95); box-shadow: none; }

        @keyframes breathe { 0% { transform: scale(1); filter: brightness(1); } 100% { transform: scale(1.05); filter: brightness(1.2); } }

        /* ÃœST BAR (TAÅžMA KORUMALI) */
        .top-bar { 
            position: fixed; top: 0; left: 0; width: 100%; height: 65px; background: rgba(18, 26, 36, 0.95);
            backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .tb-left { display: flex; align-items: center; gap: 15px; }
        .tb-logo { font-family: 'Orbitron', sans-serif; font-size: 16px; font-weight: 900; color: #fff; letter-spacing: 1px; }
        .tb-logo span { color: #00f0ff; }
        
        .tb-right { display: flex; align-items: center; gap: 10px; }
        
        .balance-box { display: flex; align-items: center; background: #0b1118; padding: 6px 12px; border-radius: 8px; border: 1px solid #1f2c3b; max-width: 140px; }
        .balance-box b { font-size: 14px; color: #00ffa3; font-family: 'Inter', monospace; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 85px; display: inline-block; vertical-align: middle; }
        .mc-icon { background: linear-gradient(135deg, #00f0ff, #0055ff); color: #fff; font-size: 9px; font-weight: 900; padding: 3px 6px; border-radius: 4px; margin-left: 8px; box-shadow: 0 0 10px rgba(0,240,255,0.4); }
        
        .action-icon-btn { 
            background: #1f2c3b; color: #94a3b8; border: none; width: 34px; height: 34px; 
            border-radius: 8px; font-size: 14px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }
        .action-icon-btn:active { transform: scale(0.9); background: #2a3a4d; color: #fff; }
        .action-icon-btn.red:active { background: #ef4444; color: #fff; }

        /* CRASH RENKLERÄ° Ä°LE X GEÃ‡MÄ°ÅžÄ° */
        .history-bar { 
            position: fixed; top: 65px; left: 0; width: 100%; height: 45px; background: rgba(14, 21, 29, 0.9);
            display: flex; align-items: center; padding: 0 10px; overflow-x: auto; gap: 8px;
            scrollbar-width: none; border-bottom: 1px solid rgba(255,255,255,0.03); z-index: 900; backdrop-filter: blur(5px);
        }
        .history-bar::-webkit-scrollbar { display: none; }
        .hist-pill { 
            padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 800; 
            font-family: 'Inter', sans-serif; background: #1a2430; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .hist-red { color: #ff3b30; background: rgba(255,59,48,0.1); border: 1px solid rgba(255,59,48,0.3); }
        .hist-green { color: #00ffa3; background: rgba(0,255,163,0.1); border: 1px solid rgba(0,255,163,0.3); }
        .hist-gold { color: #f59e0b; background: rgba(245,158,11,0.15); border: 1px solid rgba(245,158,11,0.4); text-shadow: 0 0 5px rgba(245,158,11,0.5); }

        /* OYUN ALANI VE PROFESYONEL GRID */
        .game-area { 
            position: absolute; top: 110px; bottom: 180px; left: 0; width: 100%;
            background: radial-gradient(circle at center, #121a24 0%, #0b1118 100%);
            z-index: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center; padding: 20px 15px;
        }

        .mines-info-header { 
            display: flex; justify-content: space-between; width: 100%; max-width: 450px; 
            margin-bottom: 15px; background: rgba(26, 36, 48, 0.6); padding: 10px 15px; 
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); font-family: 'Orbitron'; 
        }
        .mines-info-header div { font-size: 12px; color: #94a3b8; font-weight: 700; letter-spacing: 1px; }
        .mines-info-header span { font-size: 16px; font-weight: 900; margin-left: 5px; }

        #grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; 
            width: 100%; max-width: 450px; aspect-ratio: 1/1; 
        }
        
        .tile { 
            background: linear-gradient(145deg, #1a2430, #121a24); border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; font-size: 32px; 
            cursor: pointer; transition: transform 0.1s, background 0.3s, box-shadow 0.3s; 
            border: 2px solid #2a3a4d; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5), 0 5px 15px rgba(0,0,0,0.4); 
        }
        .tile.active-hover:active { transform: scale(0.9); border-color: #00f0ff; }
        .tile.open { 
            background: linear-gradient(145deg, #00b894, #00d2ad); border-color: #55efc4; 
            box-shadow: 0 0 20px rgba(0, 184, 148, 0.4); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            cursor: default; text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .tile.mine { 
            background: linear-gradient(145deg, #d63031, #ff7675); border-color: #ff7675; 
            box-shadow: 0 0 25px rgba(214, 48, 49, 0.6); animation: shake 0.4s; 
            cursor: default; text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .tile.dimmed-diamond { background: rgba(0, 184, 148, 0.15); border-color: rgba(0, 184, 148, 0.3); opacity: 0.7; cursor: default; filter: grayscale(0.6); }
        .tile.dimmed-mine { background: rgba(214, 48, 49, 0.15); border-color: rgba(214, 48, 49, 0.3); opacity: 0.8; cursor: default; filter: grayscale(0.4); }

        @keyframes popIn { 0% {transform: scale(0.5); opacity: 0;} 100% {transform: scale(1); opacity: 1;} }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

        .provably-fair-text { font-size: 10px; color: #64748b; margin-top: 15px; font-family: monospace; text-align: center; max-width: 400px; word-wrap: break-word; }

        /* ALT PANEL (BAHÄ°S KONTROLLERÄ° VE OTOMATÄ°K RASTGELE BAHÄ°S) */
        .bottom-controls { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 180px; background: #121a24;
            border-top: 2px solid #1f2c3b; padding: 15px; display: flex; justify-content: center; z-index: 1000;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.6);
        }
        .bet-box { 
            background: linear-gradient(145deg, #111827, #0a0f1a); width: 100%; max-width: 450px; border-radius: 16px; padding: 15px;
            display: flex; flex-direction: column; justify-content: space-between; border: 1px solid #1f2937;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3); gap: 10px;
        }
        
        .input-row { display: flex; gap: 10px; }
        .bet-input-wrap { flex: 2; position: relative; background: #030712; border-radius: 10px; border: 2px solid #1f2937; transition: border 0.3s;}
        .bet-input-wrap:focus-within { border-color: #00f0ff; box-shadow: 0 0 10px rgba(0,240,255,0.2); }
        .bet-input-wrap input { width: 100%; background: transparent; border: none; color: #00f0ff; padding: 12px; text-align: center; font-size: 16px; font-weight: 900; font-family: 'Orbitron'; outline: none; }
        
        select { flex: 1; background: #030712; border: 2px solid #1f2937; border-radius: 10px; color: #fff; padding: 12px; text-align: center; font-size: 14px; font-weight: 900; font-family: 'Orbitron'; outline: none; transition: 0.3s; appearance: none; }
        select:focus { border-color: #00f0ff; }
        select:disabled, .bet-input-wrap input:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-row { display: flex; gap: 10px; align-items: stretch; }
        
        .action-btn { 
            flex: 3; min-height: 50px; border: none; border-radius: 10px; font-weight: 900; 
            font-size: 16px; cursor: pointer; transition: transform 0.1s, filter 0.1s, box-shadow 0.1s; text-transform: uppercase; font-family: 'Inter'; letter-spacing: 1px;
            box-shadow: 0 5px 0 rgba(0,0,0,0.5);
        }
        .btn-bet { background: linear-gradient(180deg, #6366f1, #4338ca); color: #fff; box-shadow: 0 5px 0 #312e81; }
        .btn-bet:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 1px 0 #312e81; }
        
        .btn-cashout { background: linear-gradient(180deg, #f59e0b, #d97706); color: #000; box-shadow: 0 5px 0 #b45309; animation: pulseCashout 1.5s infinite; }
        .btn-cashout:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 1px 0 #b45309; animation: none;}

        .btn-loss { background: linear-gradient(180deg, #ef4444, #b91c1c); color: #fff; box-shadow: 0 5px 0 #7f1d1d; }
        
        .action-btn:disabled { opacity: 0.7; filter: grayscale(0.6); cursor: not-allowed; transform: translateY(4px) !important; box-shadow: 0 1px 0 rgba(0,0,0,0.5) !important; animation: none;}

        /* RASTGELE BUTONU VE OTOMATÄ°K SWITCH */
        .random-btn { 
            flex: 1; background: #1a2430; border: 2px solid #2a3a4d; border-radius: 10px; color: #00ffa3; font-size: 20px; 
            cursor: pointer; box-shadow: 0 4px 0 #121a24; transition: 0.1s; display: flex; align-items: center; justify-content: center;
        }
        .random-btn:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 0 0 transparent; }
        .random-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .auto-switch-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; flex: 1; background: #1a2430; border-radius: 10px; border: 1px solid #2a3a4d; }
        .auto-switch-wrap span { font-size: 9px; font-weight: 800; color: #94a3b8; font-family: 'Inter'; letter-spacing: 0.5px; }
        .switch { position: relative; width: 32px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        input:checked + .slider { background-color: #00f0ff; box-shadow: 0 0 10px rgba(0,240,255,0.5); }
        input:checked + .slider:before { transform: translateX(14px); }

        @keyframes pulseCashout { 0% { filter: brightness(1); } 50% { filter: brightness(1.3); } 100% { filter: brightness(1); } }

        /* Ã–ZEL ANÄ°MASYONLU MODAL (POPUP) SÄ°STEMÄ° %100 TEMA UYUMLU */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 100000; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.show { opacity: 1; display: flex; }
        
        .modal-card { 
            background: linear-gradient(145deg, #111827, #0a0f1a); border: 1px solid #1f2937; width: 90%; max-width: 360px; 
            border-radius: 20px; padding: 30px 25px; transform: scale(0.8) translateY(30px); opacity: 0; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 25px 50px rgba(0,0,0,0.9); text-align: center;
        }
        .modal-overlay.show .modal-card { transform: scale(1) translateY(0); opacity: 1; }
        
        .modal-icon { font-size: 50px; margin-bottom: 15px; filter: drop-shadow(0 0 15px rgba(0,0,0,0.5)); }
        .modal-card h3 { color: #fff; font-family: 'Inter'; font-size: 20px; font-weight: 900; margin-bottom: 10px; letter-spacing: 0.5px; }
        .modal-card p { font-size: 14px; color: #94a3b8; line-height: 1.6; margin-bottom: 25px; font-weight: 500; white-space: pre-line; }
        .modal-card p b { color: #00f0ff; }
        .modal-close { background: linear-gradient(135deg, #00f0ff, #0055ff); color: #fff; border: none; width: 100%; padding: 14px; border-radius: 12px; font-weight: 900; font-size: 15px; letter-spacing: 1px; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,240,255,0.3); text-transform: uppercase;}
        .modal-close:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,240,255,0.5); }
        .modal-close:active { transform: translateY(2px); box-shadow: none; }

        @media (max-width: 400px) { 
            .game-area { bottom: 170px; padding: 10px; }
            .bottom-controls { height: 170px; padding: 10px; }
            .bet-box { padding: 10px; gap: 8px; }
            .bet-input-wrap input, select { padding: 10px; font-size: 14px; }
            .action-btn { min-height: 45px; font-size: 14px; }
            .tile { font-size: 26px; border-radius: 8px; }
            #grid { gap: 6px; }
        }
    </style>
</head>
<body>

<div id="studioIntro">
    <div class="intro-logo">
        <i class="fa-solid fa-gem"></i>
        <h1>PLAYMATRÄ°X<br><span>MINES</span></h1>
    </div>
    <div class="loader-track" id="loaderTrack"><div class="loader-fill" id="loaderFill"></div></div>
    <button id="btnEnterGame" class="btn-intro-start">SÄ°STEME BAÄžLAN</button>
</div>

<div id="matrixModal" class="modal-overlay">
    <div class="modal-card">
        <div id="matrixModalIcon" class="modal-icon"></div>
        <h3 id="matrixModalTitle">Bilgi</h3>
        <p id="matrixModalDesc">Mesaj iÃ§eriÄŸi</p>
        <button class="modal-close" onclick="closeMatrixModal()">TAMAM</button>
    </div>
</div>

<header class="top-bar">
    <div class="tb-left">
        <div class="tb-logo">PM <span>MINES</span></div>
    </div>
    <div class="tb-right">
        <div class="balance-box">
            <b id="uiBalance">YÃ¼kleniyor</b><div class="mc-icon">MC</div>
        </div>
        <button class="action-icon-btn" onclick="showHowToPlay()"><i class="fa-solid fa-circle-info"></i></button>
        <a href="/" class="action-icon-btn red"><i class="fa-solid fa-right-from-bracket"></i></a>
    </div>
</header>

<div class="history-bar" id="uiHistory"></div>

<main class="game-area">
    <div class="mines-info-header">
        <div>Ã‡ARPAN: <span id="uiMultiplier" style="color:#00ffa3;">1.00x</span></div>
        <div>MAYIN: <span id="uiMineCount" style="color:#ff3b30;">3</span></div>
    </div>
    
    <div id="grid"></div>
    <div class="provably-fair-text" id="pfHash">Adillik Åžifresi (Hash) Bekleniyor...</div>
</main>

<div class="bottom-controls">
    <div class="bet-box">
        <div class="input-row">
            <div class="bet-input-wrap">
                <input type="number" id="inpBet" value="100" min="10" step="10">
            </div>
            <select id="inpMines"></select>
        </div>
        <div class="btn-row">
            <div class="auto-switch-wrap">
                <span>OTO OYNA</span>
                <label class="switch"><input type="checkbox" id="autoSwitch"><span class="slider"></span></label>
            </div>
            <button id="btnAction" class="action-btn btn-bet">MC KULLAN</button>
            <button id="btnRandom" class="random-btn" title="Rastgele SeÃ§" disabled><i class="fa-solid fa-dice"></i></button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, getIdToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
        authDomain:"emirhan-site.firebaseapp.com",
        projectId:"emirhan-site",
        storageBucket:"emirhan-site.firebasestorage.app",
        messagingSenderId:"668871888390",
        appId:"1:668871888390:web:76568bda84cb1641f7bd87"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const API_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" ? "http://localhost:3000" : "https://emirhan-siye.onrender.com";

    // --- ZOOM (Ã‡Ä°FT TIKLAMA) ENGELLEYÄ°CÄ° ---
    document.addEventListener('dblclick', function(event) { event.preventDefault(); }, { passive: false });
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
        let now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) { event.preventDefault(); }
        lastTouchEnd = now;
    }, { passive: false });

    // DOM ELEMENTS
    const elBal = document.getElementById("uiBalance");
    const elMult = document.getElementById("uiMultiplier");
    const elMineCount = document.getElementById("uiMineCount");
    const elHist = document.getElementById("uiHistory");
    const elGrid = document.getElementById("grid");
    const elHash = document.getElementById("pfHash");
    const btnAction = document.getElementById("btnAction");
    const btnRandom = document.getElementById("btnRandom");
    const inpBet = document.getElementById("inpBet");
    const inpMines = document.getElementById("inpMines");
    const autoSwitch = document.getElementById("autoSwitch");

    // MAYIN SEÃ‡ENEKLERÄ° (1-24)
    for(let i=1; i<=24; i++){ let opt = document.createElement("option"); opt.value = i; opt.text = i + " MayÄ±n"; inpMines.appendChild(opt); }
    inpMines.value = 3; inpMines.addEventListener("change", () => elMineCount.innerText = inpMines.value);

    // PROFESYONEL MODAL YÃ–NETÄ°CÄ°SÄ°
    window.showMatrixModal = (title, message, type = 'info') => {
        const icon = document.getElementById("matrixModalIcon");
        document.getElementById("matrixModalTitle").innerText = title;
        document.getElementById("matrixModalDesc").innerHTML = message;
        
        if(type === 'error') { icon.innerHTML = '<i class="fa-solid fa-triangle-exclamation" style="color:#ff3b30"></i>'; document.getElementById("matrixModalTitle").style.color = '#ff3b30'; } 
        else if(type === 'success') { icon.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#00ffa3"></i>'; document.getElementById("matrixModalTitle").style.color = '#00ffa3'; } 
        else { icon.innerHTML = '<i class="fa-solid fa-gem" style="color:#00f0ff"></i>'; document.getElementById("matrixModalTitle").style.color = '#00f0ff'; }
        
        const modal = document.getElementById('matrixModal');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);
    };

    window.closeMatrixModal = () => {
        const modal = document.getElementById('matrixModal');
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
    };

    window.showHowToPlay = () => {
        showMatrixModal(
            "Mines NasÄ±l OynanÄ±r?", 
            "1. <b>MC KULLAN</b> butonuna basarak oyunu baÅŸlatÄ±n.\n2. Kutulara tÄ±klayarak (veya Zar butonuna basarak) elmaslarÄ± bulun.\n3. Her elmas Ã§arpanÄ±nÄ±zÄ± artÄ±rÄ±r.\n4. MayÄ±na basmadan <b>Ã‡EK</b> butonuna basarak kazancÄ±nÄ±zÄ± alÄ±n.", 
            "info"
        );
    };

    // --- PROFESYONEL SES MOTORU (iOS Ä°Ã‡Ä°N Ã–ZEL KÄ°LÄ°T AÃ‡ICI SÄ°STEM) ---
    let audioCtx = null;
    let audioUnlocked = false; 
    const sounds = {};
    const sfxUrls = {
        bet: 'https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3',     
        open: 'https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3',   
        explode: 'https://assets.mixkit.co/active_storage/sfx/170/170-preview.mp3', 
        win: 'https://assets.mixkit.co/active_storage/sfx/2004/2004-preview.mp3'    
    };

    function initAndUnlockAudio() {
        if (audioUnlocked) return;
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            const buffer = audioCtx.createBuffer(1, 1, 22050);
            const source = audioCtx.createBufferSource();
            source.buffer = buffer; source.connect(audioCtx.destination); source.start(0);
            if (audioCtx.state === 'suspended') audioCtx.resume();
            audioUnlocked = true;
        } catch (e) { console.warn("Ses motoru baÅŸlatÄ±lamadÄ±:", e); }
    }

    async function loadSoundFiles() {
        if (!audioCtx) return;
        for (let [key, url] of Object.entries(sfxUrls)) {
            try {
                const res = await fetch(url);
                const buf = await res.arrayBuffer();
                sounds[key] = await audioCtx.decodeAudioData(buf);
            } catch(e) {}
        }
    }

    let lastSoundTime = { bet: 0, open: 0, explode: 0, win: 0 };
    function playSfx(name) {
        if(!audioCtx || !sounds[name] || !audioUnlocked) return;
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const now = Date.now();
        if (now - lastSoundTime[name] < 50) return; // Spam korumasÄ±
        lastSoundTime[name] = now;
        
        try {
            const src = audioCtx.createBufferSource();
            src.buffer = sounds[name];
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = name === 'open' ? 0.5 : 0.8; 
            src.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            src.start(0);
        } catch (e) {}
    }

    const unlockOnTouch = () => { initAndUnlockAudio(); document.removeEventListener('touchstart', unlockOnTouch); };
    document.addEventListener('touchstart', unlockOnTouch, { once: true, passive: true });

    // INTRO LOGIC
    let loadProg = 0;
    const loadInt = setInterval(() => {
        loadProg += Math.random() * 20;
        if(loadProg >= 100) {
            loadProg = 100; clearInterval(loadInt);
            document.getElementById('loaderTrack').style.display = 'none';
            document.getElementById('btnEnterGame').style.display = 'block';
        }
        document.getElementById('loaderFill').style.width = loadProg + '%';
    }, 100);

    document.getElementById('btnEnterGame').addEventListener('click', () => {
        initAndUnlockAudio(); loadSoundFiles();     
        document.getElementById('studioIntro').style.opacity = '0';
        setTimeout(() => { document.getElementById('studioIntro').style.display = 'none'; initGame(); }, 600);
    });

    // STATE VARIABLES
    let isProcessing = false;
    let gameState = null;
    
    // LOKAL GEÃ‡MÄ°Åž YÃ–NETÄ°MÄ°
    let historyData = JSON.parse(localStorage.getItem('pm_mines_history') || '[]');
    function addHistory(mult) {
        historyData.unshift(mult);
        if(historyData.length > 15) historyData.pop();
        localStorage.setItem('pm_mines_history', JSON.stringify(historyData));
        renderHistory();
    }
    function renderHistory() {
        elHist.innerHTML = "";
        historyData.forEach(v => {
            let c = v < 2 ? 'hist-red' : (v < 5 ? 'hist-green' : 'hist-gold');
            elHist.innerHTML += `<div class="hist-pill ${c}">${v.toFixed(2)}x</div>`;
        });
    }

    async function api(endpoint, method='GET', body=null) {
        if(!auth.currentUser) return null;
        const token = await getIdToken(auth.currentUser);
        const opt = { method, headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'} };
        if(body) opt.body = JSON.stringify(body);
        const res = await fetch(API_URL+endpoint, opt);
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || "Sunucuyla baÄŸlantÄ± kurulamadÄ±.");
        return data;
    }

    function initGame() {
        api('/api/me').then(d => { if(d) elBal.innerText = Math.floor(d.balance).toLocaleString('tr-TR'); }).catch(()=>{});
        renderHistory();
        renderGrid();
        api('/api/mines/state').then(d => { if(d && d.state) { gameState = d.state; updateUI(); }});
    }

    function renderGrid() {
        elGrid.innerHTML = "";
        for(let i=0; i<25; i++){
            let tile = document.createElement("div");
            tile.className = "tile active-hover";
            tile.id = `tile-${i}`;
            tile.addEventListener("click", () => handleTileClick(i));
            elGrid.appendChild(tile);
        }
    }

    function updateUI() {
        if (!gameState || gameState.status !== 'playing') {
            btnAction.innerText = "MC KULLAN";
            btnAction.className = "action-btn btn-bet";
            btnAction.disabled = isProcessing;
            inpBet.disabled = isProcessing;
            inpMines.disabled = isProcessing;
            btnRandom.disabled = true;
            elMult.innerText = "1.00x";
            elMult.style.color = "#00ffa3";
            elMineCount.innerText = inpMines.value;
            if(!gameState) elHash.innerText = "Adillik Åžifresi (Hash) Bekleniyor...";
        } else {
            inpBet.disabled = true;
            inpMines.disabled = true;
            btnRandom.disabled = isProcessing;
            elMult.innerText = gameState.multiplier.toFixed(2) + "x";
            elMult.style.color = "#00f0ff";
            elMineCount.innerText = gameState.minesCount;
            elHash.innerText = `Hash: ${gameState.hash}`;
            
            if (gameState.opened.length > 0) {
                const winAmount = Math.floor(gameState.bet * gameState.multiplier);
                btnAction.innerText = `Ã‡EK MC ${winAmount.toLocaleString('tr-TR')}`;
                btnAction.className = "action-btn btn-cashout";
                btnAction.disabled = isProcessing;
            } else {
                btnAction.innerText = "TAÅž SEÃ‡Ä°N";
                btnAction.className = "action-btn btn-disabled";
                btnAction.disabled = true;
            }

            gameState.opened.forEach(idx => {
                const t = document.getElementById(`tile-${idx}`);
                if(t && !t.classList.contains('open')) { t.className = "tile open"; t.innerHTML = "ðŸ’Ž"; }
            });
        }
    }

    function revealBoard(boardArray, hitIndex) {
        for(let i=0; i<25; i++) {
            const t = document.getElementById(`tile-${i}`);
            t.className = "tile";
            if(i === hitIndex) {
                t.classList.add("mine"); t.innerHTML = "ðŸ’£";
            } else if(boardArray[i] === 1) {
                t.classList.add("dimmed-mine"); t.innerHTML = "ðŸ’£";
            } else if(!t.innerHTML.includes("ðŸ’Ž")) {
                t.classList.add("dimmed-diamond"); t.innerHTML = "ðŸ’Ž";
            }
        }
    }

    async function handleAction(actionType, tileIndex = null, fromAuto = false) {
        if(isProcessing) return;
        isProcessing = true; updateUI();

        try {
            if (actionType === 'start') {
                const betAmount = parseInt(inpBet.value);
                const minesCount = parseInt(inpMines.value);
                if(isNaN(betAmount) || betAmount < 10) throw new Error("Min bahis 10 MC");
                
                const res = await api('/api/mines/start', 'POST', { bet: betAmount, minesCount });
                gameState = res.state;
                playSfx("bet");
                renderGrid();
            } 
            else if (actionType === 'click') {
                const targetTile = document.getElementById(`tile-${tileIndex}`);
                if(targetTile) targetTile.style.transform = "scale(0.9)"; // Optimistic
                
                const res = await api('/api/mines/action', 'POST', { action: 'click', index: tileIndex });
                gameState = res.state;
                
                if(gameState.status === 'busted') {
                    playSfx("explode");
                    revealBoard(res.board, tileIndex);
                    elHash.innerText = `Seed Ã‡Ã¶zÃ¼ldÃ¼: ${res.serverSeed}`;
                    btnAction.innerText = "KAYBETTÄ°N!";
                    btnAction.className = "action-btn btn-loss";
                    addHistory(0.00);
                    setTimeout(() => { gameState = null; renderGrid(); updateUI(); runAutoLogic(); }, 2000);
                } else if (gameState.status === 'cashed_out') {
                    playSfx("win");
                    revealBoard(res.board, -1);
                    elHash.innerText = `Seed Ã‡Ã¶zÃ¼ldÃ¼: ${res.serverSeed}`;
                    showMatrixModal("KAZANDINIZ!", `${res.winAmount.toLocaleString('tr-TR')} MC Bakiyenize eklendi.`, "success");
                    addHistory(gameState.multiplier);
                    setTimeout(() => { gameState = null; renderGrid(); updateUI(); runAutoLogic(); }, 2500);
                } else {
                    playSfx("open");
                }
            } 
            else if (actionType === 'cashout') {
                const res = await api('/api/mines/action', 'POST', { action: 'cashout' });
                gameState = res.state;
                playSfx("win");
                revealBoard(res.board, -1);
                elHash.innerText = `Seed Ã‡Ã¶zÃ¼ldÃ¼: ${res.serverSeed}`;
                btnAction.innerText = `KAZANDIN: ${res.winAmount}`;
                btnAction.className = "action-btn btn-success";
                addHistory(gameState.multiplier);
                setTimeout(() => { gameState = null; renderGrid(); updateUI(); runAutoLogic(); }, 2000);
            }
            api('/api/me').then(d=>{if(d) elBal.innerText=Math.floor(d.balance).toLocaleString('tr-TR');});
        } catch(e) {
            if(!fromAuto) showMatrixModal("Hata", e.message, "error");
            if(fromAuto) autoSwitch.checked = false; // Hatada otoyu kapat
        }
        
        isProcessing = false; updateUI();
        
        // Oto bahis devredeyse ve oyun oynanÄ±yorsa rastgele tÄ±kla ve Ã§ek.
        if (actionType === 'start' && autoSwitch.checked) {
            setTimeout(() => runAutoLogic(), 800);
        }
    }

    // OTOMATÄ°K BAHÄ°S VE RASTGELE SEÃ‡Ä°M MANTIÄžI
    function pickRandomTile() {
        if(!gameState || gameState.status !== 'playing' || isProcessing) return;
        let available = [];
        for(let i=0; i<25; i++) { if(!gameState.opened.includes(i)) available.push(i); }
        if(available.length > 0) {
            let rnd = available[Math.floor(Math.random() * available.length)];
            handleAction('click', rnd, autoSwitch.checked);
        }
    }

    function runAutoLogic() {
        if (!autoSwitch.checked) return;
        if (!gameState || gameState.status !== 'playing') {
            // Oyun bittiyse ve oto aÃ§Ä±ksa yeniden baÅŸlat
            handleAction('start', null, true);
        } else {
            // Oyun iÃ§indeyse, 1 tane rastgele seÃ§
            if (gameState.opened.length === 0) {
                pickRandomTile();
            } else {
                // Zaten 1 tane aÃ§Ä±ldÄ±ysa Ã§ek
                setTimeout(() => handleAction('cashout', null, true), 800);
            }
        }
    }

    btnAction.addEventListener("click", () => {
        if(!gameState || gameState.status !== 'playing') handleAction('start');
        else if(gameState.opened.length > 0) handleAction('cashout');
    });

    btnRandom.addEventListener("click", () => { pickRandomTile(); });

    function handleTileClick(index) {
        if(!gameState || gameState.status !== 'playing' || isProcessing) return;
        if(gameState.opened.includes(index)) return;
        handleAction('click', index);
    }

    onAuthStateChanged(auth, user => { if(!user) window.location.href = '/'; });
</script>
</body>
</html>
