<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="description" content="PlayMatrix Mines | GÃ¼venli, adil ve heyecanlÄ± mayÄ±n tarlasÄ± oyunu. ElmaslarÄ± bul, Ã§arpanÄ± katla, mayÄ±nlardan kaÃ§!">
<meta name="keywords" content="mines oyunu, casino, playmatrix, mayÄ±n tarlasÄ±, kripto oyun, gÃ¼venli bahis, elmas bulma">
<meta name="author" content="PlayMatrix">
<meta name="robots" content="index, follow">
<meta name="theme-color" content="#020408">

<meta property="og:title" content="PlayMatrix Mines | GerÃ§ek Casino HeyecanÄ±">
<meta property="og:description" content="ElmaslarÄ± bularak kazancÄ±nÄ± katla. %100 Provably Fair ve gÃ¼venli!">
<meta property="og:type" content="website">
<meta property="og:site_name" content="PlayMatrix">

<title>PlayMatrix - Mines</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
    /* GENEL DÃœZEN VE SIFIR KAYMA KORUMASI */
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; touch-action:manipulation; user-select:none; }
    html, body { height:100vh; width: 100vw; overflow:hidden; overscroll-behavior: none; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; background: #020408; color:white; }

    /* ÃœST BAR (SADECE BAKÄ°YE, TAÅžMA KORUMALI) */
    .top-bar { position:fixed; top:0; left:0; right:0; height:70px; display:flex; align-items:center; justify-content:space-between; padding:0 15px; background: rgba(0,0,0,0.95); border-bottom: 2px solid #4fd1ff; z-index:1000; box-shadow: 0 4px 15px rgba(0,0,0,0.8); }
    .brand { font-family: 'Orbitron', sans-serif; font-size:1.2rem; font-weight:900; background: linear-gradient(90deg, #4fd1ff, #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 1px; flex-shrink: 0; }
    .right-menu { display:flex; gap:8px; align-items: center; justify-content: flex-end; flex: 1; margin-left: 10px; overflow: hidden; }
    
    .user-pill-mini { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 5px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); height: 38px; white-space: nowrap; overflow: hidden; }
    .balance-info { display: flex; align-items: center; overflow: hidden; }
    .balance-info b { font-size: 14px; color: #00ffa3; font-weight: 700; font-family: 'Inter', monospace; text-overflow: ellipsis; overflow: hidden; }
    .mc-chip { width: 22px; height: 22px; flex-shrink: 0; background: radial-gradient(circle at 30% 30%, #4fd1ff, #0055ff); border-radius: 50%; margin-left: 6px; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 900; color: #fff; box-shadow: 0 0 10px rgba(79, 209, 255, 0.3); border: 1.2px solid rgba(255,255,255,0.2); }

    .back-btn { background: linear-gradient(to bottom, #ff4b4b, #cc0000); color: white; text-decoration: none; padding: 8px 15px; border-radius: 10px; font-weight: 800; font-size: 11px; border: 1px solid #7a0000; cursor: pointer; transition: 0.3s; margin-left: 5px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

    /* OYUN ALANI */
    .container { position:absolute; top:70px; bottom:0; width:100%; display:flex; flex-direction:column; padding:15px; overflow-y:auto; background-image: radial-gradient(at 0% 0%, hsla(225,39%,10%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,15%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(225,39%,10%,1) 0, transparent 50%), radial-gradient(at 50% 50%, hsla(225,39%,5%,1) 0, transparent 100%), linear-gradient(180deg, #020408 0%, #0a0f1e 100%); }

    .mines-header { display:flex; justify-content:space-between; align-items:center; background:rgba(26, 34, 72, 0.4); padding:12px 15px; border-radius:14px; margin-bottom:15px; border: 1px solid rgba(79, 209, 255, 0.1); backdrop-filter: blur(5px); z-index: 2; font-family: 'Orbitron'; font-weight: bold; }
    
    #grid { display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin-bottom:20px; z-index: 2; flex:1; align-content: center; max-width: 500px; margin-left: auto; margin-right: auto; width: 100%; }
    
    .tile { background: rgba(22, 29, 54, 0.7); aspect-ratio: 1/1; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; transition: transform 0.1s, background 0.3s, box-shadow 0.3s; border: 1px solid rgba(39, 60, 143, 0.5); box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
    .tile.active-hover:active { transform: scale(0.9); }
    .tile.open { background: linear-gradient(145deg, #00b894, #00d2ad); border-color: #55efc4; box-shadow: 0 0 20px rgba(0, 184, 148, 0.6); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: default; }
    .tile.mine { background: linear-gradient(145deg, #d63031, #ff7675); border-color: #ff7675; box-shadow: 0 0 25px rgba(214, 48, 49, 0.7); animation: shake 0.4s; cursor: default; }
    .tile.dimmed-diamond { background: rgba(22, 29, 54, 0.3); border-color: rgba(39, 60, 143, 0.2); opacity: 0.5; cursor: default; filter: grayscale(0.8); }
    .tile.dimmed-mine { background: rgba(214, 48, 49, 0.2); border-color: rgba(214, 48, 49, 0.3); opacity: 0.7; cursor: default; filter: grayscale(0.5); }

    @keyframes popIn { 0% {transform: scale(0.5); opacity: 0;} 100% {transform: scale(1); opacity: 1;} }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

    .bet-panel { background: rgba(10, 15, 30, 0.85); border-top: 1px solid rgba(79, 209, 255, 0.1); padding: 20px 15px; margin: auto -15px 0 -15px; display: flex; flex-direction: column; gap: 12px; z-index: 10; max-width: 600px; margin-left: auto; margin-right: auto; width: 100%; border-radius: 20px 20px 0 0; }

    .input-row { display: flex; gap: 10px; }
    input, select { width:100%; background: rgba(5, 8, 17, 0.8); border: 2px solid #273c8f; border-radius:12px; padding:15px; color:white; font-weight: bold; font-size:16px; outline:none; text-align: center; transition: 0.3s; font-family: 'Orbitron'; }
    input:focus, select:focus { border-color: #4fd1ff; }
    input:disabled, select:disabled { opacity: 0.5; cursor: not-allowed; }

    button.main-btn { width:100%; padding:18px; border-radius:12px; border:none; font-weight:900; cursor:pointer; font-size:16px; background: linear-gradient(180deg, #6366f1, #4338ca); color:white; transition: 0.1s; font-family: 'Orbitron'; text-transform: uppercase; box-shadow: 0 5px 0 #312e81; letter-spacing: 1px; }
    button.main-btn:active:not(:disabled) { transform: translateY(5px); box-shadow: 0 0 0 transparent; }
    button.main-btn:disabled { opacity: 0.6; filter: grayscale(0.8); cursor: not-allowed; transform: none; box-shadow: 0 5px 0 rgba(0,0,0,0.5); }
    
    .btn-cashout { background: linear-gradient(180deg, #f59e0b, #d97706) !important; box-shadow: 0 5px 0 #b45309 !important; }
    .btn-loss { background: linear-gradient(180deg, #ef4444, #b91c1c) !important; box-shadow: 0 5px 0 #7f1d1d !important; }

    /* YENÄ°: AÃ‡ILIÅž VE BÄ°LGÄ°LENDÄ°RME MODALI (NASIL OYNANIR) */
    .modal-overlay { position: fixed; inset: 0; background: rgba(2,4,10,0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(15px); touch-action: none; transition: opacity 0.3s; }
    
    .animated-border-box {
        position: relative; width: 90%; max-width: 380px; border-radius: 16px; padding: 4px;
        background: linear-gradient(45deg, #4fd1ff, #00ffa3, #4fd1ff, #6366f1);
        background-size: 300% 300%; animation: gradientBorder 3s ease infinite;
        box-shadow: 0 0 40px rgba(79, 209, 255, 0.4);
        transform: scale(0.9); animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards, gradientBorder 3s ease infinite;
    }

    @keyframes modalPop { to { transform: scale(1); } }
    @keyframes gradientBorder { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    .modal-content { background: linear-gradient(to bottom, #0a0f1a, #000); border-radius: 12px; padding: 25px; text-align: center; width: 100%; height: 100%; }
    .modal-title { color: #4fd1ff; margin-bottom: 15px; font-family: 'Orbitron', sans-serif; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 2px 5px rgba(79,209,255,0.6); }
    
    .info-list { font-size: 13px; color: #ddd; margin-bottom: 25px; text-align: left; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; border: 1px solid #1f2937; line-height: 1.6; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); font-family: 'Inter', sans-serif; }
    .info-list .highlight { color: #00ffa3; font-weight: bold; }
    .info-list .highlight-red { color: #ff4b4b; font-weight: bold; }
    
    .info-item { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; }
    .info-item span { font-size: 16px; line-height: 1.2; }

    .btn-start-game { width: 100%; padding: 15px; border-radius: 8px; border: none; background: linear-gradient(to bottom, #00ffa3, #00b894); font-weight: 900; color: #000; font-size: 16px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,255,163,0.3); text-transform: uppercase; font-family: 'Orbitron'; transition: 0.2s; }
    .btn-start-game:active { transform: translateY(3px); box-shadow: none; }
</style>
</head>
<body>

<div id="start-overlay" class="modal-overlay">
    <div class="animated-border-box">
        <div class="modal-content">
            <h2 class="modal-title">Mines Nedir?</h2>
            <div class="info-list">
                <div class="info-item"><span>ðŸ’Ž</span><div><b>ElmaslarÄ± Bul:</b> KapalÄ± kutularÄ±n ardÄ±ndaki elmaslarÄ± bularak Ã§arpanÄ±nÄ± katla.</div></div>
                <div class="info-item"><span>ðŸ’£</span><div><b>MayÄ±nlardan KaÃ§:</b> MayÄ±na basarsan tÃ¼m kazancÄ±nÄ± ve bahsini kaybedersin.</div></div>
                <div class="info-item"><span>ðŸ’°</span><div><b>Ä°stediÄŸin An Ã‡ek:</b> GÃ¼vende hissettiÄŸin an <span class="highlight">Ã‡EK</span> butonuna basarak kÃ¢rÄ±nÄ± al.</div></div>
                <div style="margin-top: 15px; text-align: center; color: #94a3b8; font-size: 11px; border-top: 1px solid #1f2937; padding-top: 10px;">
                    <i>En iyi oyun deneyimi iÃ§in cihazÄ±nÄ±zÄ±n sesini aÃ§Ä±nÄ±z.</i>
                </div>
            </div>
            <button id="systemStartBtn" class="btn-start-game">ANLADIM BAÅžLA</button>
        </div>
    </div>
</div>

<div id="custom-alert-overlay" class="modal-overlay" style="display: none; opacity: 0; z-index: 10001;">
    <div class="animated-border-box" id="custom-alert-box">
        <div class="modal-content">
            <h2 class="modal-title" id="custom-alert-title">UYARI</h2>
            <div class="info-list" style="text-align: center; font-size: 15px; font-weight: bold; margin-bottom: 25px; border:none; background: transparent; box-shadow: none;">
                <span id="custom-alert-message"></span>
            </div>
            <button id="custom-alert-btn" class="btn-start-game">KAPAT</button>
        </div>
    </div>
</div>

<header class="top-bar">
    <div class="brand">MÄ°NES</div>
    <nav class="right-menu">
        <div class="user-pill-mini">
            <div class="balance-info"><b id="userBalance">YÃ¼kleniyor...</b></div>
            <div class="mc-chip">MC</div>
        </div>
        <a href="/" class="back-btn">Ã‡IKIÅž</a>
    </nav>
</header>

<main class="container">
    <div class="mines-header">
        <div>Ã‡ARPAN: <span id="multiplierDisplay" style="color:#00ffa3; font-size: 1.2rem;">1.00x</span></div>
        <div>MAYIN: <span id="mineDisplay" style="color:#ff4b4b; font-size: 1.2rem;">3</span></div>
    </div>
    
    <div id="grid"></div>
    
    <div class="bet-panel">
        <div class="input-row">
            <input type="number" id="bet" placeholder="Bahis MiktarÄ±" value="10" min="10">
            <select id="mineCount"></select>
        </div>
        <button id="startBtn" class="main-btn">MC KULLAN</button>
    </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, getIdToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const API_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" ? "http://localhost:3000" : "https://emirhan-siye.onrender.com";

// --- CUSTOM MODAL UYARI SÄ°STEMÄ° ---
function showCustomAlert(msg, title = "BÄ°LDÄ°RÄ°M", type = "error") {
    const overlay = document.getElementById('custom-alert-overlay');
    const titleEl = document.getElementById('custom-alert-title');
    const messageEl = document.getElementById('custom-alert-message');
    const boxEl = document.getElementById('custom-alert-box');
    const btnEl = document.getElementById('custom-alert-btn');

    titleEl.innerText = title;
    messageEl.innerHTML = `<b>${msg}</b>`;

    if (type === 'error') {
        titleEl.style.color = '#ff4b4b';
        titleEl.style.textShadow = '0 2px 5px rgba(255,75,75,0.6)';
        boxEl.style.background = 'linear-gradient(45deg, #ff4b4b, #b91c1c, #ff4b4b, #991b1b)';
        btnEl.style.background = 'linear-gradient(to bottom, #ff4b4b, #cc0000)';
        btnEl.style.boxShadow = '0 5px 15px rgba(255,75,75,0.3)';
    } else {
        titleEl.style.color = '#00ffa3';
        titleEl.style.textShadow = '0 2px 5px rgba(0,255,163,0.6)';
        boxEl.style.background = 'linear-gradient(45deg, #00ffa3, #00b894, #00ffa3, #047857)';
        btnEl.style.background = 'linear-gradient(to bottom, #00ffa3, #00b894)';
        btnEl.style.boxShadow = '0 5px 15px rgba(0,255,163,0.3)';
    }

    overlay.style.display = 'flex';
    setTimeout(() => { overlay.style.opacity = '1'; }, 10);
}

document.getElementById('custom-alert-btn').addEventListener('click', () => {
    const overlay = document.getElementById('custom-alert-overlay');
    overlay.style.opacity = '0';
    setTimeout(() => { overlay.style.display = 'none'; }, 300);
});

// --- YENÄ° GERÃ‡EKÃ‡Ä° SES MOTORU ---
let audioCtx = null;
const sounds = {};
const urls = {
    bet: 'https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3', // Ã‡ip/Bahis sesi
    open: 'https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3', // Elmas aÃ§Ä±lma (Soft Ã‡Ä±nlama)
    explode: 'https://assets.mixkit.co/active_storage/sfx/170/170-preview.mp3', // MayÄ±n Patlama (GerÃ§ek Boom)
    win: 'https://assets.mixkit.co/active_storage/sfx/2004/2004-preview.mp3'  // Casino KazanÃ§ (ÅžÄ±kÄ±rtÄ±)
};

function initAudio() {
    if (audioCtx) return;
    try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        for (const [name, url] of Object.entries(urls)) {
            fetch(url).then(res => res.arrayBuffer()).then(buf => audioCtx.decodeAudioData(buf)).then(decoded => sounds[name] = decoded).catch(e=>{});
        }
    } catch (e) {}
}

let lastSoundTime = { bet: 0, open: 0, explode: 0, win: 0 };
function playSound(name) {
    if (!audioCtx || !sounds[name]) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    const now = Date.now();
    if (now - lastSoundTime[name] < 100) return; // Ses Ã§akÄ±ÅŸmasÄ±nÄ±/yankÄ±yÄ± Ã¶nle
    lastSoundTime[name] = now;

    const source = audioCtx.createBufferSource();
    source.buffer = sounds[name];
    source.connect(audioCtx.destination);
    source.start(0);
}

// --- API YÃ–NETÄ°MÄ° ---
let userBalance = 0;
let isProcessing = false;
let gameState = null;

async function fetchAPI(endpoint, method = 'GET', body = null) {
    if (!auth.currentUser) return null;
    const token = await getIdToken(auth.currentUser);
    const options = { method, headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } };
    if (body) options.body = JSON.stringify(body);
    const res = await fetch(`${API_URL}${endpoint}`, options);
    const data = await res.json();
    if (data.redirect || res.status === 401 || res.status === 403) { window.location.href = '/'; throw new Error("YÃ¶nlendiriliyorsunuz."); }
    if (!data.ok) throw new Error(data.error || "Sunucu hatasÄ±");
    return data;
}

async function fetchBalance() {
    try {
        const data = await fetchAPI('/api/me');
        if(data) {
            userBalance = data.balance;
            document.getElementById("userBalance").innerText = userBalance.toLocaleString('tr-TR');
        }
    } catch(e) {}
}

const mineSelect = document.getElementById("mineCount");
for(let i=1; i<=24; i++){ let opt = document.createElement("option"); opt.value = i; opt.text = i + " MAYIN"; mineSelect.appendChild(opt); }
mineSelect.value = 3; mineSelect.addEventListener("change", () => document.getElementById("mineDisplay").innerText = mineSelect.value);

function renderGrid() {
    const gridEl = document.getElementById("grid");
    gridEl.innerHTML = "";
    for(let i=0; i<25; i++){
        let tile = document.createElement("div");
        tile.className = "tile active-hover";
        tile.id = `tile-${i}`;
        tile.addEventListener("click", () => handleTileClick(i));
        gridEl.appendChild(tile);
    }
}

function updateUI() {
    const startBtn = document.getElementById("startBtn");
    const betInput = document.getElementById("bet");
    const multDisplay = document.getElementById("multiplierDisplay");

    if (!gameState || gameState.status !== 'playing') {
        startBtn.innerText = "MC KULLAN";
        startBtn.className = "main-btn";
        startBtn.disabled = false;
        betInput.disabled = false;
        mineSelect.disabled = false;
        multDisplay.innerText = "1.00x";
        multDisplay.style.color = "#00ffa3";
    } else {
        betInput.disabled = true;
        mineSelect.disabled = true;
        multDisplay.innerText = gameState.multiplier.toFixed(2) + "x";
        multDisplay.style.color = "#4fd1ff";
        
        if (gameState.opened.length > 0) {
            const winAmount = Math.floor(gameState.bet * gameState.multiplier);
            startBtn.innerText = `Ã‡EK MC ${winAmount.toLocaleString('tr-TR')}`;
            startBtn.className = "main-btn btn-cashout";
            startBtn.disabled = false;
        } else {
            startBtn.innerText = "TAÅž SEÃ‡Ä°N";
            startBtn.className = "main-btn";
            startBtn.disabled = true;
        }

        // TahtayÄ± GÃ¼ncelle (ElmaslarÄ± GÃ¶ster)
        gameState.opened.forEach(idx => {
            const t = document.getElementById(`tile-${idx}`);
            if(t && !t.classList.contains('open')) { 
                t.className = "tile open"; 
                t.innerHTML = "ðŸ’Ž"; 
            }
        });
    }
}

async function handleAction(actionType, tileIndex = null) {
    if(isProcessing) return;
    
    const startBtn = document.getElementById("startBtn");
    isProcessing = true;
    startBtn.disabled = true; // Spam korumasÄ±

    try {
        if (actionType === 'start') {
            const betAmount = parseInt(document.getElementById("bet").value);
            const minesCount = parseInt(mineSelect.value);
            if(isNaN(betAmount) || betAmount < 10) throw new Error("Min bahis 10 MC");
            
            const res = await fetchAPI('/api/mines/start', 'POST', { bet: betAmount, minesCount });
            gameState = res.state;
            playSound("bet");
            renderGrid();
        } 
        else if (actionType === 'click') {
            // Optimistik UI (TÄ±klanan kutuyu anÄ±nda parlat, sunucu cevabÄ±nÄ± bekle)
            const targetTile = document.getElementById(`tile-${tileIndex}`);
            if(targetTile) targetTile.style.transform = "scale(0.9)";
            
            const res = await fetchAPI('/api/mines/action', 'POST', { action: 'click', index: tileIndex });
            gameState = res.state;
            
            if(gameState.status === 'busted') {
                playSound("explode");
                revealBoard(res.board, tileIndex, false);
                startBtn.innerText = "KAYBETTÄ°N!";
                startBtn.className = "main-btn btn-loss";
                setTimeout(() => { gameState = null; renderGrid(); updateUI(); }, 2500);
            } else if (gameState.status === 'cashed_out') {
                playSound("win");
                revealBoard(res.board, -1, true);
                showCustomAlert(`${res.winAmount} MC KazandÄ±nÄ±z!`, "TEBRÄ°KLER!", "success");
                setTimeout(() => { gameState = null; renderGrid(); updateUI(); }, 3000);
            } else {
                playSound("open");
            }
        } 
        else if (actionType === 'cashout') {
            const res = await fetchAPI('/api/mines/action', 'POST', { action: 'cashout' });
            gameState = res.state;
            playSound("win");
            revealBoard(res.board, -1, true);
            startBtn.innerText = `KAZANDIN: ${res.winAmount}`;
            startBtn.className = "main-btn btn-cancel";
            startBtn.style.background = "#00b894";
            setTimeout(() => { gameState = null; renderGrid(); updateUI(); }, 2500);
        }
        fetchBalance();
    } catch(e) {
        showCustomAlert(e.message, "HATA", "error");
    }
    
    updateUI();
    isProcessing = false;
}

function revealBoard(boardArray, hitIndex, isWin) {
    for(let i=0; i<25; i++) {
        const t = document.getElementById(`tile-${i}`);
        t.className = "tile";
        if(i === hitIndex) {
            t.classList.add("mine"); t.innerHTML = "ðŸ’£";
        } else if(boardArray[i] === 1) {
            t.classList.add("dimmed-mine"); t.innerHTML = "ðŸ’£";
        } else if(!t.innerHTML.includes("ðŸ’Ž")) {
            t.classList.add("dimmed-diamond"); t.innerHTML = "ðŸ’Ž";
        }
    }
}

document.getElementById("startBtn").addEventListener("click", () => {
    if(!gameState || gameState.status !== 'playing') handleAction('start');
    else if(gameState.opened.length > 0) handleAction('cashout');
});

function handleTileClick(index) {
    if(!gameState || gameState.status !== 'playing' || isProcessing) return;
    if(gameState.opened.includes(index)) return;
    handleAction('click', index);
}

document.getElementById('systemStartBtn').addEventListener('click', async () => {
    initAudio(); 
    document.getElementById('start-overlay').style.opacity = '0';
    setTimeout(async () => {
        document.getElementById('start-overlay').style.display = 'none';
        renderGrid();
        await fetchBalance();
        try {
            const res = await fetchAPI('/api/mines/state');
            if(res && res.state && res.state.status === 'playing') { gameState = res.state; updateUI(); }
        } catch(e){}
    }, 300);
});

onAuthStateChanged(auth, user => { if(!user) window.location.href = '/'; });
</script>
</body>
</html>
