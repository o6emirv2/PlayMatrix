<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>PlayMatrix Mines | %100 GÃ¼venli Sunucu TabanlÄ±</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:manipulation;}
    html,body{ height:100%; overflow:hidden; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; background: #020408; color:white; }

    .top-bar{
        position:fixed;top:0;width:100%;height:70px; display:flex;align-items:center;justify-content:space-between;
        padding:0 15px; background: rgba(0,0,0,0.95); border-bottom: 2px solid #4fd1ff; z-index:1000;
    }
    .brand{ font-family: 'Orbitron', sans-serif; font-size:1.1rem; font-weight:900; color:#4fd1ff; letter-spacing: 1px; }
    .right-menu{display:flex;gap:8px;align-items: center;}
    
    .user-pill-mini { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 5px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); height: 38px; }
    .balance-info { display: flex; align-items: center; }
    .balance-info b { font-size: 14px; color: #00ffa3; font-weight: 700; font-family: 'Inter', monospace; }
    .mc-chip { width: 22px; height: 22px; background: radial-gradient(circle at 30% 30%, #4fd1ff, #0055ff); border-radius: 50%; margin-left: 6px; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 900; color: #fff; box-shadow: 0 0 10px rgba(79, 209, 255, 0.3); border: 1.2px solid rgba(255,255,255,0.2); }

    .back-btn { background: #d63031; color: white; text-decoration: none; padding: 8px 15px; border-radius: 10px; font-weight: 800; font-size: 11px; border: none; cursor: pointer; transition: 0.3s; margin-left: 5px; }

    .container{
        position:absolute;top:70px;bottom:0;width:100%; display:flex;flex-direction:column;padding:15px;overflow-y:auto;
        background-image: radial-gradient(at 0% 0%, hsla(225,39%,10%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,15%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(225,39%,10%,1) 0, transparent 50%), radial-gradient(at 50% 50%, hsla(225,39%,5%,1) 0, transparent 100%), linear-gradient(180deg, #020408 0%, #0a0f1e 100%);
    }

    .mines-header{
        display:flex;justify-content:space-between;align-items:center; background:rgba(26, 34, 72, 0.4); padding:12px 15px; border-radius:14px; margin-bottom:15px; border: 1px solid rgba(79, 209, 255, 0.1); backdrop-filter: blur(5px); z-index: 2; font-family: 'Orbitron';
    }
    
    #grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px; z-index: 2; flex:1; align-content: center;}
    
    .tile{
        background: rgba(22, 29, 54, 0.7); aspect-ratio: 1/1; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(39, 60, 143, 0.5); box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }
    .tile.active-hover:active { transform: scale(0.9); }
    .tile.open{ background: linear-gradient(145deg, #00b894, #00d2ad); border-color: #55efc4; box-shadow: 0 0 15px rgba(0, 184, 148, 0.4); animation: flip 0.4s; cursor: default; }
    .tile.mine{ background: linear-gradient(145deg, #d63031, #ff7675); border-color: #ff7675; box-shadow: 0 0 20px rgba(214, 48, 49, 0.5); animation: shake 0.4s; cursor: default; }
    .tile.dimmed-diamond { background: rgba(22, 29, 54, 0.3); border-color: rgba(39, 60, 143, 0.2); opacity: 0.5; cursor: default; filter: grayscale(0.5); }
    .tile.dimmed-mine { background: rgba(214, 48, 49, 0.2); border-color: rgba(214, 48, 49, 0.3); opacity: 0.7; cursor: default; }

    @keyframes flip { 0% {transform: rotateY(90deg);} 100% {transform: rotateY(0deg);} }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }

    .bet-panel{
        background: rgba(10, 15, 30, 0.85); border-top: 1px solid rgba(79, 209, 255, 0.1); padding: 20px 15px; margin: auto -15px 0 -15px; display: flex; flex-direction: column; gap: 10px; z-index: 10;
    }

    input, select{
        width:100%; background: rgba(5, 8, 17, 0.8); border: 1px solid #273c8f; border-radius:12px; padding:12px; color:white; font-weight: bold; font-size:16px; outline:none; text-align: center; transition: 0.3s; font-family: 'Orbitron';
    }
    input:focus { border-color: #4fd1ff; }
    input:disabled, select:disabled { opacity: 0.5; cursor: not-allowed; }

    button.main-btn {
        width:100%; padding:15px; border-radius:12px; border:none; font-weight:900; cursor:pointer; font-size:16px; background: linear-gradient(180deg, #6366f1, #4338ca); color:white; transition: 0.2s; font-family: 'Orbitron'; text-transform: uppercase; box-shadow: 0 4px 0 #312e81;
    }
    button.main-btn:active:not(:disabled) { transform: translateY(4px); box-shadow: none; }
    button.main-btn:disabled { opacity: 0.5; filter: grayscale(0.5); cursor: not-allowed; }
    
    .btn-cashout { background: linear-gradient(180deg, #f59e0b, #d97706) !important; box-shadow: 0 4px 0 #b45309 !important; }
    .btn-loss { background: linear-gradient(180deg, #ef4444, #b91c1c) !important; box-shadow: 0 4px 0 #7f1d1d !important; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(2,4,10,0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(10px); flex-direction: column; }
    .modal-content { background: rgba(10,15,25,0.95); padding: 40px; border-radius: 20px; text-align: center; border: 2px solid #4fd1ff; box-shadow: 0 0 30px rgba(79,209,255,0.2); width: 85%; max-width: 350px; }
</style>
</head>
<body>

<div id="sys-start-overlay" class="modal-overlay">
    <div class="modal-content">
        <h2 style="font-family:'Orbitron'; color:#4fd1ff; font-size: 24px; margin-bottom: 10px;">MÄ°NES PROTOKOLÃœ</h2>
        <p style="font-size: 12px; color: #94a3b8; margin-bottom: 25px; font-family: 'Inter';">%100 Sunucu KorumalÄ± Mod: Sesleri ve oyun motorunu aktifleÅŸtirmek iÃ§in sistemi baÅŸlatÄ±n.</p>
        <button id="systemStartBtn" style="width: 100%; padding: 15px; border-radius: 12px; border: none; background: linear-gradient(90deg, #00ffa3, #00b894); color: #000; font-weight: 900; font-family: 'Orbitron'; font-size: 16px; cursor: pointer;">SÄ°STEMÄ° BAÅžLAT</button>
    </div>
</div>

<header class="top-bar">
    <div class="brand">MÄ°NES</div>
    <nav class="right-menu">
        <div class="user-pill-mini">
            <div class="balance-info"><b id="userBalance">YÃ¼kleniyor...</b><div class="mc-chip">MC</div></div>
        </div>
        <div class="user-pill-mini" style="border-color: #ffcc00;">
            <div class="balance-info"><b id="currentBet" style="color:#ffcc00">0</b><div class="mc-chip" style="background: radial-gradient(circle at 30% 30%, #ffcc00, #ff8a00);">MC</div></div>
        </div>
        <a href="/" class="back-btn">Ã‡IKIÅž</a>
    </nav>
</header>

<main class="container">
    <div class="mines-header">
        <div>MULTÄ°: <span id="multiplierDisplay" style="color:white;">1.00x</span></div>
        <div>MAYIN: <span id="mineDisplay" style="color:#ff2a4d;">3</span></div>
    </div>
    
    <div id="grid"></div>
    
    <div class="bet-panel">
        <input type="number" id="bet" placeholder="Bahis MiktarÄ±" value="10" min="10">
        <select id="mineCount"></select>
        <button id="startBtn" class="main-btn">MC KULLAN</button>
    </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, getIdToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const API_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" ? "http://localhost:3000" : "https://emirhan-siye.onrender.com";

// --- SES SÄ°STEMÄ° ---
let audioCtx = null;
const sounds = {};
async function initAudio() {
    if (audioCtx) return;
    try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const buffer = audioCtx.createBuffer(1, 1, 22050);
        const source = audioCtx.createBufferSource(); source.buffer = buffer; source.connect(audioCtx.destination); source.start(0);

        const urls = {
            bet: 'https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3',
            open: 'https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3',
            explode: 'https://assets.mixkit.co/active_storage/sfx/2802/2802-preview.mp3',
            win: 'https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3'
        };
        for (const [name, url] of Object.entries(urls)) {
            fetch(url).then(res => res.arrayBuffer()).then(buf => audioCtx.decodeAudioData(buf)).then(decoded => sounds[name] = decoded).catch(e=>{});
        }
    } catch (e) { console.error(e); }
}
function playSound(name) {
    if (!audioCtx || !sounds[name]) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const source = audioCtx.createBufferSource(); source.buffer = sounds[name]; source.connect(audioCtx.destination); source.start(0);
}

// --- API YÃ–NETÄ°MÄ° ---
let userBalance = 0;
let isProcessing = false;
let gameState = null;

async function fetchAPI(endpoint, method = 'GET', body = null) {
    if (!auth.currentUser) { window.location.href = '/'; return; }
    const token = await getIdToken(auth.currentUser);
    const options = { method, headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } };
    if (body) options.body = JSON.stringify(body);
    const res = await fetch(`${API_URL}${endpoint}`, options);
    const data = await res.json();
    if (data.redirect) window.location.href = '/';
    if (!data.ok) throw new Error(data.error || "Sunucu hatasÄ±");
    return data;
}

async function fetchBalance() {
    try {
        const data = await fetchAPI('/api/me');
        if(data) {
            userBalance = data.balance;
            document.getElementById("userBalance").innerText = userBalance.toLocaleString('tr-TR');
        }
    } catch(e) {}
}

const mineSelect = document.getElementById("mineCount");
for(let i=1; i<=24; i++){ let opt = document.createElement("option"); opt.value = i; opt.text = i + " MAYIN"; mineSelect.appendChild(opt); }
mineSelect.value = 3; mineSelect.addEventListener("change", () => document.getElementById("mineDisplay").innerText = mineSelect.value);

function renderGrid() {
    const gridEl = document.getElementById("grid");
    gridEl.innerHTML = "";
    for(let i=0; i<25; i++){
        let tile = document.createElement("div");
        tile.className = "tile active-hover";
        tile.id = `tile-${i}`;
        tile.addEventListener("click", () => handleTileClick(i));
        gridEl.appendChild(tile);
    }
}

function updateUI() {
    const startBtn = document.getElementById("startBtn");
    const betInput = document.getElementById("bet");
    const multDisplay = document.getElementById("multiplierDisplay");
    const betDisp = document.getElementById("currentBet");

    if (!gameState || gameState.status !== 'playing') {
        startBtn.innerText = "MC KULLAN";
        startBtn.className = "main-btn";
        betInput.disabled = false;
        mineSelect.disabled = false;
        multDisplay.innerText = "1.00x";
        betDisp.innerText = "0";
    } else {
        betInput.disabled = true;
        mineSelect.disabled = true;
        multDisplay.innerText = gameState.multiplier.toFixed(2) + "x";
        betDisp.innerText = gameState.bet.toLocaleString('tr-TR');
        
        if (gameState.opened.length > 0) {
            const winAmount = Math.floor(gameState.bet * gameState.multiplier);
            startBtn.innerText = `Ã‡EK (MC ${winAmount.toLocaleString('tr-TR')})`;
            startBtn.className = "main-btn btn-cashout";
        } else {
            startBtn.innerText = "TAÅž SEÃ‡Ä°N";
            startBtn.className = "main-btn";
            startBtn.style.background = "linear-gradient(180deg, #00d2ad 0%, #00b894 100%)";
        }

        // TahtayÄ± GÃ¼ncelle
        gameState.opened.forEach(idx => {
            const t = document.getElementById(`tile-${idx}`);
            if(t) { t.className = "tile open"; t.innerHTML = "ðŸ’Ž"; }
        });
    }
}

async function handleAction(actionType, tileIndex = null) {
    if(isProcessing) return;
    isProcessing = true;
    const startBtn = document.getElementById("startBtn");
    startBtn.disabled = true;

    try {
        if (actionType === 'start') {
            const betAmount = parseInt(document.getElementById("bet").value);
            const minesCount = parseInt(mineSelect.value);
            if(isNaN(betAmount) || betAmount < 10) throw new Error("Min bahis 10 MC");
            
            const res = await fetchAPI('/api/mines/start', 'POST', { bet: betAmount, minesCount });
            gameState = res.state;
            playSound("bet");
            renderGrid();
        } 
        else if (actionType === 'click') {
            const res = await fetchAPI('/api/mines/action', 'POST', { action: 'click', index: tileIndex });
            gameState = res.state;
            
            if(gameState.status === 'busted') {
                playSound("explode");
                revealBoard(res.board, tileIndex, false);
                startBtn.innerText = "KAYBETTÄ°N!";
                startBtn.className = "main-btn btn-loss";
                setTimeout(() => { gameState = null; renderGrid(); updateUI(); }, 2500);
            } else if (gameState.status === 'cashed_out') {
                playSound("win");
                revealBoard(res.board, -1, true);
                alert(`OTOMATÄ°K Ã‡EKÄ°M: ${res.winAmount} MC KazandÄ±nÄ±z!`);
                setTimeout(() => { gameState = null; renderGrid(); updateUI(); }, 2500);
            } else {
                playSound("open");
            }
        } 
        else if (actionType === 'cashout') {
            const res = await fetchAPI('/api/mines/action', 'POST', { action: 'cashout' });
            gameState = res.state;
            playSound("win");
            revealBoard(res.board, -1, true);
            startBtn.innerText = `KAZANDIN: ${res.winAmount}`;
            startBtn.className = "main-btn btn-cancel";
            startBtn.style.background = "#00b894";
            setTimeout(() => { gameState = null; renderGrid(); updateUI(); }, 2500);
        }
        fetchBalance();
    } catch(e) {
        alert(e.message);
    }
    
    updateUI();
    isProcessing = false;
    startBtn.disabled = false;
}

function revealBoard(boardArray, hitIndex, isWin) {
    for(let i=0; i<25; i++) {
        const t = document.getElementById(`tile-${i}`);
        t.className = "tile";
        if(i === hitIndex) {
            t.classList.add("mine"); t.innerHTML = "ðŸ’£";
        } else if(boardArray[i] === 1) {
            t.classList.add("dimmed-mine"); t.innerHTML = "ðŸ’£";
        } else if(!t.innerHTML.includes("ðŸ’Ž")) {
            t.classList.add("dimmed-diamond"); t.innerHTML = "ðŸ’Ž";
        }
    }
}

document.getElementById("startBtn").addEventListener("click", () => {
    if(!gameState || gameState.status !== 'playing') handleAction('start');
    else if(gameState.opened.length > 0) handleAction('cashout');
});

function handleTileClick(index) {
    if(!gameState || gameState.status !== 'playing' || isProcessing) return;
    if(gameState.opened.includes(index)) return;
    handleAction('click', index);
}

document.getElementById('systemStartBtn').addEventListener('click', async () => {
    initAudio(); document.getElementById('sys-start-overlay').style.display = 'none';
    renderGrid();
    await fetchBalance();
    try {
        const res = await fetchAPI('/api/mines/state');
        if(res.state && res.state.status === 'playing') { gameState = res.state; updateUI(); }
    } catch(e){}
});

onAuthStateChanged(auth, user => { if(!user) window.location.href = '/'; });
</script>
</body>
</html>
